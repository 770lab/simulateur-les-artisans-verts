<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur PAC + ITE â€” Les Artisans Verts</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,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">
    <link rel="apple-touch-icon" href="data:image/png;base64,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">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        /* === BANDEAU INFO 2026 === */
        .info-banner-2026 {
            background: linear-gradient(135deg, #14532d 0%, #166534 50%, #15803d 100%);
            color: white;
            padding: 10px 20px;
            font-size: 13px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .info-banner-2026 strong { color: #86efac; }
        .info-banner-2026 .separator-dot { opacity: 0.4; margin: 0 4px; }

        /* === AUTO-DETECTION REVENUS === */
        .revenus-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .revenus-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .revenus-toggle h3 {
            font-size: 14px;
            font-weight: 600;
            color: #16a34a;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .revenus-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #16a34a;
        }
        .revenus-toggle .toggle-arrow.open { transform: rotate(180deg); }
        .revenus-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding-top: 0;
        }
        .revenus-body.open {
            max-height: 500px;
            padding-top: 14px;
        }
        .revenus-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .revenus-grid { grid-template-columns: 1fr; }
        }
        .revenus-grid label {
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 4px;
            display: block;
        }
        .revenus-grid select, .revenus-grid input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }
        .revenus-grid select:focus, .revenus-grid input:focus {
            border-color: #16a34a;
            outline: none;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }
        .profil-result {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: fadeSlide 0.3s ease;
        }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .profil-result.show { display: block; }
        .profil-result.profil-bleu {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .profil-result.profil-jaune {
            background: linear-gradient(135deg, #fef9c3, #fef08a);
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .profil-result.profil-violet {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            color: #5b21b6;
            border: 1px solid #c4b5fd;
        }
        .profil-result.profil-rose {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            color: #9d174d;
            border: 1px solid #f9a8d4;
        }

        /* === CEE DETAIL SECTION === */
        .cee-section {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #93c5fd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .cee-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .cee-toggle h3 {
            font-size: 14px;
            font-weight: 600;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .cee-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #2563eb;
        }
        .cee-toggle .toggle-arrow.open { transform: rotate(180deg); }
        .cee-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease, padding 0.3s ease;
            padding-top: 0;
        }
        .cee-body.open {
            max-height: 800px;
            padding-top: 14px;
        }
        .cee-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .cee-grid { grid-template-columns: 1fr; }
        }
        .cee-grid label {
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 4px;
            display: block;
        }
        .cee-grid select, .cee-grid input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }
        .cee-grid select:focus, .cee-grid input:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .cee-result {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            text-align: center;
            display: none;
            animation: fadeSlide 0.3s ease;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .cee-result.show { display: block; }
        .cee-hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        .cee-bloc-171, .cee-bloc-148 {
            transition: all 0.3s ease;
        }
        .cee-hidden { display: none !important; }

        /* Isolation state radio buttons */
        .g-radio {
            display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px;
            border: 1.5px solid #e2e8f0; border-radius: 10px; cursor: pointer;
            transition: all 0.15s ease; font-size: 13px; background: white;
        }
        .g-radio:hover { border-color: #a3cfbb; background: #f8fdfb; }
        .g-radio.selected { border-color: #16a34a; background: #f0fdf4; }
        .g-radio input[type="radio"] { accent-color: #16a34a; margin: 3px 0 0 0; width: 18px; height: 18px; flex-shrink: 0; }
        .g-label { flex: 1; }
        .g-label-title { font-weight: 600; color: #1d1d1f; font-size: 13px; }
        .g-label-sub { font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .g-value { display: none; }

        /* Dim form */
        .dim-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
        .dim-field label { font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; margin-bottom: 6px; }
        .dim-field .req { color: #dc2626; }
        .dim-field input, .dim-field select {
            width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px;
            font-size: 15px; font-weight: 500; color: #0f172a; background: white; transition: border-color 0.15s;
        }
        .dim-field input:focus, .dim-field select:focus { border-color: #16a34a; outline: none; box-shadow: 0 0 0 3px rgba(22,163,74,0.08); }
        .dim-field .dim-hint { font-size: 11px; color: #94a3b8; margin-top: 4px; }

        /* Confort slider */
        .confort-box { border: 1.5px solid #e2e8f0; border-radius: 10px; padding: 16px; }
        .confort-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .confort-val { font-size: 22px; font-weight: 700; color: #16a34a; }
        .confort-lbl { font-size: 14px; font-weight: 600; color: #334155; text-transform: uppercase; letter-spacing: 0.5px; }
        input.confort-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 4px; outline: none; margin: 8px 0; padding: 0; border: none;
            background: linear-gradient(to right, #fb923c, #16a34a 50%, #3b82f6); }
        input.confort-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 26px; height: 26px; border-radius: 50%; background: white; border: 3px solid #16a34a; cursor: pointer; box-shadow: 0 1px 6px rgba(0,0,0,0.15); }
        input.confort-slider::-moz-range-thumb { width: 26px; height: 26px; border-radius: 50%; background: white; border: 3px solid #16a34a; cursor: pointer; box-shadow: 0 1px 6px rgba(0,0,0,0.15); }
        .confort-labels { display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .confort-desc { font-size: 12px; color: #64748b; margin-top: 10px; font-style: italic; }

        /* ===== PRODUIT & OPTIONS ===== */
        .produit-bloc {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 10px;
            padding: 14px;
        }
        .produit-bloc-head {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .produit-bloc-icon {
            font-size: 18px;
            width: 32px;
            height: 32px;
            background: rgba(34,197,94,0.12);
            border-radius: 8px;
            display: grid;
            place-items: center;
        }
        .produit-bloc-title {
            font-size: 14px;
            font-weight: 700;
            color: #1d1d1f;
        }
        .produit-opt-section {
            display: none;
            margin-top: 8px;
            padding: 12px;
            background: rgba(255,255,255,0.7);
            border: 1px solid #d1fae5;
            border-radius: 8px;
            animation: prodOptIn 0.25s ease;
        }
        @keyframes prodOptIn {
            from { opacity: 0; transform: translateY(-4px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        #pacInfo b { color: #16a34a; }

        /* Isolation checklist */
        .iso-check {
            display: flex; align-items: center; gap: 10px; padding: 10px 14px;
            border: 1.5px solid #e2e8f0; border-radius: 8px; cursor: pointer;
            transition: all 0.15s ease; background: white;
        }
        .iso-check:hover { border-color: #a3cfbb; background: #f8fdfb; }
        .iso-check:has(input:checked) { border-color: #16a34a; background: #f0fdf4; }
        .iso-check input[type="checkbox"] { accent-color: #16a34a; width: 18px; height: 18px; flex-shrink: 0; cursor: pointer; }
        .iso-info { flex: 1; }
        .iso-title { font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; }
        .iso-sub { font-size: 11px; color: #94a3b8; }
        .iso-quand {
            padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px;
            color: #64748b; background: #f8fafc; display: none; cursor: pointer;
        }
        .iso-check:has(input:checked) .iso-quand { display: block; }
        .cee-kpi-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        .cee-kpi {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 12px;
            text-align: center;
        }
        .cee-kpi .kpi-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .cee-kpi .kpi-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e40af;
        }
        .cee-kpi .kpi-value.green { color: #16a34a; }
        .cee-kpi .kpi-detail {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 2px;
            font-family: ui-monospace, monospace;
        }

        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }



        .btn-apply {
            flex: 1;
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-apply:hover {
            background: #0077ed;
        }

        .btn-close-modal {
            background: #f5f5f7;
            color: #1d1d1f;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-close-modal:hover {
            background: #e8e8ed;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 28px;
            padding: 30px 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #1d1d1f;
        }

        .form-group small {
            display: block;
            font-size: 12px;
            color: #86868b;
            margin-top: 4px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 4px rgba(0,113,227,0.1);
        }

        .fournisseur-only {
            display: none;
        }

        .fournisseur-mode .fournisseur-only {
            display: block;
        }
        
        .fournisseur-mode .ttc-readonly {
            display: none !important;
        }

        .client-only {
            display: block;
        }

        .fournisseur-mode .client-only {
            display: none;
        }

        /* Telepro mode: like fournisseur but hides marge, dimensionnement, photo */
        .telepro-mode .fournisseur-only {
            display: block;
        }
        .telepro-mode .ttc-readonly {
            display: none !important;
        }
        .telepro-mode .client-only {
            display: none;
        }
        .telepro-mode .telepro-hide {
            display: none !important;
        }

        .results-sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .summary-card {
            background: linear-gradient(165deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.05);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--scroll-gradient, linear-gradient(90deg, #34d399, #22d3ee, #818cf8));
            transition: background 0.4s ease;
        }

        .result-row-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }
        .result-row-card:hover {
            background: rgba(255,255,255,0.07);
            border-color: rgba(255,255,255,0.12);
            transform: translateY(-1px);
        }
        .result-row-card .rrc-label {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255,255,255,0.55);
            letter-spacing: 0.3px;
        }
        .result-row-card .rrc-value {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            font-variant-numeric: tabular-nums;
        }
        .result-row-card .rrc-value.green { color: #34d399; }
        .result-row-card .rrc-value.yellow { color: #fbbf24; }
        .result-row-card .rrc-value.red { color: #f87171; }
        .result-row-card .rrc-value.cyan { color: #22d3ee; }
        .result-row-card .rrc-value.blue { color: #60a5fa; }

        .result-highlight-card {
            background: linear-gradient(135deg, rgba(52,211,153,0.12) 0%, rgba(34,211,238,0.08) 100%);
            border: 1px solid rgba(52,211,153,0.2);
            border-radius: 14px;
            padding: 18px 22px;
            margin-bottom: 12px;
            text-align: center;
            position: relative;
        }
        .result-highlight-card .rhc-label {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .result-highlight-card .rhc-value {
            font-size: 34px;
            font-weight: 800;
            color: #34d399;
            text-shadow: 0 0 30px rgba(52,211,153,0.3);
        }

        .glow-separator {
            height: 2px;
            margin: 16px 0;
            border-radius: 2px;
            background: var(--scroll-gradient, linear-gradient(90deg, #34d399, #22d3ee, #818cf8));
            opacity: 0.4;
            transition: opacity 0.3s, background 0.6s;
        }
        .glow-separator:hover { opacity: 0.7; }

        .dark-section-title {
            font-size: 11px;
            font-weight: 700;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            padding-left: 2px;
        }

        .scenario-label-dark {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 18px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 3px solid #34d399;
            line-height: 1.5;
            transition: border-color 0.4s;
        }
        .scenario-label-dark strong { font-weight: 600; color: #f1f5f9; }
        .scenario-label-dark .separator { color: rgba(255,255,255,0.3); margin: 0 8px; }

        .rac-dark-section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px;
        }
        .rac-dark-section .amount-label {
            color: rgba(255,255,255,0.45);
        }
        .rac-dark-section input[type="number"] {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            color: #f1f5f9;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        .rac-dark-section input[type="number"]:focus {
            border-color: #34d399;
            box-shadow: 0 0 0 3px rgba(52,211,153,0.15);
            outline: none;
        }
        .rac-dark-section .note-small { color: rgba(255,255,255,0.35); }

        .ttc-input-dark {
            font-size: 26px;
            font-weight: 700;
            text-align: right;
            padding: 0;
            margin: 0;
            width: 150px;
            border: none !important;
            border-radius: 0;
            background: none !important;
            background-color: transparent !important;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
            color: #60a5fa;
            color-scheme: dark;
            font-variant-numeric: tabular-nums;
            font-family: inherit;
            box-shadow: none !important;
        }
        .ttc-input-dark::-webkit-outer-spin-button,
        .ttc-input-dark::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .ttc-input-dark:focus {
            outline: none !important;
            border: none !important;
            box-shadow: none !important;
        }

        .btn-dark-export {
            width: 100%;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
            letter-spacing: 0.3px;
        }
        .btn-dark-export:hover {
            background: rgba(255,255,255,0.12);
            color: white;
            border-color: rgba(255,255,255,0.2);
        }
        .btn-dark-export.pdf { }
        .btn-dark-export.whatsapp { }

        .summary-header {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .scenario-label {
            font-size: 13px;
            color: #1d1d1f;
            margin-bottom: 20px;
            padding: 14px;
            background: #f5f5f7;
            border-radius: 8px;
            border-left: 4px solid #0071e3;
            line-height: 1.5;
        }
        
        .scenario-label strong {
            font-weight: 600;
        }
        
        .scenario-label .separator {
            color: #86868b;
            margin: 0 8px;
        }
        
        .color-bleu { color: #0071e3; }
        .color-jaune { color: #fbbf24; }
        .color-violet { color: #8b5cf6; }
        .color-rose { color: #ec4899; }

        .amount-row {
            margin-bottom: 12px;
        }

        .amount-label {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 4px;
        }

        .amount-value {
            font-size: 26px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .amount-value.highlight {
            color: #34c759;
        }

        .rac-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .rac-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .rac-item input {
            font-size: 22px;
            font-weight: 700;
            color: #1d1d1f;
            text-align: center;
            padding: 8px 10px;
        }

        .final-amount {
            text-align: right;
            padding-top: 20px;
            border-top: 2px solid #f5f5f7;
        }

        .final-amount .amount-label {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 6px;
        }

        .final-amount .amount-value {
            font-size: 34px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .status-badge {
            padding: 18px 24px;
            font-weight: 700;
            font-size: 15px;
            border-radius: 14px;
            text-align: center;
            width: 100%;
            letter-spacing: 0.3px;
            transition: all 0.3s;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .status-badge.ok {
            background: linear-gradient(135deg, #065f46, #059669);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.35);
        }
        .status-badge.ok:hover {
            box-shadow: 0 6px 28px rgba(5, 150, 105, 0.5);
            transform: translateY(-1px);
        }
        .status-badge.ok:active { transform: translateY(0); }
        .status-badge.danger {
            background: linear-gradient(135deg, #7f1d1d, #dc2626);
            color: white;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.25);
        }

        .btn-reset {
            background: #f5f5f7;
            border: 1px solid #e5e7eb;
            padding: 8px;
            border-radius: 8px;
            font-size: 0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-reset:hover {
            background: #e8e8ed;
        }


        .footer {
            text-align: center;
            padding: 8px 20px 8px;
            color: #86868b;
            font-size: 13px;
        }

        @media print {
            #loginScreen, .header, .user-bar, .guest-bar, .btn-reset, .footer, .parameters-section, .main-content, .hist-overlay, #pwdModal {
                display: none !important;
            }
            
            #appScreen {
                display: block !important;
            }

            .tab-pac-active ~ #pacDevisArea,
            body:not(:has(.tab-ite-active)) #pacDevisArea {
                display: block !important;
            }
            body:not(:has(.tab-ite-active)) #printArea {
                display: none !important;
            }
            body:not(:has(.tab-ite-active)) #iteDevisArea {
                display: none !important;
            }
            .tab-ite-active ~ #iteDevisArea,
            body:has(.tab-ite-active) #iteDevisArea {
                display: block !important;
            }
            body:has(.tab-ite-active) #printArea {
                display: none !important;
            }
            body:has(.tab-ite-active) #pacDevisArea {
                display: none !important;
            }

            body {
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            @page {
                margin: 10mm;
                size: A4;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                padding: 16px 10px;
            }

            .results-sidebar {
                position: static;
            }
        }

        .note-small {
            font-size: 11px;
            color: #86868b;
            text-align: center;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        /* ============ MOBILE ============ */
        @media (max-width: 600px) {
            html, body { overflow-x: hidden; }
            .header { padding: 8px 0; }
            .container { padding: 0 8px; }
            .header .container > div:first-child { margin-bottom: 4px; flex-wrap: wrap !important; gap: 8px !important; }
            .tab-buttons { order: 3; flex: 0 0 100%; justify-content: center; }
            .main-content { grid-template-columns: 1fr !important; padding: 8px 4px !important; gap: 10px !important; }
            .user-bar { flex-wrap: wrap; gap: 5px; justify-content: center; }
            .user-bar .user-name { font-size: 11px; }
            .user-bar .user-role { font-size: 9px; padding: 1px 5px; }
            .user-bar .btn-hist, .user-bar .btn-logout { padding: 3px 7px; font-size: 10px; }
            .view-toggle { padding: 2px; width: 100%; }
            .view-toggle .toggle-opt { padding: 4px 8px; font-size: 10px; flex: 1; }
            .guest-bar { justify-content: center; }
            .guest-bar .btn-login-small { padding: 5px 10px; font-size: 11px; }
            .card { padding: 10px; margin-bottom: 10px; }
            .card-title { font-size: 13px; margin-bottom: 10px; }
            .parameters-section { padding: 4px; border-radius: 8px; min-width: 0; overflow-x: hidden; }
            .results-sidebar { padding: 6px; position: static; border-radius: 8px; min-width: 0; }
            .grid-3col { grid-template-columns: 1fr 1fr 1fr !important; gap: 6px !important; }
            .form-group label { font-size: 11px; }
            .form-group input, .form-group select { padding: 7px 8px; font-size: 12px; }
            /* Stack inline grids */
            .dossier-hero [style*="grid-template-columns"],
            #mprCeeWrapper [style*="grid-template-columns"],
            .card [style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
            .dim-row { grid-template-columns: 1fr !important; }
            .rac-grid { grid-template-columns: 1fr !important; }
            .cee-kpi-row { grid-template-columns: 1fr !important; }
            #isoChecklist { grid-template-columns: 1fr !important; }
            .login-box { width: 90% !important; max-width: 340px; padding: 24px !important; box-sizing: border-box; }
            .dossier-hero { padding: 14px 12px !important; }
            .dossier-hero-row { flex-direction: column; }
            .dossier-hero-input { font-size: 14px !important; padding: 10px 12px !important; }
        }
        @media (max-width: 380px) {
            .grid-3col { grid-template-columns: 1fr 1fr !important; }
            .view-toggle .toggle-opt { padding: 3px 6px; font-size: 9px; }
        }

        /* LOGIN SCREEN */
        .login-container { display:flex; align-items:center; justify-content:center; min-height:100vh; background:linear-gradient(135deg, #0f172a 0%, #1e3a5f 40%, #134e4a 100%); padding: 20px; box-sizing: border-box; }
        .login-box { background:white; padding:40px; border-radius:16px; width:360px; max-width:100%; box-shadow:0 20px 60px rgba(0,0,0,0.3); box-sizing:border-box; }
        .login-box h2 { text-align:center; margin:0 0 6px; font-size:20px; }
        .login-box h2 span { color:#16a34a; }
        .login-box .login-sub { text-align:center; color:#6b7280; font-size:13px; margin-bottom:24px; }
        .login-box .form-group { margin-bottom:16px; }
        .login-box .form-group label { display:block; font-size:13px; font-weight:600; color:#374151; margin-bottom:6px; }
        .login-box .form-group input { width:100%; padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; box-sizing:border-box; }
        .login-box .form-group input:focus { border-color:#16a34a; outline:none; box-shadow:0 0 0 3px rgba(22,163,74,0.15); }
        .login-box .btn-login { width:100%; padding:12px; background:linear-gradient(135deg,#16a34a,#15803d); color:white; border:none; border-radius:8px; font-size:15px; font-weight:700; cursor:pointer; }
        .login-box .btn-login:hover { opacity:0.9; }
        .login-error { color:#dc2626; text-align:center; margin-top:12px; font-size:13px; display:none; }
        .login-logo { text-align:center; margin-bottom:20px; }
        .login-logo span { background:linear-gradient(135deg,#16a34a,#15803d); color:white; padding:10px 18px; border-radius:10px; font-weight:700; font-size:14px; display:inline-block; }

        /* USER BAR */
        .user-bar { display:flex; align-items:center; gap:8px; }
        .user-bar .user-name { font-size:12px; color:#6b7280; font-weight:600; }
        .user-bar .user-role { font-size:10px; color:white; background:#16a34a; padding:1px 6px; border-radius:4px; font-weight:600; }
        .user-bar .btn-hist { padding:4px 10px; font-size:11px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:6px; cursor:pointer; font-weight:600; color:#374151; }
        .user-bar .btn-hist:hover { background:#e5e7eb; }
        .user-bar .btn-logout { padding:4px 10px; font-size:11px; background:#fef2f2; border:1px solid #fecaca; border-radius:6px; cursor:pointer; font-weight:600; color:#dc2626; }
        .user-bar .btn-logout:hover { background:#fee2e2; }
        .guest-bar { display:flex; align-items:center; gap:8px; }
        .guest-bar .btn-login-small { padding:6px 14px; font-size:12px; background:linear-gradient(135deg,#16a34a,#15803d); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; }

        /* VIEW TOGGLE SWITCH */
        .view-toggle { display:flex; align-items:center; gap:8px; background:#f3f4f6; border-radius:8px; padding:3px; }
        .view-toggle .toggle-opt { padding:5px 12px; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; color:#6b7280; transition:all 0.2s; border:none; background:none; }
        .view-toggle .toggle-opt.active { background:white; color:#1f2937; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .view-toggle .toggle-opt:hover:not(.active) { color:#374151; }

        /* HISTORY MODAL */
        .hist-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; }
        .hist-overlay.active { display:flex; }
        .hist-modal { background:white; border-radius:14px; width:90%; max-width:500px; max-height:80vh; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .hist-modal-header { padding:16px 20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
        .hist-modal-header h3 { margin:0; font-size:16px; }
        .hist-modal-close { background:none; border:none; font-size:22px; cursor:pointer; color:#6b7280; padding:0 4px; }
        .hist-modal-body { padding:16px 20px; overflow-y:auto; max-height:60vh; }
        .hist-entry { padding:10px 0; border-bottom:1px solid #f3f4f6; }
        .hist-entry:last-child { border-bottom:none; }
        .hist-meta { display:flex; gap:8px; align-items:center; margin-bottom:4px; }
        .hist-date { font-size:11px; color:#9ca3af; }
        .hist-user { font-size:11px; font-weight:700; color:#16a34a; }
        .hist-action { font-size:13px; color:#1f2937; }
        .hist-detail { font-size:11px; color:#6b7280; margin-top:2px; }
        .hist-empty { text-align:center; color:#9ca3af; padding:30px 0; }
        .hist-clear { margin-top:12px; text-align:center; }
        .hist-clear button { font-size:12px; color:#dc2626; background:none; border:1px solid #fecaca; padding:4px 12px; border-radius:6px; cursor:pointer; }

    
/* ============ TAB SYSTEM ============ */
.tab-btn {
    padding: 6px 16px;
    border-radius: 20px;
    border: 1.5px solid #d2d2d7;
    background: #f5f5f7;
    color: #86868b;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}
.tab-btn:hover { background: #e8e8ed; }
.tab-btn.active {
    background: #16a34a;
    color: white;
    border-color: #16a34a;
}
.tab-buttons { display: flex; gap: 6px; margin-right: 12px; }

/* Tab visibility */
.tab-pac-content { display: none; }
.tab-ite-content { display: none; }
.tab-pac-active .tab-pac-content { display: block; }
.tab-ite-active .tab-ite-content { display: block; }
/* For grid layouts in sidebar */
.tab-pac-active .tab-pac-content.sidebar-grid { display: block; }
.tab-ite-active .tab-ite-content.sidebar-grid { display: block; }
/* Hide MPR result bloc in ITE mode */
.tab-ite-active #mprResultBloc { display: none !important; }

/* ============ ITE CARDS (light theme) ============ */
.ite-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.08);
    margin-bottom: 16px;
}
.ite-card-head {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    flex-wrap: wrap;
}
.ite-card-icon {
    font-size: 20px;
    width: 36px; height: 36px;
    background: rgba(22,163,74,0.08);
    border-radius: 10px;
    display: grid; place-items: center;
}
.ite-card-head h3 {
    font-size: 14px;
    font-weight: 700;
    color: #1d1d1f;
}
.ite-card-head .ite-tag {
    font-size: 9px;
    background: rgba(249,115,22,0.12);
    color: #f97316;
    padding: 3px 8px;
    border-radius: 12px;
    font-weight: 700;
    text-transform: uppercase;
    margin-left: auto;
}
.ite-card-head .ite-tag-auto {
    background: rgba(22,163,74,0.08);
    color: #16a34a;
}
.ite-fg {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}
.ite-fg.c3 { grid-template-columns: 1fr 1fr 1fr; }
.ite-fi {
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.ite-fi.full { grid-column: 1 / -1; }
.ite-fi label {
    font-size: 11px;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.4px;
}
.ite-fi input, .ite-fi select {
    width: 100%;
    padding: 9px 12px;
    border: 1px solid #d2d2d7;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    color: #1d1d1f;
    transition: border-color 0.2s;
}
.ite-fi input:focus, .ite-fi select:focus {
    outline: none;
    border-color: #16a34a;
    box-shadow: 0 0 0 3px rgba(22,163,74,0.1);
}
.ite-note { font-size: 11px; color: #86868b; margin-bottom: 12px; line-height: 1.5; }

/* ITE KPI row */
.ite-kpi-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 10px;
    margin-bottom: 14px;
}
.ite-kpi {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 14px;
    text-align: center;
}
.ite-kpi-icon { font-size: 18px; margin-bottom: 4px; }
.ite-kpi-val { font-size: 16px; font-weight: 800; color: #16a34a; }
.ite-kpi-val.red { color: #dc2626; }
.ite-kpi-label { font-size: 10px; color: #64748b; margin-top: 2px; }

/* ITE CEE table */
.ite-cee-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    font-size: 12px;
}
.ite-cee-table th {
    background: rgba(22,163,74,0.08);
    color: #16a34a;
    padding: 8px 10px;
    text-align: left;
    font-weight: 700;
    font-size: 10px;
    text-transform: uppercase;
}
.ite-cee-table td {
    padding: 8px 10px;
    border-bottom: 1px solid #e2e8f0;
}
.ite-cee-table tr.active {
    background: rgba(22,163,74,0.04);
    border-left: 3px solid #16a34a;
}
.ite-cee-table .val {
    font-weight: 700;
    color: #16a34a;
    text-align: right;
}

/* ITE alerts */
.ite-alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin: 10px 0;
    font-size: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}
.ite-alert-ok { background: #f0fdf4; border: 1px solid #bbf7d0; color: #16a34a; }
.ite-alert-warn { background: #fef2f2; border: 1px solid #fecaca; color: #dc2626; }
.ite-alert-ptz { background: #eff6ff; border: 1px solid #bfdbfe; color: #2563eb; }

/* ITE search row */
.ite-search-row {
    display: flex;
    gap: 8px;
    align-items: flex-end;
}
.ite-search-row .ite-fi { flex: 1; }
.ite-btn-search {
    padding: 9px 16px;
    border-radius: 8px;
    background: #0071e3;
    color: white;
    font-size: 12px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    height: 39px;
    transition: background 0.2s;
}
.ite-btn-search:hover { background: #0077ed; }
.ite-search-status {
    font-size: 11px;
    margin-top: 6px;
    padding: 6px 10px;
    border-radius: 6px;
    display: none;
}
.ite-search-status.ok { display: block; background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
.ite-search-status.err { display: block; background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
.ite-search-status.loading { display: block; background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }

/* === HERO RECHERCHE DOSSIER === */
.dossier-hero {
    background: linear-gradient(135deg, #0f172a 0%, #1a2e4a 50%, #0d3321 100%);
    border-radius: 14px;
    padding: 22px 20px 18px;
    margin-bottom: 18px;
    position: relative;
    overflow: hidden;
}
.dossier-hero::before {
    content: '';
    position: absolute;
    top: -30px; right: -30px;
    width: 120px; height: 120px;
    background: radial-gradient(circle, rgba(52,211,153,0.12) 0%, transparent 70%);
    border-radius: 50%;
}
.dossier-hero-label {
    font-size: 10px;
    font-weight: 700;
    color: rgba(255,255,255,0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
}
.dossier-hero-title {
    font-size: 16px;
    font-weight: 800;
    color: white;
    margin-bottom: 2px;
}
.dossier-hero-sub {
    font-size: 11px;
    color: rgba(255,255,255,0.35);
    margin-bottom: 14px;
}
.dossier-hero-row {
    display: flex;
    gap: 8px;
    align-items: stretch;
}
.dossier-hero-input {
    flex: 1;
    padding: 13px 16px;
    border: 1.5px solid rgba(255,255,255,0.12) !important;
    border-radius: 10px;
    background: rgba(255,255,255,0.07) !important;
    background-color: rgba(255,255,255,0.07) !important;
    color: white !important;
    font-size: 17px;
    font-weight: 700;
    letter-spacing: 1.5px;
    font-family: ui-monospace, 'SF Mono', monospace;
    transition: all 0.2s;
}
.dossier-hero-input::placeholder { color: rgba(255,255,255,0.2); }
.dossier-hero-input:focus {
    outline: none;
    border-color: #34d399;
    background: rgba(52,211,153,0.07);
    box-shadow: 0 0 0 3px rgba(52,211,153,0.12);
}
.dossier-hero-btn {
    padding: 13px 20px;
    border-radius: 10px;
    background: linear-gradient(135deg, #16a34a, #15803d);
    color: white;
    font-size: 13px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    box-shadow: 0 2px 10px rgba(22,163,74,0.4);
}
.dossier-hero-btn:hover {
    background: linear-gradient(135deg, #15803d, #14532d);
    transform: translateY(-1px);
    box-shadow: 0 4px 14px rgba(22,163,74,0.5);
}
.dossier-hero-btn:active { transform: translateY(0); }
.dossier-hero-status {
    margin-top: 10px;
    font-size: 12px;
    font-weight: 600;
    padding: 8px 12px;
    border-radius: 8px;
    display: none;
}
.dossier-hero-status.ok {
    display: block;
    background: rgba(52,211,153,0.12);
    color: #34d399;
    border: 1px solid rgba(52,211,153,0.25);
}
.dossier-hero-status.err {
    display: block;
    background: rgba(239,68,68,0.1);
    color: #f87171;
    border: 1px solid rgba(239,68,68,0.2);
}
.dossier-hero-status.loading {
    display: block;
    background: rgba(96,165,250,0.1);
    color: #60a5fa;
    border: 1px solid rgba(96,165,250,0.2);
}
/* Champs du hero en dark */
.dossier-hero .form-group label {
    color: rgba(255,255,255,0.55);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.4px;
}
.dossier-hero .form-group input,
.dossier-hero .form-group select {
    background: rgba(255,255,255,0.07) !important;
    background-color: rgba(255,255,255,0.07) !important;
    color: white !important;
    border: 1px solid rgba(255,255,255,0.12) !important;
    border-radius: 8px;
}
.dossier-hero .form-group input::placeholder { color: rgba(255,255,255,0.25) !important; }
.dossier-hero .form-group input:focus,
.dossier-hero .form-group select:focus {
    border-color: #34d399 !important;
    outline: none;
    box-shadow: 0 0 0 2px rgba(52,211,153,0.15) !important;
}
.dossier-hero .form-group select option { background: #1e293b; color: white; }
.dossier-hero-divider {
    border: none;
    border-top: 1px solid rgba(255,255,255,0.1);
    margin: 16px 0;
}
/* Picker doublons */
.dossier-picker-title {
    font-size: 11px;
    font-weight: 700;
    color: rgba(255,255,255,0.45);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 8px;
}
.dossier-picker-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    cursor: pointer;
    transition: all 0.15s ease;
    margin-bottom: 6px;
}
.dossier-picker-item:hover {
    background: rgba(52,211,153,0.12);
    border-color: rgba(52,211,153,0.3);
}
.dossier-picker-num {
    font-size: 12px;
    font-weight: 800;
    color: #34d399;
    font-family: ui-monospace, monospace;
    white-space: nowrap;
}
.dossier-picker-name {
    font-size: 13px;
    font-weight: 600;
    color: white;
    flex: 1;
}
.dossier-picker-tel {
    font-size: 11px;
    color: rgba(255,255,255,0.4);
    white-space: nowrap;
}
/* Statut de recherche Ã  l'intÃ©rieur du hero */
.dossier-hero .ite-search-status {
    background: rgba(52,211,153,0.12) !important;
    color: #34d399 !important;
    border: 1px solid rgba(52,211,153,0.25) !important;
}
.dossier-hero .ite-search-status.err {
    background: rgba(239,68,68,0.1) !important;
    color: #f87171 !important;
    border-color: rgba(239,68,68,0.2) !important;
}
.dossier-hero .ite-search-status.loading {
    background: rgba(96,165,250,0.1) !important;
    color: #60a5fa !important;
    border-color: rgba(96,165,250,0.2) !important;
}

/* ITE QR block */
.ite-qr-block {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 10px 14px;
}
.ite-qr-label { font-size: 10px; color: #64748b; line-height: 1.4; }
.ite-qr-label b { color: #2563eb; }

/* ITE devis print styles */
.ite-page { width: 210mm; min-height: 297mm; margin: 20px auto; padding: 10mm 12mm 20mm; background: #fff; position: relative; font-family: Arial, Helvetica, sans-serif; font-size: 8.5pt; color: #111; line-height: 1.45; }
.ite-page .dv-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6mm; }
.ite-page .dv-title { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 2mm; margin-bottom: 3mm; }
.ite-page .dv-title span { font-size: 12pt; font-weight: 900; }
.ite-page .dv-info { display: grid; grid-template-columns: 1fr 1fr; gap: 0 6mm; margin-bottom: 4mm; font-size: 8pt; line-height: 1.6; }
.ite-page .dv-th { display: grid; grid-template-columns: 1fr 50px 72px 72px 48px; border-bottom: 2px solid #000; padding: 2mm 0 1mm; margin-bottom: 2mm; }
.ite-page .dv-th div { font-size: 10pt; font-weight: 900; }
.ite-page .dv-th .r { text-align: right; }
.ite-page .dv-th .c { text-align: center; }
.ite-page .dv-block { margin-bottom: 3mm; font-size: 8pt; line-height: 1.55; }
.ite-page .dv-row { display: grid; grid-template-columns: 1fr 50px 72px 72px 48px; border-top: 1.5px solid #333; border-bottom: 1.5px solid #333; padding: 1.5mm 0; margin: 2mm 0 1mm; }
.ite-page .dv-row div { font-size: 8pt; }
.ite-page .dv-row .n { font-weight: 700; }
.ite-page .dv-row .r { text-align: right; font-weight: 600; }
.ite-page .dv-row .c { text-align: center; }
.ite-page .dv-specs { font-size: 7.5pt; line-height: 1.55; margin-bottom: 3mm; padding-left: 2mm; }
.ite-page .dv-cond { font-size: 7.5pt; line-height: 1.5; margin-bottom: 3mm; border: 2px solid #c00; border-radius: 2px; padding: 3mm; }
.ite-page .dv-cond h4 { font-weight: 700; font-size: 8pt; margin-bottom: 1mm; }
.ite-page .dv-totaux { display: flex; gap: 6mm; margin-top: 4mm; }
.ite-page .dv-sig { border: 1px solid #999; padding: 4mm; font-size: 7.5pt; flex: 1; min-height: 32mm; }
.ite-page .dv-tt { font-size: 8pt; min-width: 200px; border-collapse: collapse; }
.ite-page .dv-tt td { padding: 1.5px 4px; }
.ite-page .dv-tt td:last-child { text-align: right; font-weight: 600; }
.ite-page .dv-tt .ttc td { font-size: 10pt; font-weight: 900; border-top: 1px solid #333; padding-top: 3px; }
.ite-page .dv-tt .reste td { color: #8b2252; font-size: 10pt; font-weight: 900; font-style: italic; border-top: 1px solid #8b2252; padding-top: 3px; }
.ite-page .dv-footer { position: absolute; bottom: 5mm; left: 12mm; right: 12mm; border-top: 1px solid #ccc; padding-top: 1.5mm; font-size: 5pt; color: #444; text-align: center; line-height: 1.4; }
.ite-page .dv-pn { position: absolute; right: 0; bottom: 0; font-weight: 700; font-size: 9pt; }
.ite-page .dv-legal { font-size: 6.5pt; line-height: 1.45; color: #333; margin-top: 4mm; border: 2px solid #c00; border-radius: 2px; padding: 3mm; }
.ite-page .dv-finance { font-size: 8pt; line-height: 1.6; margin-top: 4mm; }

/* PTZ Document Styles - Official CERFA Eco-PTZ */
.ite-page.cerfa { font-family: Arial, Helvetica, sans-serif; font-size: 8.5pt; color: #111; line-height: 1.5; }
.ite-page .ptz-sig-block { border: 1px solid #999; padding: 4mm; min-height: 28mm; font-size: 7.5pt; line-height: 1.5; position: relative; }
.ite-page .sig-canvas-area { width: 100%; height: 18mm; border: 1px dashed #cbd5e1; border-radius: 4px; margin-top: 2mm; background: #fafafa; }

/* E-Signature Modal */
.esign-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 100000; display: flex; align-items: center; justify-content: center; animation: esignFadeIn 0.3s ease; }
@keyframes esignFadeIn { from { opacity: 0; } to { opacity: 1; } }
.esign-modal { background: white; border-radius: 16px; width: 95%; max-width: 540px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.esign-header { padding: 20px 24px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; }
.esign-header h3 { font-size: 18px; font-weight: 800; color: #111827; margin: 0; }
.esign-close { width: 36px; height: 36px; border-radius: 50%; border: none; background: #f3f4f6; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; color: #6b7280; transition: all 0.2s; }
.esign-close:hover { background: #e5e7eb; color: #111; }
.esign-body { padding: 24px; }
.esign-step { margin-bottom: 20px; }
.esign-step-label { font-size: 12px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
.esign-step-title { font-size: 15px; font-weight: 700; color: #111827; margin-bottom: 12px; }
.esign-canvas-wrap { border: 2px solid #d1d5db; border-radius: 12px; overflow: hidden; background: #fafafa; position: relative; }
.esign-canvas-wrap.active { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
.esign-canvas { width: 100%; height: 150px; cursor: crosshair; touch-action: none; }
.esign-canvas-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #9ca3af; font-size: 14px; pointer-events: none; }
.esign-clear-btn { margin-top: 8px; padding: 6px 14px; border-radius: 8px; border: 1px solid #d1d5db; background: white; color: #374151; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.esign-clear-btn:hover { background: #f9fafb; border-color: #9ca3af; }
.esign-info { font-size: 12px; color: #6b7280; line-height: 1.5; margin-top: 6px; }
.esign-footer { padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 10px; justify-content: flex-end; }
.esign-btn { padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.2s; border: none; }
.esign-btn-cancel { background: #f3f4f6; color: #374151; }
.esign-btn-cancel:hover { background: #e5e7eb; }
.esign-btn-sign { background: linear-gradient(135deg, #1e40af, #3b82f6); color: white; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
.esign-btn-sign:hover { box-shadow: 0 6px 16px rgba(59,130,246,0.4); transform: translateY(-1px); }
.esign-btn-sign:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
.esign-status { display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; margin-top: 12px; }
.esign-status.pending { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
.esign-status.signed { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
.esign-sent-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
.esign-sent-badge.sent { background: #dbeafe; color: #1e40af; }
.esign-sent-badge.signed { background: #d1fae5; color: #065f46; }

/* Print: updated for tab system */
@media print {
    .tab-pac-active #pacDevisArea { display: block !important; }
    .tab-pac-active #printArea { display: none !important; }
    .tab-pac-active #iteDevisArea { display: none !important; }
    .tab-ite-active #iteDevisArea { display: block !important; }
    .tab-ite-active #printArea { display: none !important; }
    .tab-ite-active #pacDevisArea { display: none !important; }
}

/* Shared client card */
.shared-client-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.08);
    margin-bottom: 16px;
}
@media (max-width: 700px) {
    .ite-fg { grid-template-columns: 1fr; }
    .ite-fg.c3 { grid-template-columns: 1fr; }
    .ite-kpi-row { grid-template-columns: 1fr 1fr; gap: 8px; }
    .ite-kpi { padding: 10px; }
    .ite-kpi-val { font-size: 14px; }
    .ite-search-row { flex-direction: column; }
    .ite-btn-search { width: 100%; }
    .ite-qr-block { flex-direction: column; text-align: center; }
    .ite-card { padding: 10px; margin-bottom: 10px; overflow: hidden; }
    .ite-card-head { gap: 8px; margin-bottom: 10px; }
    .ite-card-head h3 { font-size: 13px; }
    .ite-card-head .ite-tag { margin-left: 0; font-size: 8px; }
    .ite-cee-table { font-size: 11px; display: block; overflow-x: auto; }
    .ite-fi input, .ite-fi select { font-size: 13px; padding: 8px 10px; }
    .ite-fi label { font-size: 10px; }
    .ite-alert { font-size: 11px; padding: 8px 10px; }
    .shared-client-card { padding: 10px; }
    .ttc-input-dark { width: 100% !important; font-size: 20px; }
}

    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.2/html2pdf.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js" crossorigin="anonymous"></script>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-container">
    <div class="login-box">
        <div class="login-logo"><span>&#127968; LES ARTISANS VERTS</span></div>
        <h2>Simulateur <span>PAC 2026</span></h2>
        <p class="login-sub">Connexion commerciale</p>
        <div class="form-group"><label>Nom d'utilisateur</label><input type="text" id="loginUser" placeholder="Utilisateur" autofocus></div>
        <div class="form-group"><label>Mot de passe</label><input type="password" id="loginPass" placeholder="Mot de passe"></div>
        <button class="btn-login" onclick="doLogin()">Se connecter</button>
        <p id="loginError" class="login-error"></p>
        <div style="margin-top:20px;padding-top:18px;border-top:1px solid #e5e7eb;text-align:center;">
            <p style="color:#9ca3af;font-size:12px;margin-bottom:10px;">Pas de compte ?</p>
            <button onclick="doGuestLogin()" style="width:100%;padding:11px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">&#128100; Continuer en vue client</button>
        </div>
    </div>
</div>

<!-- HISTORY MODAL -->
<div id="historyModal" class="hist-overlay" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="hist-modal">
        <div class="hist-modal-header">
            <h3>&#128203; Journal des modifications</h3>
            <button class="hist-modal-close" onclick="document.getElementById('historyModal').classList.remove('active')">&times;</button>
        </div>
        <div class="hist-modal-body" id="historyBody"></div>
    </div>
</div>

<!-- PASSWORD CHANGE MODAL -->
<div id="pwdModal" class="hist-overlay" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="hist-modal" style="max-width:380px;">
        <div class="hist-modal-header">
            <h3>&#128273; Changer mon mot de passe</h3>
            <button class="hist-modal-close" onclick="document.getElementById('pwdModal').classList.remove('active')">&times;</button>
        </div>
        <div class="hist-modal-body">
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;">Ancien mot de passe</label>
                <input type="password" id="pwdOld" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;">Nouveau mot de passe</label>
                <input type="password" id="pwdNew" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;">Confirmer</label>
                <input type="password" id="pwdConfirm" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
            </div>
            <button onclick="doChangePassword()" style="width:100%;padding:12px;background:linear-gradient(135deg,#16a34a,#15803d);color:white;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;">Modifier</button>
            <p id="pwdError" style="color:#dc2626;text-align:center;margin-top:10px;font-size:13px;display:none;"></p>
            <p id="pwdSuccess" style="color:#16a34a;text-align:center;margin-top:10px;font-size:13px;display:none;"></p>
        </div>
    </div>
</div>

<!-- DOSSIERS MODAL -->
<div id="dossiersModal" class="hist-overlay" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="hist-modal" style="max-width:600px;max-height:85vh;">
        <div class="hist-modal-header">
            <h3>&#128194; Mes dossiers</h3>
            <button class="hist-modal-close" onclick="document.getElementById('dossiersModal').classList.remove('active')">&times;</button>
        </div>
        <div style="padding:10px 16px 0;">
            <input type="text" id="dossierSearch" placeholder="&#128269; Rechercher par nom, n&deg; devis ou commercial..." oninput="filterDossiers()" style="width:100%;padding:10px 14px;border:1px solid #d1d5db;border-radius:8px;font-size:13px;box-sizing:border-box;">
        </div>
        <div class="hist-modal-body" id="dossiersBody" style="max-height:60vh;overflow-y:auto;"></div>
    </div>
</div>

<!-- APP (hidden until login) -->
<div id="appScreen" style="display:none;">
    <div class="header">
        <div class="container">
            <!-- Row 1: Logo + Title + Refresh -->
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="background:linear-gradient(135deg,#16a34a,#15803d); color:white; padding:8px 12px; border-radius:8px; font-weight:700; font-size:13px; letter-spacing:0.3px; box-shadow:0 2px 8px rgba(22,163,74,0.3);">&#127968; LAV</div>
                    <div style="font-size:16px; font-weight:700; color:#1d1d1f; line-height:1.2;">Simulateur <span style="font-size:11px; background:#16a34a; color:white; padding:1px 6px; border-radius:4px; vertical-align:middle;">2026</span></div>
                </div>
                <div class="tab-buttons">
                    <button class="tab-btn active" id="tabPAC" onclick="switchTab('pac')">PAC</button>
                    <button class="tab-btn" id="tabITE" onclick="switchTab('ite')">ITE</button>
                </div>
                <button class="btn-reset" onclick="reset()" title="RafraÃ®chir"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></button>
            </div>
            <!-- Row 2: User controls -->
            <!-- GUEST BAR -->
            <div class="guest-bar" id="guestBar" style="display:none;">
                <button class="btn-login-small" onclick="goToLogin()">&#128273; Se connecter</button>
            </div>
            <!-- USER BAR -->
            <div class="user-bar" id="userBar" style="display:none;">
                <span class="user-name" id="userNameDisplay">&mdash;</span>
                <span class="user-role" id="userRoleDisplay">&mdash;</span>
                <div class="view-toggle" id="viewToggle">
                    <button class="toggle-opt active" id="togClient" onclick="switchView('client')">&#128100; Client</button>
                    <button class="toggle-opt" id="togTelepro" onclick="switchView('telepro')">&#128222; Telepro</button>
                    <button class="toggle-opt" id="togFournisseur" onclick="switchView('fournisseur')">&#128202; Pro</button>
                </div>
                <button class="btn-hist" id="btnDossiers" onclick="openDossiers()" style="display:none;">&#128194;</button>
                <button class="btn-hist" id="btnHistory" onclick="openHistory()" style="display:none;">&#128203;</button>
                <button class="btn-hist" id="btnPwd" onclick="openPwdModal()" style="display:none;">&#128273;</button>
                <button class="btn-logout" onclick="doLogout()">&#8618;</button>
            </div>
        </div>
    </div>

    <div class="main-content tab-pac-active" id="mainContent">
        <div class="parameters-section">
            <div class="card">
                <h2 class="card-title">Param&egrave;tres</h2>

                <!-- ===== HERO RECHERCHE DOSSIER ===== -->
                <div class="dossier-hero">
                    <div class="dossier-hero-label">&#128194; Informations client</div>
                    <div class="dossier-hero-title">Informations client</div>
                    <div class="dossier-hero-sub">Saisissez un t&eacute;l ou un n&deg; de dossier</div>
                    <div class="dossier-hero-row">
                        <input
                            id="iteNumClient"
                            class="dossier-hero-input"
                            type="text"
                            value=""
                            placeholder="AVR-202XX ou 06..."
                            autocomplete="off"
                            spellcheck="false"
                            onkeydown="if(event.key==='Enter'){event.preventDefault();ite_searchClient();}"
                        >
                        <button id="iteBtnSearch" class="dossier-hero-btn" onclick="ite_searchClient()">&#128269;&nbsp;Chercher</button>
                    </div>
                    <div id="iteSearchStatus" class="ite-search-status" style="margin-top:10px;"></div>
                    <!-- Picker doublons -->
                    <div id="dossierPickerList" style="display:none;margin-top:10px;"></div>

                    <!-- Champs client (PAC + ITE) -->
                    <div style="margin-top:16px;">
                        <hr class="dossier-hero-divider">
                        <!-- Nom + PrÃ©nom en premier -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Nom</label>
                                <input type="text" id="nom" placeholder="Nom du client" oninput="checkExport()" onchange="logClientChange()">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Pr&eacute;nom</label>
                                <input type="text" id="prenom" placeholder="Pr&eacute;nom du client" oninput="checkExport()" onchange="logClientChange()">
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Adresse travaux</label>
                                <input type="text" id="iteAdresse" placeholder="123 rue...">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>CP + Ville</label>
                                <input type="text" id="iteVille" placeholder="75000 Paris">
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label>T&eacute;l&eacute;phone</label>
                                <input type="text" id="iteTel" placeholder="06...">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>E-mail</label>
                                <input type="text" id="iteEmail" placeholder="client@email.com">
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label>N&deg; Devis</label>
                                <input type="text" id="iteNumDevis" value="AVR-2026-">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Date</label>
                                <input type="date" id="iteDateDevis" value="2026-02-26">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Commercial</label>
                                <select id="iteConseiller"><option value="">&mdash; S&eacute;lectionner &mdash;</option></select>
                            </div>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Chauffage actuel</label>
                                <select id="iteTypeChauffage">
                                        <option value="Gaz">Gaz naturel</option>
                                        <option value="Fioul">Fioul</option>
                                        <option value="Ã‰lectrique">Ã‰lectrique</option>
                                        <option value="Bois">Bois / GranulÃ©s</option>
                                        <option value="PAC">Pompe Ã  chaleur</option>
                                        <option value="Autre">Autre</option>
                                    </select>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Pr&eacute;carit&eacute; CEE (auto)</label>
                                <select id="itePrecarite" onchange="ite_calc()">
                                    <option value="classique">Classique</option>
                                    <option value="modeste">Modeste</option>
                                    <option value="grande">Grande pr&eacute;carit&eacute;</option>
                                </select>
                            </div>
                        </div>
                        <!-- DÃ©partement + Surface + RFR + Foyer -->
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="departement">D&eacute;partement</label>
                                <input type="text" id="departement" placeholder="Ex: 33, 75&hellip;" maxlength="3" style="text-align:center;font-weight:600;" oninput="detectDept()">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="surfaceClient">Surface (m&sup2;)</label>
                                <input type="number" id="surfaceClient" placeholder="Ex: 95" min="1" style="font-weight:600;" oninput="syncSurfaceFromClient()">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="rfr">Revenu fiscal (&euro;)</label>
                                <input type="number" id="rfr" placeholder="Ex: 35 000" oninput="detectProfil()" style="font-weight:600;">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label for="nbPersonnes">Foyer</label>
                                <select id="nbPersonnes" onchange="detectProfil()">
                                    <option value="1">1 pers.</option>
                                    <option value="2">2 pers.</option>
                                    <option value="3">3 pers.</option>
                                    <option value="4" selected>4 pers.</option>
                                    <option value="5">5 pers.</option>
                                    <option value="6">6 pers.</option>
                                    <option value="7">7 pers.</option>
                                    <option value="8">8 pers.</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hidden: auto-gÃ©rÃ©s -->
                <select id="zone" onchange="calc()" style="display:none;">
                    <option value="H1">H1</option><option value="H2">H2</option><option value="H3">H3</option>
                </select>
                <span id="deptZoneResult" style="display:none;"></span>
                <select id="region" onchange="detectProfil()" style="display:none;">
                    <option value="PROVINCE">Province</option><option value="IDF">IDF</option>
                </select>
                <input type="hidden" id="typeLogement" value="maison">
                <select id="surface" style="display:none;">
                    <option value="S<70">S &lt; 70 mÂ²</option>
                    <option value="70<=S<90">70 &le; S &lt; 90 mÂ²</option>
                    <option value="S>=90" selected>S &ge; 90 mÂ²</option>
                </select>
                <select id="categorie" style="display:none;">
                    <option value="BLEU">BLEU</option><option value="JAUNE">JAUNE</option>
                    <option value="VIOLET">VIOLET</option><option value="ROSE">ROSE</option>
                </select>

                <!-- ===== BLOC RÃ‰SULTAT MPR + CEE (MPR masquÃ©) ===== -->
                <div id="mprCeeWrapper" style="margin-top: 14px; border-radius: 14px; padding: 20px; background: linear-gradient(160deg, #0f172a 0%, #1e3a5f 40%, #134e4a 100%); color: white;">

                <!-- Bloc rÃ©sultat MPR â€” masquÃ© -->
                <div id="mprResultBloc" style="display: none !important;">
                    <div id="mprProfilIcon"></div>
                    <div id="mprProfilLabel"></div>
                    <div id="mprProfilDesc"></div>
                    <div id="mprInfoRegion"></div>
                    <div id="mprInfoFoyer"></div>
                    <div id="mprInfoSeuil"></div>
                    <div id="mprInfoRFR"></div>
                    <div id="mprInfoAide"></div>
                </div>

                

            </div><!-- end shared client card -->

            <!-- ===== PAC-SPECIFIC PARAMETERS (hidden â€” calc fields only) ===== -->
            <div class="tab-pac-content" style="display:none;">
            <div class="card">
                <h2 class="card-title">&#9889; Aides CEE</h2>
<!-- Scenario & ETAS hidden (auto-derived from Produit & Options) -->
                <div style="display:none;">
                    <select id="scenario" onchange="onScenarioChange()">
                        <option value="PAC">PAC</option>
                        <option value="PAC + BALLON Ã‰LECTRIQUE">PAC + BALLON Ã‰LECTRIQUE</option>
                        <option value="PAC + BALLON THERMO">PAC + BALLON THERMO</option>
                        <option value="PAC + SSC">PAC + SSC</option>
                        <option value="SSC">SSC</option>
                    </select>
                    <select id="etas" onchange="syncEtas(); calc()">
                        <option value="111-140">111 &lt; ETAS &lt; 140</option>
                        <option value="140-170" selected>140 &lt; ETAS &lt; 170</option>
                    </select>
                    <div id="etasGroup"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div class="form-group" style="margin-bottom: 0;" id="ceeSurfaceGroup">
                        <label style="color: rgba(255,255,255,0.7);">Surface chauffÃ©e (mÂ²)</label>
                        <input type="number" id="ceeSurface" min="1" step="1" value="95" oninput="syncSurfaces('cee')">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="color: rgba(255,255,255,0.7);">ScÃ©nario auto</label>
                        <input type="text" id="scenarioAutoDisplay" disabled value="PAC" style="background: rgba(255,255,255,0.05); color: #fbbf24; font-weight: 600; border: 1px solid rgba(255,255,255,0.1);">
                    </div>
                </div>

                <!-- Fiches info (hidden) -->
                <div style="display:none;">
                    Fiches : <strong id="ceeFichesLabel">BAR-TH-171</strong>
                    <span id="ceeNonCumulNote"></span>
                </div>

                <!-- Hidden fields for JS -->
                <span id="ceeScenarioLabel" style="display:none;">PAC</span>
                <select id="ficheCEE" style="display:none;" onchange="toggleCEEBlocs(); calcCEEDetail();">
                    <option value="171">BAR-TH-171</option>
                    <option value="143">BAR-TH-143</option>
                    <option value="148">BAR-TH-148</option>
                </select>
                <select id="ceeEtas" style="display:none;">
                    <option value="lt140">lt140</option>
                    <option value="ge140" selected>ge140</option>
                </select>
                <div style="display:none;">
                    <select id="menageCEE" onchange="calcCEEDetail()">
                        <option value="tm">TrÃ¨s modestes (12,5 &euro;/MWhc)</option>
                        <option value="autres">Autres mÃ©nages (7,5 &euro;/MWhc)</option>
                    </select>
                    <input type="text" id="ceeCoefSurface" disabled value="&mdash;">
                    <div id="ceeSurfaceInfo"></div>
                </div>

                <!-- KPI CEE -->
                <div class="cee-kpi-row" style="grid-template-columns: 1fr 1fr; margin-top: 4px;">
                    <div class="cee-kpi" style="background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.6);">Volume CEE</div>
                        <div class="kpi-value" id="ceeOutKwhc" style="color: #fbbf24;">&mdash;</div>
                    </div>
                    <div class="cee-kpi" style="background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.6);">Prime CEE</div>
                        <div class="kpi-value" id="ceeOutPrime" style="color: #34d399;">&mdash;</div>
                    </div>
                </div>
                <!-- DÃ©tail fournisseur -->
                <div class="fournisseur-only" style="margin-top: 4px; font-size: 11px; color: rgba(255,255,255,0.4); font-family: ui-monospace, monospace;">
                    <span id="ceeOutDetail">&mdash;</span> Â· <span id="ceeOutPrix">&mdash;</span>
                </div>

                </div><!-- /mprCeeWrapper -->

                <!-- Blocs fournisseur dÃ©tail -->
                <div class="fournisseur-only">
                    <div class="cee-bloc-171" id="ceeBloc171" style="display:none;"></div>
                    <div class="cee-bloc-148 cee-hidden" id="ceeBloc148" style="margin-top: 8px;">
                        <div class="cee-grid">
                            <div>
                                <label>Forfait BAR-TH-148 (kWhc)</label>
                                <input type="number" id="ceeKwhc148" min="0" step="100" value="9000" oninput="calcCEEDetail()">
                            </div>
                            <div>
                                <label>Forfait calculÃ©</label>
                                <input type="text" id="cee148Forfait" disabled value="&mdash;" style="background: #f1f5f9; font-weight: 600;">
                            </div>
                            <div>
                                <label>Note interne</label>
                                <input type="text" id="ceeNote148" placeholder="COP, volume ballon, marque..." oninput="calcCEEDetail()">
                            </div>
                        </div>
                    </div>
                    <div id="ceeBloc143" class="cee-hidden" style="margin-top: 8px;">
                        <div style="font-size: 12px; font-weight: 600; color: #2563eb; margin-bottom: 8px;">&#128217; BAR-TH-143 &mdash; SSC Â· <span style="color: #059669;">Coup de pouce &times;2</span></div>
                        <div class="cee-grid">
                            <div>
                                <label>Forfait par zone</label>
                                <input type="text" id="cee143Forfait" disabled value="&mdash;" style="background: #f1f5f9; font-weight: 600;">
                                <div class="cee-hint">H1: 134 800 Â· H2: 121 000 Â· H3: 100 500 kWhc</div>
                            </div>
                        </div>
                    </div>
                    <div class="cee-kpi-row" style="grid-template-columns: 1fr; margin-top: 8px;">
                        <div class="cee-kpi" id="ceeKpi148" style="display:none;">
                            <div class="kpi-label">Dont BAR-TH-148</div>
                            <div class="kpi-value" id="ceeOut148" style="color: #059669;">&mdash;</div>
                            <div class="kpi-detail" id="ceeOut148Detail">&mdash;</div>
                        </div>
                    </div>
                    <div class="cee-result" id="ceeResult"></div>
                </div>

                <div id="calcErrorDebug" style="color: red; font-size: 12px; font-weight: 600; margin-top: 8px; padding: 6px; background: #fef2f2; border-radius: 6px;"></div>
            </div>
            </div><!-- end tab-pac-content for params -->

            <!-- ===================== PRODUIT & OPTIONS ===================== -->
            <div class="tab-pac-content">
            <div class="card" id="produitCard">
                <h2 class="card-title">&#9881;&#65039; Produit & Options</h2>

                <!-- PAC Air/Eau -->
                <div class="produit-bloc">
                    <div class="produit-bloc-head">
                        <span class="produit-bloc-icon">&#9881;&#65039;</span>
                        <span class="produit-bloc-title">Pompe &agrave; Chaleur Air/Eau</span>
                    </div>
                    <div class="form-group" style="margin-bottom: 10px;">
                        <label>Mod&egrave;le PAC</label>
                        <select id="marquePAC" onchange="updatePAC();syncEtasFromPAC();calc();calcCEEDetail()">
                            <option value="">-- S&eacute;lectionner un mod&egrave;le --</option>
                            <optgroup label="THALEOS Mono">
                                <option value="THALEOS_04M">THALEOS 4kW Mono</option>
                                <option value="THALEOS_06M">THALEOS 6kW Mono</option>
                                <option value="THALEOS_08M">THALEOS 8kW Mono</option>
                                <option value="THALEOS_10M">THALEOS 10kW Mono</option>
                                <option value="THALEOS_12M">THALEOS 12kW Mono</option>
                                <option value="THALEOS_14M">THALEOS 14kW Mono</option>
                                <option value="THALEOS_16M">THALEOS 16kW Mono</option>
                            </optgroup>
                            <optgroup label="THALEOS Tri">
                                <option value="THALEOS_08T">THALEOS 8kW Tri</option>
                                <option value="THALEOS_10T">THALEOS 10kW Tri</option>
                                <option value="THALEOS_12T">THALEOS 12kW Tri</option>
                                <option value="THALEOS_14T">THALEOS 14kW Tri</option>
                                <option value="THALEOS_16T">THALEOS 16kW Tri</option>
                            </optgroup>
                            <optgroup label="THALEOS Bi-Bloc">
                                <option value="THALEOS_BI_08M">THALEOS Bi-Bloc 8kW</option>
                                <option value="THALEOS_BI_10M">THALEOS Bi-Bloc 10kW</option>
                                <option value="THALEOS_BI_12M">THALEOS Bi-Bloc 12kW</option>
                                <option value="THALEOS_BI_14M">THALEOS Bi-Bloc 14kW</option>
                                <option value="THALEOS_BI_16M">THALEOS Bi-Bloc 16kW</option>
                            </optgroup>
                            <optgroup label="WELLEA">
                                <option value="WELLEA_12T">WELLEA 12kW Tri</option>
                                <option value="WELLEA_14T">WELLEA 14kW Tri</option>
                                <option value="WELLEA_16T">WELLEA 16kW Tri</option>
                                <option value="WELLEA_16M">WELLEA 16kW Mono</option>
                            </optgroup>
                            <optgroup label="WOLF">
                                <option value="WOLF_FHA_05_06_230">WOLF 5kW Mono</option>
                                <option value="WOLF_FHA_06_07_230">WOLF 6kW Mono</option>
                                <option value="WOLF_FHA_08_10_230">WOLF 8kW Mono</option>
                                <option value="WOLF_FHA_11_14_230">WOLF 11kW Mono</option>
                                <option value="WOLF_FHA_14_17_230">WOLF 14kW Mono</option>
                                <option value="WOLF_FHA_14_17_400">WOLF 14kW Tri</option>
                            </optgroup>
                        </select>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:10px;">
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Prix PAC TTC (&euro;)</label>
                            <input type="number" id="prixPAC" value="7650" oninput="calc()">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Prix Pose TTC (&euro;)</label>
                            <input type="number" id="prixPose" value="3240" oninput="calc()">
                        </div>
                        <div class="form-group" style="margin-bottom:0;">
                            <label>Usage</label>
                            <select id="usagePAC"><option>Chauffage seul</option><option>Chauffage + ECS</option></select>
                        </div>
                    </div>
                    <div id="pacInfo" style="font-size:11px;color:#64748b;line-height:1.5;min-height:20px;"></div>
                </div>

                <!-- Ballon Thermodynamique -->
                <div class="produit-bloc" style="margin-top:14px;">
                    <div class="produit-bloc-head">
                        <span class="produit-bloc-icon">&#128703;</span>
                        <span class="produit-bloc-title">Ballon Thermodynamique</span>
                    </div>
                    <div class="form-group" style="margin-bottom:8px;">
                        <label>Inclure un ballon CET ?</label>
                        <select id="includeBallon" onchange="toggleProduitOpt('ballonOpt',this.value==='oui');calc();calcCEEDetail()">
                            <option value="non">Non</option>
                            <option value="oui">Oui</option>
                        </select>
                    </div>
                    <div class="produit-opt-section" id="ballonOpt">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label>R&eacute;f&eacute;rence</label>
                                <select id="refBallon">
                                    <option value="PERFORMER2_200L">Performer 2 &mdash; 200L</option>
                                    <option value="PERFORMER2_270L">Performer 2 &mdash; 270L</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Prix TTC (&euro;)</label>
                                <input type="number" id="prixBallon" value="2000" oninput="calc()">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Pose TTC (&euro;)</label>
                                <input type="number" id="prixPoseBallon" value="860" oninput="calc()">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>COP</label>
                                <input id="copBallon" value="2,78">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SSC -->
                <div class="produit-bloc" style="margin-top:14px;">
                    <div class="produit-bloc-head">
                        <span class="produit-bloc-icon">&#9728;&#65039;</span>
                        <span class="produit-bloc-title">SSC &mdash; Syst&egrave;me Solaire Combin&eacute;</span>
                    </div>
                    <div class="form-group" style="margin-bottom:8px;">
                        <label>Inclure SSC ?</label>
                        <select id="includeSSC" onchange="toggleProduitOpt('sscOpt',this.value==='oui');calc();calcCEEDetail()">
                            <option value="non">Non</option>
                            <option value="oui">Oui &mdash; YODAV (QS/62338)</option>
                        </select>
                    </div>
                    <div class="produit-opt-section" id="sscOpt">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Produit</label>
                                <select id="refSSC"><option>THALEOS SSC 420L SUNBOOSTER</option></select>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Prix SSC TTC (&euro;)</label>
                                <input type="number" id="prixSSC" value="10230" oninput="calc()">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label>Pose SSC TTC (&euro;)</label>
                                <input type="number" id="prixPoseSSC" value="4730" oninput="calc()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TVA (hidden, default 5.5%) -->
                <input type="hidden" id="tvaProduit" value="5.5">
            </div>
            </div><!-- end tab-pac-content produit -->

            <div class="tab-pac-content">
            <!-- ===================== BARÃˆME PAC (client) ===================== -->
            <div class="card" id="baremeCard">
                <h2 class="card-title">&#128208; Puissance PAC recommandÃ©e</h2>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 14px;">Estimation selon la surface, l'annÃ©e de construction et l'isolation</div>

                <!-- Hidden input for sync -->
                <input type="hidden" id="baremeSurface" value="100">

                <!-- AnnÃ©e de construction -->
                <div class="form-group" style="margin-bottom: 14px;">
                    <label>AnnÃ©e de construction</label>
                    <input type="number" id="dimAnnee" value="2000" min="1900" max="2026" oninput="evalIsolation(); calcBareme(); calcDim()">
                </div>

                <!-- Questionnaire isolation -->
                <div style="margin-bottom: 14px;">
                    <label style="font-weight: 700; color: #1d1d1f; font-size: 14px; display: block; margin-bottom: 12px;">Travaux d&eacute;j&agrave; r&eacute;alis&eacute;s</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;" id="isoChecklist">
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="combles">
                            <span class="iso-info">
                                <span class="iso-title">&#127968; Combles / Toiture</span>
                                <span class="iso-sub">Souffl&eacute;e, rampants, sarking</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="murs">
                            <span class="iso-info">
                                <span class="iso-title">&#129521; Murs (ITE / ITI)</span>
                                <span class="iso-sub">Ext&eacute;rieure ou int&eacute;rieure</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="fenetres">
                            <span class="iso-info">
                                <span class="iso-title">&#128999; Fen&ecirc;tres DV / TV</span>
                                <span class="iso-sub">Double ou triple vitrage</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="plancher">
                            <span class="iso-info">
                                <span class="iso-title">&#11015;&#65039; Plancher bas</span>
                                <span class="iso-sub">Vide sanitaire, sous-sol</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)" style="grid-column: 1 / -1;">
                            <input type="checkbox" name="isoWork" value="vmc">
                            <span class="iso-info">
                                <span class="iso-title">&#128168; VMC double flux</span>
                                <span class="iso-sub">Ventilation m&eacute;canique contr&ocirc;l&eacute;e</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                    </div>
                    <!-- RÃ©sultat isolation (fournisseur only) -->
                    <div id="isoResult" class="fournisseur-only" style="margin-top: 10px; padding: 10px 14px; border-radius: 8px; font-size: 13px; background: #f8fafc; border: 1.5px solid #e2e8f0;">
                        <span style="font-weight: 600;" id="isoStateName">Ã‰tat d'origine / Non prÃ©cisÃ©</span>
                        <span style="color: #64748b;"> &mdash; </span>
                        <span style="font-weight: 700; color: #16a34a;" id="dimGDisplay">G = 0,95</span>
                    </div>
                </div>

                <!-- RÃ©sultat barÃ¨me visuel -->
                <div id="baremeResult" style="padding: 20px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-radius: 12px; border: 1.5px solid #bbf7d0;">
                    <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; text-align: center;">PAC recommandÃ©e</div>
                    
                    <!-- Gauge visuelle -->
                    <div id="baremeGauge" style="position: relative; margin: 0 auto; max-width: 340px;">
                        <!-- Labels puissance -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span id="baremeLow" style="font-size: 20px; font-weight: 800; color: #16a34a;">10 kW</span>
                            <span id="baremeHigh" style="font-size: 20px; font-weight: 800; color: #dc2626;">12 kW</span>
                        </div>
                        <!-- Barre -->
                        <div style="position: relative; height: 12px; border-radius: 6px; background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%); margin-bottom: 4px;">
                            <!-- Curseur -->
                            <div id="baremeCursor" style="position: absolute; top: -6px; width: 24px; height: 24px; border-radius: 50%; background: white; border: 3px solid #0f172a; box-shadow: 0 2px 8px rgba(0,0,0,0.25); transition: left 0.4s ease; left: 50%;" ></div>
                        </div>
                        <!-- Labels bas -->
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8;">
                            <span>Bien isolÃ©</span>
                            <span>Mal isolÃ©</span>
                        </div>
                    </div>

                    <!-- RÃ©sultat texte -->
                    <div style="text-align: center; margin-top: 14px;">
                        <div id="baremeReco" style="font-size: 32px; font-weight: 800; color: #16a34a;">10 kW</div>
                        <div id="baremeAlt" style="font-size: 13px; color: #64748b; margin-top: 2px;"></div>
                        <div id="baremeIsoHint" style="font-size: 11px; color: #64748b; margin-top: 4px;"></div>
                    </div>
                </div>

                <!-- Tableau supprimÃ© - logique intÃ©grÃ©e dans calcBareme -->
            </div>

            <!-- ===================== NOTE DE DIMENSIONNEMENT (fournisseur) ===================== -->
            <div class="card fournisseur-only telepro-hide" id="dimensionnementCard">
                <h2 class="card-title">&#128208; Dimensionnement PAC</h2>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 18px;">Estimation de la puissance recommandÃ©e Â· Formule : P = G &times; V &times; &#916;T</div>

                <!-- Surface + Hauteur -->
                <div class="dim-row">
                    <div class="dim-field">
                        <label>Surface au sol (mÂ²) <span class="req">*</span></label>
                        <input type="number" id="dimSurface" value="100" min="1" oninput="syncSurfaces('dim')">
                        <div class="dim-hint">Exemple : 100 mÂ²</div>
                    </div>
                    <div class="dim-field">
                        <label>Hauteur sous plafond (m)</label>
                        <input type="number" id="dimHauteur" value="2.5" min="1.5" max="5" step="0.1" oninput="calcDim()">
                        <div class="dim-hint">DÃ©faut : 2,5 m</div>
                    </div>
                </div>

                <!-- ParamÃ¨tres avancÃ©s (masquÃ©s, gardÃ©s pour calcul) -->
                <input type="hidden" id="dimTbase" value="-7">
                <input type="hidden" id="dimTint" value="21">
                <input type="hidden" id="dimT1" value="60">
                <input type="hidden" id="dimT2" value="140">

                <!-- RÃ‰SULTATS -->
                <div style="background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: white; font-size: 14px; margin-bottom: 14px; text-align: center;">RÃ‰SULTATS DU DIMENSIONNEMENT</div>
                    
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">DÃ©perditions totales (P = G &times; V &times; &#916;T)</div>
                        <div style="font-size: 28px; font-weight: 800; color: #fbbf24;" id="dimDeperditions">&mdash;</div>
                        <div style="font-size: 12px; color: #cbd5e1;" id="dimDepFormula">&mdash;</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance PAC</div>
                            <div style="font-size: 24px; font-weight: 800; color: #34d399;" id="dimPuissancePAC">&mdash;</div>
                            <div style="font-size: 11px; color: #cbd5e1;" id="dimPuissancePACDetail">&mdash;</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance appoint</div>
                            <div style="font-size: 24px; font-weight: 800; color: #f97316;" id="dimPuissanceAppoint">&mdash;</div>
                            <div style="font-size: 11px; color: #cbd5e1;" id="dimPuissanceAppointDetail">&mdash;</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.08); border-radius: 8px; padding: 10px; margin-top: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance totale (PAC + appoint)</div>
                        <div style="font-size: 20px; font-weight: 700; color: white;" id="dimPuissanceTotale">&mdash;</div>
                    </div>
                </div>

                <!-- TempÃ©rature d'eau -->
                <div class="dim-row" style="margin-bottom: 0;">
                    <div class="dim-field">
                        <label>TÂ° d'eau du circuit (Â°C)</label>
                        <input type="number" id="dimTeau" value="60" step="5" min="30" max="80">
                    </div>
                </div>

                <!-- Ã‰quipement -->
                <div style="margin-top: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px;">
                    <div style="font-weight: 600; color: #1d1d1f; font-size: 13px; margin-bottom: 10px;">MatÃ©riel installÃ©</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: #64748b;">Marque PAC</label>
                            <input type="text" id="dimMarque" placeholder="Ex: Daikin, Atlantic&#8230;" style="width: 100%; padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #64748b;">RÃ©fÃ©rence PAC</label>
                            <input type="text" id="dimReference" placeholder="RÃ©f. modÃ¨le" style="width: 100%; padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card fournisseur-only">
                <h2 class="card-title">CoÃ»ts (Vue Fournisseur)</h2>
                
                <div style="background: #f5f5f7; padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                    <!-- PAC MatÃ©riel -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">PAC MatÃ©riel</label>
                        <input type="number" id="coutPACMateriel" value="2900" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qtePACMateriel" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPACMateriel">2 900 &euro;</div>
                    </div>
                    
                    <!-- PAC Pose -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">PAC Pose</label>
                        <input type="number" id="coutPACPose" value="2500" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qtePACPose" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPACPose">2 500 &euro;</div>
                    </div>
                    
                    <!-- Ballon MatÃ©riel -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Ballon MatÃ©riel</label>
                        <input type="number" id="coutBallonMateriel" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteBallonMateriel" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalBallonMateriel">0 &euro;</div>
                    </div>
                    
                    <!-- Ballon Pose -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Ballon Pose</label>
                        <input type="number" id="coutBallonPose" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteBallonPose" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalBallonPose">0 &euro;</div>
                    </div>
                    
                    <!-- Accessoires -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Access.</label>
                        <input type="number" id="coutAccessoires" value="500" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAccessoires" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAccessoires">500 &euro;</div>
                    </div>
                    
                    <!-- Admin -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Admin</label>
                        <input type="number" id="coutAdmin" value="400" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAdmin" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAdmin">400 &euro;</div>
                    </div>
                    
                    <!-- Mandat MPR -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Mandat MPR</label>
                        <input type="number" id="coutMandat" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteMandat" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalMandat">0 &euro;</div>
                    </div>
                    
                    <!-- Demande mairie -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Mairie</label>
                        <input type="number" id="coutMairie" value="250" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteMairie" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalMairie">0 &euro;</div>
                    </div>
                    
                    <!-- PrÃ©visite -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="checkPrevisite" onchange="updateFromDetail()" style="width: 16px; height: 16px;"> PrÃ©visite
                        </label>
                        <input type="number" id="coutPrevisite" value="200" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <div style="text-align: center; font-weight: 600; color: #64748b;">&mdash;</div>
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPrevisite">0 &euro;</div>
                    </div>
                </div>
                
                <small style="font-size: 11px; color: #86868b; margin-bottom: 12px; display: block; text-align: center;">
                    <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="lockCoutHT" checked onchange="calc()"> Verrouiller les coÃ»ts (auto selon scÃ©nario)
                    </label>
                </small>
                
                <div style="background: #0071e3; color: white; padding: 14px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; font-size: 14px;">TOTAL COÃ›T HT</span>
                        <span style="font-size: 20px; font-weight: 700;" id="coutTotalHTDisplay">6 200 &euro;</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="prixCumac">Prix cumac (&euro;/MWhc) &mdash; auto selon mÃ©nage</label>
                        <input type="number" id="prixCumac" value="12.5" step="0.01" oninput="calc()" style="font-weight: 600;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label>kWh cumac</label>
                        <input type="text" id="kwhCumac" value="" readonly style="background: #f5f5f7; color: #1d1d1f; font-weight: 600;">
                    </div>
                </div>
            </div>

            <div style="padding-bottom: 40px;"></div>
            </div><!-- end tab-pac-content for bareme+dim+costs -->


            <!-- ===== ITE CONTENT ===== -->
            <div class="tab-ite-content">
                <!-- LOT 1 - BAR-EN-102 -->
                <div class="ite-card">
                    <div class="ite-card-head">
                        <div class="ite-card-icon">&#129521;</div>
                        <h3>LOT 1 &mdash; BAR-EN-102 &mdash; ITE Murs Ext&eacute;rieurs</h3>
                        <span class="ite-tag">LOT 1 &middot; Obligatoire</span>
                    </div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Surface (m&sup2;)</label><input type="number" id="iteSurfaceITE" value="105" oninput="ite_calc()"></div>
                        <input type="hidden" id="iteMontantLot1" value="0">
                        <div class="ite-fi" style="display:none;"><label>Prix mat&eacute;riel (&euro;/m&sup2;)</label><input type="number" id="itePrixMatITE" value="0" oninput="ite_calc()"></div>
                        <div class="ite-fi" style="display:none;"><label>Prix MO (&euro;/m&sup2;)</label><input type="number" id="itePrixMoITE" value="0" oninput="ite_calc()"></div>
                        <div class="ite-fi"><label>Isolant</label><select id="iteIsolantITE"><option value="CELLOMUR_120">HIRSCH CELLOMUR ULTRA 120mm &mdash; R=3,85</option><option value="CELLOMUR_140">HIRSCH CELLOMUR ULTRA 140mm &mdash; R=4,50</option></select></div>
                    </div>
                    <div class="ite-fg" style="margin-top: 10px; display:none;">
                        <div class="ite-fi full"><label>Sous-traitance</label><input id="iteSousTraitITE" value="RL CONSEILS, 2 RUE LOUIS PERGAUD 94700 MAISONS-ALFORT"></div>
                        <div class="ite-fi"><label>SIRET</label><input id="iteSiretSousTraitITE" value="85320240600049"></div>
                        <div class="ite-fi"><label>RGE</label><input id="iteRgeSousTraitITE" value="E-E 184700 (02/07/2024 &rarr; 01/07/2026)"></div>
                        <div class="ite-fi"><label>Couleur cr&eacute;pi</label><input id="iteCouleurCrepi" value="Ton pierre"></div>
                        <div class="ite-fi"><label>Enduit</label><input id="iteEnduitITE" value="Enduit AFC 1.5 base Soltherm"></div>
                    </div>
                </div>

                <!-- LOT 2 -->
                <div class="ite-card">
                    <div class="ite-card-head">
                        <div class="ite-card-icon">&#128256;</div>
                        <h3>LOT 2 &mdash; 2&egrave;me Geste</h3>
                        <span class="ite-tag">LOT 2 &middot; min 1 500 &euro;</span>
                    </div>
                    <div class="ite-note">2&egrave;me geste obligatoire pour CEE + PTZ. <b style="color: #f97316;">Minimum factur&eacute; : 1 500 &euro;</b></div>
                    <div class="ite-fg">
                        <div class="ite-fi full"><label>Type</label>
                            <select id="iteTypeLot2" onchange="ite_switchLot2();ite_calc()">
                                <option value="101">BAR-EN-101 &mdash; Isolation combles perdus</option>
                                <option value="103">BAR-EN-103 &mdash; Isolation plancher bas</option>
                                <option value="148">BAR-TH-148 &mdash; Chauffe-eau thermodynamique</option>
                            </select>
                        </div>
                    </div>
                    <div id="iteLot2Alert"></div>
                </div>

                <!-- LOT 2: BAR-EN-101 -->
                <div class="ite-card" id="iteCard101" style="display: none;">
                    <div class="ite-card-head"><div class="ite-card-icon">&#127968;</div><h3>BAR-EN-101 &mdash; Combles Perdus</h3></div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Surface (m&sup2;)</label><input type="number" id="iteSurface101" value="50" oninput="ite_calc()"></div>
                        <input type="hidden" id="itePrixMat101" value="0">
                        <input type="hidden" id="itePrixMo101" value="0">
                    </div>
                </div>

                <!-- LOT 2: BAR-EN-103 -->
                <div class="ite-card" id="iteCard103" style="display: none;">
                    <div class="ite-card-head"><div class="ite-card-icon">&#127968;</div><h3>BAR-EN-103 &mdash; Plancher Bas</h3></div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Surface (m&sup2;)</label><input type="number" id="iteSurface103" value="50" oninput="ite_calc()"></div>
                        <input type="hidden" id="itePrixMat103" value="0">
                        <input type="hidden" id="itePrixMo103" value="0">
                    </div>
                </div>

                <!-- LOT 2: BAR-TH-148 -->
                <div class="ite-card" id="iteCard148" style="display: none;">
                    <div class="ite-card-head"><div class="ite-card-icon">&#128703;</div><h3>BAR-TH-148 &mdash; CET</h3></div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Mod&egrave;le</label><select id="iteRefCET"><option value="200">THALEOS Performer 2 &mdash; 200L</option><option value="240">THALEOS Performer III &mdash; 240L</option><option value="270">THALEOS Performer 2 &mdash; 270L</option></select></div>
                        <input type="hidden" id="itePrixCET" value="0">
                        <input type="hidden" id="itePrixPoseCET" value="0">
                        <div class="ite-fi"><label>COP</label><input id="iteCopCET" value="2,78"></div>
                    </div>
                </div>

                <!-- LOT 3 (optionnel) -->
                <div class="ite-card" style="border:1px dashed #94a3b8;">
                    <div class="ite-card-head">
                        <div class="ite-card-icon">&#128257;</div>
                        <h3>LOT 3 &mdash; 3&egrave;me Geste (optionnel)</h3>
                        <span class="ite-tag" style="background:#3b82f6;">Plafond PTZ 30 000 &euro;</span>
                    </div>
                    <div class="ite-note">3&egrave;me geste optionnel : passe le plafond Eco-PTZ de 25 000 &euro; &agrave; <b style="color:#3b82f6;">30 000 &euro;</b>. <b style="color: #f97316;">Minimum factur&eacute; : 1 500 &euro;</b></div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Inclure LOT 3 ?</label><select id="iteIncludeLot3" onchange="ite_switchLot3();ite_calc()"><option value="non">Non</option><option value="oui">Oui</option></select></div>
                        <div class="ite-fi full" id="iteTypeLot3Wrap" style="display:none;"><label>Type</label>
                            <select id="iteTypeLot3" onchange="ite_switchLot3();ite_calc()">
                                <option value="101">BAR-EN-101 &mdash; Isolation combles perdus</option>
                                <option value="103">BAR-EN-103 &mdash; Isolation plancher bas</option>
                                <option value="148">BAR-TH-148 &mdash; Chauffe-eau thermodynamique</option>
                            </select>
                        </div>
                    </div>
                    <div id="iteLot3Alert"></div>
                </div>

                <!-- LOT 3: BAR-EN-101 -->
                <div class="ite-card" id="iteCard101L3" style="display: none;">
                    <div class="ite-card-head"><div class="ite-card-icon">&#127968;</div><h3>LOT 3 &mdash; BAR-EN-101 Combles Perdus</h3></div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Surface (m&sup2;)</label><input type="number" id="iteSurface101L3" value="50" oninput="ite_calc()"></div>
                        <input type="hidden" id="itePrixMat101L3" value="0">
                        <input type="hidden" id="itePrixMo101L3" value="0">
                    </div>
                </div>

                <!-- LOT 3: BAR-EN-103 -->
                <div class="ite-card" id="iteCard103L3" style="display: none;">
                    <div class="ite-card-head"><div class="ite-card-icon">&#127968;</div><h3>LOT 3 &mdash; BAR-EN-103 Plancher Bas</h3></div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Surface (m&sup2;)</label><input type="number" id="iteSurface103L3" value="50" oninput="ite_calc()"></div>
                        <input type="hidden" id="itePrixMat103L3" value="0">
                        <input type="hidden" id="itePrixMo103L3" value="0">
                    </div>
                </div>

                <!-- LOT 3: BAR-TH-148 -->
                <div class="ite-card" id="iteCard148L3" style="display: none;">
                    <div class="ite-card-head"><div class="ite-card-icon">&#128703;</div><h3>LOT 3 &mdash; BAR-TH-148 CET</h3></div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Mod&egrave;le</label><select id="iteRefCETL3"><option value="200">THALEOS Performer 2 &mdash; 200L</option><option value="240">THALEOS Performer III &mdash; 240L</option><option value="270">THALEOS Performer 2 &mdash; 270L</option></select></div>
                        <input type="hidden" id="itePrixCETL3" value="0">
                        <input type="hidden" id="itePrixPoseCETL3" value="0">
                        <div class="ite-fi"><label>COP</label><input id="iteCopCETL3" value="2,78"></div>
                    </div>
                </div>

                <!-- MONTANT TOTAL PROJET -->
                <div class="ite-card" style="background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border: 2px solid #16a34a;">
                    <div class="ite-card-head">
                        <div class="ite-card-icon">&#128176;</div>
                        <h3>Montant total du projet</h3>
                    </div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Montant TTC (&euro;)</label><input type="number" id="iteMontantTotalProjet" value="0" oninput="ite_onMontantTotal()"></div>
                    </div>
                    <div id="iteMontantDetail" style="font-size:12px;color:#64748b;margin-top:8px;"></div>
                </div>

                <!-- CEE EDF -->
                <div class="ite-card">
                    <div class="ite-card-head">
                        <div class="ite-card-icon">&#128202;</div>
                        <h3>CEE EDF &amp; PTZ</h3>
                        <span class="ite-tag ite-tag-auto">Auto</span>
                    </div>
                    <div class="ite-note">Obligataire : EDF (SIREN 552 081 317)</div>
                    <div id="itePtzStatus"></div>
                    <div id="iteAidesSummary"></div>
                    <div id="iteCeeTableContainer"></div>
                    <div class="ite-fg" style="margin-top: 14px;">
                        <div class="ite-fi"><label>TVA (%)</label><input type="number" id="iteTva" value="5.5" step="0.1" oninput="ite_calc()"></div>
                        <div class="ite-fi"><label>Prime CEE totale (&euro;) <small style="color:#16a34a;">AUTO</small></label><input type="number" id="itePrimeCEE" step="0.01" oninput="ite_calc()"></div>
                    </div>
                </div>

                <!-- Partenaires (masquÃ©) -->

                <!-- Financement -->
                <div class="ite-card">
                    <div class="ite-card-head"><div class="ite-card-icon">&#128179;</div><h3>Financement</h3></div>
                    <div class="ite-fg">
                        <div class="ite-fi"><label>Inclure ?</label><select id="iteIncludeFinancement" onchange="ite_calc()"><option value="oui">Oui</option><option value="non">Non</option></select></div>
                        <div class="ite-fi"><label>Dur&eacute;e (mois)</label><input type="number" id="iteDureeMois" value="120" oninput="ite_calcFinancement()"></div>
                        <div class="ite-fi"><label>Date naissance emprunteur</label><input type="text" inputmode="numeric" id="iteDobEmprunteur" placeholder="JJMMAAAA" maxlength="10" oninput="ecoptz_formatDateInput(this)"></div>
                        <div class="ite-fi"><label>Type assurance</label><select id="iteTypeAssurance" onchange="ite_calcFinancement()"><option value="DIM" selected>DIM</option><option value="D">D</option><option value="DIMC">DIMC</option><option value="Aucune">Aucune</option></select></div>
                        <div class="ite-fi"><label>Mensualit&eacute; hors ass. (&euro;)</label><input type="number" id="iteMensHorsAss" value="0" step="0.01" readonly style="background:#f7f8fa;"></div>
                        <div class="ite-fi"><label>Mensualit&eacute; avec ass. (&euro;)</label><input type="number" id="iteMensAvecAss" value="0" step="0.01" readonly style="background:#f7f8fa;"></div>
                        <div class="ite-fi"><label>TAEA</label><span id="iteFinTAEA" style="font-weight:700;font-size:14px;color:#1a2744;">-</span></div>
                        <div class="ite-fi"><label>Total d&ucirc; hors ass. (&euro;)</label><input type="number" id="iteTotalDuHA" value="0" step="0.01" readonly style="background:#f7f8fa;"></div>
                        <div class="ite-fi"><label>Total d&ucirc; avec ass. (&euro;)</label><input type="number" id="iteTotalDuAA" value="0" step="0.01" readonly style="background:#f7f8fa;"></div>
                    </div>
                </div>


                <!-- Generate button -->
                <div style="margin-top: 10px;">
                    <button onclick="ite_generateDevis()" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, #16a34a, #0d8a3a); color: white; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px rgba(22,163,74,0.25); transition: all 0.2s; font-family: inherit;">
                        &#128196; G&eacute;n&eacute;rer le Devis ITE
                    </button>
                </div>
                <div style="margin-top: 8px;">
                    <button onclick="ite_generatePTZ()" style="width: 100%; padding: 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, #006B3F, #2E9D5E); color: white; font-size: 15px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 20px rgba(0,107,63,0.25); transition: all 0.2s; font-family: inherit;">
                        &#127963;&#65039; G&eacute;n&eacute;rer le document PTZ
                    </button>
                </div>
                <div style="margin-top: 8px;">
                    <button onclick="esign_openModal()" style="width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #d1d5db; background: white; color: #374151; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <span style="font-size: 18px;">&#9998;</span> Signature &eacute;lectronique des documents
                    </button>
                </div>
            </div><!-- end tab-ite-content -->

        </div>

        <div class="results-sidebar" id="resultsSidebar">
            <div class="tab-pac-content">
            <div class="summary-card" style="margin-bottom: 0;">
                <div class="scenario-label-dark" id="scenarioSummary">&mdash;</div>

                <!-- TOTAL TTC (readonly client) -->
                <div class="ttc-readonly">
                    <div class="result-row-card" style="background: rgba(96,165,250,0.08); border-color: rgba(96,165,250,0.15);">
                        <div class="rrc-label">&#128176; CoÃ»t installation TTC</div>
                        <div class="rrc-value blue" id="totalTTC">&mdash;</div>
                    </div>
                </div>

                <!-- TOTAL TTC (editable fournisseur) -->
                <div class="fournisseur-only" style="margin-bottom: 12px;">
                    <div class="result-row-card" style="background: rgba(96,165,250,0.08); border-color: rgba(96,165,250,0.15);">
                        <div class="rrc-label">&#128176; CoÃ»t installation TTC</div>
                        <div class="rrc-value blue" id="totalTTCEditable" contenteditable="true" oninput="onTTCEdit()" style="cursor: text; min-width: 60px;">10 890 â‚¬</div>
                    </div>
                    <input type="hidden" id="totalTTCInput" value="10890">
                    <small style="font-size: 11px; color: rgba(255,255,255,0.35); margin-top: 6px; display: block;">
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" id="lockTTC" checked onchange="calc()"> Verrouiller (auto selon scÃ©nario)
                        </label>
                    </small>
                </div>

                <!-- COÃ›T HT fournisseur -->
                <div class="fournisseur-only" style="margin-bottom: 4px;">
                    <div class="result-row-card">
                        <div>
                            <div class="rrc-label">CoÃ»t HT</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px;">MatÃ©riel + pose + admin</div>
                        </div>
                        <div class="rrc-value" id="displayCoutHT" style="font-size: 18px;">&mdash;</div>
                    </div>
                </div>

                <div class="glow-separator"></div>

                <!-- ESTIMATION FINANCIÃˆRE -->
                <div class="dark-section-title">Estimation financiÃ¨re</div>

                <div class="result-row-card">
                    <div class="rrc-label">MaPrimeRÃ©nov'</div>
                    <div class="rrc-value green" id="aidesMPR" style="font-size: 18px;">&mdash;</div>
                </div>

                <div class="result-row-card">
                    <div>
                        <div class="rrc-label">Certificats CEE</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px;" id="ceeSourceLabel">BAR-TH dÃ©taillÃ©</div>
                    </div>
                    <div class="rrc-value green" id="aidesCEE" style="font-size: 18px;">&mdash;</div>
                </div>

                <div class="glow-separator"></div>

                <!-- TOTAL AIDES -->
                <div class="result-highlight-card">
                    <div class="rhc-label">Total des aides</div>
                    <div class="rhc-value" id="totalAides">&mdash;</div>
                </div>

                <!-- RESTE Ã€ CHARGE -->
                <div class="result-row-card" style="background: rgba(251,191,36,0.08); border-color: rgba(251,191,36,0.15);">
                    <div class="rrc-label">&#127968; Reste Ã  charge estimÃ©</div>
                    <div class="rrc-value yellow" id="resteCharge">&mdash;</div>
                </div>

                <!-- MARGE fournisseur -->
                <div class="fournisseur-only telepro-hide" style="margin-top: 4px;">
                    <div class="result-row-card" style="background: rgba(248,113,113,0.06); border-color: rgba(248,113,113,0.12);">
                        <div class="rrc-label">&#128202; Marge finale (HT)</div>
                        <div class="rrc-value" id="margeFinal" style="font-size: 18px;">&mdash;</div>
                    </div>
                </div>

                <div class="glow-separator"></div>

                <!-- RAC Section (fournisseur only) -->
                <div class="rac-dark-section fournisseur-only" style="margin-bottom: 14px;">
                    <div class="dark-section-title" style="margin-bottom: 10px;">Prise en charge du RAC</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div class="amount-label" style="color: rgba(255,255,255,0.45); margin-bottom: 4px;">Pourcentage (%)</div>
                            <input type="number" id="racPourcent" value="0" min="0" max="100" step="1" oninput="updatePct()" onchange="logRACChange()">
                        </div>
                        <div>
                            <div class="amount-label" style="color: rgba(255,255,255,0.45); margin-bottom: 4px;">RAC offert (&euro;)</div>
                            <input type="number" id="racOffert" value="0" min="0" step="1" oninput="updateAmt()" onchange="logRACChange()">
                        </div>
                    </div>
                    <div id="maxPctInfo" style="font-size: 12px; padding: 10px 14px; border-radius: 8px; background: rgba(5,150,105,0.12); border: 1px solid rgba(5,150,105,0.25); color: #34d399; margin-bottom: 6px;">
                        Remise max : <strong id="maxPctValue">&mdash;</strong> pour rester en dossier vert
                    </div>
                    <div class="note-small" style="font-size: 11px; margin-bottom: 8px; color: rgba(255,255,255,0.3);">AppliquÃ© sur le RAC brut. N'affecte pas le prix cumac.</div>
                </div>

                <!-- Status + Actions -->
                <div id="statusBadge" class="status-badge ok" style="margin-bottom: 14px;" onclick="shareDevis()">
                    <span id="statusIcon">&#9989;</span>
                    <span id="statusText">Voulez-vous un devis ?</span>
                </div>

                <button id="exportBtn" class="btn-dark-export pdf" onclick="exportPDF()" style="margin-top: 14px;">
                    &#128196; G&eacute;n&eacute;rer le Devis PAC
                </button>
                
                <button id="whatsappBtn" class="btn-dark-export whatsapp" onclick="sendWhatsApp()">
                    &#128172; Envoyer par WhatsApp
                </button>
                <button onclick="esign_openModal('pac')" class="btn-dark-export" style="margin-top: 8px; background: rgba(255,255,255,0.08) !important; border: 1px solid rgba(255,255,255,0.15) !important;">
                    &#9998; Signature &eacute;lectronique
                </button>

            </div><!-- end tab-pac-content sidebar -->

            <!-- ITE SIDEBAR -->
            <div class="tab-ite-content">
            <div class="summary-card" style="margin-bottom: 0;">
                <div class="scenario-label-dark" style="border-left-color: #16a34a;">
                    <strong style="color: #34d399;">ITE</strong><span class="separator">&bull;</span>Isolation Thermique Ext&eacute;rieure
                </div>

                <div class="result-row-card">
                    <div class="rrc-label">&#129521; LOT 1 &mdash; ITE</div>
                    <div class="rrc-value blue" id="iteSidebarLot1">&mdash;</div>
                </div>

                <div class="result-row-card">
                    <div>
                        <div class="rrc-label">LOT 2</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px;" id="iteSidebarLot2Type">BAR-EN-103</div>
                    </div>
                    <div class="rrc-value" id="iteSidebarLot2">&mdash;</div>
                </div>
                <div id="iteSidebarLot2Alert" style="display: none; font-size: 11px; color: #f87171; padding: 6px 10px; background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.15); border-radius: 8px; margin-bottom: 10px;">
                    &#9888;&#65039; LOT 2 &lt; 1 500 &euro;
                </div>

                <div class="glow-separator"></div>

                <div class="dark-section-title">Aides &amp; Primes</div>

                <div class="result-row-card" style="background: rgba(52,211,153,0.08); border-color: rgba(52,211,153,0.15);">
                    <div class="rrc-label">&#128220; Prime CEE EDF</div>
                    <div class="rrc-value green" id="iteSidebarCEE">&mdash;</div>
                </div>

                <div id="iteSidebarMPR" style="display: none;"></div>

                <div class="glow-separator"></div>

                <div class="result-row-card" style="background: rgba(96,165,250,0.08); border-color: rgba(96,165,250,0.15);">
                    <div class="rrc-label">&#128176; Total TTC</div>
                    <div class="rrc-value blue" id="iteSidebarTTC">&mdash;</div>
                </div>

                <div class="result-row-card" style="background: rgba(251,191,36,0.08); border-color: rgba(251,191,36,0.15);">
                    <div class="rrc-label">&#127968; Reste &agrave; r&eacute;gler</div>
                    <div class="rrc-value yellow" id="iteSidebarReste">&mdash;</div>
                </div>

                <div id="iteSidebarPTZ" style="margin-top: 10px;"></div>

                <button onclick="ite_generateDevis()" class="btn-dark-export pdf" style="margin-top: 14px;">
                    &#128196; G&eacute;n&eacute;rer le Devis ITE
                </button>
                <button onclick="ite_generatePTZ()" class="btn-dark-export pdf" style="margin-top: 8px; background: linear-gradient(135deg, #006B3F, #2E9D5E) !important;">
                    &#127963;&#65039; G&eacute;n&eacute;rer PTZ
                </button>
                <button onclick="esign_openModal()" class="btn-dark-export" style="margin-top: 8px; background: rgba(255,255,255,0.08) !important; border: 1px solid rgba(255,255,255,0.15) !important;">
                    &#9998; Signature &eacute;lectronique
                </button>
            </div>
            </div><!-- end tab-ite-content sidebar -->
</div>
        </div>
    </div>

    <div class="footer">
        <p style="margin: 0;">PropulsÃ© par 770 Lab</p>
    </div>
</div><!-- /appScreen -->

    <div id="printArea" style="display: none;">
        <div style="padding: 20px 30px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #1f2937; max-width: 800px; margin: 0 auto;">
            
            <!-- EN-TÃŠTE -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 3px solid #16a34a;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: linear-gradient(135deg, #16a34a, #15803d); color: white; padding: 8px 14px; border-radius: 8px; font-weight: 700; font-size: 14px;">&#127968; LES ARTISANS VERTS</div>
                    <div style="font-size: 12px; color: #6b7280;">Simulateur Aides PAC 2026</div>
                </div>
                <div style="text-align: right;">
                    <div id="printDate" style="font-size: 12px; color: #6b7280;"></div>
                    <div id="printCommercial" style="font-size: 11px; color: #16a34a; font-weight: 600; margin-top: 2px;"></div>
                </div>
            </div>

            <!-- TITRE -->
            <h1 id="printTitle" style="font-size: 22px; font-weight: 800; margin: 0 0 14px; color: #0f172a;"></h1>

            <!-- CLIENT + PROFIL -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; page-break-inside: avoid;">
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;">
                    <div style="font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">&#128100; Client</div>
                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <tr><td style="padding: 2px 0; color: #6b7280; width: 45%;">Nom</td><td style="padding: 2px 0; font-weight: 600;" id="printNom"></td></tr>
                        <tr><td style="padding: 2px 0; color: #6b7280;">DÃ©partement</td><td style="padding: 2px 0; font-weight: 600;" id="printDept"></td></tr>
                        <tr><td style="padding: 2px 0; color: #6b7280;">Zone</td><td style="padding: 2px 0; font-weight: 600;" id="printZone"></td></tr>
                        <tr><td style="padding: 2px 0; color: #6b7280;">Foyer</td><td style="padding: 2px 0; font-weight: 600;" id="printFoyer"></td></tr>
                        <tr><td style="padding: 2px 0; color: #6b7280;">RFR</td><td style="padding: 2px 0; font-weight: 600;" id="printRFR"></td></tr>
                    </table>
                </div>
                <div id="printProfilCard" style="border-radius: 8px; padding: 12px; color: white;">
                    <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; opacity: 0.8;">&#127963;&#65039; Profil MaPrimeRÃ©nov'</div>
                    <div id="printProfilIcon" style="font-size: 28px; margin-bottom: 2px;">&#128309;</div>
                    <div id="printProfilLabel" style="font-size: 18px; font-weight: 800;"></div>
                    <div id="printProfilDesc" style="font-size: 12px; opacity: 0.85; margin-top: 2px;"></div>
                    <div id="printProfilSeuil" style="font-size: 11px; opacity: 0.7; margin-top: 4px;"></div>
                </div>
            </div>

            <!-- CONFIGURATION TECHNIQUE -->
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin-bottom: 14px; page-break-inside: avoid;">
                <div style="font-size: 10px; font-weight: 700; color: #0369a1; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">&#9881;&#65039; Configuration technique</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div><div style="font-size: 10px; color: #64748b;">ScÃ©nario</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printScenario"></div></div>
                    <div><div style="font-size: 10px; color: #64748b;">Surface</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printSurface"></div></div>
                    <div><div style="font-size: 10px; color: #64748b;">ETAS</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printETAS"></div></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 6px;">
                    <div><div style="font-size: 10px; color: #64748b;">PAC recommandÃ©e</div><div style="font-size: 13px; font-weight: 700; color: #16a34a;" id="printPACReco"></div></div>
                    <div><div style="font-size: 10px; color: #64748b;">Isolation</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printIsolation"></div></div>
                    <div><div style="font-size: 10px; color: #64748b;">Construction</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printAnnee"></div></div>
                </div>
            </div>

            <!-- ESTIMATION FINANCIÃˆRE -->
            <div style="margin-bottom: 14px; page-break-inside: avoid;">
                <div style="font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">&#128176; Estimation financiÃ¨re</div>
                <div style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <tr style="background: #f8fafc;">
                            <td style="padding: 10px 14px; font-weight: 600;">Total TTC installation</td>
                            <td style="padding: 10px 14px; text-align: right; font-weight: 800; font-size: 16px;" id="printTTC"></td>
                        </tr>
                        <tr style="border-top: 1px solid #f1f5f9;">
                            <td style="padding: 8px 14px; color: #6b7280;">&#8627; MaPrimeRÃ©nov'</td>
                            <td style="padding: 8px 14px; text-align: right; font-weight: 700; color: #2563eb; font-size: 14px;" id="printMPR"></td>
                        </tr>
                        <tr style="border-top: 1px solid #f1f5f9;">
                            <td style="padding: 8px 14px; color: #6b7280;">&#8627; Prime CEE</td>
                            <td style="padding: 8px 14px; text-align: right; font-weight: 700; color: #2563eb; font-size: 14px;" id="printCEE"></td>
                        </tr>
                        <tr style="border-top: 2px solid #16a34a; background: #f0fdf4;">
                            <td style="padding: 10px 14px; font-weight: 700; color: #16a34a; font-size: 14px;">Total des aides</td>
                            <td style="padding: 10px 14px; text-align: right; font-weight: 800; color: #16a34a; font-size: 18px;" id="printTotalAides"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- DÃ‰TAIL CEE -->
            <div style="background: #fefce8; border: 1px solid #fde68a; border-radius: 8px; padding: 8px 12px; margin-bottom: 14px; font-size: 11px; color: #92400e; page-break-inside: avoid;">
                <strong>DÃ©tail CEE :</strong> <span id="printCEEDetail"></span>
            </div>

            <!-- RESTE Ã€ CHARGE -->
            <div style="border: 2px solid #0f172a; border-radius: 10px; padding: 16px; margin-bottom: 14px; text-align: center; page-break-inside: avoid;">
                <div style="font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Reste Ã  charge client</div>
                <div id="printRAC" style="font-size: 36px; font-weight: 800; color: #0f172a;"></div>
                <div id="printRACDetail" style="font-size: 12px; color: #6b7280; margin-top: 2px;"></div>
            </div>

            <!-- STATUT -->
            <div id="printStatus" style="padding: 12px; border-radius: 8px; text-align: center; font-weight: 700; font-size: 16px; margin-bottom: 16px; page-break-inside: avoid;"></div>

            <!-- PIED DE PAGE -->
            <div style="text-align: center; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                <div style="font-size: 10px; color: #9ca3af;">Document gÃ©nÃ©rÃ© automatiquement &mdash; Les Artisans Verts Â· PropulsÃ© par 770 Lab</div>
                <div style="font-size: 9px; color: #d1d5db; margin-top: 2px;">Ce document est une estimation et ne constitue pas un devis contractuel</div>
            </div>
        </div>
    </div>


    <div id="pacDevisArea" style="display: none;"></div>
    <div id="iteDevisArea" style="display: none;"></div>
    <div id="itePtzArea" style="display: none;"></div>

    <!-- E-Signature Modal -->
    <div id="esignOverlay" class="esign-overlay" style="display: none;">
        <div class="esign-modal">
            <div class="esign-header">
                <h3>&#9998; Signature &eacute;lectronique</h3>
                <button class="esign-close" onclick="esign_close()">&times;</button>
            </div>
            <div class="esign-body">
                <div id="esignDocList" style="margin-bottom: 16px;">
                    <!-- Liste des documents disponibles -->
                </div>
                <div class="esign-step">
                    <div class="esign-step-label">&#128100; &Eacute;tape 1</div>
                    <div class="esign-step-title">Signature du client</div>
                    <div class="esign-canvas-wrap" id="esignClientWrap">
                        <canvas class="esign-canvas" id="esignClientCanvas"></canvas>
                        <div class="esign-canvas-placeholder" id="esignClientPlaceholder">Dessinez votre signature ici</div>
                    </div>
                    <button class="esign-clear-btn" onclick="esign_clearPad('client')">&#128260; Effacer</button>
                    <div class="esign-info">Utilisez votre doigt ou stylet pour signer. La signature sera int&eacute;gr&eacute;e dans le document PDF.</div>
                </div>
                <div class="esign-step">
                    <div class="esign-step-label">&#127970; &Eacute;tape 2</div>
                    <div class="esign-step-title">Signature du repr&eacute;sentant LES ARTISANS VERTS</div>
                    <div class="esign-canvas-wrap" id="esignRepWrap">
                        <canvas class="esign-canvas" id="esignRepCanvas"></canvas>
                        <div class="esign-canvas-placeholder" id="esignRepPlaceholder">Dessinez votre signature ici</div>
                    </div>
                    <button class="esign-clear-btn" onclick="esign_clearPad('rep')">&#128260; Effacer</button>
                </div>
                <div id="esignStatusMsg"></div>
            </div>
            <div class="esign-footer">
                <button class="esign-btn esign-btn-cancel" onclick="esign_close()">Annuler</button>
                <button class="esign-btn esign-btn-sign" id="esignSubmitBtn" onclick="esign_applySignatures()">
                    &#10003; Signer et t&eacute;l&eacute;charger le PDF
                </button>
            </div>
        </div>
    </div>

<script>
// Debug helper
const _debugLog=[];
function dbg(msg){
    _debugLog.push(new Date().toLocaleTimeString()+': '+msg);
    try{
        const el=document.getElementById('debugLog');
        if(el) el.innerHTML=_debugLog.slice(-30).map(l=>'<div>'+l+'</div>').join('');
    }catch(e){}
    console.log('[DBG]', msg);
}
window.onerror=function(msg,url,line,col,err){
    console.warn('JS ERROR:', msg, 'line', line);
    return false;
};

// ============================================
// BARÃˆMES DE REVENUS MPR 2026
// ============================================
// ============================================
// TABLE DÃ‰PARTEMENTS \u2192 ZONE CLIMATIQUE (source officielle)
// ============================================
const DEPT_ZONE = {
    "01":"H1","02":"H1","03":"H1","04":"H2","05":"H1","06":"H3","07":"H2","08":"H1","09":"H2","10":"H1",
    "11":"H3","12":"H2","13":"H3","14":"H1","15":"H1","16":"H2","17":"H2","18":"H2","19":"H1","20":"H3",
    "2A":"H3","2B":"H3",
    "21":"H1","22":"H2","23":"H1","24":"H2","25":"H1","26":"H2","27":"H1","28":"H1","29":"H2","30":"H3",
    "31":"H2","32":"H2","33":"H2","34":"H3","35":"H2","36":"H2","37":"H2","38":"H1","39":"H1","40":"H2",
    "41":"H2","42":"H1","43":"H1","44":"H2","45":"H1","46":"H2","47":"H2","48":"H2","49":"H2","50":"H2",
    "51":"H1","52":"H1","53":"H2","54":"H1","55":"H1","56":"H2","57":"H1","58":"H1","59":"H1","60":"H1",
    "61":"H1","62":"H1","63":"H1","64":"H2","65":"H2","66":"H3","67":"H1","68":"H1","69":"H1","70":"H1",
    "71":"H1","72":"H2","73":"H1","74":"H1","75":"H1","76":"H1","77":"H1","78":"H1","79":"H2","80":"H1",
    "81":"H2","82":"H2","83":"H3","84":"H2","85":"H2","86":"H2","87":"H1","88":"H1","89":"H1","90":"H1",
    "91":"H1","92":"H1","93":"H1","94":"H1","95":"H1"
};

function detectDept() {
    const deptInput = document.getElementById('departement').value.trim();
    if (!deptInput) return;
    const deptKey = deptInput.padStart(2,'0');

    // Auto IDF
    const IDF_DEPTS = ['75','77','78','91','92','93','94','95'];
    const isIDF = IDF_DEPTS.includes(deptKey);
    document.getElementById('region').value = isIDF ? 'IDF' : 'PROVINCE';
    detectProfil();

    const zone = DEPT_ZONE[deptInput] || DEPT_ZONE[deptKey];
    if (zone) {
        document.getElementById('zone').value = zone;
        document.getElementById('deptZoneResult').textContent = `\u2192 Zone ${zone}${isIDF ? ' Â· IDF' : ''}`;
        
        // Auto Tbase dimensionnement
        const tbase = DEPT_TBASE[deptKey] || DEPT_TBASE[deptInput];
        if (tbase !== undefined) {
            document.getElementById('dimTbase').value = tbase;
            calcDim();
        }
        calc();
        calcCEEDetail();
    } else {
        document.getElementById('deptZoneResult').textContent = '\u274C DÃ©partement inconnu';
        
    }
}

const REVENUS_2026 = {
    PROVINCE: {
        1: [17363, 22259, 31185],
        2: [25393, 32553, 45842],
        3: [30540, 39148, 55196],
        4: [35676, 45735, 64550],
        5: [40835, 52348, 73907],
        supplement: [5151, 6598, 9357]
    },
    IDF: {
        1: [24031, 29253, 40851],
        2: [35270, 42933, 60051],
        3: [42357, 51564, 71846],
        4: [49455, 60208, 84562],
        5: [56580, 68877, 96817],
        supplement: [7116, 8663, 12257]
    }
};

function getSeuilsForPersonnes(region, nb) {
    const data = REVENUS_2026[region];
    if (nb <= 5) return data[nb];
    const base = data[5];
    const sup = data.supplement;
    const extra = nb - 5;
    return [
        base[0] + sup[0] * extra,
        base[1] + sup[1] * extra,
        base[2] + sup[2] * extra
    ];
}

function detectProfil() {
    const region = document.getElementById('region').value;
    const nb = parseInt(document.getElementById('nbPersonnes').value);
    const rfr = parseFloat(document.getElementById('rfr').value);
    const bloc = document.getElementById('mprResultBloc');

    if (!rfr || rfr <= 0) {
        bloc.style.display = 'none';
        return;
    }

    const seuils = getSeuilsForPersonnes(region, nb);
    let profil, icon, label, desc, bg, color;

    if (rfr <= seuils[0]) {
        profil = 'BLEU'; icon = '\uD83D\uDD35'; label = 'Profil Bleu'; desc = 'Revenus trÃ¨s modestes';
        bg = 'linear-gradient(135deg, #1e40af, #3b82f6)'; color = '#ffffff';
    } else if (rfr <= seuils[1]) {
        profil = 'JAUNE'; icon = '\uD83D\uDFE1'; label = 'Profil Jaune'; desc = 'Revenus modestes';
        bg = 'linear-gradient(135deg, #ca8a04, #eab308)'; color = '#ffffff';
    } else if (rfr <= seuils[2]) {
        profil = 'VIOLET'; icon = '\uD83D\uDFE3'; label = 'Profil Violet'; desc = 'Revenus intermÃ©diaires';
        bg = 'linear-gradient(135deg, #6b21a8, #a855f7)'; color = '#ffffff';
    } else {
        profil = 'ROSE'; icon = '<span style="display:inline-block;width:28px;height:28px;border-radius:50%;background:#f472b6;"></span>'; label = 'Profil Rose'; desc = 'Revenus supÃ©rieurs';
        bg = 'linear-gradient(135deg, #9d174d, #f472b6)'; color = '#ffffff';
    }

    const regionLabel = region === 'IDF' ? 'ÃŽle-de-France' : 'Province';
    const seuilIdx = profil === 'BLEU' ? 0 : (profil === 'JAUNE' ? 1 : 2);
    const seuilVal = seuils[seuilIdx];

    // Update bloc
    bloc.style.display = 'block';
    bloc.style.background = bg;
    bloc.style.color = color;
    document.getElementById('mprProfilIcon').innerHTML = icon;
    document.getElementById('mprProfilLabel').textContent = label;
    document.getElementById('mprProfilDesc').textContent = desc;
    const zn = document.getElementById('zone').value;
    document.getElementById('mprInfoRegion').textContent = regionLabel + ' Â· ' + zn;
    document.getElementById('mprInfoFoyer').textContent = nb + ' pers.';
    document.getElementById('mprInfoSeuil').textContent = profil === 'ROSE'
        ? '> ' + seuilVal.toLocaleString('fr-FR') + ' \u20AC'
        : '\u2264 ' + seuilVal.toLocaleString('fr-FR') + ' \u20AC';
    document.getElementById('mprInfoRFR').textContent = 'RFR dÃ©clarÃ© : ' + rfr.toLocaleString('fr-FR') + ' \u20AC';

    // Aide MPR pour le scÃ©nario en cours
    const sc = document.getElementById('scenario').value;
    const mpr = D.MPR[sc] ? D.MPR[sc][profil] : 0;
    document.getElementById('mprInfoAide').textContent = mpr > 0
        ? 'Aide MaPrimeRÃ©nov\' : ' + mpr.toLocaleString('fr-FR') + ' \u20AC'
        : 'Pas d\'aide MaPrimeRÃ©nov\' pour ce profil';

    document.getElementById('categorie').value = profil;

    // Sync catÃ©gorie mÃ©nage CEE
    document.getElementById('menageCEE').value = (profil === 'BLEU') ? 'tm' : 'autres';

    calc();
    calcCEEDetail();
}

function toggleRevenus() {
    const body = document.getElementById('revenusBody');
    const arrow = document.getElementById('toggleArrow');
    if (body) body.classList.toggle('open');
    if (arrow) arrow.classList.toggle('open');
}

// ============================================
// CEE DÃ‰TAIL \u2014 BAR-TH-171 / 143 / 148
// (Source : fiche BAR-TH-171 vA78.4)
// ============================================
const CEE_PRICE = { tm: 12.5, autres: 7.5 }; // \u20AC/MWhc

const BAR143 = { H1: 134800, H2: 121000, H3: 100500 };

// BAR-TH-148 v.A73.3 \u2014 Forfaits officiels (Ã  compter du 01/11/2025)
const BAR148 = { maison: 14700, appartement: 11800 };

const BAR171 = {
    maison: {
        base: { lt140: 90900, ge140: 109200 },
        coefSurface: (S) => (S < 70 ? 0.5 : (S < 90 ? 0.7 : 1.0)),
        tranches: "Maison : S<70\u21920,5 Â· 70\u2264S<90\u21920,7 Â· S\u226590\u21921"
    },
    appartement: {
        base: { lt140: 48700, ge140: 58900 },
        coefSurface: (S) => (S < 35 ? 0.5 : (S < 60 ? 0.7 : 1.0)),
        tranches: "Appart : S<35\u21920,5 Â· 35\u2264S<60\u21920,7 Â· S\u226560\u21921"
    },
    coefZone: { H1: 1.2, H2: 1.0, H3: 0.7 }
};


// Surface dropdown \u2192 catÃ©gorie pour table CEE (maison: les 5 anciennes catÃ©gories)
function surfaceToCategory(surfaceVal) {
    // surfaceVal comes from the dropdown: "S<70", "70<=S<90", "S>=90" (maison) or "S<35", "35<=S<60", "S>=60" (appart)
    // Map to table CEE keys
    const map = {
        'S<70': 'S<70', '70<=S<90': '70<S<90', 'S>=90': '90<S<110',
        'S<35': 'S<70', '35<=S<60': '70<S<90', 'S>=60': '90<S<110'
    };
    return map[surfaceVal] || '90<S<110';
}

function getSurfaceLabel() {
    const sel = document.getElementById('surface');
    return sel.options[sel.selectedIndex].text;
}

// Surface coef from dropdown value (BAR-TH-171 officiel)
function getSurfaceCoef(surfaceVal) {
    const map = { 'S<70': 0.5, '70<=S<90': 0.7, 'S>=90': 1, 'S<35': 0.5, '35<=S<60': 0.7, 'S>=60': 1 };
    return map[surfaceVal] || 1;
}

// Dynamic surface options based on type logement
function updateSurfaceOptions() {
    const tl = document.getElementById('typeLogement').value;
    const sel = document.getElementById('surface');
    const oldCoef = getSurfaceCoef(sel.value); // preserve coef level
    sel.innerHTML = '';
    if (tl === 'maison') {
        sel.add(new Option('S < 70 mÂ²', 'S<70'));
        sel.add(new Option('70 \u2264 S < 90 mÂ²', '70<=S<90'));
        sel.add(new Option('S \u2265 90 mÂ²', 'S>=90'));
    } else {
        sel.add(new Option('S < 35 mÂ²', 'S<35'));
        sel.add(new Option('35 \u2264 S < 60 mÂ²', '35<=S<60'));
        sel.add(new Option('S \u2265 60 mÂ²', 'S>=60'));
    }
    // Set option with same coef level
    const coefToMaison = { 0.5: 'S<70', 0.7: '70<=S<90', 1: 'S>=90' };
    const coefToAppart = { 0.5: 'S<35', 0.7: '35<=S<60', 1: 'S>=60' };
    const targetMap = tl === 'maison' ? coefToMaison : coefToAppart;
    sel.value = targetMap[oldCoef] || sel.options[sel.options.length - 1].value;
}

function onTypeLogementChange() {
    updateSurfaceOptions();
    calc();
}

function syncEtas() {
    const val = document.getElementById('etas').value;
    document.getElementById('ceeEtas').value = (val === '111-140') ? 'lt140' : 'ge140';
    calcCEEDetail();
}

// ===== PRODUIT & OPTIONS =====
function updatePAC() {
    var key = document.getElementById('marquePAC').value;
    var p = PAC_CATALOG[key];
    var el = document.getElementById('pacInfo');
    if (!p || !el) return;
    var ev = (p.etas || '').split('/').map(function(s){ return parseFloat(s.trim()); });
    var appType = (ev.length > 1 && ev[1] >= 100) ? 'Haute temp\u00e9rature' : 'Basse temp\u00e9rature';
    var etasHT = ev.length > 1 ? ev[1] : ev[0];
    el.innerHTML = '<b>' + p.m + '</b> \u00b7 ' + p.cls + ' \u00b7 ETAS ' + p.etas + '% \u00b7 COP ' + p.cop35 + '/' + p.cop55 + ' \u00b7 ' + p.ref + ' \u00b7 ' + p.dim +
        '<br><span style="color:#16a34a">\u2192 Application : <b>' + appType + '</b> \u00b7 ETAS HT : <b>' + etasHT + '%</b> (' + (etasHT >= 140 ? '\u2265 140%' : '111-140%') + ')</span>';
    var dm = document.getElementById('dimMarque');
    var dr = document.getElementById('dimReference');
    if (dm) dm.value = p.m;
    if (dr) dr.value = p.r;
}

function syncEtasFromPAC() {
    var key = document.getElementById('marquePAC').value;
    var p = PAC_CATALOG[key];
    if (!p) return;
    var ev = (p.etas || '').split('/').map(function(s){ return parseFloat(s.trim()); });
    var etasHT = ev.length > 1 ? ev[1] : ev[0];
    var etasSel = document.getElementById('etas');
    if (etasSel) {
        etasSel.value = etasHT >= 140 ? '140-170' : '111-140';
        syncEtas();
    }
}

function toggleProduitOpt(id, show) {
    var el = document.getElementById(id);
    if (!el) return;
    el.style.display = show ? 'block' : 'none';
    autoSyncScenario();
}

function getAutoScenario() {
    var ssc = document.getElementById('includeSSC');
    var bal = document.getElementById('includeBallon');
    if (ssc && ssc.value === 'oui') return 'PAC + SSC';
    if (bal && bal.value === 'oui') return 'PAC + BALLON THERMO';
    return 'PAC';
}

function autoSyncScenario() {
    var sc = getAutoScenario();
    var sel = document.getElementById('scenario');
    if (sel) { sel.value = sc; }
    var disp = document.getElementById('scenarioAutoDisplay');
    if (disp) { disp.value = sc; }
    syncEtasFromPAC();
    onScenarioChange();
}

function onScenarioChange() {
    const sc = document.getElementById('scenario').value;
    const isSSC = (sc === 'SSC');
    // SSC seul: hide ETAS, surface, barÃ¨me PAC (143 = forfait zone only)
    document.getElementById('etasGroup').style.display = isSSC ? 'none' : '';
    document.getElementById('ceeSurfaceGroup').style.display = isSSC ? 'none' : '';
    document.getElementById('baremeCard').style.display = isSSC ? 'none' : '';
    const dimCard = document.getElementById('dimensionnementCard');
    if (dimCard) dimCard.style.display = isSSC ? 'none' : '';
    // Demande mairie for SSC scenarios
    const mairieRow = document.getElementById('mairieRow');
    if (mairieRow) mairieRow.style.display = (sc === 'PAC + SSC' || sc === 'SSC') ? '' : 'none';
    detectProfil();
    calc();
    if(typeof logScenarioChange==='function') logScenarioChange();
}

let _calcRunning = false;

let lastCEEDetailPrime = 0;
let lastCEEDetailKwhc = 0;

function toggleCEE() {
    const body = document.getElementById('ceeBody');
    const arrow = document.getElementById('ceeToggleArrow');
    if (body) body.classList.toggle('open');
    if (arrow) arrow.classList.toggle('open');
}

// Quelle(s) fiche(s) BAR-TH s'appliquent selon le scÃ©nario
// Depuis 01/01/2026 : BAR-TH-148 NON cumulable avec BAR-TH-171 (arrÃªtÃ© 15/12/2025)
function getCEEFiches(scenario) {
    switch(scenario) {
        case 'PAC':                    return ['171'];
        case 'PAC + BALLON Ã‰LECTRIQUE': return ['171'];
        case 'PAC + BALLON THERMO':     return ['171']; // 148 non cumulable depuis 01/2026
        case 'PAC + SSC':              return ['171', '143']; // cumul 171+143, CdP sur 171 uniquement
        case 'SSC':                    return ['143']; // SSC seul = BAR-TH-143 uniquement
        default:                        return ['171'];
    }
}

function calcCEEDetail() {
  try {
    const sc = document.getElementById('scenario').value;
    const zn = document.getElementById('zone').value;
    const menage = document.getElementById('menageCEE').value;
    const price = CEE_PRICE[menage] || CEE_PRICE.autres;
    const tl = document.getElementById('typeLogement').value;
    const surfaceVal = document.getElementById('surface').value;
    const coefS = getSurfaceCoef(surfaceVal);

    // Update surface info label
    const ceeSurfInfo = document.getElementById('ceeSurfaceInfo');
    if (ceeSurfInfo) {
        const s = parseInt(document.getElementById('ceeSurface').value) || 0;
        if (tl === 'maison') {
            ceeSurfInfo.textContent = s < 70 ? '\u2192 S < 70 mÂ² (coef 0,5)' : (s < 90 ? '\u2192 70 \u2264 S < 90 mÂ² (coef 0,7)' : '\u2192 S \u2265 90 mÂ² (coef 1)');
        } else {
            ceeSurfInfo.textContent = s < 35 ? '\u2192 S < 35 mÂ² (coef 0,5)' : (s < 60 ? '\u2192 35 \u2264 S < 60 mÂ² (coef 0,7)' : '\u2192 S \u2265 60 mÂ² (coef 1)');
        }
    }

    const fiches = getCEEFiches(sc);

    // Labels
    document.getElementById('ceeScenarioLabel').textContent = SCENARIO_NAMES[sc] || sc;
    document.getElementById('ceeFichesLabel').textContent = fiches.map(f => 'BAR-TH-' + f).join(' + ');
    const noteEl = document.getElementById('ceeNonCumulNote');
    if (noteEl) { noteEl.style.display = 'none'; }

    // Show/hide blocs
    document.getElementById('ceeBloc171').classList.toggle('cee-hidden', !fiches.includes('171'));
    document.getElementById('ceeBloc148').classList.toggle('cee-hidden', !fiches.includes('148'));
    document.getElementById('ceeBloc143').classList.toggle('cee-hidden', !fiches.includes('143'));

    let totalKwhc = 0;
    let details = [];
    let statusParts = [];

    // === BAR-TH-171 ===
    if (fiches.includes('171')) {
        const etasKey = document.getElementById('etas').value === '111-140' ? 'lt140' : 'ge140';
        const base = BAR171[tl].base[etasKey];
        const cz = BAR171.coefZone[zn];
        document.getElementById('ceeCoefSurface').value = coefS.toString().replace('.', ',');
        const CDP = 5; // Coup de pouce Chauffage \u00D75 (arrÃªtÃ© 74e, oct 2025)
        const kwhc171 = base * coefS * cz * CDP;
        totalKwhc += kwhc171;
        details.push(`171: ${fmtIntCEE(kwhc171)}`);
        statusParts.push(`\u2705 171: base ${fmtIntCEE(base)} \u00D7 coef ${coefS} \u00D7 zone ${cz} \u00D7 CdP \u00D7${CDP}`);
    }

    // === BAR-TH-148 ===
    if (fiches.includes('148')) {
        const kwhc148 = BAR148[tl] || 14700;
        totalKwhc += kwhc148;
        details.push(`148: ${fmtIntCEE(kwhc148)}`);
        const typeLabel = tl === 'maison' ? 'Maison' : 'Appart';
        document.getElementById('cee148Forfait').value = `${fmtIntCEE(kwhc148)} kWhc (${typeLabel})`;
        const prime148 = (kwhc148 / 1000) * price;
        document.getElementById('ceeOut148').textContent = fmtEurCEE(prime148);
        document.getElementById('ceeOut148Detail').textContent = `${fmtIntCEE(kwhc148)} kWhc`;
        document.getElementById('ceeKpi148').style.display = 'block';
        statusParts.push(`\u2705 148: ${fmtIntCEE(kwhc148)} kWhc (v.A73.3 Â· ${typeLabel})`);
    } else {
        document.getElementById('ceeKpi148').style.display = 'none';
    }

    // === BAR-TH-143 ===
    if (fiches.includes('143')) {
        const base143 = BAR143[zn];
        const CDP143 = 2;
        const kwhc143avecCdP = base143 * CDP143;
        // Si cumul avec 171 : CdP va sur 171 (\u00D75 > \u00D72), 143 = forfait base
        // Si 143 seul : CdP \u00D72 applicable
        const has171 = fiches.includes('171');
        const kwhc143 = has171 ? base143 : kwhc143avecCdP;
        totalKwhc += kwhc143;
        details.push(`143: ${fmtIntCEE(kwhc143)}`);
        if (has171) {
            document.getElementById('cee143Forfait').value = `${fmtIntCEE(base143)} kWhc (${zn}) \u2014 CdP sur 171`;
            statusParts.push(`\u2705 143: forfait ${zn} = ${fmtIntCEE(base143)} kWhc (CdP \u00D7${CDP143} = ${fmtIntCEE(kwhc143avecCdP)} si seul)`);
        } else {
            document.getElementById('cee143Forfait').value = `${fmtIntCEE(base143)} \u00D7 ${CDP143} = ${fmtIntCEE(kwhc143avecCdP)} kWhc (${zn})`;
            statusParts.push(`\u2705 143: forfait ${zn} ${fmtIntCEE(base143)} \u00D7 CdP \u00D7${CDP143} = ${fmtIntCEE(kwhc143avecCdP)} kWhc`);
        }
    }

    const primeCEE = (totalKwhc / 1000) * price;
    lastCEEDetailPrime = primeCEE;
    lastCEEDetailKwhc = totalKwhc;

    document.getElementById('ceeOutKwhc').textContent = `${fmtIntCEE(totalKwhc)} kWhc`;
    document.getElementById('ceeOutDetail').textContent = details.join(' + ');
    document.getElementById('ceeOutPrime').textContent = fmtEurCEE(primeCEE);
    document.getElementById('ceeOutPrix').textContent = `${price.toString().replace('.', ',')} \u20AC/MWhc Â· ${menage === 'tm' ? 'TrÃ¨s modestes' : 'Autres'}`;

    const resultEl = document.getElementById('ceeResult');
    if (statusParts.length > 0) {
        resultEl.className = 'cee-result show';
        resultEl.innerHTML = statusParts.join('<br>');
    } else {
        resultEl.className = 'cee-result';
    }

  } catch(e) {
    console.error('calcCEEDetail() error:', e);
    if(typeof dbg==='function') dbg('\u274C calcCEEDetail: '+e.message+' at line '+(e.stack||'').split('\n')[1]);
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = 'âš \u0161\u00A0 CEEDetail: ' + e.message; errDiv.style.display = 'block'; errDiv.style.color = '#dc2626'; errDiv.style.background = '#fef2f2'; }
  }
}

function fmtIntCEE(n) {
    return isFinite(n) ? Math.round(n).toLocaleString('fr-FR') : '\u2014';
}
function fmtEurCEE(n) {
    return isFinite(n) ? Math.round(n).toLocaleString('fr-FR') + ' \u20AC' : '\u2014';
}

// ============================================
// DONNÃ‰ES PRINCIPALES
// ============================================
const D={TTC:{"PAC":10890,"PAC + BALLON Ã‰LECTRIQUE":13750,"PAC + BALLON THERMO":13750,"PAC + SSC":25850,"SSC":15000},MPR:{"PAC":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON Ã‰LECTRIQUE":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON THERMO":{BLEU:6200,JAUNE:4800,VIOLET:3400,ROSE:0},"PAC + SSC":{BLEU:15000,JAUNE:12000,VIOLET:7000,ROSE:0},"SSC":{BLEU:10000,JAUNE:8000,VIOLET:4000,ROSE:0}},COUT:{"PAC":6600,"PAC + BALLON Ã‰LECTRIQUE":6800,"PAC + BALLON THERMO":7200,"PAC + SSC":11650,"SSC":8500},COUT_DETAIL:{"PAC":{pac_materiel:2900,pac_pose:2500,ballon_materiel:0,ballon_pose:0,accessoires:800,admin:400,mairie:0},"PAC + BALLON Ã‰LECTRIQUE":{pac_materiel:2900,pac_pose:2500,ballon_materiel:200,ballon_pose:0,accessoires:800,admin:400,mairie:0},"PAC + BALLON THERMO":{pac_materiel:2900,pac_pose:2500,ballon_materiel:1100,ballon_pose:500,accessoires:800,admin:400,mairie:0},"PAC + SSC":{pac_materiel:5700,pac_pose:4500,ballon_materiel:0,ballon_pose:0,accessoires:800,admin:400,mairie:250},"SSC":{pac_materiel:4200,pac_pose:3500,ballon_materiel:0,ballon_pose:0,accessoires:500,admin:300,mairie:250}},CEE:{"140-170":{H1:{PAC:{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON ELECTRIQUE":{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON THERMO":{"S<70":289500,"70<S<90":399420,"90<S<110":564300,"110<S<130":619260,"S>130":894060},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON ELECTRIQUE":{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON THERMO":{"S<70":243700,"70<S<90":335300,"90<S<110":472700,"110<S<130":518500,"S>130":747500},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON ELECTRIQUE":{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON THERMO":{"S<70":175000,"70<S<90":239120,"90<S<110":335300,"110<S<130":367360,"S>130":527660},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}},"111-140":{H1:{PAC:{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON ELECTRIQUE":{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON THERMO":{"S<70":253200,"70<S<90":348600,"90<S<110":491700,"110<S<130":539400,"S>130":777900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON ELECTRIQUE":{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON THERMO":{"S<70":213450,"70<S<90":292950,"90<S<110":412200,"110<S<130":451950,"S>130":650700},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON ELECTRIQUE":{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON THERMO":{"S<70":153825,"70<S<90":209475,"90<S<110":292950,"110<S<130":320775,"S>130":459900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}}}};
const M={"PAC":"PAC","PAC + BALLON Ã‰LECTRIQUE":"BALLON ELECTRIQUE","PAC + BALLON THERMO":"BALLON THERMO","PAC + SSC":"BALLON SSC","SSC":"BALLON SSC"};

const SCENARIO_NAMES = {"PAC":"PAC","PAC + BALLON Ã‰LECTRIQUE":"PAC + Ballon Ã‰lectrique","PAC + BALLON THERMO":"PAC + Ballon Thermo","PAC + SSC":"PAC + SSC","SSC":"SSC"};

// ============================================
// CATALOGUE PAC â€” Fiches techniques complÃ¨tes
// ============================================
const PAC_CATALOG = {
    THALEOS_04M:{m:'THALEOS',n:'PAC THALEOS R290 4kW Mono ETAS 195%',r:'THAHP04-M',a:'220-240V/1Ph',cop35:'5,15',cop55:'3,20',cap35:'4,5kW',cap55:'4,6kW',cls:'A+++/A+++',etas:'195/151',scop:'5,20/4,00',db:'56dB(A)',dim:'1130x420x704mm',kg:'93Kg',ref:'R290',ch:'-',pr:'18A',rg:'6'},
    THALEOS_06M:{m:'THALEOS',n:'PAC THALEOS R290 6kW Mono ETAS 194%',r:'THAHP06-M',a:'220-240V/1Ph',cop35:'4,95',cop55:'3,15',cap35:'6,35kW',cap55:'6,40kW',cls:'A+++/A+++',etas:'194/151',scop:'5,24/4,03',db:'56dB(A)',dim:'1130x420x704mm',kg:'93Kg',ref:'R290',ch:'-',pr:'18A',rg:'6'},
    THALEOS_08M:{m:'THALEOS',n:'PAC THALEOS R290 8kW Mono ETAS 198%',r:'THAHP08-M',a:'220-240V/1Ph',cop35:'5,00',cop55:'3,30',cap35:'8,40kW',cap55:'7,80kW',cls:'A+++/A+++',etas:'198/152',scop:'5,21/3,94',db:'57dB(A)',dim:'1280x420x1040mm',kg:'141Kg',ref:'R290',ch:'-',pr:'18A',rg:'6'},
    THALEOS_10M:{m:'THALEOS',n:'PAC THALEOS R290 10kW Mono ETAS 203%',r:'THAHP10-M',a:'220-240V/1Ph',cop35:'4,80',cop55:'3,25',cap35:'10,0kW',cap55:'9,50kW',cls:'A+++/A+++',etas:'203/154',scop:'5,16/3,93',db:'57dB(A)',dim:'1280x420x1040mm',kg:'141Kg',ref:'R290',ch:'-',pr:'18A',rg:'6'},
    THALEOS_12M:{m:'THALEOS',n:'PAC THALEOS R290 12kW Mono ETAS 186%',r:'THAHP12-M',a:'220-240V/1Ph',cop35:'4,90',cop55:'3,25',cap35:'12,0kW',cap55:'12,0kW',cls:'A+++/A+++',etas:'186/150',scop:'4,96/3,86',db:'57dB(A)',dim:'1280x420x1040mm',kg:'156Kg',ref:'R290',ch:'1,35kg',pr:'35A',rg:'6'},
    THALEOS_14M:{m:'THALEOS',n:'PAC THALEOS R290 14kW Mono ETAS 186%',r:'THAHP14-M',a:'220-240V/1Ph',cop35:'4,80',cop55:'3,20',cap35:'14,0kW',cap55:'14,0kW',cls:'A+++/A+++',etas:'186/150',scop:'5,13/3,93',db:'58dB(A)',dim:'1280x420x1040mm',kg:'156Kg',ref:'R290',ch:'1,35kg',pr:'35A',rg:'6'},
    THALEOS_16M:{m:'THALEOS',n:'PAC THALEOS R290 16kW Mono ETAS 188%',r:'THAHP16-M',a:'220-240V/1Ph',cop35:'4,70',cop55:'3,15',cap35:'15,1kW',cap55:'15,1kW',cls:'A+++/A+++',etas:'188/150',scop:'5,16/3,89',db:'60dB(A)',dim:'1280x420x1040mm',kg:'156Kg',ref:'R290',ch:'1,35kg',pr:'35A',rg:'6'},
    THALEOS_08T:{m:'THALEOS',n:'PAC THALEOS R290 8kW Tri ETAS 198%',r:'THAHP08-T',a:'380-415V/3Ph',cop35:'5,00',cop55:'3,30',cap35:'8,40kW',cap55:'7,80kW',cls:'A+++/A+++',etas:'198/152',scop:'5,16/3,89',db:'57dB(A)',dim:'1280x420x1040mm',kg:'141Kg',ref:'R290',ch:'1,35kg',pr:'10A',rg:'6'},
    THALEOS_10T:{m:'THALEOS',n:'PAC THALEOS R290 10kW Tri ETAS 203%',r:'THAHP10-T',a:'380-415V/3Ph',cop35:'4,80',cop55:'3,25',cap35:'10,0kW',cap55:'9,50kW',cls:'A+++/A+++',etas:'203/154',scop:'5,16/3,93',db:'57dB(A)',dim:'1280x420x1040mm',kg:'141Kg',ref:'R290',ch:'1,35kg',pr:'10A',rg:'6'},
    THALEOS_12T:{m:'THALEOS',n:'PAC THALEOS R290 12kW Tri ETAS 150%',r:'THAHP12-T',a:'380-415V/3Ph',cop35:'4,90',cop55:'3,25',cap35:'12,0kW',cap55:'12,0kW',cls:'A+++/A+++',etas:'186/150',scop:'4,98/3,86',db:'58dB(A)',dim:'1280x420x1040mm',kg:'141Kg',ref:'R290',ch:'1,35kg',pr:'10A',rg:'6'},
    THALEOS_14T:{m:'THALEOS',n:'PAC THALEOS R290 14kW Tri ETAS 150%',r:'THAHP14-T',a:'380-415V/3Ph',cop35:'4,80',cop55:'3,20',cap35:'14,0kW',cap55:'14,0kW',cls:'A+++/A+++',etas:'186/150',scop:'5,13/3,93',db:'59dB(A)',dim:'1280x420x1040mm',kg:'156Kg',ref:'R290',ch:'1,35kg',pr:'14A',rg:'6'},
    THALEOS_16T:{m:'THALEOS',n:'PAC THALEOS R290 16kW Tri ETAS 150%',r:'THAHP16-T',a:'380-415V/3Ph',cop35:'4,70',cop55:'3,15',cap35:'15,1kW',cap55:'15,1kW',cls:'A+++/A+++',etas:'188/150',scop:'5,05/3,88',db:'60dB(A)',dim:'1280x420x1040mm',kg:'156Kg',ref:'R290',ch:'1,35kg',pr:'14A',rg:'6'},
    THALEOS_BI_08M:{m:'THALEOS',n:'PAC THALEOS Bi-Bloc R290 8kW Mono ETAS 198%',r:'THAHPOUT8KW-M',a:'220-240V/1Ph',cop35:'5,00',cop55:'3,30',cap35:'8,10kW',cap55:'7,60kW',cls:'A+++/A+++',etas:'198/152',scop:'5,16/3,89',db:'57dB(A)',dim:'1280x420x1040mm',kg:'128Kg',ref:'R290',ch:'1,35kg',pr:'18A',rg:'6'},
    THALEOS_BI_10M:{m:'THALEOS',n:'PAC THALEOS Bi-Bloc R290 10kW Mono ETAS 203%',r:'THAHPOUT10KW-M',a:'220-240V/1Ph',cop35:'4,80',cop55:'3,25',cap35:'9,80kW',cap55:'9,40kW',cls:'A+++/A+++',etas:'203/154',scop:'5,16/3,93',db:'57dB(A)',dim:'1280x420x1040mm',kg:'128Kg',ref:'R290',ch:'1,35kg',pr:'18A',rg:'6'},
    THALEOS_BI_12M:{m:'THALEOS',n:'PAC THALEOS Bi-Bloc R290 12kW Mono ETAS 186%',r:'THAHPOUT12KW-M',a:'220-240V/1Ph',cop35:'4,90',cop55:'3,25',cap35:'11,6kW',cap55:'11,5kW',cls:'A+++/A+++',etas:'186/150',scop:'4,98/3,86',db:'58dB(A)',dim:'1280x420x1040mm',kg:'143Kg',ref:'R290',ch:'1,35kg',pr:'18A',rg:'6'},
    THALEOS_BI_14M:{m:'THALEOS',n:'PAC THALEOS Bi-Bloc R290 14kW Mono ETAS 186%',r:'THAHPOUT14KW-M',a:'220-240V/1Ph',cop35:'4,80',cop55:'3,20',cap35:'13,6kW',cap55:'13,5kW',cls:'A+++/A+++',etas:'186/150',scop:'5,13/3,93',db:'59dB(A)',dim:'1280x420x1040mm',kg:'143Kg',ref:'R290',ch:'1,35kg',pr:'35A',rg:'6'},
    THALEOS_BI_16M:{m:'THALEOS',n:'PAC THALEOS Bi-Bloc R290 16kW Mono ETAS 188%',r:'THAHPOUT16KW-M',a:'220-240V/1Ph',cop35:'4,70',cop55:'3,15',cap35:'14,9kW',cap55:'14,9kW',cls:'A+++/A+++',etas:'188/150',scop:'5,05/3,88',db:'60dB(A)',dim:'1280x420x1040mm',kg:'143Kg',ref:'R290',ch:'1,35kg',pr:'35A',rg:'6'},
    WELLEA_12T:{m:'WELLEA',n:'PAC WELLEA R290 12kW HT Tri',r:'BDHW-120R-04T35',a:'380V/3Ph',cop35:'4,90',cop55:'3,25',cap35:'12,1kW',cap55:'12,1kW',cls:'A+++',etas:'150',scop:'3,86',db:'-',dim:'-',kg:'-',ref:'R290',ch:'-',pr:'-',rg:'6'},
    WELLEA_14T:{m:'WELLEA',n:'PAC WELLEA R290 14kW HT Tri',r:'BDHW-140R-04T35',a:'380V/3Ph',cop35:'4,80',cop55:'3,20',cap35:'14,5kW',cap55:'14,5kW',cls:'A+++',etas:'150',scop:'3,93',db:'-',dim:'-',kg:'-',ref:'R290',ch:'-',pr:'-',rg:'6'},
    WELLEA_16T:{m:'WELLEA',n:'PAC WELLEA R290 16kW HT Tri',r:'BDHW-160R-04T35',a:'380V/3Ph',cop35:'4,70',cop55:'3,15',cap35:'15,9kW',cap55:'15,9kW',cls:'A+++',etas:'150',scop:'3,88',db:'-',dim:'-',kg:'-',ref:'R290',ch:'-',pr:'-',rg:'6'},
    WELLEA_16M:{m:'WELLEA',n:'PAC WELLEA R290 16kW HT Mono',r:'BDHW-160R-04M25',a:'220-240V/1Ph',cop35:'4,70',cop55:'3,15',cap35:'15,9kW',cap55:'15,9kW',cls:'A+++',etas:'150',scop:'3,88',db:'-',dim:'-',kg:'-',ref:'R290',ch:'-',pr:'-',rg:'6'},
    WOLF_FHA_05_06_230:{m:'WOLF',n:'PAC WOLF FHA 05/06 5kW Mono ETAS 181%',r:'9148083',a:'220-240V/1Ph',cop35:'4,7',cop55:'3,1',cap35:'5,0kW',cap55:'5,0kW',cls:'A+++',etas:'181/127',scop:'4,7/3,1',db:'56,8dB(A)',dim:'1295x718x429mm',kg:'79+27Kg',ref:'R32',ch:'1,4kg',pr:'-',rg:'BM-2'},
    WOLF_FHA_06_07_230:{m:'WOLF',n:'PAC WOLF FHA 06/07 6kW Mono ETAS 167%',r:'9148084',a:'220-240V/1Ph',cop35:'5,2',cop55:'2,8',cap35:'6,0kW',cap55:'6,0kW',cls:'A++',etas:'167/129',scop:'5,2/2,8',db:'59,8dB(A)',dim:'1295x718x429mm',kg:'79+27Kg',ref:'R32',ch:'1,4kg',pr:'-',rg:'BM-2'},
    WOLF_FHA_08_10_230:{m:'WOLF',n:'PAC WOLF FHA 08/10 8kW Mono ETAS 196%',r:'9148085',a:'220-240V/1Ph',cop35:'4,9',cop55:'2,9',cap35:'8,0kW',cap55:'8,0kW',cls:'A+++',etas:'196/133',scop:'4,9/2,9',db:'60,5dB(A)',dim:'1385x865x526mm',kg:'88+27Kg',ref:'R32',ch:'1,4kg',pr:'-',rg:'BM-2'},
    WOLF_FHA_11_14_230:{m:'WOLF',n:'PAC WOLF FHA 11/14 11kW Mono ETAS 174%',r:'9148086',a:'220-240V/1Ph',cop35:'5,1',cop55:'3,1',cap35:'11,0kW',cap55:'11,0kW',cls:'A++',etas:'174/126',scop:'5,1/3,1',db:'60,8dB(A)',dim:'1385x865x526mm',kg:'122+27Kg',ref:'R32',ch:'1,75kg',pr:'-',rg:'BM-2'},
    WOLF_FHA_14_17_230:{m:'WOLF',n:'PAC WOLF FHA 14/17 14kW Mono ETAS 178%',r:'9148087',a:'220-240V/1Ph',cop35:'5,0',cop55:'3,1',cap35:'13,0kW',cap55:'13,0kW',cls:'A+++',etas:'178/131',scop:'5,0/3,1',db:'66,4dB(A)',dim:'1385x865x526mm',kg:'122+27Kg',ref:'R32',ch:'1,75kg',pr:'-',rg:'BM-2'},
    WOLF_FHA_14_17_400:{m:'WOLF',n:'PAC WOLF FHA 14/17 14kW Tri ETAS 173%',r:'9148089',a:'380-415V/3Ph',cop35:'5,1',cop55:'3,1',cap35:'14,0kW',cap55:'13,0kW',cls:'A++',etas:'173/129',scop:'5,1/3,1',db:'66,6dB(A)',dim:'1385x865x526mm',kg:'122+27Kg',ref:'R32',ch:'1,75kg',pr:'-',rg:'BM-2'}
};

function getCEE(et, zn, cs, sf){
    if(!D.CEE[et]) return 0;
    if(!D.CEE[et][zn]) return 0;
    if(!D.CEE[et][zn][cs]) return 0;
    if(!D.CEE[et][zn][cs][sf]) return 0;
    return D.CEE[et][zn][cs][sf];
}

let mode=0;
let autoGesteApplied = false;
let savedRacPourcent = 0;
let savedRacOffert = 0;

function fmt(n){
    return Math.round(n).toLocaleString('fr-FR')+' \u20AC';
}

function onTTCEdit(){
    const el = document.getElementById('totalTTCEditable');
    const raw = el.textContent.replace(/[^0-9]/g, '');
    const val = parseInt(raw) || 0;
    document.getElementById('totalTTCInput').value = val;
    document.getElementById('lockTTC').checked = false;
    calc();
}

// Prevent Enter from adding linebreaks, and reformat on blur
document.addEventListener('DOMContentLoaded', function(){
    const tte = document.getElementById('totalTTCEditable');
    if(tte){
        tte.addEventListener('keydown', function(e){
            if(e.key === 'Enter'){ e.preventDefault(); tte.blur(); }
        });
        tte.addEventListener('blur', function(){
            const raw = tte.textContent.replace(/[^0-9]/g, '');
            const val = parseInt(raw) || 0;
            document.getElementById('totalTTCInput').value = val;
            tte.textContent = fmt(val);
        });
    }
});

function updateFromTTC(){
    document.getElementById('lockTTC').checked=false;
    calc();
}

function updateFromDetail(){
    document.getElementById('lockCoutHT').checked=false;
    
    const fields = [
        ['coutPACMateriel','qtePACMateriel','totalPACMateriel'],
        ['coutPACPose','qtePACPose','totalPACPose'],
        ['coutBallonMateriel','qteBallonMateriel','totalBallonMateriel'],
        ['coutBallonPose','qteBallonPose','totalBallonPose'],
        ['coutAccessoires','qteAccessoires','totalAccessoires'],
        ['coutAdmin','qteAdmin','totalAdmin'],
        ['coutMandat','qteMandat','totalMandat'],
        ['coutMairie','qteMairie','totalMairie']
    ];
    
    let totalGlobal = 0;
    fields.forEach(([cId, qId, tId]) => {
        const c = parseFloat(document.getElementById(cId).value) || 0;
        const q = parseFloat(document.getElementById(qId).value) || 0;
        const t = c * q;
        document.getElementById(tId).textContent = fmt(t);
        totalGlobal += t;
    });
    
    // PrÃ©visite (checkbox)
    const prevChecked = document.getElementById('checkPrevisite').checked;
    const prevCost = prevChecked ? (parseFloat(document.getElementById('coutPrevisite').value) || 0) : 0;
    document.getElementById('totalPrevisite').textContent = prevChecked ? fmt(prevCost) : '0 \u20AC';
    totalGlobal += prevCost;
    
    document.getElementById('coutTotalHTDisplay').textContent = fmt(totalGlobal);
    calc();
}

function getCoutFromFields() {
    const f = ['coutPACMateriel','coutPACPose','coutBallonMateriel','coutBallonPose','coutAccessoires','coutAdmin','coutMandat','coutMairie'];
    const q = ['qtePACMateriel','qtePACPose','qteBallonMateriel','qteBallonPose','qteAccessoires','qteAdmin','qteMandat','qteMairie'];
    let t = 0;
    for (let i = 0; i < f.length; i++) {
        t += (parseFloat(document.getElementById(f[i]).value)||0) * (parseFloat(document.getElementById(q[i]).value)||0);
    }
    if (document.getElementById('checkPrevisite').checked) t += parseFloat(document.getElementById('coutPrevisite').value)||0;
    return t;
}

function getCoutFromDetail(sc, ad) {
    if (!D.COUT_DETAIL[sc]) return D.COUT[sc] || 0;
    const d = D.COUT_DETAIL[sc];
    let t = d.pac_materiel + d.pac_pose + d.ballon_materiel + d.ballon_pose + d.accessoires + d.admin + (d.mairie || 0);
    if (ad > 0) t += Math.round(ad * 0.12);
    if (document.getElementById('checkPrevisite').checked) t += parseFloat(document.getElementById('coutPrevisite').value)||200;
    return t;
}

// Frais pass-through (facturÃ©s au client, ajoutÃ©s au TTC)
// These are revenue items that shouldn't reduce margin
function getPassThrough() {
    if(mode) {
        const m = (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
        const r = (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
        const p = document.getElementById('checkPrevisite').checked ? (parseFloat(document.getElementById('coutPrevisite').value)||0) : 0;
        return m + r + p;
    } else {
        // Client mode: calculate from data
        const sc = document.getElementById('scenario').value;
        const ct = document.getElementById('categorie').value;
        const ad = (D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
        const d = D.COUT_DETAIL[sc];
        let pt = (d ? (d.mairie||0) : 0);
        if(ad > 0) pt += Math.round(ad * 0.12);
        if(document.getElementById('checkPrevisite').checked) pt += parseFloat(document.getElementById('coutPrevisite').value)||200;
        return pt;
    }
}

function calc(){
  try {
    _calcRunning = true;
    
    // Always recalculate CEE detail first (updates lastCEEDetailPrime)
    calcCEEDetail();
    
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    // Check if CEE override is active
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        if(lockTTC){
            tt = D.TTC[sc] || 0;
            document.getElementById('totalTTCInput').value=tt;
            const tte = document.getElementById('totalTTCEditable');
            if(tte) tte.textContent = fmt(tt);
        }else{
            tt=parseFloat(document.getElementById('totalTTCInput').value)||0;
        }
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                document.getElementById('coutPACMateriel').value = detail.pac_materiel;
                document.getElementById('qtePACMateriel').value = 1;
                document.getElementById('totalPACMateriel').textContent = fmt(detail.pac_materiel);
                document.getElementById('coutPACPose').value = detail.pac_pose;
                document.getElementById('qtePACPose').value = 1;
                document.getElementById('totalPACPose').textContent = fmt(detail.pac_pose);
                document.getElementById('coutBallonMateriel').value = detail.ballon_materiel;
                document.getElementById('qteBallonMateriel').value = detail.ballon_materiel > 0 ? 1 : 0;
                document.getElementById('totalBallonMateriel').textContent = fmt(detail.ballon_materiel);
                document.getElementById('coutBallonPose').value = detail.ballon_pose;
                document.getElementById('qteBallonPose').value = detail.ballon_pose > 0 ? 1 : 0;
                document.getElementById('totalBallonPose').textContent = fmt(detail.ballon_pose);
                document.getElementById('coutAccessoires').value = detail.accessoires;
                document.getElementById('qteAccessoires').value = 1;
                document.getElementById('totalAccessoires').textContent = fmt(detail.accessoires);
                document.getElementById('coutAdmin').value = detail.admin;
                document.getElementById('qteAdmin').value = 1;
                document.getElementById('totalAdmin').textContent = fmt(detail.admin);
                // Mandat MPR = 12% de l'aide MPR
                const mandatVal = Math.round(ad * 0.12);
                document.getElementById('coutMandat').value = mandatVal;
                document.getElementById('qteMandat').value = ad > 0 ? 1 : 0;
                document.getElementById('totalMandat').textContent = fmt(ad > 0 ? mandatVal : 0);
                // Demande mairie (SSC uniquement)
                const mairieVal = detail.mairie || 0;
                document.getElementById('coutMairie').value = mairieVal > 0 ? mairieVal : 250;
                document.getElementById('qteMairie').value = mairieVal > 0 ? 1 : 0;
                document.getElementById('totalMairie').textContent = fmt(mairieVal);
                // PrÃ©visite
                const prevOn = document.getElementById('checkPrevisite').checked;
                const prevCost = prevOn ? (parseFloat(document.getElementById('coutPrevisite').value) || 200) : 0;
                document.getElementById('totalPrevisite').textContent = prevOn ? fmt(prevCost) : '0 \u20AC';
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin + (ad > 0 ? mandatVal : 0) + mairieVal + prevCost;
            }else{
                ch = D.COUT[sc] || 0;
            }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
            ch += (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
            ch += (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
            if(document.getElementById('checkPrevisite').checked) ch += parseFloat(document.getElementById('coutPrevisite').value)||0;
        }
        document.getElementById('coutTotalHTDisplay').textContent = fmt(ch);
    }else{
        ch=getCoutFromDetail(sc, ad);
    }
    
    // Pass-through costs (mandat, mairie, prÃ©visite) are revenue items
    // They're displayed in costs but excluded from margin calculation
    const chForMarge = ch - getPassThrough();
    
    let ce;
    let ceForMarge, taForMarge;
    
    // Always use detailed CEE calculation (with Coup de pouce)
    ce = lastCEEDetailPrime;
    ceForMarge = ce;
    taForMarge = ad + ceForMarge;
    
    if(mode){
        // Sync prixCumac with mÃ©nage CEE category
        const menageVal = document.getElementById('menageCEE').value;
        const pxAuto = (menageVal === 'tm') ? 12.5 : 7.5;
        document.getElementById('prixCumac').value = pxAuto;
        document.getElementById('kwhCumac').value=Math.round(lastCEEDetailKwhc).toLocaleString('fr-FR');
    }
    
    const ceDisplay = ce;
    const ceeSourceText = getCEEFiches(sc).map(f => 'BAR-TH-' + f).join(' + ') + ' dÃ©taillÃ©';
    
    const ta=ad+ceDisplay;
    const rb=tt-ta;
    
    // Compute pro-level RAC (prix cumac trÃ¨s modestes) for auto-geste detection
    const proCEE = (lastCEEDetailKwhc / 1000) * 12.5;
    const proRB = tt - (ad + proCEE);
    
    // En vue client, si aides > TTC, ajuster l'affichage pour cohÃ©rence (TTC = aides + 1)
    const displayTTC = (!mode && rb < 0) ? (ta + 1) : tt;
    
    document.getElementById('totalTTC').textContent=fmt(displayTTC);
    const tteSync = document.getElementById('totalTTCEditable');
    if(tteSync && document.activeElement !== tteSync) tteSync.textContent = fmt(tt);
    document.getElementById('aidesMPR').textContent=fmt(ad);
    document.getElementById('aidesCEE').textContent=fmt(ceDisplay);
    document.getElementById('totalAides').textContent=fmt(ta);
    document.getElementById('ceeSourceLabel').textContent=ceeSourceText;
    
    if(mode) document.getElementById('displayCoutHT').textContent=fmt(ch);
    
    const st=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const ct2=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zn2=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const et2=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const sf2=getSurfaceLabel();
    const colorClass=ct==='BLEU'?'color-bleu':(ct==='JAUNE'?'color-jaune':(ct==='VIOLET'?'color-violet':'color-rose'));
    const borderColor=ct==='BLEU'?'#0071e3':(ct==='JAUNE'?'#fbbf24':(ct==='VIOLET'?'#8b5cf6':'#ec4899'));
    
    let summaryHTML;
    if (sc === 'SSC') {
        summaryHTML = `<strong class="${colorClass}">${st}</strong><span class="separator">\u2022</span>${ct2}<span class="separator">\u2022</span>Zone ${zn2}`;
    } else {
        summaryHTML = `<strong class="${colorClass}">${st}</strong><span class="separator">\u2022</span>${ct2}<span class="separator">\u2022</span>Zone ${zn2}<span class="separator">\u2022</span>${sf2}<span class="separator">\u2022</span>${et2}`;
    }
    document.getElementById('scenarioSummary').innerHTML = summaryHTML;
    document.getElementById('scenarioSummary').style.borderLeftColor=borderColor;
    
    calcRAC(rb,chForMarge,ta,taForMarge,tt,proRB);
    if(typeof dbg==='function') dbg('calc: sc='+sc+' ct='+ct+' ad='+ad+' ce='+ce+' ch='+ch+' chFM='+chForMarge+' tt='+tt+' rb='+rb+' taFM='+taForMarge+' proRB='+Math.round(proRB));
    
    _calcRunning = false;
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = ''; errDiv.style.display = 'none'; }
  } catch(e) {
    _calcRunning = false;
    console.error('calc() error:', e);
    if(typeof dbg==='function') dbg('\u274C calc: '+e.message+' at '+(e.stack||'').split('\n')[1]);
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = 'âš \u0161\u00A0 calc(): ' + e.message; errDiv.style.display = 'block'; errDiv.style.color = '#dc2626'; errDiv.style.background = '#fef2f2'; }
  }
}

function calcRAC(rb,ch,ta,taForMarge,tt,proRB){
    let po=parseFloat(document.getElementById('racPourcent').value)||0;
    let mo=parseFloat(document.getElementById('racOffert').value)||0;
    
    // Vue client : auto geste co quand le RAC pro est nÃ©gatif
    if(!mode && proRB !== undefined && proRB < 0 && rb > 1){
        if(!autoGesteApplied){
            savedRacPourcent = document.getElementById('racPourcent').value;
            savedRacOffert = document.getElementById('racOffert').value;
        }
        mo = rb - 1;
        po = rb > 0 ? Math.round((mo/rb)*100) : 0;
        document.getElementById('racOffert').value = Math.round(mo);
        document.getElementById('racPourcent').value = po;
        autoGesteApplied = true;
    } else if(mode && autoGesteApplied){
        document.getElementById('racPourcent').value = savedRacPourcent;
        document.getElementById('racOffert').value = savedRacOffert;
        po = parseFloat(savedRacPourcent) || 0;
        mo = parseFloat(savedRacOffert) || 0;
        autoGesteApplied = false;
    } else if(!mode && proRB !== undefined && proRB >= 0 && autoGesteApplied){
        document.getElementById('racPourcent').value = savedRacPourcent;
        document.getElementById('racOffert').value = savedRacOffert;
        po = parseFloat(savedRacPourcent) || 0;
        mo = parseFloat(savedRacOffert) || 0;
        autoGesteApplied = false;
    }
    
    const rc=rb-mo;
    // RAC nÃ©gatif \u2192 afficher 1\u20AC en vue client, vrai montant en vue fournisseur
    document.getElementById('resteCharge').textContent = (rc < 0 && !mode) ? '1 \u20AC' : fmt(rc);
    
    const rbForMarge = tt - taForMarge;
    const moForMarge = autoGesteApplied ? (parseFloat(savedRacOffert)||0) : mo;
    const rcForMarge = rbForMarge - moForMarge;
    const vhForMarge = Math.max(0,rcForMarge)/1.055;
    const mgForMarge = vhForMarge - ch + taForMarge;
    
    if(mode){
        document.getElementById('margeFinal').textContent=fmt(mgForMarge);
    }
    
    const currentScenario = document.getElementById('scenario').value;
    const seuilOK = (currentScenario === 'PAC + SSC' || currentScenario === 'SSC') ? 6000 : 4000;
    
    // Calculate max % offerable (fournisseur)
    if(mode){
        const maxPctEl = document.getElementById('maxPctValue');
        const maxPctBox = document.getElementById('maxPctInfo');
        if(maxPctEl){
            if(rb <= 0){
                // Aides cover entire TTC - no RAC to discount
                if(mgForMarge >= seuilOK){
                    maxPctEl.textContent = 'Aides > TTC \u2014 pas de RAC \u00e0 r\u00e9duire';
                    maxPctBox.style.background = 'rgba(5,150,105,0.12)';
                    maxPctBox.style.borderColor = 'rgba(5,150,105,0.25)';
                    maxPctBox.style.color = '#34d399';
                } else {
                    maxPctEl.textContent = '0% \u2014 marge insuffisante';
                    maxPctBox.style.background = 'rgba(220,38,38,0.12)';
                    maxPctBox.style.borderColor = 'rgba(220,38,38,0.25)';
                    maxPctBox.style.color = '#f87171';
                }
            } else {
                // Normal case: solve for max offert
                const maxOffert = rbForMarge - (seuilOK + ch - taForMarge) * 1.055;
                const maxPct = Math.max(0, Math.floor((maxOffert / rb) * 100));
                if(typeof dbg==='function') dbg('maxOff: maxOff='+Math.round(maxOffert)+' pct='+maxPct);
                if(maxOffert > 0){
                    maxPctEl.textContent = maxPct + '% (' + fmt(Math.floor(maxOffert)) + ')';
                    maxPctBox.style.background = 'rgba(5,150,105,0.12)';
                    maxPctBox.style.borderColor = 'rgba(5,150,105,0.25)';
                    maxPctBox.style.color = '#34d399';
                } else {
                    maxPctEl.textContent = '0% \u2014 marge insuffisante';
                    maxPctBox.style.background = 'rgba(220,38,38,0.12)';
                    maxPctBox.style.borderColor = 'rgba(220,38,38,0.25)';
                    maxPctBox.style.color = '#f87171';
                }
            }
        }
    }
    
    const bd=document.getElementById('statusBadge');
    const icon=document.getElementById('statusIcon');
    const txt=document.getElementById('statusText');
    if(typeof dbg==='function') dbg('RAC: mg='+Math.round(mgForMarge)+' seuil='+seuilOK+' rbFM='+Math.round(rbForMarge)+' ch='+Math.round(ch));
    if(mgForMarge>=seuilOK){
        bd.className='status-badge ok';
        bd.onclick=shareDevis;
        icon.textContent='\u2705';
        txt.textContent='Voulez-vous un devis ?';
    }else{
        bd.className='status-badge danger';
        bd.onclick=null;
        icon.textContent='\u274C';
        txt.textContent='Dossier refusÃ©';
    }
}

function shareDevis(){
    const nom=document.getElementById('nom').value.trim()||'Client';
    const prenom=document.getElementById('prenom').value.trim()||'';
    const scenario=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const ttc=document.getElementById('totalTTC').textContent;
    const totalAides=document.getElementById('totalAides').textContent;
    const rac=document.getElementById('resteCharge').textContent;
    
    const text = `\uD83C\uDFE0 Estimation PAC \u2014 ${prenom} ${nom}\n\n\uD83D\uDCCB ${scenario}\n\uD83D\uDCB0 Installation TTC : ${ttc}\n\uD83C\uDF81 Total aides : ${totalAides}\n\uD83C\uDFE0 Reste Ã  charge : ${rac}\n\nSimulation rÃ©alisÃ©e par Les Artisans Verts`;
    
    if(navigator.share){
        navigator.share({
            title: 'Devis PAC \u2014 ' + (prenom + ' ' + nom).trim(),
            text: text
        }).catch(()=>{});
    }else{
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(text).then(()=>{
            const bd=document.getElementById('statusBadge');
            const oldTxt=document.getElementById('statusText').textContent;
            document.getElementById('statusText').textContent='\u2713 CopiÃ© !';
            setTimeout(()=>{ document.getElementById('statusText').textContent=oldTxt; }, 2000);
        }).catch(()=>{
            window.open('https://api.whatsapp.com/send?text='+encodeURIComponent(text),'_blank');
        });
    }
}

function updatePct(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        tt = lockTTC ? (D.TTC[sc] || 0) : (parseFloat(document.getElementById('totalTTCInput').value)||0);
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin + (ad > 0 ? Math.round(ad * 0.12) : 0) + (detail.mairie || 0) + (document.getElementById("checkPrevisite").checked ? (parseFloat(document.getElementById("coutPrevisite").value) || 200) : 0);
            }else{ ch = D.COUT[sc] || 0; }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
            ch += (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
            ch += (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
            if(document.getElementById('checkPrevisite').checked) ch += parseFloat(document.getElementById('coutPrevisite').value)||0;
        }
    }else{ ch=getCoutFromDetail(sc, ad); }
    
    let ce = lastCEEDetailPrime;
    let ceForMarge = ce;
    let taForMarge = ad + ceForMarge;
    
    const chForMarge = ch - getPassThrough();
    const ta=ad+ce;
    const rb=tt-ta;
    
    let po=parseFloat(document.getElementById('racPourcent').value)||0;
    if(po>100)po=100; if(po<0)po=0;
    document.getElementById('racPourcent').value=Math.round(po);
    const mo=Math.round(rb*(po/100));
    document.getElementById('racOffert').value=mo;
    
    calcRAC(rb,chForMarge,ta,taForMarge,tt);
}

function updateAmt(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        tt = lockTTC ? (D.TTC[sc] || 0) : (parseFloat(document.getElementById('totalTTCInput').value)||0);
    }else{ tt=D.TTC[sc]||0; }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin;
            }else{ ch = D.COUT[sc] || 0; }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
            ch += (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
            ch += (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
            if(document.getElementById('checkPrevisite').checked) ch += parseFloat(document.getElementById('coutPrevisite').value)||0;
        }
    }else{ ch=getCoutFromDetail(sc, ad); }
    
    let ce = lastCEEDetailPrime;
    let ceForMarge = ce;
    let taForMarge = ad + ceForMarge;
    
    const chForMarge = ch - getPassThrough();
    const ta=ad+ce;
    const rb=tt-ta;
    
    let mo=parseFloat(document.getElementById('racOffert').value)||0;
    if(mo>rb)mo=rb; if(mo<0)mo=0;
    document.getElementById('racOffert').value=Math.round(mo);
    let po=rb>0?Math.round((mo/rb)*100):0;
    if(po>100)po=100; if(po<0)po=0;
    document.getElementById('racPourcent').value=po;
    
    calcRAC(rb,chForMarge,ta,taForMarge,tt);
}

function reset(){
    document.getElementById('scenario').value='PAC';
    document.getElementById('categorie').value='BLEU';
    document.getElementById('zone').value='H1';
    document.getElementById('etas').value='140-170';
    document.getElementById('surface').value='S>=90';
    document.getElementById('typeLogement').value='maison';
    document.getElementById('rfr').value='';
    document.getElementById('nbPersonnes').value='4';
    document.getElementById('mprResultBloc').style.display='none';
    updateSurfaceOptions();
    document.getElementById('racPourcent').value=0;
    document.getElementById('racOffert').value=0;
    if(mode){
        document.getElementById('prixCumac').value=12.5;
    }
    calc();
}

function checkExport(){
    const nom=document.getElementById('nom').value.trim();
    const prenom=document.getElementById('prenom').value.trim();
    const btn=document.getElementById('exportBtn');
    const wBtn=document.getElementById('whatsappBtn');
    const hint=document.getElementById('exportHint');
    if(nom&&prenom){
        btn.disabled=false; btn.style.cursor='pointer'; btn.style.opacity='1';
        wBtn.disabled=false; wBtn.style.cursor='pointer'; wBtn.style.opacity='1';
        if(hint) hint.style.display='none';
    }else{
        btn.disabled=true; btn.style.cursor='not-allowed'; btn.style.opacity='0.5';
        wBtn.disabled=true; wBtn.style.cursor='not-allowed'; wBtn.style.opacity='0.5';
        if(hint) hint.style.display='block';
    }
}

function sendWhatsApp(){
    if(typeof logExport==='function') logExport('WhatsApp');
    const nom=document.getElementById('nom').value.trim() || 'Client';
    const prenom=document.getElementById('prenom').value.trim() || '';
    const scenario=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const categorie=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zone=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const etas=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const surface=getSurfaceLabel();
    const ttc=document.getElementById('totalTTC').textContent;
    const aidesMPR=document.getElementById('aidesMPR').textContent;
    const aidesCEE=document.getElementById('aidesCEE').textContent;
    const totalAides=document.getElementById('totalAides').textContent;
    const rac=document.getElementById('resteCharge').textContent;
    const message=`\uD83C\uDFE0 *Demande de devis - Les Artisans Verts*%0A%0A\uD83D\uDC64 *Client :* ${prenom} ${nom}%0A%0A\uD83D\uDCCB *Configuration :*%0A\u2022 ScÃ©nario : ${scenario}%0A\u2022 ${categorie}%0A\u2022 ${zone}%0A\u2022 ${surface}%0A\u2022 ${etas}%0A%0A\uD83D\uDCB0 *Montants :*%0A\u2022 Total TTC : ${ttc}%0A\u2022 Aides MPR : ${aidesMPR}%0A\u2022 Aides CEE : ${aidesCEE}%0A\u2022 Total aides : ${totalAides}%0A\u2022 Reste Ã  charge : ${rac}%0A%0AJe souhaite obtenir un devis dÃ©taillÃ©.`;
    window.open(`https://api.whatsapp.com/send?text=${message}`, '_blank');
}

function exportPDF(){
    if(typeof logExport==='function') logExport('PDF');
    const nom=document.getElementById('nom').value.trim() || 'Client';
    const prenom=document.getElementById('prenom').value.trim() || '';
    const fullName = (prenom + ' ' + nom).trim();

    // En-tÃªte
    document.getElementById('printTitle').textContent = 'Dossier \u2014 ' + fullName;
    document.getElementById('printDate').textContent = new Date().toLocaleDateString('fr-FR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    document.getElementById('printCommercial').textContent = currentUser ? ('Commercial : ' + currentUser.name) : '';

    // Client info
    document.getElementById('printNom').textContent = fullName;
    document.getElementById('printDept').textContent = document.getElementById('departement').value || '\u2014';
    const zoneEl = document.getElementById('zone');
    document.getElementById('printZone').textContent = zoneEl ? zoneEl.value : '\u2014';
    const foyerEl = document.getElementById('foyer');
    document.getElementById('printFoyer').textContent = foyerEl ? foyerEl.options[foyerEl.selectedIndex].text : '\u2014';
    const rfr = document.getElementById('rfr').value;
    document.getElementById('printRFR').textContent = rfr ? parseInt(rfr).toLocaleString('fr-FR') + ' \u20AC' : '\u2014';

    // Profil MPR
    const profilLabel = document.getElementById('mprProfilLabel');
    const profilDesc = document.getElementById('mprProfilDesc');
    const profilCard = document.getElementById('printProfilCard');
    const cat = document.getElementById('categorie').value;
    const profilColors = { BLEU:'#2563eb', JAUNE:'#d97706', VIOLET:'#7c3aed', ROSE:'#db2777' };
    const profilIcons = { BLEU:'\uD83D\uDD35', JAUNE:'\uD83D\uDFE1', VIOLET:'\uD83D\uDFE3', ROSE:'\uD83D\uDD34' };
    profilCard.style.background = profilColors[cat] || '#64748b';
    document.getElementById('printProfilIcon').textContent = profilIcons[cat] || '\u26AA';
    document.getElementById('printProfilLabel').textContent = profilLabel ? profilLabel.textContent : cat;
    document.getElementById('printProfilDesc').textContent = profilDesc ? profilDesc.textContent : '';
    const seuilEl = document.getElementById('mprInfoSeuil');
    document.getElementById('printProfilSeuil').textContent = seuilEl ? ('Seuil : ' + seuilEl.textContent) : '';

    // Configuration technique
    const sc = document.getElementById('scenario');
    document.getElementById('printScenario').textContent = sc.options[sc.selectedIndex].text;
    const ceeSurf = document.getElementById('ceeSurface');
    document.getElementById('printSurface').textContent = (ceeSurf ? ceeSurf.value : '95') + ' mÂ²';
    const etas = document.getElementById('etas');
    document.getElementById('printETAS').textContent = etas ? etas.options[etas.selectedIndex].text : '\u2014';
    const baremeReco = document.getElementById('baremeReco');
    document.getElementById('printPACReco').textContent = baremeReco ? baremeReco.textContent : '\u2014';
    const isoState = document.getElementById('isoStateName');
    document.getElementById('printIsolation').textContent = isoState ? isoState.textContent : '\u2014';
    document.getElementById('printAnnee').textContent = document.getElementById('dimAnnee').value || '\u2014';

    // Montants
    document.getElementById('printTTC').textContent = document.getElementById('totalTTC').textContent;
    document.getElementById('printMPR').textContent = document.getElementById('aidesMPR').textContent;
    document.getElementById('printCEE').textContent = document.getElementById('aidesCEE').textContent;
    document.getElementById('printTotalAides').textContent = document.getElementById('totalAides').textContent;

    // DÃ©tail CEE
    const ceeFiches = document.getElementById('ceeFichesLabel');
    const ceeDetailEl = document.getElementById('ceeOutDetail');
    const ceePrixEl = document.getElementById('ceeOutPrix');
    let ceeDetail = '';
    if(ceeFiches) ceeDetail += 'Fiches : ' + ceeFiches.textContent;
    if(ceeDetailEl && ceeDetailEl.textContent !== '\u2014') ceeDetail += ' Â· ' + ceeDetailEl.textContent;
    if(ceePrixEl && ceePrixEl.textContent !== '\u2014') ceeDetail += ' Â· ' + ceePrixEl.textContent;
    document.getElementById('printCEEDetail').textContent = ceeDetail || '\u2014';

    // RAC
    document.getElementById('printRAC').textContent = document.getElementById('resteCharge').textContent;
    const pct = document.getElementById('racPourcent').value;
    const offert = document.getElementById('racOffert').value;
    if(parseInt(pct) > 0 || parseInt(offert) > 0){
        document.getElementById('printRACDetail').textContent = 'Prise en charge fournisseur : ' + pct + '% soit ' + offert + ' \u20AC';
    } else {
        document.getElementById('printRACDetail').textContent = '';
    }

    // Statut
    const badge = document.getElementById('statusBadge');
    const printStatus = document.getElementById('printStatus');
    printStatus.textContent = document.getElementById('statusText').textContent;
    if(badge.classList.contains('ok')){
        printStatus.style.background = '#dcfce7';
        printStatus.style.color = '#166534';
        printStatus.style.border = '2px solid #86efac';
    } else {
        printStatus.style.background = '#fef2f2';
        printStatus.style.color = '#991b1b';
        printStatus.style.border = '2px solid #fca5a5';
    }

    window.print();
}

// ============================================
// AUTHENTIFICATION PAR COMMERCIAL (API)
// ============================================
const API_URL = 'https://script.google.com/macros/s/AKfycbwMCcrAU9QrP6N6G2haz2dCdO4dFEH0aeNlyeIvpP5EDw_R2JTjSHrLr2E74EhUGlqn/exec';
const FALLBACK_USERS = {
    'ishay':   { pass:'lav',       name:'Ishay',       role:'admin' },
    'admin':   { pass:'gamberge',  name:'Admin',       role:'admin' },
    'mendy':   { pass:'mendy5786', name:'Mendy',       role:'commercial' },
    'david':   { pass:'david26',   name:'David',       role:'commercial' },
    'sarah':   { pass:'sarah26',   name:'Sarah',       role:'commercial' },
    'marc':    { pass:'marc26',    name:'Marc',        role:'commercial' },
    'julie':   { pass:'julie26',   name:'Julie',       role:'commercial' },
    'thomas':  { pass:'thomas26',  name:'Thomas',      role:'commercial' },
    'telepro': { pass:'telepro26', name:'TÃ©lÃ©prospecteur', role:'telepro' },
};
let currentUser = null;
let useAPI = false;

function apiCall(params, callback, errorCallback) {
    if (!API_URL) { if(errorCallback) errorCallback('Pas de serveur'); return; }
    const qs = Object.entries(params).map(([k,v])=>k+'='+encodeURIComponent(v)).join('&');
    fetch(API_URL + '?' + qs, {redirect:'follow'})
        .then(r => r.text())
        .then(txt => {
            let d;
            try { d = JSON.parse(txt); } catch(e) {
                const m = txt.match(/\{[\s\S]*\}/);
                if(m) try { d = JSON.parse(m[0]); } catch(e2){}
            }
            if(d) callback(d);
            else if(errorCallback) errorCallback('RÃ©ponse invalide');
        })
        .catch(e => { if(errorCallback) errorCallback(e.message); });
}

function apiPost(body, callback, errorCallback) {
    if (!API_URL) { if(errorCallback) errorCallback('Pas de serveur'); return; }
    fetch(API_URL, {method:'POST', redirect:'follow', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:JSON.stringify(body)})
        .then(r => r.text())
        .then(txt => {
            let d;
            try { d = JSON.parse(txt); } catch(e) {
                const m = txt.match(/\{[\s\S]*\}/);
                if(m) try { d = JSON.parse(m[0]); } catch(e2){}
            }
            if(d) callback(d);
            else if(errorCallback) errorCallback('RÃ©ponse invalide');
        })
        .catch(e => { if(errorCallback) errorCallback(e.message); });
}

function doLogin(){
    const u = document.getElementById('loginUser').value.trim().toLowerCase();
    const p = document.getElementById('loginPass').value;
    const errEl = document.getElementById('loginError');
    errEl.style.display = 'none';
    if(!u){ errEl.textContent='Veuillez saisir un identifiant'; errEl.style.display='block'; return; }

    if(API_URL) {
        // API mode
        errEl.textContent = 'Connexion...'; errEl.style.display='block'; errEl.style.color='#6b7280';
        apiCall({action:'login', user:u, pass:p}, function(d){
            errEl.style.color = '#dc2626';
            if(d.success){
                useAPI = true;
                const usr = d.user || {};
                currentUser = {
                    id: usr.username || u,
                    name: usr.name || u,
                    role: usr.role || 'commercial'
                };
                try{ localStorage.setItem('pac_user', JSON.stringify(currentUser)); localStorage.setItem('pac_api','1'); }catch(e){}
                showApp();
            } else {
                errEl.textContent = d.error || 'Identifiants incorrects';
                errEl.style.display = 'block';
            }
        }, function(err){
            // Fallback local
            errEl.style.color = '#dc2626';
            doLoginLocal(u, p, errEl);
        });
    } else {
        doLoginLocal(u, p, errEl);
    }
}
function doLoginLocal(u, p, errEl){
    const account = FALLBACK_USERS[u];
    if(!account || account.pass !== p){
        errEl.textContent = 'Identifiant ou mot de passe incorrect';
        errEl.style.display = 'block';
        errEl.style.color = '#dc2626';
        return;
    }
    useAPI = false;
    currentUser = { id:u, name:account.name, role:account.role };
    try{ localStorage.setItem('pac_user', JSON.stringify(currentUser)); localStorage.removeItem('pac_api'); }catch(e){}
    showApp();
    logAction('Connexion (local)', account.name);
}
document.getElementById('loginPass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
document.getElementById('loginUser').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

function doLogout(){
    logAction('DÃ©connexion', currentUser ? currentUser.name : '');
    currentUser = null;
    try{ localStorage.removeItem('pac_user'); localStorage.removeItem('pac_api'); }catch(e){}
    location.reload();
}

function goToLogin(){
    currentUser = null;
    try{ localStorage.removeItem('pac_user'); }catch(e){}
    document.getElementById('appScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
}

function doGuestLogin(){
    currentUser = { id:'guest', name:'Client', role:'guest' };
    try{ localStorage.setItem('pac_user', JSON.stringify(currentUser)); }catch(e){}
    showApp();
}

function switchView(v){
    const mc = document.getElementById('mainContent');
    const togC = document.getElementById('togClient');
    const togT = document.getElementById('togTelepro');
    const togF = document.getElementById('togFournisseur');
    // Reset all
    mc.classList.remove('fournisseur-mode', 'telepro-mode');
    togC.classList.remove('active');
    if(togT) togT.classList.remove('active');
    togF.classList.remove('active');
    
    if(v === 'fournisseur'){
        mode = 1;
        mc.classList.add('fournisseur-mode');
        togF.classList.add('active');
        document.getElementById('tabITE').style.display='';
        logAction('Vue fournisseur', '');
    } else if(v === 'telepro'){
        mode = 1;
        mc.classList.add('telepro-mode');
        if(togT) togT.classList.add('active');
        document.getElementById('tabITE').style.display='';
        logAction('Vue telepro', '');
    } else {
        mode = 0;
        togC.classList.add('active');
        document.getElementById('tabITE').style.display='none';
        // Force PAC tab in client view (ITE not available)
        switchTab('pac');
    }
    try{ calc(); }catch(e){}
}

function showApp(){
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';

    const isGuest = !currentUser || currentUser.role === 'guest';

    if(isGuest){
        // Vue client uniquement
        mode = 0;
        document.getElementById('mainContent').classList.remove('fournisseur-mode');
        document.getElementById('mainContent').classList.remove('telepro-mode');
        document.getElementById('guestBar').style.display = 'flex';
        document.getElementById('userBar').style.display = 'none';
        document.getElementById('tabITE').style.display = 'none';
        switchTab('pac'); // ITE not available in client view
    } else {
        document.getElementById('guestBar').style.display = 'none';
        document.getElementById('userBar').style.display = 'flex';
        document.getElementById('userNameDisplay').textContent = currentUser.name;
        
        const isAdmin = currentUser.role === 'admin';
        const isTelepro = currentUser.role === 'telepro';
        
        // Role label
        if(isAdmin) document.getElementById('userRoleDisplay').textContent = '\uD83D\uDC51 Admin';
        else if(isTelepro) document.getElementById('userRoleDisplay').textContent = '\uD83D\uDCDE TÃ©lÃ©prospecteur';
        else document.getElementById('userRoleDisplay').textContent = '\uD83D\uDCCA Commercial';
        
        // Tab visibility: admin sees all 3, telepro sees Client+Telepro, commercial sees Client+Pro
        const togT = document.getElementById('togTelepro');
        const togF = document.getElementById('togFournisseur');
        if(isAdmin){
            if(togT) togT.style.display = '';
            togF.style.display = '';
        } else if(isTelepro){
            if(togT) togT.style.display = '';
            togF.style.display = 'none';
        } else {
            if(togT) togT.style.display = 'none';
            togF.style.display = '';
        }
        
        // Default view
        if(isTelepro){
            switchView('telepro');
        } else {
            switchView('fournisseur');
        }
        
        // Admin-only buttons
        document.getElementById('btnHistory').style.display = isAdmin ? '' : 'none';
        document.getElementById('btnPwd').style.display = isAdmin ? '' : 'none';
        // Dossier button for all logged-in users
        document.getElementById('btnDossiers').style.display = '';
        
        // Auto-fill conseiller with user name
        var conSel = document.getElementById('iteConseiller');
        if(conSel){
            conSel.innerHTML = '<option value="'+currentUser.name+'">'+currentUser.name+'</option>';
            conSel.value = currentUser.name;
        }
    }

    try { updateSurfaceOptions(); } catch(e){}
    try { calc(); } catch(e){}
    try { buildBaremeTable(); } catch(e){}
    try { calcBareme(); } catch(e){}
    try { syncEtas(); } catch(e){}
    try { calcDim(); } catch(e){}
    try { syncProfilPrecarite(); } catch(e){}
}

function checkAutoLogin(){
    try{
        const stored = localStorage.getItem('pac_user');
        if(stored){
            const data = JSON.parse(stored);
            if(data && data.id){
                if(localStorage.getItem('pac_api')) useAPI = true;
                currentUser = data;
                showApp();
                return true;
            }
        }
    }catch(e){}
    return false;
}

// ============================================
// CHANGEMENT DE MOT DE PASSE
// ============================================
function openPwdModal(){
    document.getElementById('pwdOld').value = '';
    document.getElementById('pwdNew').value = '';
    document.getElementById('pwdConfirm').value = '';
    document.getElementById('pwdError').style.display = 'none';
    document.getElementById('pwdSuccess').style.display = 'none';
    document.getElementById('pwdModal').classList.add('active');
}
function doChangePassword(){
    const oldP = document.getElementById('pwdOld').value;
    const newP = document.getElementById('pwdNew').value;
    const conf = document.getElementById('pwdConfirm').value;
    const errEl = document.getElementById('pwdError');
    const okEl = document.getElementById('pwdSuccess');
    errEl.style.display = 'none';
    okEl.style.display = 'none';

    if(!oldP || !newP){ errEl.textContent='Tous les champs sont requis'; errEl.style.display='block'; return; }
    if(newP.length < 4){ errEl.textContent='Minimum 4 caractÃ¨res'; errEl.style.display='block'; return; }
    if(newP !== conf){ errEl.textContent='Les mots de passe ne correspondent pas'; errEl.style.display='block'; return; }

    if(useAPI && API_URL){
        errEl.textContent = 'Modification...'; errEl.style.display='block'; errEl.style.color='#6b7280';
        apiCall({action:'changePassword', user:currentUser.id, oldPass:oldP, newPass:newP}, function(d){
            errEl.style.color = '#dc2626';
            if(d.success){
                errEl.style.display = 'none';
                okEl.textContent = '\u2705 Mot de passe modifiÃ© !';
                okEl.style.display = 'block';
                setTimeout(()=>{ document.getElementById('pwdModal').classList.remove('active'); }, 1500);
            } else {
                errEl.textContent = d.error || 'Erreur';
                errEl.style.display = 'block';
            }
        }, function(err){
            errEl.textContent = 'Erreur serveur: ' + err;
            errEl.style.display = 'block';
            errEl.style.color = '#dc2626';
        });
    } else {
        // Mode local: update FALLBACK_USERS
        const account = FALLBACK_USERS[currentUser.id];
        if(!account){ errEl.textContent='Compte introuvable'; errEl.style.display='block'; return; }
        if(account.pass !== oldP){ errEl.textContent='Ancien mot de passe incorrect'; errEl.style.display='block'; return; }
        account.pass = newP;
        okEl.textContent = '\u2705 ModifiÃ© (session uniquement en mode local)';
        okEl.style.display = 'block';
        logAction('Changement mot de passe', currentUser.name);
        setTimeout(()=>{ document.getElementById('pwdModal').classList.remove('active'); }, 1500);
    }
}

// ============================================
// JOURNAL DES MODIFICATIONS
// ============================================
function getJournal(){
    try{ return JSON.parse(localStorage.getItem('pac_journal') || '[]'); }catch(e){ return []; }
}
function saveJournal(j){
    try{
        if(j.length > 200) j = j.slice(j.length - 200);
        localStorage.setItem('pac_journal', JSON.stringify(j));
    }catch(e){}
}
function logAction(action, detail){
    const entry = {
        date: new Date().toISOString(),
        user: currentUser ? currentUser.name : '?',
        role: currentUser ? currentUser.role : '?',
        action: action,
        detail: detail || ''
    };
    // Local journal
    const j = getJournal();
    j.push(entry);
    saveJournal(j);
    // API journal (fire and forget)
    if(useAPI && API_URL){
        apiCall({action:'log', user:entry.user, logAction:action, detail:detail||''}, function(){}, function(){});
    }
}
function openHistory(){
    if(useAPI && API_URL){
        // Fetch from server
        const body = document.getElementById('historyBody');
        body.innerHTML = '<div class="hist-empty">Chargement...</div>';
        document.getElementById('historyModal').classList.add('active');
        apiCall({action:'getJournal', limit:'100'}, function(d){
            renderJournal(d.journal || []);
        }, function(err){
            // Fallback to local
            renderJournal(getJournal().reverse().slice(0, 100));
        });
    } else {
        renderJournal(getJournal().reverse().slice(0, 100));
        document.getElementById('historyModal').classList.add('active');
    }
}
function renderJournal(entries){
    const body = document.getElementById('historyBody');
    if(!entries || entries.length === 0){
        body.innerHTML = '<div class="hist-empty">Aucune entrÃ©e dans le journal</div>';
        return;
    }
    let html = '';
    entries.forEach(e => {
        const d = new Date(e.date);
        const dateStr = d.toLocaleDateString('fr-FR') + ' ' + d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
        html += '<div class="hist-entry">';
        html += '<div class="hist-meta"><span class="hist-user">' + (e.user||'?') + '</span><span class="hist-date">' + dateStr + '</span></div>';
        html += '<div class="hist-action">' + (e.action||'') + '</div>';
        if(e.detail) html += '<div class="hist-detail">' + e.detail + '</div>';
        html += '</div>';
    });
    if(currentUser && currentUser.role === 'admin'){
        html += '<div class="hist-clear"><button onclick="clearJournal()">\uD83D\uDDD1\uFE0F Vider le journal</button></div>';
    }
    body.innerHTML = html;
}
function clearJournal(){
    if(confirm('Vider tout le journal ?')){
        try{ localStorage.setItem('pac_journal','[]'); }catch(e){}
        openHistory();
    }
}

// Log key actions
function logScenarioChange(){
    const sc = document.getElementById('scenario').value;
    logAction('Changement scÃ©nario', sc);
}
function logClientChange(){
    const nom = document.getElementById('nom').value.trim();
    const prenom = document.getElementById('prenom').value.trim();
    if(nom || prenom) logAction('Client modifiÃ©', (prenom + ' ' + nom).trim());
}
function logExport(type){
    const nom = document.getElementById('nom').value.trim() || 'Client';
    logAction('Export ' + type, nom);
}
function logRACChange(){
    const pct = document.getElementById('racPourcent').value;
    const offert = document.getElementById('racOffert').value;
    logAction('RAC modifiÃ©', pct + '% / ' + offert + ' \u20AC');
}


// ============================================
// SCROLL GRADIENT
// ============================================
(function() {
    const gradients = [
        'linear-gradient(90deg, #34d399, #22d3ee, #818cf8)',
        'linear-gradient(90deg, #22d3ee, #818cf8, #c084fc)',
        'linear-gradient(90deg, #818cf8, #c084fc, #f472b6)',
        'linear-gradient(90deg, #c084fc, #f472b6, #fb923c)',
        'linear-gradient(90deg, #f472b6, #fb923c, #fbbf24)',
        'linear-gradient(90deg, #fb923c, #fbbf24, #34d399)',
    ];
    let ticking = false;
    function updateScrollGradient() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = docHeight > 0 ? scrollTop / docHeight : 0;
        const idx = Math.min(Math.floor(scrollPercent * gradients.length), gradients.length - 1);
        document.documentElement.style.setProperty('--scroll-gradient', gradients[idx]);
        ticking = false;
    }
    window.addEventListener('scroll', function() {
        if (!ticking) { requestAnimationFrame(updateScrollGradient); ticking = true; }
    }, { passive: true });
    updateScrollGradient();
})();

// ============================================
// DIMENSIONNEMENT PAC
// ============================================

// Tbase par dÃ©partement (Â°C) - valeurs conventionnelles
const DEPT_TBASE = {
    '01':-10,'02':-9,'03':-8,'04':-8,'05':-10,'06':-5,'07':-6,'08':-10,'09':-8,'10':-10,
    '11':-5,'12':-8,'13':-5,'14':-7,'15':-10,'16':-5,'17':-5,'18':-8,'19':-8,'20':-2,
    '2A':-2,'2B':-2,'21':-10,'22':-4,'23':-8,'24':-5,'25':-12,'26':-6,'27':-7,'28':-7,
    '29':-4,'30':-5,'31':-5,'32':-5,'33':-5,'34':-5,'35':-5,'36':-7,'37':-7,'38':-10,
    '39':-10,'40':-5,'41':-7,'42':-8,'43':-10,'44':-5,'45':-7,'46':-5,'47':-5,'48':-10,
    '49':-5,'50':-5,'51':-10,'52':-10,'53':-5,'54':-12,'55':-10,'56':-4,'57':-12,'58':-10,
    '59':-9,'60':-7,'61':-7,'62':-9,'63':-8,'64':-5,'65':-5,'66':-5,'67':-12,'68':-12,
    '69':-8,'70':-12,'71':-10,'72':-7,'73':-12,'74':-12,'75':-7,'76':-7,'77':-7,'78':-7,
    '79':-5,'80':-9,'81':-5,'82':-5,'83':-3,'84':-6,'85':-5,'86':-5,'87':-8,'88':-12,
    '89':-10,'90':-12,'91':-7,'92':-7,'93':-7,'94':-7,'95':-7
};

let currentG = 0.95;

// ============ DIMENSIONNEMENT \u2014 AnnÃ©e \u2192 G auto ============

// Table G par annÃ©e de construction
function getGFromAnnee(annee) {
    if (annee >= 2021) return 0.6;   // RE 2020
    if (annee >= 2013) return 0.7;   // RT 2012
    if (annee >= 2006) return 0.75;  // RT 2005
    if (annee >= 2001) return 0.8;
    if (annee >= 1990) return 0.95;  // RT 2000
    if (annee >= 1983) return 1.1;
    if (annee >= 1975) return 1.3;   // 1Ã¨re rÃ©glementation
    return 1.6;                       // Avant 1975
}

let currentIsolation = 'origine';

function evalIsolation() {
    const checks = document.querySelectorAll('#isoChecklist input[type="checkbox"]:checked');
    const count = checks.length;
    let recentCount = 0;
    checks.forEach(cb => {
        const quand = cb.closest('.iso-check').querySelector('.iso-quand');
        if (quand && quand.value === 'recent') recentCount++;
    });

    // DÃ©termination auto de l'Ã©tat
    if (count === 0) {
        currentIsolation = 'origine';
    } else if (count >= 3 && recentCount >= 2) {
        currentIsolation = 'totale';
    } else {
        currentIsolation = 'partielle';
    }

    // Affichage
    const names = { origine: 'Ã‰tat d\'origine / Non prÃ©cisÃ©', partielle: 'RÃ©novation partielle', totale: 'RÃ©novation totale' };
    const colors = { origine: '#64748b', partielle: '#d97706', totale: '#16a34a' };
    const el = document.getElementById('isoStateName');
    if (el) { el.textContent = names[currentIsolation]; el.style.color = colors[currentIsolation]; }
    calcDim();
}

function selectIsolation(state) { currentIsolation = state; calcDim(); }

function getEffectiveG() {
    const annee = parseInt(document.getElementById('dimAnnee').value) || 2000;
    let g = getGFromAnnee(annee);
    if (currentIsolation === 'partielle') g = Math.max(g - 0.2, 0.5);
    if (currentIsolation === 'totale') g = Math.max(Math.min(g, 0.7), 0.5);
    return g;
}

// ============ BARÃˆME PAC ============
// Pattern: every 10mÂ², alternating single/double recommendations
// +2kW per 20mÂ² step
function getBaremePAC(surface) {
    if (surface <= 40) return [4];
    if (surface <= 50) return [6];
    // From 60mÂ²: pattern repeats every 20mÂ²
    // 60-70 = [6,8], 80 = [8], 90 = [8,10], 100 = [10], etc.
    const base = Math.floor((surface - 1) / 20); // 0-indexed group
    const inGroup = ((surface - 1) % 20) < 10 ? 0 : 1; // first or second half
    const kw = (base) * 2 + 4; // 4, 6, 8, 10, ...
    
    // Simpler approach: use explicit formula
    const step = Math.floor((surface - 1) / 10); // 0=\u226410, ... 3=31-40, 4=41-50, 5=51-60...
    const kwBase = Math.max(4, Math.floor(surface / 10) * 2);
    
    // Even simpler: keep the proven table + extend
    const table = [
        [40, [4]], [50, [6]], [60, [6,8]], [70, [6,8]], [80, [8]], [90, [8,10]],
        [100, [10]], [110, [10,12]], [120, [12]], [130, [12,14]], [140, [14]],
        [150, [14,16]], [160, [16]], [170, [16,18]], [180, [18]], [190, [18,20]],
        [200, [20]], [210, [20,22]], [220, [22]], [230, [22,24]], [240, [24]],
        [250, [24,26]], [260, [26]], [270, [26,28]], [280, [28]], [290, [28,30]],
        [300, [30]], [350, [30,35]], [Infinity, [35]]
    ];
    for (const [max, reco] of table) {
        if (surface <= max) return reco;
    }
    return [35];
}

function calcBareme() {
    const s = parseInt(document.getElementById('baremeSurface').value) || 100;
    const reco = getBaremePAC(s);
    const el = document.getElementById('baremeReco');
    const alt = document.getElementById('baremeAlt');
    const hint = document.getElementById('baremeIsoHint');
    const cursor = document.getElementById('baremeCursor');
    const lowEl = document.getElementById('baremeLow');
    const highEl = document.getElementById('baremeHigh');

    // Determine low and high power
    let lowKW, highKW;
    if (reco.length === 2) {
        lowKW = reco[0];
        highKW = reco[1];
    } else {
        lowKW = reco[0];
        highKW = reco[0] < 35 ? reco[0] + 2 : reco[0];
    }

    lowEl.textContent = lowKW + ' kW';
    highEl.textContent = highKW + ' kW';

    // Score: 0 = well insulated (left/green), 100 = poorly insulated (right/red)
    const annee = parseInt(document.getElementById('dimAnnee').value) || 2000;
    
    // Count checked isolation items
    const checks = document.querySelectorAll('#isoChecklist input[type="checkbox"]:checked');
    const totalChecks = checks.length; // 0 to 5
    let recentCount = 0;
    checks.forEach(cb => {
        const quand = cb.closest('.iso-check').querySelector('.iso-quand');
        if (quand && quand.value === 'recent') recentCount++;
    });

    // Base score from annÃ©e
    let score;
    if (annee < 1975) score = 90;
    else if (annee < 1990) score = 75;
    else if (annee < 2005) score = 55;
    else if (annee < 2012) score = 35;
    else score = 20;

    // Each checked item reduces score significantly
    // 5 items checked = max reduction
    const reductionPerItem = 12; // each item: -12
    const recentBonus = 3; // recent items: extra -3
    score -= totalChecks * reductionPerItem;
    score -= recentCount * recentBonus;

    // All 5 checked + all recent \u2192 score should be ~0-5
    // 5*12 + 5*3 = 75, from base 90 \u2192 15, from base 55 \u2192 -20 \u2192 clamped to 5

    // Clamp 3-97%
    score = Math.max(3, Math.min(97, score));

    // Position cursor
    cursor.style.left = `calc(${score}% - 12px)`;

    // Determine recommendation + auto-select PAC
    var recoKW;
    if (score <= 25) {
        el.textContent = lowKW + ' kW';
        el.style.color = '#16a34a';
        alt.textContent = 'Isolation performante \u2192 puissance optimisÃ©e';
        if (hint) hint.textContent = '';
        recoKW = lowKW;
    } else if (score >= 75) {
        el.textContent = highKW + ' kW';
        el.style.color = '#dc2626';
        alt.textContent = 'Isolation faible \u2192 puissance supÃ©rieure conseillÃ©e';
        if (hint) hint.textContent = '';
        recoKW = highKW;
    } else {
        el.textContent = lowKW + ' ou ' + highKW + ' kW';
        el.style.color = '#d97706';
        alt.textContent = lowKW + ' kW = Ã©conomique Â· ' + highKW + ' kW = confort';
        if (hint) hint.textContent = '';
        recoKW = highKW; // prefer comfort
    }
    // Auto-select best PAC from catalog (Wolf preferred)
    autoSelectPAC(recoKW);
}

function autoSelectPAC(targetKW) {
    // Priority: Wolf Mono (with 2kW tolerance) > exact match > closest
    var models = [];
    for (var key in PAC_CATALOG) {
        var p = PAC_CATALOG[key];
        var cap = parseFloat((p.cap35 || '').replace(',', '.')) || 0;
        var brand = (p.m || '').toUpperCase();
        var isMono = key.indexOf('_T') === -1 && key.indexOf('_400') === -1;
        models.push({key: key, brand: brand, kw: cap, mono: isMono});
    }
    // First pass: find best Wolf Mono within 2kW (round up preferred)
    var bestWolf = null, bestWolfDiff = Infinity;
    for (var i = 0; i < models.length; i++) {
        var m = models[i];
        if (!m.mono || m.brand !== 'WOLF') continue;
        var diff = m.kw - targetKW; // positive = larger (good for comfort)
        var absDiff = Math.abs(diff);
        if (absDiff <= 2 && (absDiff < bestWolfDiff || (absDiff === bestWolfDiff && diff > 0))) {
            bestWolf = m;
            bestWolfDiff = absDiff;
        }
    }
    // If Wolf found within tolerance, use it
    var best = bestWolf;
    // Otherwise fallback: closest Mono from any brand
    if (!best) {
        var bestDiff = Infinity;
        for (var j = 0; j < models.length; j++) {
            var m2 = models[j];
            if (!m2.mono) continue;
            var d = Math.abs(m2.kw - targetKW);
            if (d < bestDiff) { best = m2; bestDiff = d; }
        }
    }
    if (best) {
        var sel = document.getElementById('marquePAC');
        if (sel) {
            sel.value = best.key;
            sel.dispatchEvent(new Event('change'));
        }
    }
}

function syncMenageCEE() {
    const cat = document.getElementById('categorie').value;
    document.getElementById('menageCEE').value = (cat === 'BLEU') ? 'tm' : 'autres';
    calcCEEDetail();
}

function syncSurfaces(from) {
    const val = (from === 'bareme')
        ? document.getElementById('baremeSurface').value
        : (from === 'cee')
        ? document.getElementById('ceeSurface').value
        : document.getElementById('dimSurface').value;
    const s = parseInt(val) || 100;
    document.getElementById('baremeSurface').value = s;
    document.getElementById('dimSurface').value = s;
    const ceeSurf = document.getElementById('ceeSurface');
    if (ceeSurf) ceeSurf.value = s;

    // Auto-set surface dropdown (maison)
    const tl = document.getElementById('typeLogement').value;
    const sel = document.getElementById('surface');
    if (tl === 'maison') {
        if (s < 70) sel.value = 'S<70';
        else if (s < 90) sel.value = '70<=S<90';
        else sel.value = 'S>=90';
    } else {
        if (s < 35) sel.value = 'S<35';
        else if (s < 60) sel.value = '35<=S<60';
        else sel.value = 'S>=60';
    }

    calcBareme();
    calcDim();
    calcCEEDetail();
    calc();
}

function syncSurfaceFromClient() {
    var v = parseInt(document.getElementById('surfaceClient').value) || 0;
    if (v > 0) {
        document.getElementById('ceeSurface').value = v;
        syncSurfaces('cee');
    }
}

function buildBaremeTable() { /* table removed */ }

function selectG(g) { /* legacy compat */ currentG = g; calcDim(); }

function calcDim() {
    const S = parseFloat(document.getElementById('dimSurface').value) || 0;
    const H = parseFloat(document.getElementById('dimHauteur').value) || 2.5;
    const V = S * H;

    const Tbase = parseFloat(document.getElementById('dimTbase').value) || -7;
    const Tint = parseFloat(document.getElementById('dimTint').value) || 21;
    const deltaT = Tint - Tbase;

    const G = getEffectiveG();
    currentG = G;
    const gDisplay = document.getElementById('dimGDisplay');
    if (gDisplay) gDisplay.textContent = `G = ${G.toFixed(2).replace('.', ',')}`;

    const P = G * V * deltaT;
    const T1 = parseFloat(document.getElementById('dimT1').value) || 60;
    const T2 = parseFloat(document.getElementById('dimT2').value) || 140;

    const puissancePAC = P * T1 / 100;
    const puissanceTotale = P * T2 / 100;
    const puissanceAppoint = puissanceTotale - puissancePAC;

    document.getElementById('dimDeperditions').textContent = Math.round(P).toLocaleString('fr-FR') + ' W';
    document.getElementById('dimDepFormula').textContent = `${G.toFixed(2).replace('.', ',')} \u00D7 ${Math.round(V)} \u00D7 ${deltaT}`;

    document.getElementById('dimPuissancePAC').textContent = (puissancePAC / 1000).toFixed(1).replace('.', ',') + ' kW';
    document.getElementById('dimPuissancePACDetail').textContent = `${Math.round(P).toLocaleString('fr-FR')} W \u00D7 ${T1}%`;

    document.getElementById('dimPuissanceAppoint').textContent = (puissanceAppoint / 1000).toFixed(1).replace('.', ',') + ' kW';
    document.getElementById('dimPuissanceAppointDetail').textContent = `(P \u00D7 ${T2}% \u2212 PAC)`;

    document.getElementById('dimPuissanceTotale').textContent = (puissanceTotale / 1000).toFixed(1).replace('.', ',') + ' kW';
}

// ============================================
// INIT
// ============================================
dbg('\uD83D\uDE80 Init start');
checkAutoLogin();
dbg('\uD83C\uDFC1 Init complete');
// Triple-tap to show debug panel


// ============================================
// ITE SIMULATOR - ALL FUNCTIONS
// ============================================
const ite_$=id=>document.getElementById(id);
const ite_V=id=>{const el=ite_$(id);return el?el.value.trim():'';};
const ite_N=id=>{const el=ite_$(id);return el?parseFloat(el.value)||0:0;};
const ite_fmt=n=>parseFloat(n).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' \u20AC';
const ite_fmtN=n=>Math.round(n).toLocaleString('fr-FR');

// CEE EDF baremes
const CEE_ITE_102={classique:{H1:11,H2:9,H3:6},modeste:{H1:16,H2:13,H3:9},grande:{H1:22,H2:18,H3:12}};
const CEE_ITE_101={classique:{H1:14,H2:11,H3:8},modeste:{H1:20,H2:16,H3:11},grande:{H1:28,H2:22,H3:16}};
const CEE_ITE_103={classique:{H1:9,H2:7,H3:5},modeste:{H1:13,H2:11,H3:7},grande:{H1:18,H2:15,H3:10}};
const CEE_ITE_148={classique:150,modeste:200,grande:300};
const KWHC_102={H1:1600,H2:1300,H3:1000};
const KWHC_101={H1:1500,H2:1200,H3:900};
const KWHC_103={H1:1100,H2:890,H3:600};
const KWHC_148=14700;
const ITE_ISOLANT={
    CELLOMUR_120:{ref:'*ISOLATION MURS EXTERIEURS HIRSCH CELLOMUR ULTRA 120 mm',brand:'HIRSCH ISOLATION',thickness:'120',R:'3,85',acermi:'12/081/795'},
    CELLOMUR_140:{ref:'*ISOLATION MURS EXTERIEURS HIRSCH CELLOMUR ULTRA 140 mm',brand:'HIRSCH ISOLATION',thickness:'140',R:'4,50',acermi:'12/081/795'}
};
const ITE_CET_SPECS={
    '200':{vol:'200',model:'PERFORMER 2',profil:'L',ref:'THA 986 113',etas:'116',rendEtaWh:'107',cls:'A',resist:'1800',temp:'-5 \u00b0C \u00e0 +43 \u00b0C',refrig:'R-513A'},
    '240':{vol:'240',model:'PERFORMER III',profil:'XL',ref:'CV5',etas:'142',rendEtaWh:'130',cls:'A+',resist:'1800',temp:'-5 \u00b0C \u00e0 +43 \u00b0C',refrig:'R290 (propane \u2013 faible GWP)'},
    '270':{vol:'270',model:'PERFORMER 2',profil:'XL',ref:'THA 986 114',etas:'118',rendEtaWh:'109',cls:'A',resist:'1800',temp:'-5 \u00b0C \u00e0 +43 \u00b0C',refrig:'R-513A'}
};
// MPR par geste pour BAR-TH-148 (CET) â€” barÃ¨me 2026
const MPR_CET={BLEU:1200,JAUNE:800,VIOLET:400,ROSE:0};

// ============================================
// ECO-PTZ CALCULATION ENGINE (auto-financement)
// ============================================
const ECOPTZ_BRACKETS=[
    {maxD:36,rate:0.05391},
    {maxD:60,rate:0.07020},
    {maxD:72,rate:0.08210},
    {maxD:Infinity,rate:0.09315}
];
function ecoptz_getBracketRate(d){for(var b of ECOPTZ_BRACKETS)if(d<=b.maxD)return b.rate;return ECOPTZ_BRACKETS[ECOPTZ_BRACKETS.length-1].rate;}
const ECOPTZ_AGE_MULT=[
    {max:25,m:1.00},{max:30,m:1.08},{max:35,m:1.25},{max:40,m:1.50},
    {max:45,m:1.85},{max:50,m:2.30},{max:55,m:2.90},{max:60,m:3.60},
    {max:65,m:4.50},{max:70,m:5.80},{max:99,m:7.50}
];
function ecoptz_getAgeMult(age){for(var a of ECOPTZ_AGE_MULT)if(age<=a.max)return a.m;return 7.50;}
const ECOPTZ_COV_MULT={D:0.42,DIM:1.00,DIMC:1.38,Aucune:0};

function ecoptz_getAge(ds){
    if(!ds||ds.length!==8)return null;
    var d=+ds.slice(0,2),m=+ds.slice(2,4),y=+ds.slice(4,8);
    if(!d||!m||!y||d>31||m>12||y<1920||y>2008)return null;
    var now=new Date(),age=now.getFullYear()-y;
    if(now.getMonth()+1<m||(now.getMonth()+1===m&&now.getDate()<d))age--;
    return age>=18&&age<=99?age:null;
}

function ecoptz_formatDateInput(el){
    var raw=el.value.replace(/[^0-9]/g,'').slice(0,8);
    var display=raw.slice(0,2);
    if(raw.length>2)display+='-'+raw.slice(2,4);
    if(raw.length>4)display+='-'+raw.slice(4,8);
    el.value=display;
    ite_calcFinancement();
}

function ecoptz_calcTAEA(M,N,mTot){
    var base=M/N;
    if(Math.abs(mTot-base)<0.005)return 0;
    var r=0.02;
    for(var i=0;i<200;i++){
        var rm=r/12,pv=0,dpv=0;
        for(var k=1;k<=N;k++){
            var disc=Math.pow(1+rm,-k);
            pv+=mTot*disc;
            dpv+=mTot*(-k/12)*disc/(1+rm);
        }
        var f=pv-M;
        if(Math.abs(f)<0.005)break;
        r-=f/dpv;
        if(r<0)r=0.0001;
        if(r>2)r=0.5;
    }
    return Math.max(0,r);
}

function ite_calcFinancement(){
    try{
    // Get montant Ã  financer from reste Ã  payer
    var ttc=ite_N('iteMontantTotalProjet');
    var primeCEE=ite_N('itePrimeCEE');
    var montant=ttc-primeCEE;
    if(montant<=0){
        ite_$('iteMensHorsAss').value='0';
        ite_$('iteMensAvecAss').value='0';
        ite_$('iteTotalDuHA').value='0';
        ite_$('iteTotalDuAA').value='0';
        ite_$('iteFinTAEA').textContent='-';
        return;
    }

    var duree=parseInt(ite_V('iteDureeMois'))||120;
    var dobRaw=(ite_V('iteDobEmprunteur')||'').replace(/[^0-9]/g,'');
    var age=ecoptz_getAge(dobRaw);
    var cov=ite_V('iteTypeAssurance')||'DIM';

    // MensualitÃ© hors assurance (taux 0%)
    var mensHA=montant/duree;
    // Arrondi au centime
    mensHA=Math.round(mensHA*100)/100;

    // Assurance
    var mensAss=0,coutAss=0;
    if(cov!=='Aucune'&&age!==null){
        var bracketRate=ecoptz_getBracketRate(duree);
        var ageMult=ecoptz_getAgeMult(age);
        var covMult=ECOPTZ_COV_MULT[cov]||1;
        var insRate=bracketRate*ageMult*covMult;
        coutAss=montant*insRate;
        mensAss=Math.round(coutAss/duree*100)/100;
    }

    var mensAA=Math.round((mensHA+mensAss)*100)/100;
    var totalHA=Math.round(mensHA*duree*100)/100;
    var totalAA=Math.round(mensAA*duree*100)/100;

    ite_$('iteMensHorsAss').value=mensHA.toFixed(2);
    ite_$('iteMensAvecAss').value=mensAA.toFixed(2);
    ite_$('iteTotalDuHA').value=totalHA.toFixed(2);
    ite_$('iteTotalDuAA').value=totalAA.toFixed(2);

    // TAEA
    var taeaEl=ite_$('iteFinTAEA');
    if(taeaEl){
        if(cov!=='Aucune'&&age!==null&&mensAA>0){
            var taea=ecoptz_calcTAEA(montant,duree,mensAA)*100;
            taeaEl.textContent=taea.toFixed(2).replace('.',',')+' %';
        } else {
            taeaEl.textContent='-';
        }
    }
    }catch(e){console.error('ite_calcFinancement error:',e);}
}

function ite_switchLot2(){
    var t=ite_V('iteTypeLot2');
    ite_$('iteCard101').style.display=t==='101'?'block':'none';
    ite_$('iteCard103').style.display=t==='103'?'block':'none';
    ite_$('iteCard148').style.display=t==='148'?'block':'none';
}

function ite_getLot2Total(){
    var t=ite_V('iteTypeLot2');
    if(t==='101'){
        var s=ite_N('iteSurface101');
        var tot=Math.max(s*30, s<50?1500:0);
        // Sync hidden fields (ratio 57/43) pour le devis
        var pm=tot/s*0.57, pmo=tot/s*0.43;
        if(ite_$('itePrixMat101'))ite_$('itePrixMat101').value=pm.toFixed(2);
        if(ite_$('itePrixMo101'))ite_$('itePrixMo101').value=pmo.toFixed(2);
        return tot;
    }
    if(t==='103'){
        var s=ite_N('iteSurface103');
        var tot=Math.max(s*30, s<50?1500:0);
        var pm=tot/s*0.57, pmo=tot/s*0.43;
        if(ite_$('itePrixMat103'))ite_$('itePrixMat103').value=pm.toFixed(2);
        if(ite_$('itePrixMo103'))ite_$('itePrixMo103').value=pmo.toFixed(2);
        return tot;
    }
    // BAR-TH-148 : 2200â‚¬ fixe (ratio ~70/30)
    if(ite_$('itePrixCET'))ite_$('itePrixCET').value='1538';
    if(ite_$('itePrixPoseCET'))ite_$('itePrixPoseCET').value='662';
    return 2200;
}

function ite_switchLot3(){
    var inc=ite_V('iteIncludeLot3')==='oui';
    ite_$('iteTypeLot3Wrap').style.display=inc?'block':'none';
    ite_$('iteCard101L3').style.display='none';
    ite_$('iteCard103L3').style.display='none';
    ite_$('iteCard148L3').style.display='none';
    if(inc){
        var t=ite_V('iteTypeLot3');
        if(t==='101')ite_$('iteCard101L3').style.display='block';
        else if(t==='103')ite_$('iteCard103L3').style.display='block';
        else ite_$('iteCard148L3').style.display='block';
    }
}

function ite_getLot3Total(){
    if(ite_V('iteIncludeLot3')!=='oui')return 0;
    var t=ite_V('iteTypeLot3');
    if(t==='101'){
        var s=ite_N('iteSurface101L3');
        var tot=Math.max(s*30, s<50?1500:0);
        var pm=tot/s*0.57, pmo=tot/s*0.43;
        if(ite_$('itePrixMat101L3'))ite_$('itePrixMat101L3').value=pm.toFixed(2);
        if(ite_$('itePrixMo101L3'))ite_$('itePrixMo101L3').value=pmo.toFixed(2);
        return tot;
    }
    if(t==='103'){
        var s=ite_N('iteSurface103L3');
        var tot=Math.max(s*30, s<50?1500:0);
        var pm=tot/s*0.57, pmo=tot/s*0.43;
        if(ite_$('itePrixMat103L3'))ite_$('itePrixMat103L3').value=pm.toFixed(2);
        if(ite_$('itePrixMo103L3'))ite_$('itePrixMo103L3').value=pmo.toFixed(2);
        return tot;
    }
    if(ite_$('itePrixCETL3'))ite_$('itePrixCETL3').value='1538';
    if(ite_$('itePrixPoseCETL3'))ite_$('itePrixPoseCETL3').value='662';
    return 2200;
}

function ite_getCEE(){
    var z=document.getElementById('zone').value;
    var p=ite_V('itePrecarite');
    var s=ite_N('iteSurfaceITE');
    var t2=ite_V('iteTypeLot2');
    var c102=(CEE_ITE_102[p]||CEE_ITE_102.classique)[z]||0;
    var p1=s*c102;
    var p2=0,u101=0,u103=0,u148=0;
    if(t2==='101'){u101=(CEE_ITE_101[p]||CEE_ITE_101.classique)[z]||0;p2=ite_N('iteSurface101')*u101;}
    else if(t2==='103'){u103=(CEE_ITE_103[p]||CEE_ITE_103.classique)[z]||0;p2=ite_N('iteSurface103')*u103;}
    else{u148=CEE_ITE_148[p]||150;p2=u148;}
    // LOT 3
    var p3=0,u101L3=0,u103L3=0,u148L3=0;
    if(ite_V('iteIncludeLot3')==='oui'){
        var t3=ite_V('iteTypeLot3');
        if(t3==='101'){u101L3=(CEE_ITE_101[p]||CEE_ITE_101.classique)[z]||0;p3=ite_N('iteSurface101L3')*u101L3;}
        else if(t3==='103'){u103L3=(CEE_ITE_103[p]||CEE_ITE_103.classique)[z]||0;p3=ite_N('iteSurface103L3')*u103L3;}
        else{u148L3=CEE_ITE_148[p]||150;p3=u148L3;}
    }
    return{p1:p1,p2:p2,p3:p3,total:p1+p2+p3,c102:c102,u101:u101,u103:u103,u148:u148,u101L3:u101L3,u103L3:u103L3,u148L3:u148L3};
}

function ite_onMontantTotal(){
    var ttc=ite_N('iteMontantTotalProjet');
    var totLot2=ite_getLot2Total();
    var totLot3=ite_getLot3Total();
    var totLot1=Math.max(ttc-totLot2-totLot3,0);
    ite_$('iteMontantLot1').value=totLot1;
    var det=ite_$('iteMontantDetail');
    var detTxt='LOT 1 : <b>'+ite_fmtN(totLot1)+' \u20AC</b> + LOT 2 : <b>'+ite_fmtN(totLot2)+' \u20AC</b>';
    if(totLot3>0)detTxt+=' + LOT 3 : <b>'+ite_fmtN(totLot3)+' \u20AC</b>';
    detTxt+=' = <b>'+ite_fmtN(ttc)+' \u20AC TTC</b>';
    if(det) det.innerHTML=detTxt;
    ite_calc();
}

function ite_calc(){
    try{
    var sITE=ite_N('iteSurfaceITE');
    var totLot2=ite_getLot2Total();
    var totLot3=ite_getLot3Total();
    var hasLot3=ite_V('iteIncludeLot3')==='oui'&&totLot3>0;
    var ttc=ite_N('iteMontantTotalProjet');
    var totITE=Math.max(ttc-totLot2-totLot3,0);
    ite_$('iteMontantLot1').value=totITE;
    var det=ite_$('iteMontantDetail');
    var detTxt='LOT 1 : <b>'+ite_fmtN(totITE)+' \u20AC</b> + LOT 2 : <b>'+ite_fmtN(totLot2)+' \u20AC</b>';
    if(hasLot3)detTxt+=' + LOT 3 : <b>'+ite_fmtN(totLot3)+' \u20AC</b>';
    detTxt+=' = <b>'+ite_fmtN(ttc)+' \u20AC TTC</b>';
    if(det) det.innerHTML=detTxt;
    var tva=parseFloat(ite_$('iteTva')?.value)||5.5,ht=ttc/(1+tva/100);
    var cee=ite_getCEE();
    ite_$('itePrimeCEE').value=cee.total.toFixed(2);
    var primeCEE=cee.total,reste=ttc-primeCEE;
    var lot2Ok=totLot2>=1500,t2=ite_V('iteTypeLot2');
    var lot3Ok=!hasLot3||totLot3>=1500;
    var z=document.getElementById('zone').value;
    var p=ite_V('itePrecarite');
    var nbLots=hasLot3?3:2;
    var plafondPTZ=hasLot3?30000:25000;

    // MPR CET : indication uniquement si 148 en lot 2 ou 3
    var cat=document.getElementById('categorie').value;
    var has148=t2==='148'||(hasLot3&&ite_V('iteTypeLot3')==='148');
    var mprCET=has148?(MPR_CET[cat]||0):0;

    // Lot2 alert
    ite_$('iteLot2Alert').innerHTML=lot2Ok
        ?'<div class="ite-alert ite-alert-ok">\u2705 LOT 2 : '+ite_fmtN(totLot2)+' \u20AC \u2014 Minimum 1 500 \u20AC respect\u00e9</div>'
        :'<div class="ite-alert ite-alert-warn">\ud83d\udea8 LOT 2 : <b style="font-size:16px;">'+ite_fmtN(totLot2)+' \u20AC</b> \u2014 EN DESSOUS DU MINIMUM 1 500 \u20AC !</div>';

    // Lot3 alert
    var l3a=ite_$('iteLot3Alert');
    if(l3a){
        if(!hasLot3) l3a.innerHTML='';
        else l3a.innerHTML=lot3Ok
            ?'<div class="ite-alert ite-alert-ok">\u2705 LOT 3 : '+ite_fmtN(totLot3)+' \u20AC \u2014 Minimum 1 500 \u20AC respect\u00e9</div>'
            :'<div class="ite-alert ite-alert-warn">\ud83d\udea8 LOT 3 : <b style="font-size:16px;">'+ite_fmtN(totLot3)+' \u20AC</b> \u2014 EN DESSOUS DU MINIMUM 1 500 \u20AC !</div>';
    }

    // PTZ
    var ptzOk=lot2Ok&&lot3Ok&&totITE>0;
    var lot2Label=t2==='101'?'101':t2==='103'?'103':'148';
    var ptzMsg='';
    if(ptzOk){
        ptzMsg='\ud83c\udfdb\ufe0f <b>\u00c9LIGIBLE PTZ</b> \u2014 '+nbLots+' lots \u00b7 Plafond <b>'+ite_fmtN(plafondPTZ)+' \u20AC</b>';
    } else {
        var reasons=[];
        if(!lot2Ok)reasons.push('Lot 2 < 1 500 \u20AC');
        if(hasLot3&&!lot3Ok)reasons.push('Lot 3 < 1 500 \u20AC');
        if(totITE<=0)reasons.push('Lot 1 = 0');
        ptzMsg='\u274c <b>NON \u00c9LIGIBLE PTZ</b> \u2014 '+reasons.join(' / ');
    }
    ite_$('itePtzStatus').innerHTML=ptzOk
        ?'<div class="ite-alert ite-alert-ptz" style="font-size:14px;">'+ptzMsg+'</div>'
        :'<div class="ite-alert ite-alert-warn">'+ptzMsg+'</div>';

    // CEE Table
    var lot2Row=t2==='101'?'<tr class="active"><td><b>BAR-EN-101</b> Combles</td><td>'+z+'</td><td>'+p+'</td><td>'+ite_N('iteSurface101')+' m\u00b2</td><td>'+cee.u101+' \u20AC/m\u00b2</td><td class="val">'+ite_fmt(cee.p2)+'</td></tr>'
        :t2==='103'?'<tr class="active"><td><b>BAR-EN-103</b> Plancher</td><td>'+z+'</td><td>'+p+'</td><td>'+ite_N('iteSurface103')+' m\u00b2</td><td>'+cee.u103+' \u20AC/m\u00b2</td><td class="val">'+ite_fmt(cee.p2)+'</td></tr>'
        :'<tr class="active"><td><b>BAR-TH-148</b> CET</td><td>'+z+'</td><td>'+p+'</td><td>1 U</td><td>'+cee.u148+' \u20AC forfait</td><td class="val">'+ite_fmt(cee.p2)+'</td></tr>';
    var lot3Row='';
    if(hasLot3){
        var t3=ite_V('iteTypeLot3');
        lot3Row=t3==='101'?'<tr class="active"><td><b>BAR-EN-101</b> Combles (L3)</td><td>'+z+'</td><td>'+p+'</td><td>'+ite_N('iteSurface101L3')+' m\u00b2</td><td>'+cee.u101L3+' \u20AC/m\u00b2</td><td class="val">'+ite_fmt(cee.p3)+'</td></tr>'
            :t3==='103'?'<tr class="active"><td><b>BAR-EN-103</b> Plancher (L3)</td><td>'+z+'</td><td>'+p+'</td><td>'+ite_N('iteSurface103L3')+' m\u00b2</td><td>'+cee.u103L3+' \u20AC/m\u00b2</td><td class="val">'+ite_fmt(cee.p3)+'</td></tr>'
            :'<tr class="active"><td><b>BAR-TH-148</b> CET (L3)</td><td>'+z+'</td><td>'+p+'</td><td>1 U</td><td>'+cee.u148L3+' \u20AC forfait</td><td class="val">'+ite_fmt(cee.p3)+'</td></tr>';
    }
    ite_$('iteCeeTableContainer').innerHTML='<table class="ite-cee-table"><tr><th>Op\u00e9ration</th><th>Zone</th><th>Pr\u00e9carit\u00e9</th><th>Qt\u00e9</th><th>\u20AC/unit\u00e9</th><th style="text-align:right">Prime</th></tr>'
        +'<tr class="active"><td><b>BAR-EN-102</b> ITE</td><td>'+z+'</td><td>'+p+'</td><td>'+sITE+' m\u00b2</td><td>'+cee.c102+' \u20AC/m\u00b2</td><td class="val">'+ite_fmt(cee.p1)+'</td></tr>'
        +lot2Row+lot3Row
        +'<tr style="background:rgba(22,163,74,0.08);"><td colspan="5" style="font-weight:900;font-size:13px;">TOTAL CEE EDF</td><td class="val" style="font-size:15px;font-weight:900;">'+ite_fmt(cee.total)+'</td></tr></table>';

    // KPI summary
    var kpiLot3=hasLot3?'<div class="ite-kpi"><div class="ite-kpi-icon">\ud83d\udee0\ufe0f</div><div class="ite-kpi-val'+(lot3Ok?'':' red')+'">'+ite_fmtN(totLot3)+' \u20AC</div><div class="ite-kpi-label">LOT 3</div></div>':'';
    var kpiMPR='';
    var catColors={BLEU:'#3b82f6',JAUNE:'#eab308',VIOLET:'#8b5cf6',ROSE:'#ec4899'};
    var catLabels={BLEU:'Bleu',JAUNE:'Jaune',VIOLET:'Violet',ROSE:'Rose'};
    if(cat){kpiMPR='<div class="ite-kpi" style="border-color:'+(catColors[cat]||'#999')+';background:'+(catColors[cat]||'#999')+'18;"><div class="ite-kpi-icon">\ud83c\udfdb\ufe0f</div><div class="ite-kpi-val" style="color:'+(catColors[cat]||'#999')+';">'+(catLabels[cat]||cat)+'</div><div class="ite-kpi-label">Profil MPR</div></div>';}
    ite_$('iteAidesSummary').innerHTML='<div class="ite-kpi-row">'
        +'<div class="ite-kpi"><div class="ite-kpi-icon">\ud83e\uddf1</div><div class="ite-kpi-val">'+ite_fmtN(totITE)+' \u20AC</div><div class="ite-kpi-label">LOT 1 \u00b7 ITE</div></div>'
        +'<div class="ite-kpi"><div class="ite-kpi-icon">'+(t2==='101'?'\ud83c\udfe0':t2==='103'?'\ud83c\udfe0':'\ud83d\udebf')+'</div><div class="ite-kpi-val'+(lot2Ok?'':' red')+'">'+ite_fmtN(totLot2)+' \u20AC</div><div class="ite-kpi-label">LOT 2</div></div>'
        +kpiLot3
        +'<div class="ite-kpi"><div class="ite-kpi-icon">\ud83d\udcdc</div><div class="ite-kpi-val">'+ite_fmtN(primeCEE)+' \u20AC</div><div class="ite-kpi-label">CEE EDF</div></div>'
        +kpiMPR
        +'<div class="ite-kpi"><div class="ite-kpi-icon">\ud83d\udcb0</div><div class="ite-kpi-val">'+ite_fmtN(reste)+' \u20AC</div><div class="ite-kpi-label">Reste \u00e0 r\u00e9gler</div></div></div>';

    // Financement : auto-calcul ECO-PTZ
    ite_calcFinancement();

    // Sidebar update
    var sl1=ite_$('iteSidebarLot1');if(sl1)sl1.textContent=ite_fmtN(totITE)+' \u20AC';
    var sl2=ite_$('iteSidebarLot2');if(sl2){sl2.textContent=ite_fmtN(totLot2)+' \u20AC';sl2.className='rrc-value '+(lot2Ok?'':'red');}
    var sl2t=ite_$('iteSidebarLot2Type');if(sl2t)sl2t.textContent=t2==='101'?'BAR-EN-101':t2==='103'?'BAR-EN-103':'BAR-TH-148';
    var sl2a=ite_$('iteSidebarLot2Alert');if(sl2a)sl2a.style.display=lot2Ok?'none':'block';
    var sc=ite_$('iteSidebarCEE');if(sc)sc.textContent=ite_fmtN(primeCEE)+' \u20AC';
    // MPR color sidebar
    var smpr=ite_$('iteSidebarMPR');
    if(smpr){
        if(cat){
            smpr.style.display='block';
            smpr.innerHTML='<div class="result-row-card" style="background:'+(catColors[cat]||'#999')+'15;border-color:'+(catColors[cat]||'#999')+'30;"><div class="rrc-label">\ud83c\udfdb\ufe0f Profil MaPrimeR\u00e9nov\'</div><div class="rrc-value" style="color:'+(catColors[cat]||'#999')+';">'+(catLabels[cat]||cat)+'</div></div>';
        } else {
            smpr.style.display='none';
            smpr.innerHTML='';
        }
    }
    var st=ite_$('iteSidebarTTC');if(st)st.textContent=ite_fmtN(ttc)+' \u20AC';
    var sr=ite_$('iteSidebarReste');if(sr)sr.textContent=ite_fmtN(reste)+' \u20AC';
    var sp=ite_$('iteSidebarPTZ');if(sp)sp.innerHTML=ptzOk
        ?'<div style="padding:10px;border-radius:8px;background:rgba(59,130,246,0.08);border:1px solid rgba(59,130,246,0.15);color:#60a5fa;text-align:center;font-weight:700;font-size:13px;">\ud83c\udfdb\ufe0f PTZ '+nbLots+' lots \u00b7 Plafond '+ite_fmtN(plafondPTZ)+' \u20AC</div>'
        :'<div style="padding:10px;border-radius:8px;background:rgba(248,113,113,0.06);border:1px solid rgba(248,113,113,0.12);color:#f87171;text-align:center;font-weight:600;font-size:12px;">\u274c Non \u00e9ligible PTZ</div>';
    }catch(e){console.error('ite_calc error:',e);}
}

// Sync profil -> precarite
function syncProfilPrecarite(){
    var cat=document.getElementById('categorie').value;
    var prec='classique';
    if(cat==='BLEU') prec='grande';
    else if(cat==='JAUNE') prec='modeste';
    else prec='classique';
    var sel=document.getElementById('itePrecarite');
    if(sel) sel.value=prec;
    try{ite_calc();}catch(e){}
}

// Google Sheet search for ITE
var ite_csvCache=null;
function ite_setStatus(cls,msg){
    var s=ite_$('iteSearchStatus');
    if(!s)return;
    s.className='ite-search-status '+cls;
    s.innerHTML=msg;
    s.style.display='block';
}
function ite_fetchCSV(){
    return new Promise(function(resolve){
        if(ite_csvCache){resolve(ite_csvCache);return;}
        ite_setStatus('loading','\u23f3 Chargement\u2026');
        var ID='1J88r4JUwqVvZFbdAFvj3MffBkEO3gYv7dYiXHhQT3C0';
        var cb='__itecb'+Date.now();
        var url='https://docs.google.com/spreadsheets/d/'+ID+'/gviz/tq?tqx=responseHandler:'+cb;
        window[cb]=function(d){
            try{
                delete window[cb];
                var ss=document.getElementById('iteSS');if(ss)ss.remove();
                if(!d||!d.table){ite_setStatus('err','\u274c');resolve(null);return;}
                var h=d.table.cols.map(function(c){return c.label||'';});
                var rows=[h];
                for(var i=0;i<d.table.rows.length;i++){
                    var row=d.table.rows[i];
                    rows.push(row.c.map(function(c){return c?((c.f!=null)?c.f:(c.v!=null?String(c.v):'')):''; }));
                }
                ite_csvCache=rows;
                resolve(ite_csvCache);
            }catch(e){ite_setStatus('err','\u274c '+e.message);resolve(null);}
        };
        var s=document.createElement('script');s.id='iteSS';s.src=url;
        s.onerror=function(){delete window[cb];s.remove();ite_setStatus('err','\u274c R\u00e9seau');resolve(null);};
        document.body.appendChild(s);
        setTimeout(function(){if(!ite_csvCache){ite_setStatus('err','\u274c Timeout');resolve(null);}},10000);
    });
}

// Charge un dossier (row) dans tous les champs
function ite_loadDossier(f){
    var g=function(idx){return(f[idx]||'').trim();};
    document.getElementById('nom').value=g(2);
    document.getElementById('prenom').value=g(3);
    var cp=g(16)||g(12);
    if(cp){
        var dept=cp.substring(0,2);
        if(dept==='97') dept=cp.substring(0,3);
        var deptEl=document.getElementById('departement');
        if(deptEl&&dept){deptEl.value=dept;try{detectDept();}catch(e){}}
    }
    ite_$('iteNumClient').value=g(0);
    ite_$('iteNumDevis').value=g(0);
    ite_$('iteAdresse').value=g(14)||g(10);
    var vi=g(20)||g(17);
    ite_$('iteVille').value=cp&&vi?cp+' '+vi.toUpperCase():'';
    var t=g(21);if(t&&!t.startsWith('0')&&t.length<=9)t='0'+t;
    ite_$('iteTel').value=t;
    var em=g(23);ite_$('iteEmail').value=em&&em.toLowerCase()!=='n\u00e9ant'?em:'';
    var pm={'grande':'grande','simple':'modeste','classique':'classique'};
    ite_$('itePrecarite').value=pm[g(26).toLowerCase()]||'classique';
    (function(){var ch=g(34).toLowerCase(),tc=ite_$('iteTypeChauffage');if(!tc)return;
        if(ch.includes('fioul')||ch.includes('fuel'))tc.value='Fioul';
        else if(ch.includes('gaz'))tc.value='Gaz';
        else if(ch.includes('electr')||ch.includes('\u00e9lectr'))tc.value='\u00c9lectrique';
        else if(ch.includes('bois')||ch.includes('granul'))tc.value='Bois';
        else if(ch.includes('pac')||ch.includes('pompe'))tc.value='PAC';
    })();
    // Surface habitable (col 35)
    var surf=parseFloat(g(35))||0;
    if(surf>0){
        var sc=document.getElementById('surfaceClient');
        if(sc) sc.value=Math.round(surf);
        var ceeSurf=document.getElementById('ceeSurface');
        if(ceeSurf){ceeSurf.value=Math.round(surf);try{syncSurfaces('cee');}catch(e){}}
        var surfSel=document.getElementById('surface');
        if(surfSel){
            if(surf<70) surfSel.value='S<70';
            else if(surf<90) surfSel.value='70<=S<90';
            else surfSel.value='S>=90';
        }
    }
    var z=g(42).toUpperCase();
    if(z){var zs=document.getElementById('zone');if(zs){for(var j=0;j<zs.options.length;j++){if(zs.options[j].value===z){zs.selectedIndex=j;break;}}}}
    try{ite_calc();}catch(e){}
    try{calc();}catch(e){}
    try{checkExport();}catch(e){}
    ite_setStatus('ok','\u2705 '+g(0)+' \u2014 '+(g(1)+' '+g(2)+' '+g(3)).trim());
    var pl=document.getElementById('dossierPickerList');if(pl)pl.style.display='none';
}

// Affiche le picker quand plusieurs dossiers correspondent
var _ite_matches=[];
function ite_showDossierPicker(matches){
    _ite_matches=matches;
    var pl=document.getElementById('dossierPickerList');
    if(!pl)return;
    var html='<div class="dossier-picker-title">&#128276; '+matches.length+' dossiers trouv\u00e9s &mdash; lequel charger ?</div>';
    matches.forEach(function(row,i){
        var num=(row[0]||'').trim();
        var prenom=(row[1]||'').trim();
        var nom=((row[2]||'')+(row[3]?' '+row[3]:'')).trim();
        var tel=(row[21]||'').trim();
        var ville=(row[17]||row[20]||'').trim();
        html+='<div class="dossier-picker-item" onclick="ite_loadDossier(_ite_matches['+i+'])">'
            +'<span class="dossier-picker-num">'+num+'</span>'
            +'<span class="dossier-picker-name">'+(prenom+' '+nom).trim()+(ville?' &middot; '+ville:'')+'</span>'
            +'<span class="dossier-picker-tel">'+tel+'</span>'
            +'</div>';
    });
    pl.innerHTML=html;
    pl.style.display='block';
    ite_setStatus('loading','&#128276; '+matches.length+' r\u00e9sultats &mdash; choisissez un dossier ci-dessous');
}

async function ite_searchClient(){
    var q=ite_V('iteNumClient').trim();
    if(!q||q==='AVR-202XX'){ite_setStatus('err','\u274c Saisissez un n\u00b0 de dossier ou un t\u00e9l');return;}
    var qUp=q.toUpperCase();
    // Masquer le picker prÃ©cÃ©dent
    var pl=document.getElementById('dossierPickerList');if(pl)pl.style.display='none';
    ite_$('iteBtnSearch').disabled=true;
    try{
        var rows=await ite_fetchCSV();
        if(!rows){ite_$('iteBtnSearch').disabled=false;return;}
        var matches=[];
        // 1. Correspondance exacte nÂ° dossier (col 0)
        for(var i=1;i<rows.length;i++){
            if((rows[i][0]||'').toUpperCase().trim()===qUp) matches.push(rows[i]);
        }
        // 2. Partielle nÂ° dossier
        if(matches.length===0){
            for(var i=1;i<rows.length;i++){
                var id=(rows[i][0]||'').toUpperCase().trim();
                if(id&&(id.includes(qUp)||qUp.includes(id))) matches.push(rows[i]);
            }
        }
        // 3. Recherche par tÃ©lÃ©phone (col 21) â€” normaliser
        if(matches.length===0){
            var qTel=q.replace(/[\s.\-]/g,'');
            if(qTel.length>=6){
                for(var i=1;i<rows.length;i++){
                    var t=(rows[i][21]||'').replace(/[\s.\-]/g,'');
                    if(t&&t===qTel) matches.push(rows[i]);
                }
                // Partielle tÃ©lÃ©phone
                if(matches.length===0){
                    for(var i=1;i<rows.length;i++){
                        var t=(rows[i][21]||'').replace(/[\s.\-]/g,'');
                        if(t&&(t.includes(qTel)||qTel.includes(t))) matches.push(rows[i]);
                    }
                }
            }
        }
        if(matches.length===0){ite_setStatus('err','\u274c '+q+' non trouv\u00e9');return;}
        if(matches.length===1){ite_loadDossier(matches[0]);}
        else{ite_showDossierPicker(matches);}
    }catch(e){ite_setStatus('err','\u274c '+e.message);}finally{ite_$('iteBtnSearch').disabled=false;}
}

// ============================================
// ITE DEVIS GENERATION (PDF)
// ============================================
function ite_dvTH(){return'<div class="dv-th"><div>D\u00e9tail</div><div class="c">Qt\u00e9</div><div class="r">P.U TTC</div><div class="r">Total TTC</div><div class="r">TVA</div></div>';}
function ite_dvFT(p,t){return'<div class="dv-footer">LES ARTISANS VERTS SAS Soci\u00e9t\u00e9 par actions simplifi\u00e9e au capital de 40 000 \u20ac Si\u00e8ge social : 6 passage Eug\u00e8ne Barbier, 92400 Courbevoie<br>E-mail : contact@artisansverts.energy T\u00e9l\u00e9phone : 01 87 66 27 08 SIRET : 878 062 793 00038 TVA intracommunautaire : FR34 878062793<br>Assurance d\u00e9cennale : GROUPE LEADER insurance N\u00b0 de police :LUNS2507132 P\u00e9riode de validit\u00e9 : du 01/01/2026 au 31/12/2026<span class="dv-pn">'+p+'/'+t+'</span></div>';}

// ============================================
// LOGOS BASE64 (remplacer par les vrais logos)
// ============================================
var LOGO_AV_B64='data:image/png;base64,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';
var LOGO_RGE_B64='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAB+CAYAAACNvjvgAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAlmVYSWZNTQAqAAAACAAFARoABQAAAAEAAABKARsABQAAAAEAAABSASgAAwAAAAEAAgAAATEAAgAAABEAAABah2kABAAAAAEAAABsAAAAAAAAAGAAAAABAAAAYAAAAAFBZG9iZSBJbWFnZVJlYWR5AAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAtKADAAQAAAABAAAAfgAAAACI2YtqAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABZGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNi4wLjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iPgogICAgICAgICA8eG1wOkNyZWF0b3JUb29sPkFkb2JlIEltYWdlUmVhZHk8L3htcDpDcmVhdG9yVG9vbD4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CgQ+9BsAADEgSURBVHgB7X0HmB3Fle6ZdCfnIGk0iqMsFBBCQkJCCIS05GCDTTBgk3bBgO236/V+u+B9vN33vIt3vcb+DCaYYAMfOZgcJJICQoAklEeakTRZk3Oeef9/+tadnjt3pKu5E+4Mfebr6b7d1dXVp/46deqcU9UhXSBxyOHAKOFA6Ch5D+c1HA4oBxxAO0AYVRxwAD2qqtN5GQfQDgZGFQccQI+q6nRexgG0g4FRxQEH0KOqOp2XcQDtYGBUccAB9KiqTudlwvvDgvb2dmlqbBDuHXI4MBgccLkiJSY2RkJCTk7mhpys67ustFRampvwsDgJjwiXEPw55HBgoDhgxWF0AWPN0tzUJIlJyZKQlOR39icF6KL8fImKjpKUtHS/H+AkdDjQXw50dnZKSVGhREVFA3NpfmXjtzyvrqyUCJfLAbNfbHUSDQQHQkNDJTNrgjQ01KvE9idPvwDNgLz6ujpJTXcksz9MddIMLAfSgLvqqkq/MvUL0O3tbRIeHi5sMQ45HBhqDlDl8NcA4RdCOzs6JTTMr6RD/a7O874NHAiB6QGbP9Qvs50/GQd7GqpRZm6D0/MEe235X75vhdg14OWomZsBMls9fzfDRMS9QyOfA6MS0ASsN3hZVZTE3Ahks3FsQKrDoNcAXU84/0YkB0a0ymEAaPQr85s10ZcaUXmsTg58UyxbNxyQ6JhI+cFPz5bIqEipqqoSF8yS0dHRI7IinUJbHBhRgLYD1hxz39HRoQA20pavhtNSX9skRYcr5fD+Y3JwV7EUH62SowfLpLqiQTo7LB16+dqZMnfxRJXYVD0cQI/sphH0gDbANWw20tjseZ7HJl3+oXJ5/cmtcjinTCpL66SqvF5aWxBzAoDTUhMWHgoHkfXaLU1tUgjAE9ARERHS1tZmHuPsRygHghrQBqR28La1tktJfrVK2vyD5bJoZbbMmJ/pYf+T/7VBPnlzt0THuiC1Q1RyR0ZFeK73OIAlaO9XBbL2uwslJiZGKuENpbQPCwvrkcz5MXI4EJSA9gZye1uHfLP1iGx6b5/s214opQXV0tTQKq3N7bLlwwPy6+duRKCUBUJXZDh04gjP776qorOzS9rbOqXoiOWBCg8PU+O9A+i+ODYyzg8ZoA1IyRa7xPVmk0nHNB3tnfL+S9vlnee/lry9pfqbwA0NCxECN8IVJqWF1VIB1WJMlhWRNX3eOPkYEtoXdcBB1NbaAfUiTBKSY2TOoiy54uZlmrSludVROXwxbYSdGzRAG2CSH/Zj/qYUJBkzmv7AP5OOYKY14nf3vCVb1x9QaUsgGyls0jNdXXWz5HxT5AH0zIXjFewmjdnT25k5KUXO+84CyZ47TiZkp0pyWpxe5nNLj5WqlcNRNwzHRuZ+wABtwGhng5HEZm+uEcidXZ3o8tvVXhwZGemR2kxbW9Uo/3bHC7If6kVUjMvc5nsPMO7adlRWnD9Hr0+ekSHp4xLkWFENdOFuM3sb1Jbv3rJczrlsXq98+MyMjAx1sPS66JwYURwIGNB2IHsDl5yoLm+A3bdIyotrEbDdKmkA24x542XshCSViC0tLVJfX6+DMiMdH7//Q9n/NcCMgZ0v4jPV7AbTBXXhgtwKT7KYuEjJnJyiJjo7oGnGO5JzzJOOBzTf0SqSNQXSOj1er7EsiYmJPdINxI+S99dLw+GjEtKPAWcXZgYlzJkp6SuWD0RRRnUeAQHagNkAuQvgqiyrl8MHjsn+HYXYiuTwvlI1nXW0w+6LP1oe4hOjZd1Vp8o1d54llM5UQVpbW9UGvGPzYVn/2i6J9CGZqVNzi0uKkrQx8TDBhWFw2CLrrjy1RyVlzxkrX3x0sMc56twfvb5LklJjtXHRQlKIhlBeXCOnr54u//zQVVqW8vJyiY2N1ejCHhkE+OPQw3+SwtffljA4cU6WOhqaJPu2HzqA9oNxAQGa+RPMHJQ9/9BncmhPiZrU6qqb1IIQhsFbGHRf2n0jbMK2Gfbf55C+DFL7p7+6WKWzaRwfvLxDOqAehMNebCcO5sZPSZHLfrhUFpwxWVLHJGjjoIvb2JVN+onT0lEu88vaU1rX1zTLE//xoZ7gbz4jEkA/CsdLQ22zxCZGaeNiqKLdSdMzp/79CkPDDYdpsD+A5jS3UHgxHToxB/oNaANAPuLZ338irz31BeYZulRv9TWAsxeFUjomNlI2vP6N2pAvvWGJNgzamHMh0b0Hf7ROjIcacd+jV0t6Zk91ADYPKS+pRQPqgBqTrI+ZmJ2GqWIuYY8RgmcR27rhODw6wvObB7xajwZYDAfL9AXjFchUg6KiouxFdo5HCAcCBjQlNPVTSjpvIJ6IB5GREfLyo5tl5fmzJSUjXiV2RUmdmuXs91I6r750ngfMJflV0H0r4NIulT1wjBzcVSTNjW3yt/euk3MvXyCZ0InHjE+09GiFrJWbB9gK5O4ntKLH+GZzngKaQCag2WCNKtWd0jkKdg70G9B8MSOl50MFeO/F7T7flYO2NrieqXp4qxG0J5cDwF9+mqvmtKqyBtWJvRsGgZgKnZl5/eFf35aP39gtdFtTclPaMz2f8cmbexTQkVHhMhPew0KA3kxMoApiAM2C0ozXBX2ceXa2d0hMnCWRqcL4OzvC5ws7J4eVAz0V1ZMoCqWXiSGeNnesupopqe1EsCSlxsilNy6RqbMyVC2wX+cxQb3tY2sAFxEZprEW3mmYbXNjqzTVt8hnb++Bc6RdnSpRUB842KM+zB6CakNjXYvePnvRBMGUdgHerQ1nPYAGmMeOT5JFZ0+Ty25ZJj//w5Vy7lULtYHW1NSofdy7DM7vkcGBfktoAtp0yWnjEtX2W5hX2QOQlJqX3rhULsNG68cvrntKjhX2tA/T5UzHCAEbG4+BE6Qt9WGTt7IRwGwAUGmSy4AqcfRAmQg83VoGJCBQgUKphRmO6shUWDkmz8xAeChiONAaCGpNg2Qs0/nXLZar7lol0cjPToy2Y6/j6M92roys435LaL4mAUUpzS6eDg2a1OxEyUqpSkpJj5MV62ar61lPuP9RZaAjhaGdKfDcxSVEeVQZk47PYfwGB3i0YFDyh+IcC8+NYCVoW6FHH9xZpLdxEJkE93YI0vK62eDRkazs9F5g5k0EcnZ2tu6bsMiJUak0Q+ffiOBAwIA2lT4dOmunl85BsOYgDtnQJIAeOOxJBCKkJi0VlJiJKTHqNLEnYsincZ5MnTVGOIhrw0ZwEsjQWnQPIY2YjxK9NRrSng6WTti4+UhuDF8Kxw17thzGUTdRauehl9gB23U7BqAENqU1N4dGFgf6rXLwNY2E5vH0U8Zp0A+PDVGdYHA9nR/RMNOFR/TRfoBy5kWaAJMbG4EZGPI88ymFBK+tbJRVF5+iujIl+aZ39kDNaFTJzXvDoUsf3XdMJSvvmzYvU3ZtzJMwmHCt3EV17r2fH5aXHvhY9e1KuMgrYA8vhf7dVNcs19/7N7LmB6erHk2vIcFtysZnOBTcHAgY0EZCE4jJUCvoTqZkJnHAV3GsXp64f73MXzZFXvnT5+rds7OE9zPcMyPTipabe/pEWf/qNwoi5qIb8quBC/1TRNFdCLDd8W8XahZhOP8qzH7RxrYMQFfA81cNfT0ZZsBsNjKUgYD05IU7KeFff3CjnmNZOajkxii8w+4ehQH/BDRVKuOSt5fbOQ5ODvQhMv0vLMFCUDIcc9zE5F56NE11bz/3lfzqrpcsyevlAaQ+TP06fXyCPnTuaRMkHtJXLRQ4Y4DocoXKy3/cqO5qUzqqOeEErPsEAV4H4OcgqIk0ng4WzBsM4cAQv01eYSgzGwE3tZ+jTLhVXOgJCtGjtMOKwjX8+F4dzgqrysuR8i9wQDNyDlKMxBgK2oa9ia5pFwaO3nZopqP+unhVNiwSlmt3PJwisxdmSQd0WQKQQONGdaIOKsfDv3wLqkeDPmIMPINRcM4QsNSPNcQfINy/LV+vp2UmwCqSIF0ok+bF/LDx2Gz8rRtOUFevLKqWMsyICQuFDxLv1upMywKHRg4FpHLwNWlt6HADetopY09K36RregIAfPmPzvBwjBJ/xQWzZftnh3SwxwsEHykKtuYD8Azed/1f1BtYnIcoO4CVkhkP1nTUt/PhPmfeLqgyk2ePlaKccgkFWE0+3JtjiGGktYKeujBxNm5svETgOSQGTZnYbT3h/At6DgQMaPsbTpyega46QsHUjRh7CrdkdIOvHTHRCUnRsGzE9ki0DOa9NzHRtQARcS7MSjHg456/S49USQki5ShRGXFnAMo9JXkFBnqNGODFIqpvMnqNza9BJ8c1bpTW7EUIeA48E2BVSUyLlUkM+p89RmYsmSRpmP3ShvX8aOVITU3FXQNAfHggFOj9gTx7BN0bMKDtFgDGONNFzWlRHGTZSQHlBrKpG+qshzAI+yPc2X/3fy7w3MMJrtf+bLX8N/RuAs8MMjUPZEogY7TnAanJj3tLj66XEjh5sheOlwlwsFCAt2MgSLUnFY6ZTNiys2akyzR4E8fDlBgPUNPGbagJ4Zq5Obk6GOxo7pSm9iZzqX97vHdHM8yMHZh93q6KUc98cB0P63nO/ovlb+mQhiqUA0Jg5FKIREDgubANFgUMaBaMoKYeTT2Y1g5OPDWA5jWFCrr2dujLdFUb6BBDHJRteGmHZCDw/yrERxtatGqa3HTPOnn8vncttcLdQEwDYh5m4z3mmLp3GMyD4ZDkpJlLJsqt918qDTVNMgVmvDFQcbw9hA3VDVKad0wOfXlICvYUyoEtOdJS2yoJ0QloN9TtmXv/CREnkt3ZJkkzZwmPexDB3NoiHaXd9voe1/GD77J/EyYJ3/ocHEWt3pdHxG+ioAl1MOfs6XLRv5w/aGUeUEBzEDUbE083v79fdWsDA0pZWjIWnjlF1r+8E+Yxq1INCKOjw+V1mN9mQKIuxLIEhlZjeQFOwXocEpwxGtoYcJO5j25t6r/UfRlsxEFnJhrUpT9eKZOgaphVU5dcONdkqQ2vJLdE8ncXSO7XeZL31WE5llsmDRhwtjchDjoUs8bxfQ9XuEsa6+lYCdy50glXfuRPbpLUxZM01ttTGB5gKbL23ANSde/dcBRB+hLgXtQJD2zG4mky+ZpV0jVCnT2h6I2LdxyVRphVB5MGDNDGHj0fOmgsp04BbKZuWEUdmD/4fUhgVu6GV3aqru0BJhISfI/c86b80yNXS9b0dI9zZNkFcyQDqsybj2yWgzDHNSIQvwPRcbyX9usETJ2iGjEFOvCc5VNk+uIJGvDPNE/+/M9ScbRSFl90GpwroZK3/bDkfpknZXnl0lrXCutIqAI3ArMP4iPiEURPNQZ/iin9NzC8R4MOgdVE1QovjSEkLBwNEpOG+wCzKUBYappGLHZ1Hkc1MYmDcE9Ac7zTZVPtBqOYAwZoUzi6t8diUMXIN+q6Cg7Yiuns2PdVvvzwn9dKHma2FLoHfLyP0GHaGjhhHvzF6/Lzh78v8cnRsuXVz2X28lmSDVXhrge+IzXIgwM+BjJBg8GALlbSAGa6uQ0RyN98tEve+O1bkvPpQYkKj5bcTw7rpFymcQG8URHREhcXj7IRvHz6AILXFKTXnt2Je7Nfw/M7K8ulC+bBkL5mpUC/DhszTlUvCooRSUNU7gEBNBlMYFCP5sAra2qqFOWW45xlKiNcQvFCOZj4SgvGjzHt6v/d/CxczS2qa1MlUfs108AstxeLypyBWdyF0Gdfvu9VufwXl8rc1XMkMSNREqG62IkqR0VhhRTsxRzGLQdk9/rdUri3WMI6wiU5LkVVCEpdw0+FroLYnsswHoNHbYf29z3YQyMIjcX8ycwJUK+s5R9OVFo6q0gcTJt4cPaAPK/NdwCkJNumxcsTlWZorw8YoKk/G7VjEiwIW7HKETVlZSD21G9zYdEgU2kbvuGf1sof/uE1qCCdkoiJq5loBFmwPmQvyJSFZ01TLpTmlUnV4Vp5+u7nJCY9RtKxlkZKVorEIT0zrj1WK8U5JVJ+pEKaMV9Q2kMwyESAU2SSBWTbN+6U+UPL2xM/DQ2rq7lRWndukxD3sr7eN3HGd8T4SRKWNgYS+viAJm8ZL5OA3o0DdPZ6FBYkWnEYDdmIFac4f5KrRun0tH4who2DYxs+j6G+wUQDBmhKaANoRsQxqo2AttzHsP3C+lB8qEzqECpKAC+/aK4uU9AGc9a0U7Mkdazl+jbM2fjiZtnxzk64weMlEpaG9tp2KdxaLEc2F6BeYf4CsUI4mZU6cFRMNAai7BFQQ8Ekgc0L+diHYPDZvGmDtOcd7BPQNPW5Fi2FOhIpXS2+B6gEFleRSk+PRYOOkAaE7FYhpqYNpj7jxaW05qA6FmEFmZOS8VWpdg3b5dQ1Qt5Sv3wU0n2K9cjGQYsLJyizwZQgtl0ldT8aRd9PCuzKoACaMRR0gDA+OQ4zqbNmp8lYMHEm4jTi4OwgkdGLsHyAoYqiSsnflS/5ewsk5/ODsvfj/RIVGiWuMNgsAdDwcKxXh80iVIEleEYMeM17mn0Igp86qyqk4dnHtBcz53vsgZaQ+ESJXAbrxnFiSlKhhsUlRiIwrFHKiuo0jNcAlHsSgdcMK05TI+ZsAtyxCZFqeaJQaKpvheRugfXQagBMa4i3U9Jz0jEbQyTCGOog4Qtg5yfITf4m/XDvBwzQ5kX4kuMmp8odv7pEmtG9zYAZbxxsv3Z644E35eu3d8iCc+cj4L9NcrYehN5bJI2VTRLaCeM7TGYJUQnw+sFmbVMbuvOgFO7+NaKOYO3g4K+jrERqH/i/0p6fp9LX1ztQIkefc4GEZ02WLtiqvYnAo2eWbv383EpVAVRvBgp5jRLVYJPsUpADwKR6LKHGZdRUamNQzfVKeC+FB1UKEsFMVZLSow0qClWVMoCfPQLTBhuYWeYBBTRf0FoCIFKW/s1s5q/UWNOIeIpiKT5YIrvW75Iv//q1RHS6pGhbiVofqDbw284pcSNPbTDveMI9dWQ0zs6qY9KybZM0vv6cdJQU9Qlmqhqh6WMl9oprYdazVCzvZxBwnCzcBKuPAhkgI9hYD5xFxM3ElXMptBZI6NYWqBhAuQISGVIHrkKEIonn6BBj2C/zUHURNn5ajngPn8fzTGdArTcG0b8BBTTjhrloeGVlleq3TXVN8tb978i+T/dLLWZ3d7ZBB4PjIiEmUSJCuT4GOQRuUIyQW6OVAObGl/8ilS8VSlthgXRWV2JJMPQ+fZnpoI4BlpLwwzvVXNeFZRX6JLCNAWKqRyMcIAWDZ4YOtAOEXG643T0tjrHecZDEVB8aIWVr4UYnyMl2AtQQrU0cexoA8zxBbKqHz+EAn+sHckGhJqiV5prJYzj3AwpovgitDKTGpka4mxtl91v7pKOxAypEkoRGo/UriLsZqIm9fuq50fQPkrlt/y4EPB2VLgxwOcDrkwhmSOS4G+6QqDNXYyB4HDAjE9VjAch0RAkSyHWw9hRjojCtGCTDWqN6cPAYj3HNuIkIwMJAvZaghGpIoGp6vcG6i6CmtLH2CJ/BvSmIe4+Nd0kNGgRXwAomMLO0Aw5otmZOW+IW1houSRjUNHY0QWJb7m4+9NtIIRjQhoQgEtE7lsPGjC6s7xeCr6bG33y3xKy7DM6W48dtEGjUgbk2Npc540DNqAIqdXHdgimkMJ8DnNJ0V4n1T6rKGzGLHh5SDNKTEW3IuZQtiLXhEhG6DiEyZ13SDMhnUFfnAJIhCAV5Veo3sEt222sM6+GAA9r+NmSIJSOsFm+/5hx3c4BeQozEJGL2fIm7/u/ENWdBnya67rssznLgx090cKIxAUaWG1DrOifuoC6qEpTIvMY03Bph3uPyENSbVecGaLlEm7cOrZOYsX4h92xE5jk81iq2F2qYjwcV0P68GytEvVhguDIIN1EScORuvFz+5BNsaagKWET02ErH8wgB1fgNKKshUNEips+W6LWXQMU4B78x9asPe7MtF0/WqiO7gcVncu0SqhQcDHLJYQ76WBLqvdSfCeo6RL1RzWBRCE7eR12YThdfxOJbejSPrCWME+G8IcBpCgwmUA8boLnCKLu/WOhkaTDrJWMlo5ikGJ3PV1OCmdiIBalCXDXBHo4uz5L2vtg9vOdMgzSl0IYI9YqN0hBeQSUwxKMCNiQuAYO9TImYeYq4Fp4urplzJAyOoc5m6MtdAAiCeOyklkughpMTGHnnTVw+grPgk9PAP1zngI/xLh0AtJ0oialnJyH+OzUjTtUU2pQ9+jae4QucBDyfwTeimsIvH7DuKN19pbc/c6iPhxzQBADjojMRHbf06sUy65yZkjoxpQcAyIRGDFaOfp0v2174Sna9u0eBHu7+HNtQM6mv57XDijB33RxZddsKd5IueeauF2Ta8qmy6lbrHCfcPnHz0xK94mZJnpchXZExEpqQJAQ13d0hmBBZAxf/wXc/Qww2PIFeCAGMsWIqdF2uTjVnnKRgkRw2FgNsqgcMBiMdK6pVMx6vUwB467gEZgNm8tTjOdSLOVtoHOZl0iJCiU2zHiU61RKm1TyQP9PSMxiFlagoYCoRREZp7p2/mwnDuhtSQLNVc77e2p+dKyt+tFwiGWbaB8WA2bNWz9Dt0OZcef2+t6QAi6hzxkOwEL2diXDZT1062VMkzsaIhZNiHOJVSAQAu/owOEdcM6eiYVoL5EDEQfPAAAwA2vbHT6Ty0DEJhZrgkwAuAiwMDTpjbqbM+95iSZyQogM5zqGswwdG66qaLVXNrTP7zAcnLdXBsj+XQy/mbw74omMjMBUOfgDtXZBQ1Rg0JwogvAMtGjWFjaqysM0FI5j5zkMGaFZcLLq6ax64Smac1e3yZiEMGalgfpt99rKpctuzN8kL//Cy7HxzV3CBGpVtiOX3fgcjLRXAmKeoRl73DQRPfUWt1JfW4J3QuLu1FJNlr30Jeq3qwxVyxp3nSOrMMYjJaNONkvpkyYCSYKVzhkSwGtDjdTzeRubOdzH3aOIg/DckgGYrd0Ea/+DBq4XgtNMxfKp451u7oF4UYNZIg4I1A1F3c8+bLTNWTvOoIpTY1/zuKmEw0971+yUCwf3BSOyBdr2zWyrzEesArDO8tb6i3vMe3mUmb7yJujLBZIh5MECegApD/i0Y1H356Key6l8uFBcGgb7yMPf6szcgtqc1z9cGab8Q5MdDAmjqkZfed1EPMBOY7/9mvWx66nNpRAReCCQMrRqsnAMf58imJ7fI9BVY7vZ/XyhjZiB0EkQQX3n/FfL7yx6SGizfxQGYvTLJ/OMRpacO+ZnILYm801N/5KwajVIzoEKNUzL5Y3nhOxxDVCEbqhLu5ac5KPX8IT571mULZcy8LF23mvdUIzw2551d0oJxRQjyp2pSiwFz3kf7Zfblp0oHxiQe4vN0ihvVBQxC+VxszJfvz/Ip3/Bu7DV7tBxPJlAp8Azyk41L1Q8c87dapHwMTG23DuvhoAOaYJ56xhRZdu0Sz4u2ont75s7nZfsb3+jHgSi9fdF+APuP3/+T3PjYdTLx1AmahDrreT89V5772Ytq/QjHfER09MBniA4cyfC+iNIzVGdXUzXAIjdoVIao33Ph80QMvsaiK6fVhTo+Ad6KSLRqzJQpxVe0qtGQNN4Bjakv4nogLthz+RC2iVZYA/wlgi4Bz844JRMhtxZQxy7I0sHgxl+/p8AkQHWOHtSPGRd0f6aO5zoQq1Hw5REp210kTdWNqsqk4X3GL5kikbCEUF0p2JonUXCoTDxzGqadAQJkhptUqOBn2Z5iKdlRIHUlsDTB68ieIDErGQPTTEmZmqaCRAWEuTFI9oMOaPJq5U3LVSqYd37n/vdlB8AcBSYdjzjAqsUHOJ/9yQtyx8u3WYH9uOHUS+bLhw9skFRE9X3v11dY9QFB9MLfvyz7P8lBzG7v1+IKTZfce4HMXTtHGwAl/KPXP4EQV5i3YJul6XD17atkzppZEu81K8aUsb68XtWdD367QecqmvP2PdfNO+3KRbIWjY69Bxv0Q1c9qpLNnu54xyoF2UtQgoK4JyjTZo0V6tBGejZBlWFji8TXB0IhlSvR4Lb/eQsGmJjSBcZrj4X94U9zJHfDfjnlytPk66c2q3TnxOJmSPy5Vy32NBzm21BaKzuf2SrF2/PVksI82Lcwv6N4H6o8bAgLrl2q5bA3Bi3sMP/rXfMDWCCalmiSoy5sqOCbQlUz+pLKJp3Z0wZdgm+pfProRjn/H9fqaVo65q6drd06JaohqiRsQD4JF2IxBzERQTUkVhN7Y5oQJ58+Sa5/6Bq1WPi8130yDvbX0686TXucR697QordS/fa72HFRwFg7ElI7NYp9QImFJZS1aNioew62x3SMwwxFmWYdrb5fz6UFnj/+NubqrG0xJbfb1CQcgDKRlJ5ECu1uns0qiG1hVWy+TcfSB0aO/nus9zgb+4HeyUV45ypq2dpg/V+1nD+HlRAszKz5o+XaHdQP1/061d2qFR0wa7pi1hhlt7XfTUCszC2//UbOeeOVZBGllTPPmOqlMP5YqcTdYEeMOAmSkH+pjPn+//1HQ8AmV/eF0ckb+thLOwC3R5ASoATYtqZ2ZIJOzCJjZSmx8d/9Gf86t2C7OU4ngqkmfnxj2UgAGu56LtpHHgsZ6nzq17NGCR+9dhGC8xu0x95T+lK3b8DoKcEV4nPVkzCzvCA6ah+bXv4U6nHOt0EM4kCie9CYKvdG/cYkJN3vd9cbxvWf4MKaDIj3Rbcz9+HvzwKu2xvCWIYSD2vHcwlsxXYuEDpUYP1HLj8QBa+QktKwQyY49mxNdEJ/lENWQKbbjqcFYbe+Pd35KOHPkHlQxd31z3L7YJU+95/f0cWXb5Qk3JcQIltbyQmj0D37Pot7yhyUuB1Sc7bu6QS64eQFyTyJ35ckkTD+rPnxS+lpqBKwt2WH44Fxp82UbLXzJEIePbKoQ/v/etOXT3K4Fkzcf/jB5046KTKYvJgg0jDYDwbKloMerZ6qCKF246oVE+HjT1z8WSrgdgzCoLjQQU034+VbojdO1fPUd3OnHTv9UtUqXGy7GdrpAJfot0OXY8hYgbU1EXroE8bisSgixURCLFhVWLdjrf+4z0dGPGrAFue+UKFLq0uBCvLGh4RrqrDng/2eQAdjYbHjWAfSKIEzN94SGqgIqh0RxmqUcbyfSU9bMAs20T0GuRp/ud5lj6LghCI4xZOkKWwU6s1A+lSp4+RaIByKxpqL0KDaYXX7wiWfGBDIrEuqLOf+fdrJQI9KdWSVICbz2tBVB97BZN3r/yG+cSgA1orxf2SrCxu3p0VzUtxY5Nk6Y/PlqSJqbrx3M6/fI6FSSxQE9jhUD0MDQSQaN7au/6AEKgEAi0diVibbzzWAaF6kY65kclYiJ36MNUm6uAeQnl8NUzP9X4eUKUo/uqoSkOThZoMbY2XPdi4UyfKxOXZAH4FpCe/7WhJbgJt5oWn6G8Odkmd7a2SeTq+vvvhXinHeITWEEO8r6qgXCWwyQNSRGZdskDB3G0StKxHLkwSIO8Ho2cyZQpkP+iApjXBECVqCvTPYkgbu9pB5nAZW5qrKB34e9q6uXrbDoIaf9SdU7CguiHGetjNbub8ye4J6g7MpKGuvxjWiTnnzpJ0mKVM136y+Q1EekpKC549c6NwoB48BmrXabesUB26oaxOGyN5S75FwxubAPMaG6edeJ2S+hgW+cGkIQ+xAVFvZr50rWseGFckTU7zqVLwejCT7dUGvphs8SU5pda4ya2PzlkzUz1p9qepTRVSaeuDH8viW1da0gVd6fS1c2mLkG2PfSZTlkzGmhzdgC6FWkKTWyBEbYEVdN7d58jZt5/Vy4zIa/XwXtYhGIcRgNHxUWoRCeSZ/tyrgzGA1+jwPOCgjgFKkxA2kI1GFwY1iFYObdRutYeSkxYgAtNievfTCMNIlN8XtTVZoaR6DXlQpaAOPxC9oK/nDea5QQU0pUIhvi5VjVXxkyB9SfMvmicfP/yZlHN9Z5t5iZWQjyAkVsTiW85SCUm9mYMSTtLkkgf2Lv4A7M2BSgvmv+5/rZE1d6/WsvEf9eh9Hx2Qg9Bj8xEMxRDWZkSoNaFHWHjxfLkRJr7BJPZQU86ZJWmQpvyCF7FKPsZiDb948JAOG0pTSmt6IFUNc4/0qJa1IWKODpmwKFqRCONuasF7+CL9/rlb4FDdIA+o1vBZ3uqhr/uD6dygApoArMN6dDsQUGTCKWOgi15238Vq8qIksnftlAoKatTD4tsAanj1WDnTONLOSlSJwUqjs2Xvh/t6uNLJVNUB3dKqF5ORp70BsJFkYrS+6raVnqRlWL7smTufk6PbCzQtgaR54plsfPYG6LlpgA9YRloRJp810+Pw4CM4pqBENt5D6xzMjojsYzQfifxuqmqQGswpZKip0aEp6dkIKg5Af3br2noD/jHf2IwE1IOlVzOPZpgrK2CjzoLezUGnnXQqHXgcrNLbl6pmL3/AxwTFxsc3Y82NRk9eM1dNl6t/eyW6wEhVG+xAo8QhqLf8bgPsqowPtoDI+XK57k+2ffbYJo3l8MZuyiR+l7Cn7siHav7IJwb6pSEOAidjedsITPU3tOHBT2B/PqIxI7STs+ysYOBZHQhsBENBbOgErn1TNcTrhQnwOKghMbAkmfdmuv3wwhqdmEClI6VgS65U5HSb/cx7MI9ExFPHwjtqnCy8tu+V7WgcjWrGo05PDyGFSUNZrZbLYw83GQXJfvABDelB+/Hb98M0ZqMFUD3ueOlWOe27iyQKwGb3z66OtmF2gREIVUuBDVWXYEVFMn6CS099tSFHtjy9VXXFWthG7Y1h4cXzVA+m+5mAZZ40SbFRXPCLdQh2yu4uASS2t3OnDQH72oDcEogg0e4XZaK30/Qy3ZkM7xGlpAteyfE2mzAbYenOAvUaFn8FuzHGMLRTb39qi76bd4nJP+rWWXBUkWck9prVRyvks/98V/LgMi/bXSwHEUH46f3vyvp7X9c9ewI29mCjbvE0iCVzQZ/b/JetkoaRc/fsDtEgoGsREqqBP+gO6yHFGb+RhhiNMViWl91jOdbzOACGUjiRffhChMxENNoOxCyUIWahEt1rKiQzaQKCeG545DqN1GPIpgufdBuD774sumKhTMLnJ+zEyuDa0XY66+blcGcXa558Ns10E7HuHnXn2ZhZY1eP7PcN5zF17mzEn+RDAjfyG5EAIyUqA4tKAGyqCEyjNuY+8EcgZ5+H1V6/OKxxHqpqQbLTWbPt4U/UO0npTQnN/Bm4VIS0DIzyVkmGkxd89pAAmkgkk97497ex+EmrrLlzdY/WnZSZKNx8URrMedSt92Gxc52xDGRPh0mPFfUFmL3xic1yyS8v9NxqZrlQ8tglCPXJGkj0FEw5IjGAiQO/IjQWTgcjsUHc/cbt2sBYcVzllA4cQ7SqeEt1c60/e7RRBQiBYgZflLr87S/xPaPhkDrt5jOhpn2kwUoKSPDbEAfcBG0UHEHscZTwcDZa8og9ET20HLcwHqQRQVjkuerbSKPk3vN5VGOo5vA42GjQVQ7zwqZ1v/Of78tjNzwJC0KBuXTcPWOlv3hik2x75FOVNKwASoVpa2bDGrJSPoN+vondqRfZwVwNVeXJ255WB4pJxp6gGYE8z9z1vBTAEmOIAU60QzNew4C5Bnbat+FNfOWev5pk2pPQ2WIHH4/Ne5qEzM+expznXgdkafGSgl6kFaYzms9iAE7OG6RU9ZuAf85vnARPXhryYuMljwhi3aB6jUE46gp4/qgr01nC86kz8Rk+N1Cpc6dMSZOVP1+nnkaCXPOgLs98cA9/03M4/5ol6tjh+WCjoZHQ7rdmxbKC6Z3Lhbt2xqoZMu/8uTIRkjEeAUC8RkY2wb3KIPn9Gw7obJayvAqAwoqMO53WD0hP6se0fnAa06u/fFN2v7dXTYJjoaow2o0DuCoE81AK08pSBdWE+dKpQ2tWC8IuuS+BqvPQ9x7Vcsw6e4aGkVJ687vfVGkObTqEkNSDUg3zHXuR5zENzAIu1B+kYSDTC//4CswI1kvSbs0JCi/Axc/8+T6ciWNvYB4Q4Dpd7LS95+M5lJ7jYVmgiY73+UMsCyfX7nl1u5x20wo5BbEpJQj9pEeQThden4BZQmPhWWScBqdu7XttuyRPTYd5EJYUGyh5HI93XI7wg3Lw5diuIjhdatC4sB40nC3JaOgZsJ7E4rPTHguKP4UcwjT4AjG10+NTCz5UU1NdJRljra75+Km7r9K89pt1v9MZ3N4VyseyxZOiE6IlBssZqDEfZqQmVBCtIu34LgvjKAhgEtNnYUKqBWrrfBUGnBy8MJidb0KrBbtcdocECNUUrmnMPFgJxoPGBsIGRGJaLQvOUXJTajEtB6hMR4Cz/Jqnu8y8jxMG9D2Q1hCfT8uBWQgct6PrDpFlP1mDwZuPjwbhOvOmjsu0BI+/YOYzqU4cen8PFoavkNPRMLgCkk7KRdl2Pv05FoqPl2nQj6ku8V0YmceoOgI7nGXtQ22gWsHGpkwlQlBGbaAQFH3dw/L0RcyvePtRaUeIKmcdnQyRx8VYEzAzq+c4yFceQyqh7QUw0prn2jDLgs4XMoykFQwA8ktUdiLgCz4/rKeW3H62VME5swk6H4PcDTiZByUNPYxM7yGcJ9C5eROfZ2aTcx5gJ1Yx4jmC204+z+E5LqzZZ6eQcJxzN0KeZ3d+PCJAumMmjpfSxzVUNgdpk9G7KNDwm70TVZgyxGsvXjldVRkCMxTCgWmpdtBkagSKj1wtlaenCdpXsqA7Z6vx4SubduGUBn4QQVqIWOXNLR9oUA6dAEaC6+3IhmDuNwV6f78f3L8bqWvT/c1oOvZGJPKTs1EYLx2dHKu9iHVepAnqD6X2aKWgAPTJMpfdbClmvtDS0QPMJ5vRKEgfAm8qedCKAS5VCncnZ6ldbvXFWrTc0h4iYLWpY284SqlnXzmCXlJ1POp133KinssouiIEd6mZDfyg6hGNMQn1cs4YtyYGWwPUNHz/huMO43AabewbsYAebRXR3/ehfj6B09H2l2Ag3W1NYYPnIDTv4wM6HmD+dI4kjk9W9aQIM8N9jSf6W45guc8BdLDURD/LQWkch0kJybAhF2zBzBUAmcSBcdbSKVKPqWu1UDE4oCVhbChTzp4pRzcdVIuKnhxF/xxAj4LKpJlvAsBbuquwO8AIyI2Mj9apVMWQxur6xrsyJJXTq2ge5GI1xrEyCtigr+AAehTUJAGtizfC2tGMhRtp5SDxPBd3pM6M9XCtN8WOkXPxmFpm6dejaxziANqq5pH9nyCFk4jWH12lyagXcFLRlc4BICWynTiTu4khvW7w26+N5OMRabYbyQwfrLJ75Kw54B5gNZYPnUHfZV1UfRqH+ssB9GBViZPvCTlAEAKAulEK67EF3BaoGrR40FxH9YISOSQEK58inoOgbqOUhgpCQzXjzeswWEyfPU46ERNDUuAzP/bZ3GPHAaRGRiA/7vUY54KZHAkdpLVDKWptCPEEughGxpe0NDRrMBJjMlrw2Tx6BDlXsAFxMwQpwz8ZuEVwE9SM4ON9H97zmoKZr0vbNR0x5ftKsYDNbgwYQzVMgF8KYHgsF2bksmOR2BiUpMeYBBCBxSs5OZexKQp297QwBXqQ8NEBdJBUBMFLKck9TW4ekGLVU645x6UGGjFpgZF1nMBKkNKuTIFJacrgIXoMaY/WMxTgPK9SHK5wW1CVdRrzD2G37pa6lMC4oki1sM/7Q5AndXPGukQiiIxxIJz2xSUnOLCMRVw0J9Py2XS9a5nMAJQPGmJyAD3EDLc/jgBWIECS0inCpW4rMGWqCuGyDNskqClpiTGPxHYDlPfhs7z27PTY+4NDJoGxfJjf3KvqYsHefrrXcRfKx4bEXoGWEdq+2WvQWkLpTWAzhjsVsdi0tvAcEzDORAOmeuU4eCccQA8eb33mrJIYzg+qELQD03bMuBQChaAhALhSEu3DTEvpOOxEac+GRPDbgxWhktNS0oCZ/cVc5hcNjDo8wc01rbmWNCU4aahU7yDg1rBX15AUQMEJidaC6U2Mu+DM9kpMYmhjnLJbXRhxrmg30MNCu1FOnZ4hvvRaRkL/5oQArok3dn4WGmeYDHZE6qADmhJnqLudIUHoSTyEKkMzv3v+4leSu36f6sO9QIw0wTS4OonX65VU1SGcbYXKdHTjQTTeQxpAFQe9e4x7fe5eNw3QiUEFNLspszY0K/DbTAfxYSSazqhKJCD24ttEVDeaYD6swdIIE65bOqivPqiA5qzp21+6xS2hv92AtkZ2324esAcayFnzvlrGoAKaUjl+FM+O8MVQ59zwcqC33Wd4y+M83eFAQBxwAB0Q+5ybg40DDqCDrUac8gTEAQfQAbHPuTnYOOAAOthqxClPQBxwAB0Q+5ybg40DDqCDrUac8gTEAb8AHcZPQ2BypUMOB4aDA1aIq3/hTX4BOjwiQtdLc0A9HNXpPLOpsVEiXD3XOeyLK34BmjcnJCVKWSmDxx1yODB0HKB0riwvk6Rk6ysNJ3qy/4BOTMKkiFA5VlKMmQk9ZxCf6CHOdYcD/eFAW1urFB49IonJyX5LaL/Wh7YXpqoSsylqayUqOhrrEGPdZD9mPNjvd44dDpyIAwg4xqdLWqS9vU1S0tIkJtaaJHCi+3j9pAHNm9gNNDc16QORBU855HBggDiA6V34i4h0SWRk1Enn2S9An/RTnBscDgwRB/zWoYeoPM5jHA4ExAEH0AGxz7k52DjgADrYasQpT0AccAAdEPucm4ONAw6gg61GnPIExAEH0AGxz7k52DjgADrYasQpT0AccAAdEPucm4ONA/8f4pfom9xz5P4AAAAASUVORK5CYII=';

function dv_logoHeader(){
    var logoLeft=LOGO_AV_B64
        ? '<img src="'+LOGO_AV_B64+'" style="height:24mm;width:auto;">'
        : '<div style="font-size:18pt;font-weight:900;line-height:1.2;"><span style="color:#333;">ARTISANS</span> <span style="color:#16a34a;">VERTS</span></div>';
    var logoRight=LOGO_RGE_B64
        ? '<div style="text-align:right;"><img src="'+LOGO_RGE_B64+'" style="height:16mm;width:auto;"><div style="font-size:5.5pt;color:#333;text-align:center;line-height:1.3;margin-top:1mm;">N\u00b0 QPAC/69719<br>VAL 15/02/2027</div></div>'
        : '<div style="border:2px solid #7b2d8e;border-radius:6px;padding:4px 6px;width:74px;text-align:center;background:#fff;"><div style="font-size:9pt;font-weight:900;color:#7b2d8e;letter-spacing:0.5px;">RGE</div><div style="font-size:8.5pt;font-weight:800;line-height:1.1;"><span style="color:#7b2d8e;">Quali</span><span style="color:#16a34a;">Pac</span></div><div style="font-size:5pt;color:#333;margin-top:2px;line-height:1.3;">N\u00b0 QPAC/69719<br>VAL 15/02/2027</div></div>';
    return '<div class="dv-header">'+logoLeft+logoRight+'</div>';
}

function dv_subHeader(num,df,nom){
    return dv_logoHeader()+'<div style="font-size:12pt;font-weight:900;border-bottom:2px solid #000;padding-bottom:2mm;margin-bottom:3mm;display:flex;justify-content:space-between;"><span>DEVIS '+num+' du '+df+'</span><span>'+nom+'</span></div>'+ite_dvTH();
}

// ============================================
// PDF LIBS DYNAMIC LOADER
// ============================================
function loadScript(src){
    return new Promise(function(resolve,reject){
        var existing=document.querySelector('script[src="'+src+'"]');
        if(existing){existing.remove();}
        var s=document.createElement('script');
        s.src=src;
        s.crossOrigin='anonymous';
        s.onload=resolve;
        s.onerror=function(){reject(new Error('Impossible de charger: '+src));};
        document.head.appendChild(s);
    });
}

var JSPDF_CDNS=[
    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js',
    'https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js',
    'https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js'
];
var H2C_CDNS=[
    'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
    'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js',
    'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js'
];

async function ensureJsPDF(){
    if(window.jspdf && window.jspdf.jsPDF) return window.jspdf.jsPDF;
    for(var i=0;i<JSPDF_CDNS.length;i++){
        try{
            await loadScript(JSPDF_CDNS[i]);
            if(window.jspdf && window.jspdf.jsPDF) return window.jspdf.jsPDF;
        }catch(e){console.warn('jsPDF CDN '+i+' failed:',e);}
    }
    throw new Error('Impossible de charger la biblioth\u00e8que jsPDF. V\u00e9rifiez votre connexion internet.');
}

async function ensureHtml2Canvas(){
    if(typeof html2canvas==='function') return html2canvas;
    for(var i=0;i<H2C_CDNS.length;i++){
        try{
            await loadScript(H2C_CDNS[i]);
            if(typeof html2canvas==='function') return html2canvas;
        }catch(e){console.warn('html2canvas CDN '+i+' failed:',e);}
    }
    throw new Error('Impossible de charger la biblioth\u00e8que html2canvas. V\u00e9rifiez votre connexion internet.');
}

// ============================================
// PDF DOWNLOAD (remplace window.print)
// ============================================
async function downloadDevisPDF(containerId,filename){
    var container=document.getElementById(containerId);
    var pages=container.querySelectorAll('.ite-page');
    if(!pages.length){alert('Aucune page \u00e0 g\u00e9n\u00e9rer');return;}
    // Loading overlay
    var ov=document.createElement('div');
    ov.id='pdfLoadingOverlay';
    ov.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:99999;display:flex;align-items:center;justify-content:center;';
    ov.innerHTML='<div style="background:#fff;padding:32px 48px;border-radius:16px;text-align:center;font-family:Arial,sans-serif;"><div style="font-size:18px;font-weight:700;margin-bottom:12px;">G\u00e9n\u00e9ration du PDF...</div><div style="font-size:14px;color:#666;">Veuillez patienter</div></div>';
    document.body.appendChild(ov);
    try{
        var JsPDF=await ensureJsPDF();
        var h2c=await ensureHtml2Canvas();
        var pdf=new JsPDF('p','mm','a4');
        for(var i=0;i<pages.length;i++){
            if(i>0) pdf.addPage();
            var canvas=await h2c(pages[i],{scale:2,useCORS:true,backgroundColor:'#ffffff',logging:false,width:pages[i].scrollWidth,height:pages[i].scrollHeight});
            var imgData=canvas.toDataURL('image/jpeg',0.95);
            pdf.addImage(imgData,'JPEG',0,0,210,297);
        }
        pdf.save(filename);
    }catch(e){
        console.error('PDF generation error:',e);
        alert('Erreur lors de la g\u00e9n\u00e9ration du PDF: '+e.message);
    }finally{
        var ovEl=document.getElementById('pdfLoadingOverlay');
        if(ovEl) ovEl.remove();
    }
}

function ite_generateDevis(){
    var totLot2=ite_getLot2Total();
    var totLot3=ite_getLot3Total();
    var hasLot3=ite_V('iteIncludeLot3')==='oui'&&totLot3>0;
    if(totLot2<1500&&!confirm('\u26a0\ufe0f LOT 2 < 1500\u20ac ('+ite_fmtN(totLot2)+'\u20ac). Continuer ?'))return;
    if(hasLot3&&totLot3<1500&&!confirm('\u26a0\ufe0f LOT 3 < 1500\u20ac ('+ite_fmtN(totLot3)+'\u20ac). Continuer ?'))return;
    var nom=(document.getElementById('prenom').value.trim()+' '+document.getElementById('nom').value.trim()).trim()||'CLIENT';
    var num=ite_V('iteNumDevis'),nc=ite_V('iteNumClient')||num;
    var dRaw=ite_V('iteDateDevis').split('-'),df=dRaw[2]+'/'+dRaw[1]+'/'+dRaw[0];
    var adr=ite_V('iteAdresse'),vil=ite_V('iteVille'),tel=ite_V('iteTel'),em=ite_V('iteEmail');
    var zn=document.getElementById('zone').value;
    var prec=ite_V('itePrecarite'),tch=ite_V('iteTypeChauffage');
    var surfCl=document.getElementById('surfaceClient').value||'\u2014';
    var tlog='Maison individuelle / +15 ans / '+surfCl+' m\u00b2';
    var con=ite_V('iteConseiller');
    var tva=parseFloat(ite_$('iteTva')?.value)||5.5;
    var precL={classique:'Classique',modeste:'Modeste',grande:'Tr\u00e8s modeste'}[prec]||prec;
    var sITE=ite_N('iteSurfaceITE'),totITE=ite_N('iteMontantLot1');
    var t2=ite_V('iteTypeLot2'),t3=hasLot3?ite_V('iteTypeLot3'):'';
    var ttc=totITE+totLot2+totLot3,ht=ttc/(1+tva/100),tvam=ttc-ht;
    var primeCEE=ite_N('itePrimeCEE'),reste=ttc-primeCEE;
    var catMPR=document.getElementById('categorie').value;
    var has148=(t2==='148')||(hasLot3&&t3==='148');
    var mprCET=has148?(MPR_CET[catMPR]||0):0;
    var wFin=ite_V('iteIncludeFinancement')==='oui';
    var tp=hasLot3?4:3; if(wFin)tp++;
    var tvaStr=tva.toFixed(2).replace('.',',')+' %';
    // Isolant data
    var isolKey=ite_V('iteIsolantITE')||'CELLOMUR_120';
    var isol=ITE_ISOLANT[isolKey]||ITE_ISOLANT.CELLOMUR_120;
    // ITE Material / MO split
    var pmITE=ite_N('itePrixMatITE'),pmoITE=ite_N('itePrixMoITE');
    if(pmITE<=0||pmoITE<=0){var ipp=sITE>0?totITE/sITE:0;pmITE=Math.round(ipp*0.59*100)/100;pmoITE=sITE>0?Math.round((totITE-pmITE*sITE)/sITE*100)/100:0;}
    var matITE=Math.round(sITE*pmITE*100)/100,moITE=totITE-matITE;
    // kWh Cumac
    var kwhc102=Math.round(sITE*(KWHC_102[zn]||1300));

    // =========================================================
    // PAGE 1 : Header + Info + BAR-EN-102
    // =========================================================
    var pg1='<div class="ite-page">'+dv_logoHeader();
    pg1+='<div class="dv-title"><span>DEVIS : '+num+'</span><span>'+nom.toUpperCase()+'</span></div>';
    pg1+='<div class="dv-info"><div class="dv-info-l">'
    +'Num\u00e9ro Client : <b>'+nc+'</b><br>'
    +'Date de devis : <b>'+df+'</b><br>'
    +'Date de visite pr\u00e9alable : <b>'+df+'</b><br>'
    +'Adresse des travaux : '+adr+'<br>'
    +vil+'<br>'
    +'Conseiller : <b>'+con+'</b>'
    +'</div><div class="dv-info-r">'
    +nom+'<br>'+adr+'<br>'+vil+'<br>'
    +'T\u00e9l : '+tel+'<br>'
    +'E-mail : '+em+'<br>'
    +'Zone : <b>'+zn+'</b><br>'
    +'Pr\u00e9carit\u00e9 : <b>'+precL+'</b><br>'
    +'Type de chauffage : '+tch+'<br>'
    +'Type de logement : '+tlog
    +'</div></div>';
    pg1+=ite_dvTH();
    // --- BAR-EN-102 description ---
    pg1+='<div class="dv-block">'
    +'<b>BAR-EN-102 : Mise en place d\'une isolation thermique des murs par l\'ext\u00e9rieur</b>'
    +'Surface \u00e0 isoler : <b>'+sITE.toFixed(2)+' m2</b><br>'
    +'Produit <b>*ISOLATION MURS EXTERIEURS</b>, Marque <b>'+isol.brand+'</b>, R\u00e9f\u00e9rence<br><b>'+isol.ref+'</b>, Epaisseur <b>'+isol.thickness+' mm</b><br>'
    +'R\u00e9sistance thermique <b>'+isol.R+' m\u00b2.K/W</b> \u00e9valu\u00e9e selon la norme '+isol.acermi+' .<br>'
    +'Certification Acermi <b>'+isol.acermi+'</b><br><br>'
    +'- Kwh Cumac : <b>'+kwhc102.toLocaleString('fr-FR')+'</b><br><br>'
    +'Travaux sous-trait\u00e9s aupr\u00e8s de l\'entreprise <b>RL CONSEILS</b>, 2 RUE LOUIS PERGAUD<br>94700 MAISONS-ALFORT<br>'
    +'repr\u00e9sent\u00e9e par <b>GUERGOUZ ABDALLAH</b>, SIRET <b>85320240600049</b>, Certificat rge<br>Num\u00e9ro <b>E-E 184700</b> attribu\u00e9 le 02/07/2024 valable jusqu\'au 01/07/2026<br>'
    +'. Date de la visite technique : <b>'+df+'</b>'
    +'</div>';
    // --- Material row ---
    pg1+='<div class="dv-row"><div class="n">'+isol.ref+'</div><div class="c">'+sITE.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pmITE)+'</div><div class="r">'+ite_fmt(matITE)+'</div><div class="r">'+tvaStr+'</div></div>';
    pg1+='<div class="dv-specs">'
    +'Isolant :&nbsp; Marque : Hirsch<br>'
    +'Ref. : Cellomur Ultra '+isol.thickness+' Epaisseur : '+isol.thickness+'mm<br>'
    +'R\u00e9sistance thermique : '+isol.R+'m\u00b2 K/W<br>'
    +'ACERMI : '+isol.acermi+'<br>'
    +'Accessoire : - Visserie - Menuiserie - Ossature m\u00e9tallique - Colle et mortier<br>'
    +'Enduit - Finition'
    +'</div>';
    // --- MO row ---
    pg1+='<div class="dv-row"><div class="n">Main d\'\u0153uvre pour travaux isolation des murs par l\'ext\u00e9rieur</div><div class="c">'+sITE.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pmoITE)+'</div><div class="r">'+ite_fmt(moITE)+'</div><div class="r">'+tvaStr+'</div></div>';
    pg1+='<div class="dv-specs">'
    +'-Mise \u00e0 disposition des ouvriers<br>'
    +'Mise en place de 5 chevilles par plaque d\'isolant Enduit qui recouvre et prot\u00e8ge l\'isolant Gestion de l\'\u00e9tanch\u00e9it\u00e9 au niveau des jonctions Harpage, joints d\u00e9cal\u00e9s, rebouchage au mortier des espaces entre panneaux Mise en place de Cr\u00e9pi avec distance entre le sol fini et le rail de d\u00e9part sup\u00e9rieure \u00e0 15 cm :<br>'
    +'Marque du cr\u00e9pi<br>'
    +'Enduit AFC 1.5 base Soltherm<br>'
    +'-Mise en place d\'un \u00e9chafaudage<br>'
    +'Livraison , montage et d\u00e9montage<br>'
    +'Protection des sols par b\u00e2che<br>'
    +'-Mise en place d\'une peinture de couleur :<br>'
    +'Ton pierre Protection en t\u00eate d\'ITE avec mise en place d\'une \u00e9paisseur suffisante du produit de finition afin de prot\u00e9ger contre les intemp\u00e9ries et les rayonnements solaires<br>'
    +'Rail de d\u00e9part'
    +'</div>';
    pg1+=ite_dvFT(1,tp)+'</div>';

    // =========================================================
    // LOT 2 CONTENT (description + rows)
    // =========================================================
    var lot2Desc='',lot2Rows='';
    if(t2==='103'){
        var s2=ite_N('iteSurface103'),pm2=ite_N('itePrixMat103'),pmo2=ite_N('itePrixMo103');
        var kwhc103=Math.round(s2*(KWHC_103[zn]||890));
        lot2Desc='<div class="dv-block">'
        +'<b>BAR-EN-103 : Mise en place d\'une isolation thermique en Plancher bas</b>'
        +'Surface \u00e0 isoler : <b>'+s2.toFixed(2)+' m2</b><br>'
        +'Produit <b>ISOLATION PLANCHER BAS</b>, Marque <b>ACTIS</b>, R\u00e9f\u00e9rence <b>ISOLATION - TETRIS SUPER 8</b>, Epaisseur <b>80 mm</b><br>'
        +'R\u00e9sistance thermique <b>3,8 m\u00b2.K/W</b> \u00e9valu\u00e9e selon la norme NF EN 12664, la norme NF EN 12667 ou la norme NF EN 12939 pour les isolants non r\u00e9fl\u00e9chissants et selon la norme NF EN ISO 22097 pour les isolants r\u00e9fl\u00e9chissants.<br><br>'
        +'- Aucun am\u00e9nagement n\'a \u00e9t\u00e9 n\u00e9cessaire (caches spot, pare-vapeur, \u00e9cart au feu, contour de trappe, pige de rep\u00e9rage)<br><br>'
        +'- Kwh Cumac : <b>'+kwhc103.toLocaleString('fr-FR')+'</b><br><br>'
        +'Travaux sous-trait\u00e9s aupr\u00e8s de l\'entreprise <b>ENEFFY</b>, 8 RUE DE LA RICHARDIERE<br>'
        +'35530 NOYAL-SUR-VILAINE<br>'
        +'repr\u00e9sent\u00e9e par <b>LEMOIGN IWAN</b>, SIRET <b>92238972100023</b>, Certificat rge Num\u00e9ro <b>E-E205719</b> attribu\u00e9 le 08/11/2024 valable jusqu\'au 07/11/2026<br>'
        +'. Date de la visite technique : <b>'+df+'</b>'
        +'</div>';
        lot2Rows='<div class="dv-row"><div class="n">Mise en \u0153uvre d\'une solution d\'isolation pour planchers bas</div><div class="c">'+s2.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pmo2)+'</div><div class="r">'+ite_fmt(s2*pmo2)+'</div><div class="r">'+tvaStr+'</div></div>'
        +'<div class="dv-specs">'
        +'Mise en \u0153uvre des \u00e9carts autour des sources de chaleur<br>'
        +'Mise en \u0153uvre des protections \u00e9lectriques<br>'
        +'Mise en \u0153uvre de l\'isolant<br>'
        +'Nettoyage du chantier<br>'
        +'Mise en d\u00e9chetterie des gravats ou tout autres d\u00e9chets li\u00e9 \u00e0 cette prestation'
        +'</div>'
        +'<div class="dv-row"><div class="n">ISOLATION - TETRIS SUPER 8</div><div class="c">'+s2.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pm2)+'</div><div class="r">'+ite_fmt(s2*pm2)+'</div><div class="r">'+tvaStr+'</div></div>'
        +'<div class="dv-specs">'
        +'Fourniture de l\'isolant pour l\'isolation des plancher bas<br>'
        +'Marque : ACTIS \u2013 R\u00e9f\u00e9rence : TETRIS SUPER 8<br>'
        +'Conforme \u00e0 la norme RT 2012 -<br>'
        +'R\u00e9sistance thermique : 3.80m\u00b2.K/W - \u00c9paisseur : 80mm - R\u00e9action au feu : Euroclasse E<br>'
        +'Tol\u00e9rance d\'\u00e9paisseur : T2 - Transmission de vapeur d\'eau : MU 20 \u00e0 40 - Contrainte en compression : CS (10) 40<br>'
        +'Norme : 16012 + A1'
        +'</div>';
    } else if(t2==='101'){
        var s2=ite_N('iteSurface101'),pm2=ite_N('itePrixMat101'),pmo2=ite_N('itePrixMo101');
        var kwhc101=Math.round(s2*(KWHC_101[zn]||1200));
        lot2Desc='<div class="dv-block">'
        +'<b>BAR-EN-101 : Mise en place d\'une isolation thermique des combles perdus</b>'
        +'Surface \u00e0 isoler : <b>'+s2.toFixed(2)+' m2</b><br>'
        +'Produit <b>ISOLATION COMBLES</b>, Isolation par soufflage<br>'
        +'R\u00e9sistance thermique <b>R \u2265 7 m\u00b2.K/W</b><br><br>'
        +'- Kwh Cumac : <b>'+kwhc101.toLocaleString('fr-FR')+'</b><br><br>'
        +'Mat\u00e9riel(s) fourni(s) et mis en place par notre soci\u00e9t\u00e9 <b>LES ARTISANS VERTS</b>.<br>'
        +'repr\u00e9sent\u00e9e par <b>TORDJMAN BENJAMIN</b>, SIRET <b>87806279300038</b>, Certificat rge Num\u00e9ro <b>QPAC/69719</b> attribu\u00e9 le 15/02/2026 valable jusqu\'au 15/02/2027<br>'
        +'. Date de la visite technique : <b>'+df+'</b>'
        +'</div>';
        lot2Rows='<div class="dv-row"><div class="n">Mise en \u0153uvre isolation combles par soufflage</div><div class="c">'+s2.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pmo2)+'</div><div class="r">'+ite_fmt(s2*pmo2)+'</div><div class="r">'+tvaStr+'</div></div>'
        +'<div class="dv-specs">'
        +'Mise en \u0153uvre de l\'isolant par soufflage m\u00e9canique<br>'
        +'V\u00e9rification de l\'\u00e9tat du support<br>'
        +'Nettoyage du chantier'
        +'</div>'
        +'<div class="dv-row"><div class="n">Isolation souffl\u00e9 combles mat\u00e9riel</div><div class="c">'+s2.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pm2)+'</div><div class="r">'+ite_fmt(s2*pm2)+'</div><div class="r">'+tvaStr+'</div></div>'
        +'<div class="dv-specs">'
        +'Fourniture de l\'isolant pour l\'isolation des combles perdus<br>'
        +'R\u00e9sistance thermique : R \u2265 7 m\u00b2.K/W'
        +'</div>';
    } else {
        var p2=ite_N('itePrixCET'),pp2=ite_N('itePrixPoseCET'),vol2=ite_V('iteRefCET');
        var cop2=ite_V('iteCopCET');
        var cs2=ITE_CET_SPECS[vol2]||ITE_CET_SPECS['200'];
        var cn2='Chauffe-eau thermodynamique THALEOS '+cs2.model+' - '+cs2.vol+'L - '+cs2.ref;
        lot2Desc='<div class="dv-block">'
        +'<b>BAR-TH-148 : Mise en place d\'un chauffe-eau thermodynamique \u00e0 accumulation.</b><br>'
        +'Type d\'installation : <b>Sur air extrait</b><br>'
        +'Le COP du materiel install\u00e9 est de : <b>'+cop2+'</b> mesur\u00e9 selon les conditions de la norme EN 16147.<br>'
        +'Marque : <b>THALEOS</b><br>'
        +'R\u00e9f : <b>** '+cn2+'</b><br><br>'
        +'- Kwh Cumac : <b>'+KWHC_148.toLocaleString('fr-FR')+'</b><br><br>'
        +'Mat\u00e9riel(s) fourni(s) et mis en place par notre soci\u00e9t\u00e9 <b>LES ARTISANS VERTS</b>.<br>'
        +'repr\u00e9sent\u00e9e par <b>TORDJMAN BENJAMIN</b>, SIRET <b>87806279300038</b>, Certificat rge Num\u00e9ro <b>QPAC/69719</b> attribu\u00e9 le 15/02/2026 valable jusqu\'au 15/02/2027<br>'
        +'. Date de la visite technique : <b>'+df+'</b>'
        +'</div>';
        lot2Rows='<div class="dv-row"><div class="n">** '+cn2+'</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(p2)+'</div><div class="r">'+ite_fmt(p2)+'</div><div class="r">'+tvaStr+'</div></div>'
        +'<div class="dv-specs">'
        +'MARQUE : THALEOS - '+cs2.model+' - '+cs2.vol+'L - '+cs2.ref+'<br>'
        +'- Capacit\u00e9 : '+cs2.vol+' L<br>'
        +'- Profil de soutirage : '+cs2.profil+'<br>'
        +'- COP \u00e0 15\u00b0C : '+cop2+' ( Selon la norme EN 16147 )<br>'
        +'- ETAS \u00e0 15\u00b0C : '+cs2.etas+'%<br>'
        +'- RENDEMENT ENERGETIQUE (\u03b7wh) : \u2248 '+cs2.rendEtaWh+' %<br>'
        +'- Classe \u00e9nerg\u00e9tique ECS : '+cs2.cls+'<br>'
        +'- Fluide frigorig\u00e8ne : '+cs2.refrig+'<br>'
        +'- Puissance appoint \u00e9lectrique : \u2248 '+cs2.resist+' W<br>'
        +'- Temp\u00e9rature de fonctionnement air : '+cs2.temp+'<br>'
        +'- Alimentation : Monophas\u00e9 230 V<br>'
        +'- Fabrication : France<br>'
        +'- Usage : Production d\'Eau Chaude Sanitaire (ECS)'
        +'</div>'
        +'<div class="dv-row"><div class="n">FORFAIT POSE ET MISE EN SERVICE D\'UN CHAUFFE-EAU THERMODYNAMIQUE</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(pp2)+'</div><div class="r">'+ite_fmt(pp2)+'</div><div class="r">'+tvaStr+'</div></div>'
        +'<div class="dv-specs">'
        +'- Pose et installation compl\u00e8te d\'un chauffe-eau thermodynamiques<br>'
        +'- Vidange et d\u00e9pose du ballon existant<br>'
        +'- Mise en place du chauffe-eau thermodynamique en lieu et place de l\'ancien chauffe-eau.<br>'
        +'- Raccordement sur eau froide et eau chaude du circuit sanitaire existant au moyen de flexibles.<br>'
        +'- Raccordement sur tuyau de vidange existant.<br>'
        +'- Raccordement sur ligne(s) \u00e9lectrique(s) existante(s) devant correspondre aux normes en vigueur.<br>'
        +'- Remplacement du groupe de s\u00e9curit\u00e9.<br>'
        +'- Remplissage et tests d\'\u00e9tanch\u00e9it\u00e9.<br>'
        +'- Contr\u00f4le du bon fonctionnement.<br>'
        +'Mise en service et conseils d\'utilisation.'
        +'</div>';
    }

    // =========================================================
    // LOT 3 CONTENT (if any) - split into Part1 (desc) / Part2 (rows)
    // =========================================================
    var lot3Desc='',lot3Rows='';
    if(hasLot3){
        if(t3==='103'){
            var s3=ite_N('iteSurface103L3'),pm3=ite_N('itePrixMat103L3'),pmo3=ite_N('itePrixMo103L3');
            var kwhc103L3=Math.round(s3*(KWHC_103[zn]||890));
            lot3Desc='<div class="dv-block" style="margin-top:3mm;">'
            +'<b>BAR-EN-103 : Mise en place d\'une isolation thermique en Plancher bas</b>'
            +'Surface \u00e0 isoler : <b>'+s3.toFixed(2)+' m2</b><br>'
            +'Produit <b>ISOLATION PLANCHER BAS</b>, Marque <b>ACTIS</b>, R\u00e9f\u00e9rence <b>ISOLATION - TETRIS SUPER 8</b>, Epaisseur <b>80 mm</b><br>'
            +'R\u00e9sistance thermique <b>3,8 m\u00b2.K/W</b> \u00e9valu\u00e9e selon la norme NF EN 12664, la norme NF EN 12667 ou la norme NF EN 12939 pour les isolants non r\u00e9fl\u00e9chissants et selon la norme NF EN ISO 22097 pour les isolants r\u00e9fl\u00e9chissants.<br><br>'
            +'- Aucun am\u00e9nagement n\'a \u00e9t\u00e9 n\u00e9cessaire (caches spot, pare-vapeur, \u00e9cart au feu, contour de trappe, pige de rep\u00e9rage)<br><br>'
            +'- Kwh Cumac : <b>'+kwhc103L3.toLocaleString('fr-FR')+'</b><br><br>'
            +'Travaux sous-trait\u00e9s aupr\u00e8s de l\'entreprise <b>ENEFFY</b>, 8 RUE DE LA RICHARDIERE<br>'
            +'35530 NOYAL-SUR-VILAINE<br>'
            +'repr\u00e9sent\u00e9e par <b>LEMOIGN IWAN</b>, SIRET <b>92238972100023</b>, Certificat rge Num\u00e9ro <b>E-E205719</b> attribu\u00e9 le 08/11/2024 valable jusqu\'au 07/11/2026<br>'
            +'. Date de la visite technique : <b>'+df+'</b>'
            +'</div>';
            lot3Rows='<div class="dv-row"><div class="n">Mise en \u0153uvre d\'une solution d\'isolation pour planchers bas</div><div class="c">'+s3.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pmo3)+'</div><div class="r">'+ite_fmt(s3*pmo3)+'</div><div class="r">'+tvaStr+'</div></div>'
            +'<div class="dv-specs">'
            +'Mise en \u0153uvre des \u00e9carts autour des sources de chaleur<br>'
            +'Mise en \u0153uvre des protections \u00e9lectriques<br>'
            +'Mise en \u0153uvre de l\'isolant<br>'
            +'Nettoyage du chantier<br>'
            +'Mise en d\u00e9chetterie des gravats ou tout autres d\u00e9chets li\u00e9 \u00e0 cette prestation'
            +'</div>'
            +'<div class="dv-row"><div class="n">ISOLATION - TETRIS SUPER 8</div><div class="c">'+s3.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pm3)+'</div><div class="r">'+ite_fmt(s3*pm3)+'</div><div class="r">'+tvaStr+'</div></div>'
            +'<div class="dv-specs">'
            +'Fourniture de l\'isolant pour l\'isolation des plancher bas<br>'
            +'Marque : ACTIS \u2013 R\u00e9f\u00e9rence : TETRIS SUPER 8<br>'
            +'Conforme \u00e0 la norme RT 2012 -<br>'
            +'R\u00e9sistance thermique : 3.80m\u00b2.K/W - \u00c9paisseur : 80mm - R\u00e9action au feu : Euroclasse E<br>'
            +'Tol\u00e9rance d\'\u00e9paisseur : T2 - Transmission de vapeur d\'eau : MU 20 \u00e0 40 - Contrainte en compression : CS (10) 40<br>'
            +'Norme : 16012 + A1'
            +'</div>';
        } else if(t3==='101'){
            var s3=ite_N('iteSurface101L3'),pm3=ite_N('itePrixMat101L3'),pmo3=ite_N('itePrixMo101L3');
            var kwhc101L3=Math.round(s3*(KWHC_101[zn]||1200));
            lot3Desc='<div class="dv-block" style="margin-top:3mm;">'
            +'<b>BAR-EN-101 : Mise en place d\'une isolation thermique des combles perdus</b>'
            +'Surface \u00e0 isoler : <b>'+s3.toFixed(2)+' m2</b><br>'
            +'Produit <b>ISOLATION COMBLES</b>, Isolation par soufflage<br>'
            +'R\u00e9sistance thermique <b>R \u2265 7 m\u00b2.K/W</b><br><br>'
            +'- Kwh Cumac : <b>'+kwhc101L3.toLocaleString('fr-FR')+'</b><br><br>'
            +'Mat\u00e9riel(s) fourni(s) et mis en place par notre soci\u00e9t\u00e9 <b>LES ARTISANS VERTS</b>.<br>'
            +'repr\u00e9sent\u00e9e par <b>TORDJMAN BENJAMIN</b>, SIRET <b>87806279300038</b>, Certificat rge Num\u00e9ro <b>QPAC/69719</b> attribu\u00e9 le 15/02/2026 valable jusqu\'au 15/02/2027<br>'
            +'. Date de la visite technique : <b>'+df+'</b>'
            +'</div>';
            lot3Rows='<div class="dv-row"><div class="n">Mise en \u0153uvre isolation combles par soufflage</div><div class="c">'+s3.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pmo3)+'</div><div class="r">'+ite_fmt(s3*pmo3)+'</div><div class="r">'+tvaStr+'</div></div>'
            +'<div class="dv-specs">'
            +'Mise en \u0153uvre de l\'isolant par soufflage m\u00e9canique<br>'
            +'V\u00e9rification de l\'\u00e9tat du support<br>'
            +'Nettoyage du chantier'
            +'</div>'
            +'<div class="dv-row"><div class="n">Isolation souffl\u00e9 combles mat\u00e9riel</div><div class="c">'+s3.toFixed(2)+' m\u00b2</div><div class="r">'+ite_fmt(pm3)+'</div><div class="r">'+ite_fmt(s3*pm3)+'</div><div class="r">'+tvaStr+'</div></div>'
            +'<div class="dv-specs">'
            +'Fourniture de l\'isolant pour l\'isolation des combles perdus<br>'
            +'R\u00e9sistance thermique : R \u2265 7 m\u00b2.K/W'
            +'</div>';
        } else {
            var p3=ite_N('itePrixCETL3'),pp3=ite_N('itePrixPoseCETL3'),vol3=ite_V('iteRefCETL3');
            var cop3=ite_V('iteCopCETL3');
            var cs3=ITE_CET_SPECS[vol3]||ITE_CET_SPECS['200'];
            var cn3='Chauffe-eau thermodynamique THALEOS '+cs3.model+' - '+cs3.vol+'L - '+cs3.ref;
            lot3Desc='<div class="dv-block" style="margin-top:3mm;">'
            +'<b>BAR-TH-148 : Mise en place d\'un chauffe-eau thermodynamique \u00e0 accumulation.</b><br>'
            +'Type d\'installation : <b>Sur air extrait</b><br>'
            +'Le COP du materiel install\u00e9 est de : <b>'+cop3+'</b> mesur\u00e9 selon les conditions de la norme EN 16147.<br>'
            +'Marque : <b>THALEOS</b><br>'
            +'R\u00e9f : <b>** '+cn3+'</b><br><br>'
            +'- Kwh Cumac : <b>'+KWHC_148.toLocaleString('fr-FR')+'</b><br><br>'
            +'Mat\u00e9riel(s) fourni(s) et mis en place par notre soci\u00e9t\u00e9 <b>LES ARTISANS VERTS</b>.<br>'
            +'repr\u00e9sent\u00e9e par <b>TORDJMAN BENJAMIN</b>, SIRET <b>87806279300038</b>, Certificat rge Num\u00e9ro <b>QPAC/69719</b> attribu\u00e9 le 15/02/2026 valable jusqu\'au 15/02/2027<br>'
            +'. Date de la visite technique : <b>'+df+'</b>'
            +'</div>';
            lot3Rows='<div class="dv-row"><div class="n">** '+cn3+'</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(p3)+'</div><div class="r">'+ite_fmt(p3)+'</div><div class="r">'+tvaStr+'</div></div>'
            +'<div class="dv-specs">'
            +'MARQUE : THALEOS - '+cs3.model+' - '+cs3.vol+'L - '+cs3.ref+'<br>'
            +'- Capacit\u00e9 : '+cs3.vol+' L<br>'
            +'- Profil de soutirage : '+cs3.profil+'<br>'
            +'- COP \u00e0 15\u00b0C : '+cop3+' ( Selon la norme EN 16147 )<br>'
            +'- ETAS \u00e0 15\u00b0C : '+cs3.etas+'%<br>'
            +'- RENDEMENT ENERGETIQUE (\u03b7wh) : \u2248 '+cs3.rendEtaWh+' %<br>'
            +'- Classe \u00e9nerg\u00e9tique ECS : '+cs3.cls+'<br>'
            +'- Fluide frigorig\u00e8ne : '+cs3.refrig+'<br>'
            +'- Puissance appoint \u00e9lectrique : \u2248 '+cs3.resist+' W<br>'
            +'- Temp\u00e9rature de fonctionnement air : '+cs3.temp+'<br>'
            +'- Alimentation : Monophas\u00e9 230 V<br>'
            +'- Fabrication : France<br>'
            +'- Usage : Production d\'Eau Chaude Sanitaire (ECS)'
            +'</div>'
            +'<div class="dv-row"><div class="n">FORFAIT POSE ET MISE EN SERVICE D\'UN CHAUFFE-EAU THERMODYNAMIQUE</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(pp3)+'</div><div class="r">'+ite_fmt(pp3)+'</div><div class="r">'+tvaStr+'</div></div>'
            +'<div class="dv-specs">'
            +'- Pose et installation compl\u00e8te d\'un chauffe-eau thermodynamiques<br>'
            +'- Vidange et d\u00e9pose du ballon existant<br>'
            +'- Mise en place du chauffe-eau thermodynamique en lieu et place de l\'ancien chauffe-eau.<br>'
            +'- Raccordement sur eau froide et eau chaude du circuit sanitaire existant au moyen de flexibles.<br>'
            +'- Raccordement sur tuyau de vidange existant.<br>'
            +'- Raccordement sur ligne(s) \u00e9lectrique(s) existante(s) devant correspondre aux normes en vigueur.<br>'
            +'- Remplacement du groupe de s\u00e9curit\u00e9.<br>'
            +'- Remplissage et tests d\'\u00e9tanch\u00e9it\u00e9.<br>'
            +'- Contr\u00f4le du bon fonctionnement.<br>'
            +'Mise en service et conseils d\'utilisation.'
            +'</div>';
        }
    }

    // =========================================================
    // CONDITIONS BLOCK (red box)
    // =========================================================
    var condBlock='<div class="dv-cond" style="margin-top:4mm;">';
    if(mprCET>0){
        condBlock+='<h4>(**) Conditions particuli\u00e8res relatives \u00e0 l\'aide ANAH / MaPrimeR\u00e9nov\'</h4>'
        +'<p>Cette offre est cumulable avec l\'aide MaPrimeR\u00e9nov\', accord\u00e9e uniquement apr\u00e8s analyse du dossier, d\'un montant estimatif de <b>'+ite_fmt(mprCET)+'</b>.</p>'
        +'<p>Dans le cas o\u00f9 l\'aide notifi\u00e9e au client est inf\u00e9rieure au montant de l\'aide pr\u00e9visionnelle, l\'usager n\'est pas li\u00e9 par le devis et l\'entreprise s\'engage \u00e0 proposer un devis rectificatif. Le client conserve alors un droit de r\u00e9tractation d\'une dur\u00e9e de quatorze jours \u00e0 partir de la date de pr\u00e9sentation du devis rectificatif.</p>'
        +'<p>L\'aide MaPrimeR\u00e9nov\' est conditionnelle et soumise \u00e0 la conformit\u00e9 des pi\u00e8ces justificatives et informations d\u00e9clar\u00e9es par le b\u00e9n\u00e9ficiaire. En cas de fausse d\u00e9claration, de man\u0153uvre frauduleuse ou de changement du projet de travaux subventionn\u00e9, le b\u00e9n\u00e9ficiaire s\'expose au retrait et reversement de tout ou partie de l\'aide. Les services de l\'Anah pourront faire proc\u00e9der \u00e0 tout contr\u00f4le des engagements et sanctionner le b\u00e9n\u00e9ficiaire et son mandataire \u00e9ventuel des manquements constat\u00e9s.</p>';
    }
    condBlock+='<h4>Termes et conditions CEE</h4>'
    +'<p>Tout ou partie des travaux relatifs \u00e0 ce devis ou bon de commande sont \u00e9ligibles \u00e0 une prime d\'un montant de <b>'+ite_fmt(primeCEE)+'</b> euros dont EDF (SIREN 552 081 317) est \u00e0 l\'origine dans le cadre du dispositif des Certificats d\'Economies d\'Energie. Le montant de cette prime ne pourra \u00eatre r\u00e9vis\u00e9 \u00e0 la baisse qu\'en cas de modification du volume de Certificats d\'Economies d\'Energie attach\u00e9 \u00e0 l\'op\u00e9ration ou aux op\u00e9rations d\'\u00e9conomies d\'\u00e9nergie ou de la situation de pr\u00e9carit\u00e9 \u00e9nerg\u00e9tique et ce, de mani\u00e8re proportionnelle. Dans le cadre de la r\u00e9glementation un contr\u00f4le qualit\u00e9 des travaux sur site ou par contact pourra \u00eatre demand\u00e9. Un refus de ce contr\u00f4le sur site ou par contact via EDF ou un prestataire d\'EDF conduira au refus de cette prime par EDF.</p>';
    condBlock+='<b>Gestion des d\u00e9chets</b><br>Gestion, \u00e9vacuation et traitements des d\u00e9chets de chantier comprenant la main d\'\u0153uvre li\u00e9e \u00e0 la d\u00e9pose et au tri, le transport des d\u00e9chets de chantiers vers un ou plusieurs points de collecte et co\u00fbts de traitement.';
    condBlock+='</div>';

    // =========================================================
    // TOTALS + LEGAL
    // =========================================================
    var totauxBlock='<div class="dv-totaux"><div class="dv-sig" data-sig="client">Apposer signature pr\u00e9c\u00e9d\u00e9e de la mention "Bon pour accord"<br>Le :<br><div class="sig-canvas-area" data-sig="client"></div></div><div><table class="dv-tt"><tr><td>Total H.T</td><td>'+ite_fmt(ht)+'</td></tr><tr><td>Total TVA '+tva.toFixed(1).replace('.',',')+' %</td><td>'+ite_fmt(tvam)+'</td></tr><tr class="ttc"><td><b>Total TTC</b></td><td><b>'+ite_fmt(ttc)+'</b></td></tr><tr><td>Prime CEE EDF (SIREN 552 081 317)</td><td>- '+ite_fmt(primeCEE)+'</td></tr><tr class="reste"><td><b>Reste \u00e0 r\u00e9gler</b></td><td><b>'+ite_fmt(reste)+'</b></td></tr></table></div></div>';

    var legalBlock='<div class="dv-legal" style="margin-top:6mm;font-size:7.5pt;line-height:1.6;">'
    +'Ce devis est gratuit et valable 30 jours.<br>'
    +(wFin?'Le paiement du prix est acquitt\u00e9, en tout ou partie, \u00e0 l\'aide d\'un cr\u00e9dit affect\u00e9. Sous r\u00e9serve d\'acceptation du pr\u00eat par DOMOFINANCE<br>':'')
    +'Le client peut recourir \u00e0 la m\u00e9diation de la consommation en s\'adressant \u00e0 Toute r\u00e9clamation doit etre adress\u00e9 au Service Clients du Vendeur situ\u00e9 au 6 Passage Eug\u00e8ne Barbier- 92400 Courbevoie.<br><br>'
    +'Conform\u00e9ment aux dispositions de l\'article L.616-1 et R.616-1 du Code de la consommation relatives au processus de m\u00e9diation des litiges de la consommation, l\'Acheteur a le droit de recourir gratuitement au service de m\u00e9diation propos\u00e9 par Les ARTISANS VERTS<br><br>'
    +'Le m\u00e9diateur de la consommation ainsi propos\u00e9 est :<br><br>'
    +'<b>Centre de la M\u00e9diation de la Consommation des Conciliateurs de justice</b><br>'
    +'Saisine par courrier : CM2C - 14 rue Saint Jean - 75017 Paris<br>'
    +'Par t\u00e9l\u00e9phone : 0609204886<br>'
    +'Par mail via le site : https://www.cm2c.net/declarer-un-litige.php<br>'
    +'Pour le site : https://www.cm2c.net/'
    +'</div>';

    // =========================================================
    // FINANCING PAGE (if applicable)
    // =========================================================
    var finBlock='';
    if(wFin){
        var fMensHA=ite_N('iteMensHorsAss'),fMensAA=ite_N('iteMensAvecAss');
        var fTotalHA=ite_N('iteTotalDuHA'),fTotalAA=ite_N('iteTotalDuAA');
        var fDuree=ite_V('iteDureeMois');
        var villeClean=vil.split(' ').slice(1).join(' ')||'_____';
        var tamponSVG='<svg viewBox="0 0 200 120" width="180" height="108" style="margin-top:4mm;">'
        +'<rect x="10" y="5" width="180" height="110" rx="12" ry="12" fill="none" stroke="#1a3c6e" stroke-width="3" transform="rotate(-5,100,60)"/>'
        +'<text x="100" y="35" text-anchor="middle" font-family="Arial,sans-serif" font-weight="900" font-size="16" fill="#1a3c6e" transform="rotate(-5,100,60)">LES ARTISANS VERTS</text>'
        +'<text x="100" y="55" text-anchor="middle" font-family="Arial,sans-serif" font-size="10" fill="#1a3c6e" transform="rotate(-5,100,60)">6,passage Eug\u00e8ne Barbier</text>'
        +'<text x="100" y="72" text-anchor="middle" font-family="Arial,sans-serif" font-size="10" fill="#1a3c6e" transform="rotate(-5,100,60)">92400 COURBEVOIE</text>'
        +'<text x="100" y="92" text-anchor="middle" font-family="Arial,sans-serif" font-weight="700" font-size="10" fill="#1a3c6e" transform="rotate(-5,100,60)">SIRET: 878 062 793.00038</text>'
        +'</svg>';
        finBlock='<div style="font-size:9.5pt;line-height:2;margin-top:4mm;">'
        +'<b style="font-size:10pt;text-decoration:underline;">Conditions de paiement :</b><br>'
        +'Mode de r\u00e8glement : Financement<br>'
        +'Montant \u00e0 financer : '+ite_fmt(reste)+'<br>'
        +'Organisme financier : DOMOFINANCE<br>'
        +'TAEG : 0%<br>'
        +'Taux d\u00e9biteur : 0%<br>'
        +'Dur\u00e9e du contrat de cr\u00e9dit : '+fDuree+' mois<br>'
        +'Remboursement en : '+fDuree+' mois<br>'
        +'Mensualit\u00e9 hors assurance : '+ite_fmt(fMensHA)+'<br>'
        +'Mensualit\u00e9 avec assurance : '+ite_fmt(fMensAA)+'<br>'
        +'Report mensualit\u00e9 : 0 mois<br>'
        +'Assurance : '+(ite_V('iteTypeAssurance')==='Aucune'?'Non':'Oui')+'<br>'
        +'Type d\u2019assurance : '+ite_V('iteTypeAssurance')+'<br>'
        +'Technicien financier : -<br>'
        +'Montant total d\u00fb hors assurance : '+ite_fmt(fTotalHA)+'<br>'
        +'Montant total d\u00fb avec assurance : '+ite_fmt(fTotalAA)
        +'</div>'
        +'<div style="margin-top:12mm;display:flex;gap:20mm;font-size:9pt;line-height:1.8;">'
        +'<div class="dv-sig" data-sig="client" style="flex:1;border:1px solid #999;padding:4mm;">Fait \u00e0 : <b>'+villeClean.toUpperCase()+'</b><br>Le :<br><br>Signature du b\u00e9n\u00e9ficiaire :<div class="sig-canvas-area" data-sig="client"></div></div>'
        +'<div class="dv-sig" data-sig="rep" style="flex:1;border:1px solid #999;padding:4mm;">Nom du repr\u00e9sentant LES ARTISANS VERTS : <b>'+con+'</b><br>A : COURBEVOIE<br>Le :<br><br>Signature du repr\u00e9sentant'+tamponSVG+'<div class="sig-canvas-area" data-sig="rep"></div></div>'
        +'</div>';
    }

    // =========================================================
    // ASSEMBLE PAGES
    // =========================================================
    var pn=2,allPages=pg1;
    if(hasLot3){
        // pg2: LOT 2 desc+rows
        var pg2='<div class="ite-page">'+dv_subHeader(num,df,nom)+lot2Desc+lot2Rows+ite_dvFT(pn,tp)+'</div>';
        allPages+=pg2;pn++;
        // pg3: LOT 3 desc+rows
        var pg3='<div class="ite-page">'+dv_subHeader(num,df,nom)+lot3Desc+lot3Rows+ite_dvFT(pn,tp)+'</div>';
        allPages+=pg3;pn++;
        // pg4: conditions + totals + legal
        var pg4='<div class="ite-page">'+dv_subHeader(num,df,nom)+condBlock+totauxBlock+legalBlock+ite_dvFT(pn,tp)+'</div>';
        allPages+=pg4;pn++;
    } else {
        // pg2: LOT 2 desc+rows
        var pg2='<div class="ite-page">'+dv_subHeader(num,df,nom)+lot2Desc+lot2Rows+ite_dvFT(pn,tp)+'</div>';
        allPages+=pg2;pn++;
        // pg3: conditions + totals + legal
        var pg3='<div class="ite-page">'+dv_subHeader(num,df,nom)+condBlock+totauxBlock+legalBlock+ite_dvFT(pn,tp)+'</div>';
        allPages+=pg3;pn++;
    }
    if(wFin){
        var pgFin='<div class="ite-page">'+dv_subHeader(num,df,nom)+finBlock+ite_dvFT(pn,tp)+'</div>';
        allPages+=pgFin;
    }

    ite_$('iteDevisArea').innerHTML=allPages;
    ite_$('iteDevisArea').style.display='block';
    downloadDevisPDF('iteDevisArea','DEVIS-ITE-'+num+'-'+nom.replace(/\s+/g,'_')+'.pdf');
    saveDossier('ITE', num, nom);
}

// ============================================
// PTZ DOCUMENT GENERATION - CERFA Annexe 1.1
// Formulaire officiel Ã‰co-PTZ individuel
// ============================================
function ptz_chk(checked){ return '<span style="display:inline-block;width:3.5mm;height:3.5mm;border:1px solid #333;text-align:center;line-height:3.5mm;font-size:8pt;margin-right:1.5mm;vertical-align:middle;'+(checked?'background:#006B3F;color:white;':'')+'">'+( checked?'X':'&nbsp;')+'</span>'; }
function ptz_dots(val,w){ return '<span style="display:inline-block;min-width:'+(w||'40mm')+';border-bottom:1px dotted #555;padding:0 1mm;font-weight:'+(val?'600':'400')+';">'+(val||'')+'</span>'; }

async function ite_generatePTZ(){
    // Gather data from calculator
    var totLot2=ite_getLot2Total();
    var totLot3=ite_getLot3Total();
    var hasLot3=ite_V('iteIncludeLot3')==='oui'&&totLot3>0;
    var totITE=ite_N('iteMontantLot1');
    var sITE=ite_N('iteSurfaceITE');
    var t2=ite_V('iteTypeLot2');
    var t3=hasLot3?ite_V('iteTypeLot3'):'';
    var nbLots=hasLot3?3:2;
    var plafondPTZ=nbLots>=3?30000:25000;

    // Check PTZ eligibility
    var lot2Ok=totLot2>=1500;
    var lot3Ok=!hasLot3||totLot3>=1500;
    var ptzOk=lot2Ok&&lot3Ok&&totITE>0;
    if(!ptzOk){
        alert('Le projet n\'est pas \u00e9ligible \u00e0 l\'\u00e9co-PTZ. V\u00e9rifiez :\n- LOT 1 (ITE) > 0 \u20ac\n- LOT 2 \u2265 1 500 \u20ac\n'+(hasLot3?'- LOT 3 \u2265 1 500 \u20ac':''));
        return;
    }

    // Client info
    var prenomVal=document.getElementById('prenom').value.trim();
    var nomVal=document.getElementById('nom').value.trim();
    var nom=(prenomVal+' '+nomVal).trim()||'CLIENT';
    var nomUpper=nomVal.toUpperCase();
    var prenomUpper=prenomVal.charAt(0).toUpperCase()+prenomVal.slice(1);
    var num=ite_V('iteNumDevis'),nc=ite_V('iteNumClient')||num;
    var dRaw=ite_V('iteDateDevis').split('-'),df=dRaw[2]+'/'+dRaw[1]+'/'+dRaw[0];
    var adr=ite_V('iteAdresse'),vil=ite_V('iteVille'),tel=ite_V('iteTel'),em=ite_V('iteEmail');
    var vilParts=vil.split(' ');
    var cp=vilParts[0]||'';
    var villeClean=vilParts.slice(1).join(' ')||'';
    var con=ite_V('iteConseiller');
    var tva=parseFloat(ite_$('iteTva')?.value)||5.5;
    var duree=parseInt(ite_V('iteDureeMois'))||120;

    // Totals
    var ttc=ite_N('iteMontantTotalProjet');
    var primeCEE=ite_N('itePrimeCEE');
    var reste=ttc-primeCEE;
    var montantPTZ=Math.min(reste,plafondPTZ);

    // Action detection
    var hasIsoMurs=true;
    var hasIsoToiture=(t2==='101')||(hasLot3&&t3==='101');
    var hasIsoPlancher=(t2==='103')||(hasLot3&&t3==='103');
    var hasCET=(t2==='148')||(hasLot3&&t3==='148');
    var nbActions=1+(hasIsoToiture?1:0)+(hasIsoPlancher?1:0)+(hasCET?1:0);

    // Plafond dropdown value (must match exact PDF option strings)
    var plafondLabel='';
    if(nbActions===1) plafondLabel='1 action (hors isolation parois vitr\u00e9es) - 15 000 \u20ac';
    else if(nbActions===2) plafondLabel='2 actions - 25 000 \u20ac';
    else plafondLabel='3 actions et plus - 30 000 \u20ac';

    // ================================================================
    // FILL THE REAL CERFA PDF WITH PDF-LIB
    // ================================================================
    try{
        // Show loading state
        var btnEl=event&&event.target?event.target:null;
        if(btnEl){btnEl.disabled=true;btnEl.textContent='\u23f3 G\u00e9n\u00e9ration en cours...';}

        // Fetch the PDF template
        var pdfUrl='eco-ptz-emprunteur-2025.pdf';
        var pdfResp=await fetch(pdfUrl);
        if(!pdfResp.ok) throw new Error('Impossible de charger le formulaire PDF ('+pdfResp.status+')');
        var pdfBytes=await pdfResp.arrayBuffer();

        // Load with pdf-lib
        var PDFLib=window.PDFLib||window['pdf-lib'];
        var pdfDoc=await PDFLib.PDFDocument.load(pdfBytes);
        var form=pdfDoc.getForm();

        // === TEXT FIELDS ===
        // Sanitize text for WinAnsi encoding (remove narrow no-break spaces U+202F, no-break spaces U+00A0)
        var sanitize=function(s){return(s||'').replace(/[\u202f\u00a0]/g,' ');};
        var setTxt=function(name,val){try{form.getTextField(name).setText(sanitize(val)||'');}catch(e){console.warn('PTZ field not found:',name);}};

        // Page 1 - IdentitÃ©
        setTxt('Nom',nomUpper);
        setTxt('Pr\u00e9nom',prenomUpper);
        // Nom_2 / PrÃ©nom_2 left empty (co-emprunteur)

        // Page 1 - Logement
        setTxt('n\u00b0 voirie','');
        setTxt('Voie',adr);
        setTxt('Code postal',cp);
        setTxt('Ville',villeClean.toUpperCase());

        // Page 1 - Ã‰co-PTZ complÃ©mentaire fields (left empty)
        setTxt('Montant pr\u00eat\u00e9 initial','');
        setTxt('Date initial','');
        setTxt('Travaux initial','');

        // Page 1 - CoÃ»ts
        setTxt('Co\u00fbt travaux',ite_fmtN(Math.round(ttc))+' \u20ac TTC');
        setTxt('Frais','0 \u20ac TTC');
        setTxt('TOTAL TTC',ite_fmtN(Math.round(ttc))+' \u20ac TTC');

        // Page 1 - Montant et durÃ©e
        setTxt('Montant demand\u00e9 en \u20ac',ite_fmtN(Math.round(montantPTZ)));
        setTxt('Dur\u00e9e demand\u00e9e en mois',String(duree));

        // Page 2 - Demande accompagnÃ©e
        setTxt('Nb formulaires','1');
        setTxt('Nb devis',String(nbLots));
        setTxt('Nb frais','');
        setTxt('Nb copro','');
        setTxt('Nb RP','');

        // Page 2 - Signature
        setTxt('Date',df);
        // Ville for signature (reuse villeClean)
        // Note: there's a separate "Ville" on page 2 for "Fait Ã "
        // The main "Ville" field is on page 1, check if there's a second one

        // === CHECKBOXES ===
        var chk=function(name,val){
            try{
                var cb=form.getCheckBox(name);
                if(val) cb.check(); else cb.uncheck();
            }catch(e){console.warn('PTZ checkbox not found:',name);}
        };

        // Nature du logement - hardcoded maison individuelle
        chk('MI',true);
        chk('Apt',false);

        // CatÃ©gorie propriÃ©taire - hardcoded particulier
        chk('Particulier',true);
        chk('SCI',false);

        // Occupation - hardcoded propriÃ©taire
        chk('Propri\u00e9taire',true);
        chk('Donn\u00e9 dispo',false);
        chk('PB',false);

        // Type Ã©co-PTZ - hardcoded initial
        chk('Initial',true);
        chk('Compl\u00e9mentaire',false);

        // Type de travaux
        chk('1 action hors fen\u00eatres',nbActions===1);
        chk('1 action',false); // action seule dont parois vitrÃ©es
        chk('2 actions',nbActions===2);
        chk('3 actions',nbActions>=3);
        chk('Performance globale',false);
        chk('Assainissement',false);

        // Page 2 - Demande accompagnÃ©e checkboxes
        chk('X formulaires Entreprise',true);
        chk('X devis',true);
        chk('X frais',false);
        chk('X frais copro',false);
        chk('X RP',false);
        chk('X audit',false);
        chk('X SPANC',false);

        // === DROPDOWN ===
        try{
            form.getDropdown('Plafond').select(plafondLabel);
        }catch(e){console.warn('PTZ dropdown Plafond error:',e);}

        // Flatten the form so it's not editable (optional - comment out to keep editable)
        // form.flatten();

        // Save and download
        var filledPdf=await pdfDoc.save();
        var blob=new Blob([filledPdf],{type:'application/pdf'});
        var url=URL.createObjectURL(blob);
        var a=document.createElement('a');
        a.href=url;
        a.download='ECO-PTZ-'+num+'-'+nom.replace(/\s+/g,'_')+'.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(function(){URL.revokeObjectURL(url);},5000);

        if(btnEl){btnEl.disabled=false;btnEl.innerHTML='\ud83c\udfdb\ufe0f G\u00e9n\u00e9rer le document PTZ';}

    }catch(err){
        console.error('Erreur g\u00e9n\u00e9ration PTZ:',err);
        alert('Erreur lors de la g\u00e9n\u00e9ration du document PTZ :\n'+err.message);
        if(btnEl){btnEl.disabled=false;btnEl.innerHTML='\ud83c\udfdb\ufe0f G\u00e9n\u00e9rer le document PTZ';}
    }
}

// ============================================
// E-SIGNATURE SYSTEM
// ============================================
var esign_pads={client:null,rep:null};
var esign_drawing={client:false,rep:false};
var esign_hasData={client:false,rep:false};
var esign_lastDoc=''; // 'devis' or 'ptz'

function esign_openModal(docType){
    esign_lastDoc=docType||'';
    var overlay=document.getElementById('esignOverlay');
    overlay.style.display='flex';

    // Build doc list
    var docListEl=document.getElementById('esignDocList');
    var hasDevisITE=ite_$('iteDevisArea')&&ite_$('iteDevisArea').innerHTML.trim().length>0;
    var hasPtz=ite_$('itePtzArea')&&ite_$('itePtzArea').innerHTML.trim().length>0;
    var hasDevisPAC=ite_$('pacDevisArea')&&ite_$('pacDevisArea').innerHTML.trim().length>0;
    var docHtml='<div style="margin-bottom:12px;">';
    docHtml+='<div style="font-size:12px;font-weight:700;color:#6b7280;margin-bottom:8px;">DOCUMENTS DISPONIBLES</div>';
    if(hasDevisPAC){
        docHtml+='<label style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;cursor:pointer;margin-bottom:6px;">';
        docHtml+='<input type="checkbox" id="esignDocPAC" checked> <span style="font-size:13px;font-weight:600;">Devis PAC</span></label>';
    }
    if(hasDevisITE){
        docHtml+='<label style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;cursor:pointer;margin-bottom:6px;">';
        docHtml+='<input type="checkbox" id="esignDocDevis" checked> <span style="font-size:13px;font-weight:600;">Devis ITE</span></label>';
    }
    if(hasPtz){
        docHtml+='<label style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;cursor:pointer;margin-bottom:6px;">';
        docHtml+='<input type="checkbox" id="esignDocPTZ" checked> <span style="font-size:13px;font-weight:600;">Document Eco-PTZ</span></label>';
    }
    if(!hasDevisITE&&!hasPtz&&!hasDevisPAC){
        docHtml+='<div style="padding:14px;background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;color:#92400e;font-size:13px;">';
        docHtml+='\u26a0\ufe0f Aucun document g\u00e9n\u00e9r\u00e9. Veuillez d\'abord g\u00e9n\u00e9rer un Devis PAC, un Devis ITE ou un document PTZ.</div>';
    }
    docHtml+='</div>';
    docListEl.innerHTML=docHtml;

    // Init signature pads
    setTimeout(function(){
        esign_initPad('client');
        esign_initPad('rep');
    },100);
}

function esign_close(){
    document.getElementById('esignOverlay').style.display='none';
}

function esign_initPad(type){
    var canvasId=type==='client'?'esignClientCanvas':'esignRepCanvas';
    var canvas=document.getElementById(canvasId);
    if(!canvas)return;
    var rect=canvas.parentElement.getBoundingClientRect();
    canvas.width=rect.width;
    canvas.height=150;
    var ctx=canvas.getContext('2d');
    ctx.strokeStyle='#1a1a2e';
    ctx.lineWidth=2.5;
    ctx.lineCap='round';
    ctx.lineJoin='round';

    var isDown=false,lastX=0,lastY=0;

    function getPos(e){
        var r=canvas.getBoundingClientRect();
        var t=e.touches?e.touches[0]:e;
        return{x:t.clientX-r.left,y:t.clientY-r.top};
    }

    function start(e){
        e.preventDefault();
        isDown=true;
        var p=getPos(e);
        lastX=p.x;lastY=p.y;
        ctx.beginPath();
        ctx.moveTo(lastX,lastY);
        esign_hasData[type]=true;
        var ph=document.getElementById(type==='client'?'esignClientPlaceholder':'esignRepPlaceholder');
        if(ph)ph.style.display='none';
        var wrap=document.getElementById(type==='client'?'esignClientWrap':'esignRepWrap');
        if(wrap)wrap.classList.add('active');
    }
    function move(e){
        if(!isDown)return;
        e.preventDefault();
        var p=getPos(e);
        ctx.lineTo(p.x,p.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(p.x,p.y);
        lastX=p.x;lastY=p.y;
    }
    function end(){isDown=false;}

    canvas.addEventListener('mousedown',start);
    canvas.addEventListener('mousemove',move);
    canvas.addEventListener('mouseup',end);
    canvas.addEventListener('mouseleave',end);
    canvas.addEventListener('touchstart',start,{passive:false});
    canvas.addEventListener('touchmove',move,{passive:false});
    canvas.addEventListener('touchend',end);

    esign_pads[type]=canvas;
}

function esign_clearPad(type){
    var canvas=esign_pads[type];
    if(!canvas)return;
    var ctx=canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    esign_hasData[type]=false;
    var ph=document.getElementById(type==='client'?'esignClientPlaceholder':'esignRepPlaceholder');
    if(ph)ph.style.display='block';
    var wrap=document.getElementById(type==='client'?'esignClientWrap':'esignRepWrap');
    if(wrap)wrap.classList.remove('active');
}

function esign_getSignatureDataURL(type){
    var canvas=esign_pads[type];
    if(!canvas||!esign_hasData[type])return null;
    return canvas.toDataURL('image/png');
}

async function esign_applySignatures(){
    var clientSig=esign_getSignatureDataURL('client');
    var repSig=esign_getSignatureDataURL('rep');

    if(!clientSig&&!repSig){
        alert('Veuillez dessiner au moins une signature avant de continuer.');
        return;
    }

    var statusEl=document.getElementById('esignStatusMsg');
    statusEl.innerHTML='<div class="esign-status pending">\u23f3 Application des signatures en cours...</div>';

    var signDevis=document.getElementById('esignDocDevis')&&document.getElementById('esignDocDevis').checked;
    var signPTZ=document.getElementById('esignDocPTZ')&&document.getElementById('esignDocPTZ').checked;
    var signPAC=document.getElementById('esignDocPAC')&&document.getElementById('esignDocPAC').checked;

    var now=new Date();
    var dateStr=now.toLocaleDateString('fr-FR');
    var timeStr=now.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    var stampHtml='<div style="font-size:5.5pt;color:#666;margin-top:1mm;">Sign\u00e9 \u00e9lectroniquement le '+dateStr+' \u00e0 '+timeStr+'</div>';

    // Universal function to inject signatures into any document area
    function injectSignatures(areaId){
        var area=ite_$(areaId);
        if(!area)return;
        // Target all .sig-canvas-area elements with data-sig attribute
        var sigAreas=area.querySelectorAll('.sig-canvas-area[data-sig]');
        sigAreas.forEach(function(el){
            var sigType=el.getAttribute('data-sig');
            var sigData=sigType==='client'?clientSig:repSig;
            if(sigData){
                el.style.border='none';
                el.style.background='transparent';
                el.innerHTML='<img src="'+sigData+'" style="height:14mm;width:auto;">'+stampHtml;
            }
        });
        // Also handle .dv-sig blocks that DON'T have a nested .sig-canvas-area (legacy)
        var dvSigs=area.querySelectorAll('.dv-sig');
        dvSigs.forEach(function(block){
            // Skip if already has a sig-canvas-area (handled above)
            if(block.querySelector('.sig-canvas-area'))return;
            var sigType=block.getAttribute('data-sig')||'client';
            var sigData=sigType==='client'?clientSig:repSig;
            if(sigData){
                block.innerHTML+='<div style="margin-top:3mm;"><img src="'+sigData+'" style="height:14mm;width:auto;display:block;">'+stampHtml+'</div>';
            }
        });
    }

    // Apply signatures to selected documents
    if(signPAC) injectSignatures('pacDevisArea');
    if(signDevis) injectSignatures('iteDevisArea');
    if(signPTZ) injectSignatures('itePtzArea');

    // Generate signed PDFs
    try{
        var nom=(document.getElementById('prenom').value.trim()+' '+document.getElementById('nom').value.trim()).trim()||'CLIENT';
        var num=ite_V('iteNumDevis');
        var numDevis=num.replace('AVR-','');

        if(signPAC&&ite_$('pacDevisArea')&&ite_$('pacDevisArea').innerHTML.trim().length>0){
            await downloadDevisPDF('pacDevisArea','DEVIS-PAC-SIGNE-'+numDevis+'-'+nom.replace(/\s+/g,'_')+'.pdf');
        }
        if(signDevis&&ite_$('iteDevisArea')&&ite_$('iteDevisArea').innerHTML.trim().length>0){
            await downloadDevisPDF('iteDevisArea','DEVIS-ITE-SIGNE-'+num+'-'+nom.replace(/\s+/g,'_')+'.pdf');
        }
        if(signPTZ&&ite_$('itePtzArea')&&ite_$('itePtzArea').innerHTML.trim().length>0){
            await downloadDevisPDF('itePtzArea','ECO-PTZ-SIGNE-'+num+'-'+nom.replace(/\s+/g,'_')+'.pdf');
        }

        statusEl.innerHTML='<div class="esign-status signed">\u2705 Documents sign\u00e9s et t\u00e9l\u00e9charg\u00e9s avec succ\u00e8s !</div>';

        setTimeout(function(){esign_close();},2000);
    }catch(e){
        console.error('E-signature PDF error:',e);
        statusEl.innerHTML='<div class="esign-status pending">\u274c Erreur : '+e.message+'</div>';
    }
}

// ============================================
// TAB SYSTEM
// ============================================
function switchTab(tab){
    var mc=document.getElementById('mainContent');
    mc.classList.remove('tab-pac-active','tab-ite-active');
    mc.classList.add('tab-'+tab+'-active');
    document.getElementById('tabPAC').classList.toggle('active',tab==='pac');
    document.getElementById('tabITE').classList.toggle('active',tab==='ite');
    if(tab==='pac'){try{calc();}catch(e){}}
    else{try{ite_calc();}catch(e){}}
}

// ============================================
// HOOK: sync profil precarite when detectProfil runs
// ============================================
(function(){
    var origDetectProfil=window.detectProfil;
    if(typeof origDetectProfil==='function'){
        window.detectProfil=function(){
            origDetectProfil.apply(this,arguments);
            syncProfilPrecarite();
        };
    }
})();

// ============================================
// PAC DEVIS GENERATION â€” Format conforme au modÃ¨le officiel
// ============================================

// DonnÃ©es techniques CET par rÃ©fÃ©rence
var CET_SPECS={
    PERFORMER2_200L:{vol:'200',profil:'L',cop7:'2,78',etaWh:'116',resist:'1800',tempFunc:'-5 Ã  +43',refrig:'R-513A',h:'1617',diam:'620',poids:'80',ref:'THA 986 113',fullRef:'Chauffe-eau thermodynamique THALEOS- 200L - THA 986113'},
    PERFORMER2_270L:{vol:'270',profil:'XL',cop7:'2,80',etaWh:'118',resist:'1800',tempFunc:'-5 Ã  +43',refrig:'R-513A',h:'1870',diam:'620',poids:'95',ref:'THA 986 114',fullRef:'Chauffe-eau thermodynamique THALEOS- 270L - THA 986114'}
};

function pac_generateDevis(){
    try{
    var titre=ite_V('nom').toUpperCase();
    var prenom=ite_V('prenom').toUpperCase();
    var nom=(prenom+' '+titre).trim()||'CLIENT';
    var civilite='MME ';
    var nomDevis=civilite+titre+' '+prenom;
    var num=ite_V('iteNumDevis'),nc=ite_V('iteNumClient')||num;
    var dRaw=ite_V('iteDateDevis').split('-'),df=dRaw[2]+'/'+dRaw[1]+'/'+dRaw[0];
    var adr=ite_V('iteAdresse'),vil=ite_V('iteVille'),tel=ite_V('iteTel'),em=ite_V('iteEmail');
    var zn=document.getElementById('zone').value;
    var tch=ite_V('iteTypeChauffage');
    var con=ite_V('iteConseiller');
    var tva=parseFloat(document.getElementById('tvaProduit').value)||5.5;
    var tvaStr=tva.toFixed(2).replace('.',',')+' %';

    // PrÃ©caritÃ© label
    var precVal=ite_V('itePrecarite');
    var precL={classique:'Classique',modeste:'Modeste',grande:'TrÃ¨s modeste'}[precVal]||precVal;

    // RÃ©cupÃ©rer la catÃ©gorie (profil MPR)
    var profil=document.getElementById('categorie').value;
    var precDevis=profil==='BLEU'?'TrÃ¨s modeste':(profil==='JAUNE'?'Modeste':(profil==='VIOLET'?'IntermÃ©diaire':'SupÃ©rieur'));

    // Type de chauffage long
    var tchMap={'Gaz':'Combustible / Gaz','Fioul':'Combustible / Fioul','Ã‰lectrique':'Ã‰lectrique','Bois':'Combustible / Bois','PAC':'PAC existante','Autre':'Autre'};
    var tchLong=tchMap[tch]||tch;

    // PAC data
    var pacKey=document.getElementById('marquePAC').value;
    var pacEl=document.getElementById('marquePAC');
    var pacName=pacEl.options[pacEl.selectedIndex].text;
    var p=PAC_CATALOG[pacKey]||{};
    var pPAC=ite_N('prixPAC'),pPose=ite_N('prixPose');
    var usage=document.getElementById('usagePAC').value;
    var surfacePAC=ite_V('surfaceClient')||ite_V('ceeSurface')||'100';

    // DÃ©terminer application HT/BT depuis ETAS
    var ev=(p.etas||'').split('/').map(function(s){return parseFloat(s.trim());});
    var etasHT=ev.length>1?ev[1]:ev[0];
    var etasBT=ev[0]||etasHT;
    var appType=etasHT>=100?'Haute tempÃ©rature':'Basse tempÃ©rature';

    // kWh Cumac PAC
    var kwhcPAC=lastCEEDetailKwhc||0;
    var primeCEEPAC=(lastCEEDetailPrime||0);

    // Phase
    var phase=(p.a||'').indexOf('3Ph')>=0?'TriphasÃ©e':'MonophasÃ©e';
    var phaseShort=phase==='TriphasÃ©e'?'TriphasÃ©e':'MonophasÃ©e';

    // Ballon
    var wBallon=ite_V('includeBallon')==='oui';
    var ballonRef='',ballonKey='',pBallon=0,pPoseBallon=0,copB='',cetSpecs=null;
    if(wBallon){
        var bEl=document.getElementById('refBallon');
        ballonKey=bEl.value;
        ballonRef=bEl.options[bEl.selectedIndex].text;
        pBallon=ite_N('prixBallon');
        pPoseBallon=ite_N('prixPoseBallon');
        copB=ite_V('copBallon');
        cetSpecs=CET_SPECS[ballonKey]||CET_SPECS['PERFORMER2_200L'];
    }

    // SSC
    var wSSC=ite_V('includeSSC')==='oui';
    var sscRef='',pSSC=0,pPoseSSC=0;
    if(wSSC){sscRef=document.getElementById('refSSC').options[document.getElementById('refSSC').selectedIndex].text;pSSC=ite_N('prixSSC');pPoseSSC=ite_N('prixPoseSSC');}

    // Totaux
    var ttc=pPAC+pPose+(wBallon?pBallon+pPoseBallon:0)+(wSSC?pSSC+pPoseSSC:0);
    var ht=ttc/(1+tva/100),tvam=ttc-ht;

    // Aides
    var adTxt=document.getElementById('aidesMPR').textContent.replace(/[^\d]/g,'');
    var ceTxt=document.getElementById('aidesCEE').textContent.replace(/[^\d]/g,'');
    var ad=parseFloat(adTxt)||0,ce=parseFloat(ceTxt)||0;
    var totalAides=ad+ce,reste=ttc-totalAides;

    // kWhc ballon (BAR-TH-148)
    var kwhcBallon=wBallon?14700:0;
    var primeCEEBallon=wBallon?(kwhcBallon/1000*(ite_N('prixCumac')||7)):0;

    // Prime CEE totale du devis
    var primeCEETotale=ce;

    var numDevis=num.replace('AVR-','');

    var tp=3; // 3 pages

    // RGE info
    var rgeInfo='MatÃ©riel(s) fourni(s) et mis en place par notre sociÃ©tÃ© LES ARTISANS VERTS.<br>reprÃ©sentÃ©e par TORDJMAN BENJAMIN, SIRET 87806279300038, Certificat rge<br>NumÃ©ro QPAC/69719 attribuÃ© le 15/02/2026 valable jusqu\'au 15/02/2027';

    // ===== PAGE 1 =====
    var pg1='<div class="ite-page">'+dv_logoHeader();
    pg1+='<div class="dv-title"><span>DEVIS : '+numDevis+' '+nomDevis+'</span></div>';
    pg1+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:0 6mm;margin-bottom:4mm;font-size:8pt;line-height:1.6;">';
    pg1+='<div>NumÃ©ro Client : <b>'+nc+'</b><br>Date de devis : <b>'+df+'</b><br>Adresse des travaux : <b>'+adr+'</b><br><b>'+vil+'</b></div>';
    pg1+='<div>'+adr+'<br>'+vil+'<br>TÃ©l : '+tel+'<br>E-mail : '+em+'<br>Zone : <b>'+zn+'</b><br>PrÃ©caritÃ© : <b>'+precDevis+'</b><br>Type de chauffage : <b>'+tchLong+'</b><br>Type de logement : <b>Maison individuelle / +15 ans</b></div>';
    pg1+='</div>';
    pg1+=ite_dvTH();

    // === CET (Ballon) en premier si prÃ©sent (comme le modÃ¨le PDF) ===
    if(wBallon && cetSpecs){
        pg1+='<div class="dv-block"><b>BAR-TH-148 : Mise en place d\'un chauffe-eau thermodynamique Ã  accumulation.</b><br>';
        pg1+='Type d\'installation : Sur air extrait<br>';
        pg1+='Le COP du materiel installÃ© est de : '+copB+' mesurÃ© selon les conditions de la norme EN 16147.<br>';
        pg1+='Marque : THALEOS<br>';
        pg1+='RÃ©f : ** '+cetSpecs.fullRef+'<br>';
        pg1+='- Kwh Cumac : '+ite_fmtN(kwhcBallon)+'<br>';
        pg1+='- Prime CEE : '+ite_fmt(primeCEEBallon)+'<br><br>';
        pg1+=rgeInfo+'</div>';

        pg1+='<div class="dv-row"><div class="n">** '+cetSpecs.fullRef+'</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(pBallon)+'</div><div class="r">'+ite_fmt(pBallon)+'</div><div class="r">'+tvaStr+'</div></div>';
        pg1+='<div class="dv-specs">MARQUE : THALEOS - PERFORMER 2 - '+cetSpecs.vol+'L - '+cetSpecs.ref+'<br>';
        pg1+='- CapacitÃ© : '+cetSpecs.vol+'l<br>';
        pg1+='- Profil de soutirage : '+cetSpecs.profil+'<br>';
        pg1+='- COP Ã  7Â°C : '+copB+' ( Selon la norme EN 16147 )<br>';
        pg1+='- RENDEMENT ENERGETIQUE Eta wh : '+cetSpecs.etaWh+' % - Puissance de la rÃ©sistance (W) : '+cetSpecs.resist+'<br>';
        pg1+='- TempÃ©rature de fonctionnement CÂ° : '+cetSpecs.tempFunc+'<br>';
        pg1+='- type de rÃ©frigÃ©rant : '+cetSpecs.refrig+'<br>';
        pg1+='- Hauteur : '+cetSpecs.h+' mm - DiamÃ¨tre : '+cetSpecs.diam+' mm - Poids Ã  vide : '+cetSpecs.poids+' kg</div>';

        pg1+='<div class="dv-row"><div class="n">FORFAIT POSE ET MISE EN SERVICE D\'UN CHAUFFE-EAU THERMODYNAMIQUE</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(pPoseBallon)+'</div><div class="r">'+ite_fmt(pPoseBallon)+'</div><div class="r">'+tvaStr+'</div></div>';
        pg1+='<div class="dv-specs">- Pose et installation complÃ¨te d\'un chauffe-eau thermodynamiques<br>';
        pg1+='- Vidange et dÃ©pose du ballon existant<br>';
        pg1+='- Mise en place du chauffe-eau thermodynamique en lieu et place de l\'ancien chauffe-eau.<br>';
        pg1+='- Raccordement sur eau froide et eau chaude du circuit sanitaire existant au moyen de flexibles.<br>';
        pg1+='- Raccordement sur tuyau de vidange existant.<br>';
        pg1+='- Raccordement sur ligne(s) Ã©lectrique(s) existante(s) devant correspondre aux normes en vigueur.<br>';
        pg1+='- Remplacement du groupe de sÃ©curitÃ©.<br>';
        pg1+='- Remplissage et tests d\'Ã©tanchÃ©itÃ©.<br>';
        pg1+='- ContrÃ´le du bon fonctionnement.<br>';
        pg1+='Mise en service et conseils d\'utilisation.</div>';
    }

    // === PAC (BAR-TH-171) â€” Description ===
    pg1+='<div class="dv-block" style="margin-top:3mm;"><b>BAR-TH-171 : Mise en place d\'une pompe Ã  chaleur (PAC) de type air/eau</b><br>';
    pg1+='La PAC est installÃ©e pour une application '+appType+'<br>';
    pg1+='Marque : '+p.m+'<br>';
    pg1+='RÃ©fÃ©rence : ** PAC '+p.m+' '+p.n.replace('PAC '+p.m+' ','').replace('ETAS ','').replace(/%/g,'')+'kw '+appType+' '+phaseShort+' - ETAS '+etasHT+'%<br>';
    pg1+='Surface chauffÃ©e par la PAC : '+surfacePAC+',00 m2<br>';
    pg1+='Usage couvert par la PAC : '+usage+'<br>';
    pg1+='Coefficient de performance (COP) : '+p.cop55+'<br>';
    pg1+='EfficacitÃ© Ã©nergÃ©tique saisonniÃ¨re (hors dispositif de rÃ©gulation) : '+etasHT+'%, calculÃ©e selon le rÃ¨glement (EU) nÂ°813/2013 de la commission du 2 aout 2013.<br>';
    pg1+='Mise en place d\'un rÃ©gulateur de classe : '+p.rg+'<br>';
    pg1+='- DÃ©pose et remplacement d\'une chaudiÃ¨re individuelle '+tch+'<br>';
    pg1+='- Kwh Cumac : '+ite_fmtN(kwhcPAC)+'<br>';
    pg1+='NÂ° QPAC/69719 VAL 15/02/2027<br><br>';
    pg1+=rgeInfo+'</div>';

    pg1+=ite_dvFT(1,tp)+'</div>';

    // ===== PAGE 2 : Suite PAC (specs + pose) =====
    var pg2='<div class="ite-page">'+dv_subHeader(numDevis,df,nomDevis);
    pg2+='<div style="margin-top:2mm;font-size:8pt;line-height:1.55;">';
    pg2+='- Prime Coup de pouce CEE : '+ite_fmt(primeCEETotale)+'<br><br>';
    pg2+=rgeInfo+'</div>';

    // Ligne prix PAC matÃ©riel
    var pacRefFull='PAC '+p.m+' '+p.n.replace('PAC '+p.m+' ','');
    pg2+='<div class="dv-row" style="margin-top:3mm;"><div class="n">** '+pacRefFull+' '+phaseShort+' - ETAS '+etasHT+'%</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(pPAC)+'</div><div class="r">'+ite_fmt(pPAC)+'</div><div class="r">'+tvaStr+'</div></div>';

    // Specs PAC dÃ©taillÃ©es
    pg2+='<div class="dv-specs">';
    pg2+='Puissance calorifique A7/35 : '+(p.cap35||'-')+'<br>';
    pg2+='Puissance calorifique A7/55 : '+(p.cap55||'-')+'<br>';
    pg2+='COP A7/W35 //A7/W55 : '+p.cop35+' //'+p.cop55+'<br>';
    pg2+='Classe Ã©nergÃ©tique sortie d\'eau Ã  35//55Â°C : '+p.cls+'<br>';
    pg2+='EfficacitÃ© saisonniÃ¨re sortie d\'eau Ã  35/55Â°C (ETAS) : '+p.etas+' %<br>';
    pg2+='SCOP 35/55: '+p.scop+'<br>';
    pg2+='Puissance acoustique (chauffage) : '+p.db+'<br>';
    pg2+='TempÃ©rature d\'air extÃ©rieur (chauffage) : -25 / +35 Â°C<br>';
    pg2+='TempÃ©rature d\'air extÃ©rieur ECS : -25 / +43 Â°C<br>';
    pg2+='Phase / Tension / FrÃ©quence : '+p.a+' / 50 Hz<br>';
    pg2+='Protection Ã©lectrique : '+p.pr+'<br>';
    pg2+='RÃ©frigÃ©rant / PRP : '+p.ref+' / '+(p.ref==='R290'?'3':(p.ref==='R32'?'675':'-'))+'<br>';
    if(p.ch && p.ch!=='-') pg2+='Charge : '+p.ch+'<br>';
    pg2+='Dimensions de l\'unitÃ© (LxHxP) : '+p.dim+'<br>';
    pg2+='Poids net : '+p.kg+'</div>';

    // Forfait pose PAC
    pg2+='<div class="dv-row"><div class="n">FORFAIT POSE ET MISE EN SERVICE D\'UNE POMPE A CHALEUR</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(pPose)+'</div><div class="r">'+ite_fmt(pPose)+'</div><div class="r">'+tvaStr+'</div></div>';
    pg2+='<div class="dv-specs">';
    pg2+='- Pose et installation complÃ¨te d\'une pompe Ã  chaleur air/eau<br>';
    pg2+='- Forfait dÃ©placement et mise en service comprise<br>';
    pg2+='- Installation du module extÃ©rieur - Liaison hydraulique, Liaison frigorifique<br>';
    pg2+='- Raccord des liaisons a l\'existant - CÃ¢blage d\'alimentation, CÃ¢blage connexion Ã©lectrique<br>';
    pg2+='- Protection disjoncteur diffÃ©rentiel, Purge des radiateurs<br>';
    pg2+='- DÃ©sembouage du systÃ¨me, Mise en service & Programmation<br>';
    pg2+='- ContrÃ´le du circuit hydraulique et de son Ã©tanchÃ©itÃ©<br>';
    pg2+='- Mise sous pression d\'azote, ContrÃ´le de l\'Ã©tanchÃ©itÃ© du circuit frigorifique<br>';
    pg2+='- ContrÃ´le du circuit Ã©lectrique (conforme NF C15 100)<br>';
    pg2+='- Mise en service et contrÃ´le du fonctionnement, DÃ©monstration, complÃ¨te des diffÃ©rentes fonctions</div>';

    // SSC si prÃ©sent
    if(wSSC){
        pg2+='<div class="dv-block" style="margin-top:3mm;"><b>SystÃ¨me Solaire CombinÃ©</b><br>'+sscRef+'<br>LES ARTISANS VERTS Â· SIRET 87806279300038 Â· RGE QPAC/69719</div>';
        pg2+='<div class="dv-row"><div class="n">SSC '+sscRef+'</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(pSSC)+'</div><div class="r">'+ite_fmt(pSSC)+'</div><div class="r">'+tvaStr+'</div></div>';
        pg2+='<div class="dv-row"><div class="n">Forfait pose SSC</div><div class="c">1,00 U</div><div class="r">'+ite_fmt(pPoseSSC)+'</div><div class="r">'+ite_fmt(pPoseSSC)+'</div><div class="r">'+tvaStr+'</div></div>';
    }

    pg2+=ite_dvFT(2,tp)+'</div>';

    // ===== PAGE 3 : Conditions + Totaux + Signatures =====
    var pg3='<div class="ite-page">'+dv_subHeader(numDevis,df,nomDevis);

    // Single red box for all conditions (MPR + CEE + DÃ©chets)
    pg3+='<div class="dv-cond" style="margin-top:4mm;">';

    // Conditions MPR
    if(ad>0){
        pg3+='<h4>(**) Conditions particuliÃ¨res relatives Ã  l\'aide ANAH / MaPrimeRÃ©nov\'</h4>';
        pg3+='<p>Cette offre est cumulable avec l\'aide MaPrimeRÃ©nov\', accordÃ©e uniquement aprÃ¨s analyse du dossier, d\'un montant estimatif de <b>'+ite_fmt(ad)+'</b>.<br>';
        pg3+='Dans le cas oÃ¹ l\'aide notifiÃ©e au client est infÃ©rieure au montant de l\'aide prÃ©visionnelle, l\'usager n\'est pas liÃ© par le devis et l\'entreprise s\'engage Ã  proposer un devis rectificatif. Le client conserve alors un droit de rÃ©tractation d\'une durÃ©e de quatorze jours Ã  partir de la date de prÃ©sentation du devis rectificatif.<br>';
        pg3+='L\'aide MaPrimeRÃ©nov\' est conditionnelle et soumise Ã  la conformitÃ© des piÃ¨ces justificatives et informations dÃ©clarÃ©es par le bÃ©nÃ©ficiaire. En cas de fausse dÃ©claration, de manÅ“uvre frauduleuse ou de changement du projet de travaux subventionnÃ©, le bÃ©nÃ©ficiaire s\'expose au retrait et reversement de tout ou partie de l\'aide. Les services de l\'Anah pourront faire procÃ©der Ã  tout contrÃ´le des engagements et sanctionner le bÃ©nÃ©ficiaire et son mandataire Ã©ventuel des manquements constatÃ©s.</p>';
    }

    // Conditions CEE
    pg3+='<h4>Termes et conditions CEE</h4>';
    pg3+='<p>Tout ou partie des travaux relatifs \u00e0 ce devis ou bon de commande sont \u00e9ligibles \u00e0 une prime d\'un montant de <b>'+ite_fmt(ce)+'</b> euros dont EDF (SIREN 552 081 317) est \u00e0 l\'origine dans le cadre du dispositif des Certificats d\'Economies d\'Energie. Le montant de cette prime ne pourra \u00eatre r\u00e9vis\u00e9 \u00e0 la baisse qu\'en cas de modification du volume de Certificats d\'Economies d\'Energie attach\u00e9 \u00e0 l\'op\u00e9ration ou aux op\u00e9rations d\'\u00e9conomies d\'\u00e9nergie ou de la situation de pr\u00e9carit\u00e9 \u00e9nerg\u00e9tique et ce, de mani\u00e8re proportionnelle. Dans le cadre de la r\u00e9glementation un contr\u00f4le qualit\u00e9 des travaux sur site ou par contact pourra \u00eatre demand\u00e9. Un refus de ce contr\u00f4le sur site ou par contact via EDF ou un prestataire d\'EDF conduira au refus de cette prime par EDF.</p>';

    // Gestion dÃ©chets
    pg3+='<b>Gestion des dÃ©chets</b><br>';
    pg3+='Gestion, Ã©vacuation et traitements des dÃ©chets de chantier comprenant la main d\'Å“uvre liÃ©e Ã  la dÃ©pose et au tri, le transport des dÃ©chets de chantiers vers un ou plusieurs points de collecte et coÃ»ts de traitement.';

    pg3+='</div>'; // end single red box

    // Signature + Totaux
    pg3+='<div class="dv-totaux">';
    pg3+='<div class="dv-sig" data-sig="client">Apposer signature prÃ©cÃ©dÃ©e de la mention "Bon pour accord"<br>Le :<br><div class="sig-canvas-area" data-sig="client"></div>Ce devis est gratuit et valable 30 jours.<br>Mode de paiement : ChÃ¨que, Virement, Financement, EspÃ¨ce</div>';
    pg3+='<div class="dv-sig" data-sig="rep" style="margin-top:4mm;border:1px solid #999;padding:4mm;font-size:8pt;">Nom du reprÃ©sentant LES ARTISANS VERTS : <b>'+con+'</b><br>A : COURBEVOIE<br>Le :<br><br>Signature du reprÃ©sentant<svg viewBox="0 0 200 120" width="180" height="108" style="margin-top:4mm;"><rect x="10" y="5" width="180" height="110" rx="12" ry="12" fill="none" stroke="#1a3c6e" stroke-width="3" transform="rotate(-5,100,60)"/><text x="100" y="35" text-anchor="middle" font-family="Arial,sans-serif" font-weight="900" font-size="16" fill="#1a3c6e" transform="rotate(-5,100,60)">LES ARTISANS VERTS</text><text x="100" y="55" text-anchor="middle" font-family="Arial,sans-serif" font-size="10" fill="#1a3c6e" transform="rotate(-5,100,60)">6,passage Eug\u00e8ne Barbier</text><text x="100" y="72" text-anchor="middle" font-family="Arial,sans-serif" font-size="10" fill="#1a3c6e" transform="rotate(-5,100,60)">92400 COURBEVOIE</text><text x="100" y="92" text-anchor="middle" font-family="Arial,sans-serif" font-weight="700" font-size="10" fill="#1a3c6e" transform="rotate(-5,100,60)">SIRET: 878 062 793.00038</text></svg><div class="sig-canvas-area" data-sig="rep"></div></div>';
    pg3+='<div><table class="dv-tt">';
    pg3+='<tr><td>Total H.T</td><td>'+ite_fmt(ht)+'</td></tr>';
    pg3+='<tr><td>Total TVA  '+tva.toFixed(1).replace('.',',')+'%</td><td>'+ite_fmt(tvam)+'</td></tr>';
    pg3+='<tr class="ttc"><td><b>Total TTC</b></td><td><b>'+ite_fmt(ttc)+'</b></td></tr>';
    if(ce>0) pg3+='<tr><td>Prime CEE EDF (SIREN 552 081 317)</td><td>- '+ite_fmt(ce)+'</td></tr>';
    if(ad>0){
        pg3+='<tr><td>Estimation MaPrimeRÃ©nov\'</td><td>- '+ite_fmt(ad)+'</td></tr>';
        pg3+='<tr><td colspan="2" style="font-size:6pt;font-weight:400;font-style:italic;text-align:right;">Sous rÃ©serve de l\'accord de l\'ANAH (**)</td></tr>';
    }
    pg3+='<tr class="reste"><td><b>Reste \u00e0 r\u00e9gler</b></td><td><b>'+ite_fmt(reste)+'</b></td></tr>';
    pg3+='</table></div></div>';

    // MÃ©diation
    pg3+='<div class="dv-legal" style="margin-top:6mm;">';
    pg3+='Le client peut recourir Ã  la mÃ©diation de la consommation en s\'adressant Ã  Toute rÃ©clamation doit etre adressÃ© au Service Clients du Vendeur situÃ© au 6 Passage EugÃ¨ne Barbier- 92400 Courbevoie.<br>';
    pg3+='ConformÃ©ment aux dispositions de l\'article L.616-1 et R.616-1 du Code de la consommation relatives au processus de mÃ©diation des litiges de la consommation, l\'Acheteur a le droit de recourir gratuitement au service de mÃ©diation proposÃ© par Les ARTISANS VERTS<br>';
    pg3+='Le mÃ©diateur de la consommation ainsi proposÃ© est :<br>';
    pg3+='Centre de la MÃ©diation de la Consommation des Conciliateurs de justice<br>';
    pg3+='Saisine par courrier : CM2C - 14 rue Saint Jean - 75017 Paris<br>';
    pg3+='Par tÃ©lÃ©phone : 0609204886<br>';
    pg3+='Par mail via le site : https://www.cm2c.net/declarer-un-litige.php<br>';
    pg3+='Pour le site : https://www.cm2c.net/</div>';

    pg3+=ite_dvFT(3,tp)+'</div>';

    document.getElementById('pacDevisArea').innerHTML=pg1+pg2+pg3;
    document.getElementById('pacDevisArea').style.display='block';
    document.getElementById('printArea').style.display='none';
    downloadDevisPDF('pacDevisArea','DEVIS-'+numDevis+'-'+nom.replace(/\s+/g,'_')+'.pdf');
    saveDossier('PAC', numDevis, nom);
    }catch(e){console.error('pac_generateDevis error:',e);alert('Erreur gÃ©nÃ©ration devis: '+e.message);}
}

// Override print for tab-aware printing
(function(){
    window.exportPDF=function(){
        var mc=document.getElementById('mainContent');
        if(mc.classList.contains('tab-ite-active')){
            ite_generateDevis();
        } else {
            pac_generateDevis();
        }
    };
})();

// ============================================
// DOSSIER MANAGEMENT â€” API Google Sheet + fallback localStorage
// ============================================
var DOSSIER_KEY = 'lav_dossiers';
var DOSSIER_FIELDS = [
    'nom','prenom','iteAdresse','iteVille','iteTel','iteEmail',
    'iteNumDevis','iteDateDevis','iteConseiller','iteTypeChauffage','itePrecarite',
    'surfaceClient','zone','categorie',
    'iteSurfaceITE','iteMontantLot1','itePrixMatITE','itePrixMoITE','iteIsolantITE',
    'iteSousTraitITE','iteSiretSousTraitITE','iteRgeSousTraitITE','iteCouleurCrepi','iteEnduitITE',
    'iteTypeLot2','iteSurface101','itePrixMat101','itePrixMo101',
    'iteSurface103','itePrixMat103','itePrixMo103',
    'itePrixCET','itePrixPoseCET','iteRefCET','iteCopCET',
    'iteIncludeLot3','iteTypeLot3',
    'iteSurface101L3','itePrixMat101L3','itePrixMo101L3',
    'iteSurface103L3','itePrixMat103L3','itePrixMo103L3',
    'itePrixCETL3','itePrixPoseCETL3','iteRefCETL3','iteCopCETL3',
    'iteIncludeFinancement','iteDureeMois','iteMensHorsAss','iteMensAvecAss',
    'iteTotalDuHA','iteTotalDuAA','iteTypeAssurance','iteFinTAEA',
    'iteDobEmprunteur','itePrimeCEE'
];

// Cache local
function getLocalDossiers(){
    try{ return JSON.parse(localStorage.getItem(DOSSIER_KEY)||'[]'); }catch(e){ return []; }
}
function setLocalDossiers(arr){
    try{ localStorage.setItem(DOSSIER_KEY, JSON.stringify(arr)); }catch(e){}
}

function captureFields(){
    var data={};
    DOSSIER_FIELDS.forEach(function(id){
        var el=document.getElementById(id);
        if(el) data[id]=el.value||'';
    });
    return data;
}
function restoreFields(data){
    if(!data)return;
    Object.keys(data).forEach(function(id){
        var el=document.getElementById(id);
        if(el){
            el.value=data[id];
            if(el.tagName==='SELECT') try{el.dispatchEvent(new Event('change'));}catch(e){}
        }
    });
}

function saveDossier(type,numDevis,nomClient){
    if(!currentUser)return;
    var fields=captureFields();
    var localDossiers=getLocalDossiers();
    var existIdx=-1;
    for(var i=0;i<localDossiers.length;i++){
        if(localDossiers[i].numDevis===numDevis){existIdx=i;break;}
    }
    var dossier={
        id:existIdx>=0?localDossiers[existIdx].id:Date.now()+'_'+Math.random().toString(36).substr(2,5),
        numDevis:numDevis, nomClient:nomClient, type:type,
        commercial:currentUser.name, commercialId:currentUser.id,
        date:new Date().toLocaleDateString('fr-FR'),
        dateISO:new Date().toISOString(),
        fields:fields
    };
    // Save to localStorage immediately
    if(existIdx>=0) localDossiers[existIdx]=dossier;
    else localDossiers.unshift(dossier);
    setLocalDossiers(localDossiers);
    // Sync to API
    if(useAPI && API_URL){
        apiPost({action:'saveDossier', id:dossier.id, numDevis:dossier.numDevis, nomClient:dossier.nomClient,
            type:dossier.type, commercial:dossier.commercial, commercialId:dossier.commercialId,
            date:dossier.date, dateISO:dossier.dateISO, fields:dossier.fields},
            function(d){ console.log('Dossier sync\u00e9 \u2713'); },
            function(e){ console.warn('Sync dossier \u00e9chou\u00e9e (local OK):', e); }
        );
    }
}

function openDossiers(){
    var body=document.getElementById('dossiersBody');
    body.innerHTML='<div style="text-align:center;padding:30px;color:#9ca3af;">Chargement...</div>';
    document.getElementById('dossierSearch').value='';
    document.getElementById('dossiersModal').classList.add('active');
    // Try API first
    if(useAPI && API_URL){
        apiCall({action:'getDossiers'}, function(d){
            if(d.success && d.dossiers){
                setLocalDossiers(d.dossiers); // sync cache local
            }
            renderDossiers();
        }, function(){
            renderDossiers(); // fallback local
        });
    } else {
        renderDossiers();
    }
}
function filterDossiers(){ renderDossiers(); }
function renderDossiers(){
    var dossiers=getLocalDossiers();
    var isAdmin=currentUser&&currentUser.role==='admin';
    var search=(document.getElementById('dossierSearch').value||'').toLowerCase().trim();
    var filtered=dossiers.filter(function(d){
        if(!isAdmin&&d.commercialId!==currentUser.id)return false;
        if(search){
            var h=(d.nomClient+' '+d.numDevis+' '+d.commercial+' '+d.type+' '+d.date).toLowerCase();
            return h.indexOf(search)>=0;
        }
        return true;
    });
    var body=document.getElementById('dossiersBody');
    if(filtered.length===0){
        body.innerHTML='<div style="text-align:center;padding:30px;color:#9ca3af;font-size:14px;">'
            +(search?'Aucun r\u00e9sultat pour "'+search+'"':'Aucun dossier enregistr\u00e9')+'</div>';
        return;
    }
    var html='<div style="display:flex;flex-direction:column;gap:8px;padding:8px 0;">';
    filtered.forEach(function(d){
        var badge=d.type==='ITE'
            ?'<span style="background:#059669;color:white;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;">ITE</span>'
            :'<span style="background:#2563eb;color:white;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;">PAC</span>';
        html+='<div style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;cursor:pointer;transition:all 0.15s;" '
            +'onmouseover="this.style.borderColor=\'#16a34a\';this.style.background=\'#f0fdf4\'" '
            +'onmouseout="this.style.borderColor=\'#e5e7eb\';this.style.background=\'#f9fafb\'">'
            +'<div onclick="loadDossier(\''+d.id+'\')" style="flex:1;min-width:0;">'
            +'<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">'
            +badge+'<span style="font-weight:700;font-size:13px;color:#1f2937;">'+d.nomClient+'</span></div>'
            +'<div style="font-size:11px;color:#6b7280;">'
            +d.numDevis+' \u00b7 '+d.date
            +(isAdmin?' \u00b7 \ud83d\udc64 '+d.commercial:'')
            +'</div></div>'
            +'<button onclick="event.stopPropagation();deleteDossier(\''+d.id+'\')" style="background:none;border:none;cursor:pointer;font-size:16px;color:#dc2626;padding:6px;" title="Supprimer">\ud83d\uddd1\ufe0f</button>'
            +'</div>';
    });
    html+='</div>';
    body.innerHTML=html;
}
function loadDossier(id){
    var dossiers=getLocalDossiers();
    var d=null;
    for(var i=0;i<dossiers.length;i++){if(dossiers[i].id===id){d=dossiers[i];break;}}
    if(!d){alert('Dossier introuvable');return;}
    restoreFields(d.fields);
    if(d.type==='ITE') switchTab('ite'); else switchTab('pac');
    try{ite_switchLot2();}catch(e){}
    try{ite_switchLot3();}catch(e){}
    try{ite_calc();}catch(e){}
    try{calc();}catch(e){}
    try{syncProfilPrecarite();}catch(e){}
    document.getElementById('dossiersModal').classList.remove('active');
}
function deleteDossier(id){
    if(!confirm('Supprimer ce dossier ?'))return;
    // Remove locally
    var dossiers=getLocalDossiers().filter(function(d){return d.id!==id;});
    setLocalDossiers(dossiers);
    // Remove from API
    if(useAPI && API_URL){
        apiCall({action:'deleteDossier', id:id}, function(){}, function(){});
    }
    renderDossiers();
}
</script>
</body>
</html>
