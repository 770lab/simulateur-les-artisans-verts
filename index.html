<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Aides PAC 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        /* === BANDEAU INFO 2026 === */
        .info-banner-2026 {
            background: linear-gradient(135deg, #14532d 0%, #166534 50%, #15803d 100%);
            color: white;
            padding: 10px 20px;
            font-size: 13px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .info-banner-2026 strong { color: #86efac; }
        .info-banner-2026 .separator-dot { opacity: 0.4; margin: 0 4px; }

        /* === AUTO-DETECTION REVENUS === */
        .revenus-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .revenus-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .revenus-toggle h3 {
            font-size: 14px;
            font-weight: 600;
            color: #16a34a;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .revenus-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #16a34a;
        }
        .revenus-toggle .toggle-arrow.open { transform: rotate(180deg); }
        .revenus-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding-top: 0;
        }
        .revenus-body.open {
            max-height: 500px;
            padding-top: 14px;
        }
        .revenus-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .revenus-grid { grid-template-columns: 1fr; }
        }
        .revenus-grid label {
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 4px;
            display: block;
        }
        .revenus-grid select, .revenus-grid input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }
        .revenus-grid select:focus, .revenus-grid input:focus {
            border-color: #16a34a;
            outline: none;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }
        .profil-result {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: fadeSlide 0.3s ease;
        }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .profil-result.show { display: block; }
        .profil-result.profil-bleu {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .profil-result.profil-jaune {
            background: linear-gradient(135deg, #fef9c3, #fef08a);
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .profil-result.profil-violet {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            color: #5b21b6;
            border: 1px solid #c4b5fd;
        }
        .profil-result.profil-rose {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            color: #9d174d;
            border: 1px solid #f9a8d4;
        }

        /* === CEE DETAIL SECTION === */
        .cee-section {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #93c5fd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .cee-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .cee-toggle h3 {
            font-size: 14px;
            font-weight: 600;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .cee-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #2563eb;
        }
        .cee-toggle .toggle-arrow.open { transform: rotate(180deg); }
        .cee-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease, padding 0.3s ease;
            padding-top: 0;
        }
        .cee-body.open {
            max-height: 800px;
            padding-top: 14px;
        }
        .cee-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .cee-grid { grid-template-columns: 1fr; }
        }
        .cee-grid label {
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 4px;
            display: block;
        }
        .cee-grid select, .cee-grid input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }
        .cee-grid select:focus, .cee-grid input:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .cee-result {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            text-align: center;
            display: none;
            animation: fadeSlide 0.3s ease;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .cee-result.show { display: block; }
        .cee-hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        .cee-bloc-171, .cee-bloc-148 {
            transition: all 0.3s ease;
        }
        .cee-hidden { display: none !important; }

        /* Isolation state radio buttons */
        .g-radio {
            display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px;
            border: 1.5px solid #e2e8f0; border-radius: 10px; cursor: pointer;
            transition: all 0.15s ease; font-size: 13px; background: white;
        }
        .g-radio:hover { border-color: #a3cfbb; background: #f8fdfb; }
        .g-radio.selected { border-color: #16a34a; background: #f0fdf4; }
        .g-radio input[type="radio"] { accent-color: #16a34a; margin: 3px 0 0 0; width: 18px; height: 18px; flex-shrink: 0; }
        .g-label { flex: 1; }
        .g-label-title { font-weight: 600; color: #1d1d1f; font-size: 13px; }
        .g-label-sub { font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .g-value { display: none; }

        /* Dim form */
        .dim-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
        .dim-field label { font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; margin-bottom: 6px; }
        .dim-field .req { color: #dc2626; }
        .dim-field input, .dim-field select {
            width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px;
            font-size: 15px; font-weight: 500; color: #0f172a; background: white; transition: border-color 0.15s;
        }
        .dim-field input:focus, .dim-field select:focus { border-color: #16a34a; outline: none; box-shadow: 0 0 0 3px rgba(22,163,74,0.08); }
        .dim-field .dim-hint { font-size: 11px; color: #94a3b8; margin-top: 4px; }

        /* Confort slider */
        .confort-box { border: 1.5px solid #e2e8f0; border-radius: 10px; padding: 16px; }
        .confort-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .confort-val { font-size: 22px; font-weight: 700; color: #16a34a; }
        .confort-lbl { font-size: 14px; font-weight: 600; color: #334155; text-transform: uppercase; letter-spacing: 0.5px; }
        input.confort-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 4px; outline: none; margin: 8px 0; padding: 0; border: none;
            background: linear-gradient(to right, #fb923c, #16a34a 50%, #3b82f6); }
        input.confort-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 26px; height: 26px; border-radius: 50%; background: white; border: 3px solid #16a34a; cursor: pointer; box-shadow: 0 1px 6px rgba(0,0,0,0.15); }
        input.confort-slider::-moz-range-thumb { width: 26px; height: 26px; border-radius: 50%; background: white; border: 3px solid #16a34a; cursor: pointer; box-shadow: 0 1px 6px rgba(0,0,0,0.15); }
        .confort-labels { display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .confort-desc { font-size: 12px; color: #64748b; margin-top: 10px; font-style: italic; }
        .cee-kpi-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        .cee-kpi {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 12px;
            text-align: center;
        }
        .cee-kpi .kpi-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .cee-kpi .kpi-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e40af;
        }
        .cee-kpi .kpi-value.green { color: #16a34a; }
        .cee-kpi .kpi-detail {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 2px;
            font-family: ui-monospace, monospace;
        }

        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .lock-btn {
            background: #f5f5f7;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lock-btn:hover {
            background: #e8e8ed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
        }

        .modal-content h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 16px;
        }

        .modal-content button {
            width: 100%;
            padding: 12px;
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-content button:hover {
            background: #0077ed;
        }



        .btn-apply {
            flex: 1;
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-apply:hover {
            background: #0077ed;
        }

        .btn-close-modal {
            background: #f5f5f7;
            color: #1d1d1f;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-close-modal:hover {
            background: #e8e8ed;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 28px;
            padding: 30px 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #1d1d1f;
        }

        .form-group small {
            display: block;
            font-size: 12px;
            color: #86868b;
            margin-top: 4px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 4px rgba(0,113,227,0.1);
        }

        .fournisseur-only {
            display: none;
        }

        .fournisseur-mode .fournisseur-only {
            display: block;
        }
        
        .fournisseur-mode .ttc-readonly {
            display: none !important;
        }

        .client-only {
            display: block;
        }

        .fournisseur-mode .client-only {
            display: none;
        }

        .results-sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .summary-card {
            background: linear-gradient(165deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.05);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--scroll-gradient, linear-gradient(90deg, #34d399, #22d3ee, #818cf8));
            transition: background 0.4s ease;
        }

        .result-row-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }
        .result-row-card:hover {
            background: rgba(255,255,255,0.07);
            border-color: rgba(255,255,255,0.12);
            transform: translateY(-1px);
        }
        .result-row-card .rrc-label {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255,255,255,0.55);
            letter-spacing: 0.3px;
        }
        .result-row-card .rrc-value {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            font-variant-numeric: tabular-nums;
        }
        .result-row-card .rrc-value.green { color: #34d399; }
        .result-row-card .rrc-value.yellow { color: #fbbf24; }
        .result-row-card .rrc-value.red { color: #f87171; }
        .result-row-card .rrc-value.cyan { color: #22d3ee; }
        .result-row-card .rrc-value.blue { color: #60a5fa; }

        .result-highlight-card {
            background: linear-gradient(135deg, rgba(52,211,153,0.12) 0%, rgba(34,211,238,0.08) 100%);
            border: 1px solid rgba(52,211,153,0.2);
            border-radius: 14px;
            padding: 18px 22px;
            margin-bottom: 12px;
            text-align: center;
            position: relative;
        }
        .result-highlight-card .rhc-label {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .result-highlight-card .rhc-value {
            font-size: 34px;
            font-weight: 800;
            color: #34d399;
            text-shadow: 0 0 30px rgba(52,211,153,0.3);
        }

        .glow-separator {
            height: 2px;
            margin: 16px 0;
            border-radius: 2px;
            background: var(--scroll-gradient, linear-gradient(90deg, #34d399, #22d3ee, #818cf8));
            opacity: 0.4;
            transition: opacity 0.3s, background 0.6s;
        }
        .glow-separator:hover { opacity: 0.7; }

        .dark-section-title {
            font-size: 11px;
            font-weight: 700;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            padding-left: 2px;
        }

        .scenario-label-dark {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 18px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 3px solid #34d399;
            line-height: 1.5;
            transition: border-color 0.4s;
        }
        .scenario-label-dark strong { font-weight: 600; color: #f1f5f9; }
        .scenario-label-dark .separator { color: rgba(255,255,255,0.3); margin: 0 8px; }

        .rac-dark-section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px;
        }
        .rac-dark-section .amount-label {
            color: rgba(255,255,255,0.45);
        }
        .rac-dark-section input[type="number"] {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            color: #f1f5f9;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        .rac-dark-section input[type="number"]:focus {
            border-color: #34d399;
            box-shadow: 0 0 0 3px rgba(52,211,153,0.15);
            outline: none;
        }
        .rac-dark-section .note-small { color: rgba(255,255,255,0.35); }

        .ttc-input-dark {
            font-size: 24px;
            font-weight: 700;
            text-align: right;
            padding: 10px 14px;
            width: 100%;
            border: 2px solid rgba(96,165,250,0.4);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #f1f5f9;
            margin-bottom: 6px;
            transition: border-color 0.2s;
        }
        .ttc-input-dark:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96,165,250,0.15);
            outline: none;
        }

        .btn-dark-export {
            width: 100%;
            border: none;
            padding: 13px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            margin-bottom: 10px;
        }
        .btn-dark-export.pdf {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        .btn-dark-export.pdf:hover { background: linear-gradient(135deg, #60a5fa, #3b82f6); }
        .btn-dark-export.whatsapp {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        .btn-dark-export.whatsapp:hover { background: linear-gradient(135deg, #34d399, #22c55e); }
        .btn-dark-export:disabled {
            opacity: 0.35;
            cursor: not-allowed;
            filter: grayscale(0.3);
        }

        .summary-header {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .scenario-label {
            font-size: 13px;
            color: #1d1d1f;
            margin-bottom: 20px;
            padding: 14px;
            background: #f5f5f7;
            border-radius: 8px;
            border-left: 4px solid #0071e3;
            line-height: 1.5;
        }
        
        .scenario-label strong {
            font-weight: 600;
        }
        
        .scenario-label .separator {
            color: #86868b;
            margin: 0 8px;
        }
        
        .color-bleu { color: #0071e3; }
        .color-jaune { color: #fbbf24; }
        .color-violet { color: #8b5cf6; }
        .color-rose { color: #ec4899; }

        .amount-row {
            margin-bottom: 12px;
        }

        .amount-label {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 4px;
        }

        .amount-value {
            font-size: 26px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .amount-value.highlight {
            color: #34c759;
        }

        .rac-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .rac-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .rac-item input {
            font-size: 22px;
            font-weight: 700;
            color: #1d1d1f;
            text-align: center;
            padding: 8px 10px;
        }

        .final-amount {
            text-align: right;
            padding-top: 20px;
            border-top: 2px solid #f5f5f7;
        }

        .final-amount .amount-label {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 6px;
        }

        .final-amount .amount-value {
            font-size: 34px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .status-badge {
            display: inline-block;
            padding: 14px 32px;
            font-weight: 700;
            font-size: 18px;
            border-radius: 12px;
            text-align: center;
            width: 100%;
            letter-spacing: 0.5px;
            transition: all 0.3s;
        }

        .status-badge.ok {
            background: #d1f4e0;
            color: #0d7f3f;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-reset {
            background: #f5f5f7;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-reset:hover {
            background: #e8e8ed;
        }


        .footer {
            text-align: center;
            padding: 8px 20px 8px;
            color: #86868b;
            font-size: 13px;
        }

        @media print {
            .header, .lock-btn, .btn-reset, .footer, .parameters-section, .main-content {
                display: none !important;
            }
            
            #printArea {
                display: block !important;
            }

            body {
                background: white;
            }

            @page {
                margin: 15mm;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .results-sidebar {
                position: static;
            }


        }

        .note-small {
            font-size: 11px;
            color: #86868b;
            text-align: center;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 12px 20px; border-radius: 10px; font-weight: 700; font-size: 15px; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);">
                        üè† LES ARTISANS VERTS
                    </div>
                    <h1 style="margin: 0; font-size: 22px;">Simulateur Aides PAC <span style="font-size: 14px; background: #16a34a; color: white; padding: 2px 8px; border-radius: 6px; vertical-align: middle; margin-left: 6px;">2026</span></h1>
                </div>
                <button class="lock-btn" id="lockBtn">
                    <span id="lockIcon">üîí</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Bandeau Info 2026 -->
    <div class="info-banner-2026">
        <span>üìã</span>
        <span><strong>MPR 2026</strong> ‚Äî Bar√®mes √† jour</span>
        <span class="separator-dot">‚Ä¢</span>
        <span>Logement <strong>+15 ans</strong> requis</span>
        <span class="separator-dot">‚Ä¢</span>
        <span>Isolation murs & biomasse <strong>retir√©s du monogeste</strong></span>
        <span class="separator-dot">‚Ä¢</span>
        <span>Guichet r√©ouverture <strong>‚âà 12 f√©v. 2026</strong></span>
        <span class="separator-dot">‚Ä¢</span>
        <span>CEE : <strong>BAR-TH-171 / 143 / 148</strong> int√©gr√©s</span>
        <span class="separator-dot">‚Ä¢</span>
        <span>Zone auto par <strong>n¬∞ d√©partement</strong></span>
    </div>

    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h2>Acc√®s Vue fournisseur</h2>
            <input type="password" id="passwordInput" placeholder="Mot de passe">
            <button id="unlockBtn">D√©verrouiller</button>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="parameters-section">
            <div class="card">
                <h2 class="card-title">Informations Client</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label>Nom</label>
                        <input type="text" id="nom" placeholder="Nom du client" oninput="checkExport()">
                    </div>
                    <div>
                        <label>Pr√©nom</label>
                        <input type="text" id="prenom" placeholder="Pr√©nom du client" oninput="checkExport()">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Param√®tres</h2>

                <!-- Param√®tres principaux -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="scenario">Sc√©nario</label>
                        <select id="scenario" onchange="onScenarioChange()">
                            <option value="PAC">PAC</option>
                            <option value="PAC + BALLON √âLECTRIQUE">PAC + BALLON √âLECTRIQUE</option>
                            <option value="PAC + BALLON THERMO">PAC + BALLON THERMO</option>
                            <option value="PAC + SSC">PAC + SSC</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="categorie">Cat√©gorie MPR</label>
                        <select id="categorie" onchange="calc()">
                            <option value="BLEU">MPR Bleu</option>
                            <option value="JAUNE">MPR Jaune</option>
                            <option value="VIOLET">MPR Violet</option>
                            <option value="ROSE">MPR Rose</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="zone">Zone climatique</label>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <input type="text" id="departement" placeholder="Dept" maxlength="3" style="width: 58px; text-align: center; font-weight: 600;" oninput="detectDept()">
                            <select id="zone" onchange="calc()" style="flex: 1;">
                                <option value="H1">H1</option>
                                <option value="H2">H2</option>
                                <option value="H3">H3</option>
                            </select>
                            <span id="deptZoneResult" style="font-weight: 600; color: #16a34a; font-size: 12px; display: none; white-space: nowrap;"></span>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="etas">Plage d'ETAS</label>
                        <select id="etas" onchange="calc()">
                            <option value="111-140">111 &lt; ETAS &lt; 140</option>
                            <option value="140-170" selected>140 &lt; ETAS &lt; 170</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="typeLogement">Type de logement</label>
                        <select id="typeLogement" onchange="onTypeLogementChange()">
                            <option value="maison" selected>Maison individuelle</option>
                            <option value="appartement">Appartement</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="surface">Surface chauff√©e</label>
                        <select id="surface" onchange="calc()">
                            <option value="S<70">S &lt; 70 m¬≤</option>
                            <option value="70<=S<90">70 ‚â§ S &lt; 90 m¬≤</option>
                            <option value="S>=90" selected>S ‚â• 90 m¬≤</option>
                        </select>
                    </div>
                </div>

                <!-- Auto-d√©tection revenus -->
                <div class="revenus-section" style="margin-top: 16px;">
                    <h3 style="font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 10px;">üéØ D√©tection automatique du profil MPR 2026</h3>
                    <div class="revenus-body open" id="revenusBody">
                        <div class="revenus-grid">
                            <div>
                                <label>R√©gion</label>
                                <select id="region" onchange="detectProfil()">
                                    <option value="PROVINCE">Hors √éle-de-France</option>
                                    <option value="IDF">√éle-de-France</option>
                                </select>
                            </div>
                            <div>
                                <label>Personnes dans le foyer</label>
                                <select id="nbPersonnes" onchange="detectProfil()">
                                    <option value="1">1 personne</option>
                                    <option value="2">2 personnes</option>
                                    <option value="3">3 personnes</option>
                                    <option value="4" selected>4 personnes</option>
                                    <option value="5">5 personnes</option>
                                    <option value="6">6 personnes</option>
                                    <option value="7">7 personnes</option>
                                    <option value="8">8 personnes</option>
                                </select>
                            </div>
                            <div>
                                <label>Revenu fiscal de r√©f. (‚Ç¨)</label>
                                <input type="number" id="rfr" placeholder="Ex: 35 000" oninput="detectProfil()">
                            </div>
                        </div>
                        <div class="profil-result" id="profilResult"></div>
                    </div>
                </div>

                <!-- ===================== CEE D√âTAIL (BAR-TH-171 / 143 / 148) ===================== -->
                <div class="cee-section">
                    <h3 style="font-size: 13px; font-weight: 600; color: #1d1d1f; margin-bottom: 10px;">‚ö° Calcul CEE d√©taill√© (BAR-TH-171 / 143 / 148)</h3>
                    <div class="cee-body open" id="ceeBody">
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 10px;">
                            Sc√©nario : <strong id="ceeScenarioLabel">PAC</strong> ‚Üí Fiches : <strong id="ceeFichesLabel">BAR-TH-171</strong>
                            <span id="ceeNonCumulNote" style="display:none; color: #dc2626; font-weight: 600; margin-left: 8px;"></span>
                        </div>
                        <div class="cee-grid">
                            <div>
                                <label>Fiche CEE</label>
                                <select id="ficheCEE" onchange="toggleCEEBlocs(); calcCEEDetail();">
                                    <option value="171">BAR-TH-171 ‚Äì PAC air/eau</option>
                                    <option value="143">BAR-TH-143 ‚Äì SSC (solaire combin√©)</option>
                                    <option value="148">BAR-TH-148 ‚Äì CET (chauffe-eau thermo)</option>
                                </select>
                            </div>
                            <div>
                                <label>Cat√©gorie m√©nage CEE</label>
                                <select id="menageCEE" onchange="calcCEEDetail()">
                                    <option value="tm">Tr√®s modestes (12,5 ‚Ç¨/MWhc)</option>
                                    <option value="autres">Autres m√©nages (7,5 ‚Ç¨/MWhc)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Bloc 171 sp√©cifique -->
                        <div class="cee-bloc-171" id="ceeBloc171" style="margin-top: 12px;">
                            <div style="font-size: 12px; font-weight: 600; color: #2563eb; margin-bottom: 8px;">üìò BAR-TH-171 ‚Äî PAC air/eau ¬∑ <span style="color: #059669;">Coup de pouce √ó5</span></div>
                            <div class="cee-grid">
                                <div>
                                    <label>Classe ETAS (chauffage)</label>
                                    <select id="ceeEtas" onchange="calcCEEDetail()">
                                        <option value="lt140">111% ‚â§ ETAS &lt; 140%</option>
                                        <option value="ge140" selected>ETAS ‚â• 140%</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Surface chauff√©e PAC (m¬≤)</label>
                                    <input type="number" id="ceeSurface" min="1" step="1" value="95" oninput="calcCEEDetail()">
                                    <div class="cee-hint">Pi√®ces avec √©metteurs aliment√©s par la PAC</div>
                                </div>
                                <div>
                                    <label>Coef surface (auto)</label>
                                    <input type="text" id="ceeCoefSurface" disabled value="‚Äî" style="background: #f1f5f9; font-weight: 600;">
                                    <div class="cee-hint">Maison: 70/90 ¬∑ Appart: 35/60</div>
                                </div>
                            </div>
                        </div>

                        <!-- Bloc 148 sp√©cifique -->
                        <div class="cee-bloc-148 cee-hidden" id="ceeBloc148" style="margin-top: 12px;">
                            <div class="cee-grid">
                                <div>
                                    <label>Forfait BAR-TH-148 (kWhc)</label>
                                    <input type="number" id="ceeKwhc148" min="0" step="100" value="9000" oninput="calcCEEDetail()">
                                    <div class="cee-hint">Bar√®me officiel 148 (par d√©faut : 9 000 kWhc)</div>
                                </div>
                                <div>
                                    <label>Forfait calcul√©</label>
                                    <input type="text" id="cee148Forfait" disabled value="‚Äî" style="background: #f1f5f9; font-weight: 600;">
                                </div>
                                <div>
                                    <label>Note interne (optionnel)</label>
                                    <input type="text" id="ceeNote148" placeholder="COP, volume ballon, marque..." oninput="calcCEEDetail()">
                                </div>
                            </div>
                        </div>

                        <!-- Bloc BAR-TH-143 -->
                        <div id="ceeBloc143" class="cee-hidden" style="margin-top: 12px;">
                            <div style="font-size: 12px; font-weight: 600; color: #2563eb; margin-bottom: 8px;">üìô BAR-TH-143 ‚Äî SSC (solaire combin√©) ¬∑ <span style="color: #059669;">Coup de pouce √ó2</span></div>
                            <div class="cee-grid">
                                <div>
                                    <label>Forfait par zone</label>
                                    <input type="text" id="cee143Forfait" disabled value="‚Äî" style="background: #f1f5f9; font-weight: 600;">
                                    <div class="cee-hint">H1: 134 800 ¬∑ H2: 121 000 ¬∑ H3: 100 500 kWhc</div>
                                </div>
                            </div>
                        </div>

                        <!-- KPI CEE -->
                        <div class="cee-kpi-row" style="grid-template-columns: 1fr 1fr 1fr;">
                            <div class="cee-kpi">
                                <div class="kpi-label">Volume CEE</div>
                                <div class="kpi-value" id="ceeOutKwhc">‚Äî</div>
                                <div class="kpi-detail" id="ceeOutDetail">‚Äî</div>
                            </div>
                            <div class="cee-kpi">
                                <div class="kpi-label">Prime CEE</div>
                                <div class="kpi-value green" id="ceeOutPrime">‚Äî</div>
                                <div class="kpi-detail" id="ceeOutPrix">‚Äî</div>
                            </div>
                            <div class="cee-kpi" id="ceeKpi148" style="display:none;">
                                <div class="kpi-label">Dont BAR-TH-148</div>
                                <div class="kpi-value" id="ceeOut148" style="color: #059669;">‚Äî</div>
                                <div class="kpi-detail" id="ceeOut148Detail">‚Äî</div>
                            </div>
                        </div>

                        <div class="cee-result" id="ceeResult"></div>

                    </div>
                </div>

                <div style="margin-top: 12px;">
                    <button class="btn-reset" onclick="reset()" style="width: 100%;">R√©initialiser</button>
                </div>
                <div id="calcErrorDebug" style="color: red; font-size: 12px; font-weight: 600; margin-top: 8px; padding: 6px; background: #fef2f2; border-radius: 6px;"></div>
            </div>

            <!-- ===================== NOTE DE DIMENSIONNEMENT ===================== -->
            <div class="card" id="dimensionnementCard">
                <h2 class="card-title">üìê Dimensionnement PAC</h2>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 18px;">Estimation de la puissance recommand√©e ¬∑ Formule : P = G √ó V √ó ŒîT</div>

                <!-- Surface + Hauteur -->
                <div class="dim-row">
                    <div class="dim-field">
                        <label>Surface au sol (m¬≤) <span class="req">*</span></label>
                        <input type="number" id="dimSurface" value="100" min="1" oninput="calcDim()">
                        <div class="dim-hint">Exemple : 100 m¬≤</div>
                    </div>
                    <div class="dim-field">
                        <label>Hauteur sous plafond (m)</label>
                        <input type="number" id="dimHauteur" value="2.5" min="1.5" max="5" step="0.1" oninput="calcDim()">
                        <div class="dim-hint">D√©faut : 2,5 m</div>
                    </div>
                </div>

                <!-- Ann√©e de construction -->
                <div class="dim-row" style="grid-template-columns: 1fr;">
                    <div class="dim-field">
                        <label>Ann√©e de construction <span class="req">*</span></label>
                        <input type="number" id="dimAnnee" value="2000" min="1900" max="2026" oninput="calcDim()">
                        <div class="dim-hint">Base de calcul pour le coefficient G</div>
                    </div>
                </div>

                <!-- √âtat de l'isolation -->
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; margin-bottom: 8px;">√âtat de l'isolation <span style="color: #dc2626;">*</span></label>
                    <div id="gCoefOptions" style="display: flex; flex-direction: column; gap: 8px;">
                        <label class="g-radio selected" onclick="selectIsolation('origine')">
                            <input type="radio" name="dimIsolation" value="origine" checked>
                            <span class="g-label">
                                <div class="g-label-title">√âtat d'origine / Non pr√©cis√©</div>
                                <div class="g-label-sub">Coefficient standard selon l'ann√©e.</div>
                            </span>
                        </label>
                        <label class="g-radio" onclick="selectIsolation('partielle')">
                            <input type="radio" name="dimIsolation" value="partielle">
                            <span class="g-label">
                                <div class="g-label-title">R√©novation partielle</div>
                                <div class="g-label-sub">Bonus d'isolation (‚àí0,2 sur G).</div>
                            </span>
                        </label>
                        <label class="g-radio" onclick="selectIsolation('totale')">
                            <input type="radio" name="dimIsolation" value="totale">
                            <span class="g-label">
                                <div class="g-label-title">R√©novation totale</div>
                                <div class="g-label-sub">Isolation refaite √† neuf (r√©novation performante).</div>
                            </span>
                        </label>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #334155; font-weight: 600;" id="dimGDisplay">G = 0,95</div>
                </div>

                <!-- Niveau de confort -->
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; margin-bottom: 8px;">Niveau de confort <span style="color: #dc2626;">*</span></label>
                    <div class="confort-box">
                        <div class="confort-header">
                            <span class="confort-val" id="confortPct">100%</span>
                            <span class="confort-lbl" id="confortName">Standard</span>
                        </div>
                        <input type="range" class="confort-slider" id="dimConfort" min="60" max="140" value="100" step="5" oninput="updateConfort(); calcDim();">
                        <div class="confort-labels">
                            <span>√âconomie</span>
                            <span>Standard</span>
                            <span>Confort +</span>
                        </div>
                        <div class="confort-desc" id="confortDesc">Le choix recommand√© pour un confort √©quilibr√©.</div>
                    </div>
                </div>

                <!-- Param√®tres avanc√©s (masqu√©s, gard√©s pour calcul) -->
                <input type="hidden" id="dimTbase" value="-7">
                <input type="hidden" id="dimTint" value="21">
                <input type="hidden" id="dimT1" value="60">
                <input type="hidden" id="dimT2" value="140">

                <!-- R√âSULTATS -->
                <div style="background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: white; font-size: 14px; margin-bottom: 14px; text-align: center;">R√âSULTATS DU DIMENSIONNEMENT</div>
                    
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">D√©perditions totales (P = G √ó V √ó ŒîT)</div>
                        <div style="font-size: 28px; font-weight: 800; color: #fbbf24;" id="dimDeperditions">‚Äî</div>
                        <div style="font-size: 12px; color: #cbd5e1;" id="dimDepFormula">‚Äî</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance PAC</div>
                            <div style="font-size: 24px; font-weight: 800; color: #34d399;" id="dimPuissancePAC">‚Äî</div>
                            <div style="font-size: 11px; color: #cbd5e1;" id="dimPuissancePACDetail">‚Äî</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance appoint</div>
                            <div style="font-size: 24px; font-weight: 800; color: #f97316;" id="dimPuissanceAppoint">‚Äî</div>
                            <div style="font-size: 11px; color: #cbd5e1;" id="dimPuissanceAppointDetail">‚Äî</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.08); border-radius: 8px; padding: 10px; margin-top: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance totale (PAC + appoint)</div>
                        <div style="font-size: 20px; font-weight: 700; color: white;" id="dimPuissanceTotale">‚Äî</div>
                    </div>
                </div>

                <!-- Temp√©rature d'eau -->
                <div class="dim-row" style="margin-bottom: 0;">
                    <div class="dim-field">
                        <label>T¬∞ d'eau du circuit (¬∞C)</label>
                        <input type="number" id="dimTeau" value="60" step="5" min="30" max="80">
                    </div>
                </div>

                <!-- √âquipement -->
                <div style="margin-top: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px;">
                    <div style="font-weight: 600; color: #1d1d1f; font-size: 13px; margin-bottom: 10px;">Mat√©riel install√©</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: #64748b;">Marque PAC</label>
                            <input type="text" id="dimMarque" placeholder="Ex: Daikin, Atlantic‚Ä¶" style="width: 100%; padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #64748b;">R√©f√©rence PAC</label>
                            <input type="text" id="dimReference" placeholder="R√©f. mod√®le" style="width: 100%; padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card fournisseur-only">
                <h2 class="card-title">Co√ªts (Vue Fournisseur)</h2>
                
                <div style="background: #f5f5f7; padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                    <!-- PAC Mat√©riel -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">PAC Mat√©riel</label>
                        <input type="number" id="coutPACMateriel" value="2900" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qtePACMateriel" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPACMateriel">2 900 ‚Ç¨</div>
                    </div>
                    
                    <!-- PAC Pose -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">PAC Pose</label>
                        <input type="number" id="coutPACPose" value="2500" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qtePACPose" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPACPose">2 500 ‚Ç¨</div>
                    </div>
                    
                    <!-- Ballon Mat√©riel -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Ballon Mat√©riel</label>
                        <input type="number" id="coutBallonMateriel" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteBallonMateriel" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalBallonMateriel">0 ‚Ç¨</div>
                    </div>
                    
                    <!-- Ballon Pose -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Ballon Pose</label>
                        <input type="number" id="coutBallonPose" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteBallonPose" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalBallonPose">0 ‚Ç¨</div>
                    </div>
                    
                    <!-- Accessoires -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Access.</label>
                        <input type="number" id="coutAccessoires" value="500" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAccessoires" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAccessoires">500 ‚Ç¨</div>
                    </div>
                    
                    <!-- Admin -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Admin</label>
                        <input type="number" id="coutAdmin" value="300" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAdmin" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAdmin">300 ‚Ç¨</div>
                    </div>
                </div>
                
                <small style="font-size: 11px; color: #86868b; margin-bottom: 12px; display: block; text-align: center;">
                    <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="lockCoutHT" checked onchange="calc()"> Verrouiller les co√ªts (auto selon sc√©nario)
                    </label>
                </small>
                
                <div style="background: #0071e3; color: white; padding: 14px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; font-size: 14px;">TOTAL CO√õT HT</span>
                        <span style="font-size: 20px; font-weight: 700;" id="coutTotalHTDisplay">6 200 ‚Ç¨</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="prixCumac">Prix cumac (‚Ç¨/MWhc) ‚Äî auto selon m√©nage</label>
                        <input type="number" id="prixCumac" value="12.5" step="0.01" oninput="calc()" style="font-weight: 600;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label>kWh cumac</label>
                        <input type="text" id="kwhCumac" value="" readonly style="background: #f5f5f7; color: #1d1d1f; font-weight: 600;">
                    </div>
                </div>
            </div>

            <div style="padding-bottom: 40px;"></div>
        </div>

        <div class="results-sidebar" id="resultsSidebar">
            <div class="summary-card" style="margin-bottom: 0;">
                <div class="scenario-label-dark" id="scenarioSummary">‚Äî</div>

                <!-- TOTAL TTC (readonly client) -->
                <div class="ttc-readonly">
                    <div class="result-row-card" style="background: rgba(96,165,250,0.08); border-color: rgba(96,165,250,0.15);">
                        <div class="rrc-label">üí∞ Co√ªt installation TTC</div>
                        <div class="rrc-value blue" id="totalTTC">‚Äî</div>
                    </div>
                </div>

                <!-- TOTAL TTC (editable fournisseur) -->
                <div class="fournisseur-only" style="margin-bottom: 12px;">
                    <div class="dark-section-title">Co√ªt installation</div>
                    <input type="number" class="ttc-input-dark" id="totalTTCInput" value="10890" step="1" oninput="updateFromTTC()">
                    <small style="font-size: 11px; color: rgba(255,255,255,0.35); margin-top: 4px; display: block;">
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" id="lockTTC" checked onchange="calc()"> Verrouiller (auto selon sc√©nario)
                        </label>
                    </small>
                </div>

                <!-- CO√õT HT fournisseur -->
                <div class="fournisseur-only" style="margin-bottom: 4px;">
                    <div class="result-row-card">
                        <div>
                            <div class="rrc-label">Co√ªt HT</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px;">Mat√©riel + pose + admin</div>
                        </div>
                        <div class="rrc-value" id="displayCoutHT" style="font-size: 18px;">‚Äî</div>
                    </div>
                </div>

                <div class="glow-separator"></div>

                <!-- ESTIMATION FINANCI√àRE -->
                <div class="dark-section-title">Estimation financi√®re</div>

                <div class="result-row-card">
                    <div class="rrc-label">MaPrimeR√©nov'</div>
                    <div class="rrc-value green" id="aidesMPR" style="font-size: 18px;">‚Äî</div>
                </div>

                <div class="result-row-card">
                    <div>
                        <div class="rrc-label">Certificats CEE</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px;" id="ceeSourceLabel">BAR-TH d√©taill√©</div>
                    </div>
                    <div class="rrc-value green" id="aidesCEE" style="font-size: 18px;">‚Äî</div>
                </div>

                <div class="glow-separator"></div>

                <!-- TOTAL AIDES -->
                <div class="result-highlight-card">
                    <div class="rhc-label">Total des aides</div>
                    <div class="rhc-value" id="totalAides">‚Äî</div>
                </div>

                <!-- RESTE √Ä CHARGE -->
                <div class="result-row-card" style="background: rgba(251,191,36,0.08); border-color: rgba(251,191,36,0.15);">
                    <div class="rrc-label">üè† Reste √† charge estim√©</div>
                    <div class="rrc-value yellow" id="resteCharge">‚Äî</div>
                </div>

                <!-- MARGE fournisseur -->
                <div class="fournisseur-only" style="margin-top: 4px;">
                    <div class="result-row-card" style="background: rgba(248,113,113,0.06); border-color: rgba(248,113,113,0.12);">
                        <div class="rrc-label">üìä Marge finale (HT)</div>
                        <div class="rrc-value" id="margeFinal" style="font-size: 18px;">‚Äî</div>
                    </div>
                </div>

                <div class="glow-separator"></div>

                <!-- RAC Section -->
                <div class="rac-dark-section" style="margin-bottom: 14px;">
                    <div class="dark-section-title" style="margin-bottom: 10px;">Prise en charge du RAC</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div class="amount-label" style="color: rgba(255,255,255,0.45); margin-bottom: 4px;">Pourcentage (%)</div>
                            <input type="number" id="racPourcent" value="0" min="0" max="100" step="1" oninput="updatePct()">
                        </div>
                        <div>
                            <div class="amount-label" style="color: rgba(255,255,255,0.45); margin-bottom: 4px;">RAC offert (‚Ç¨)</div>
                            <input type="number" id="racOffert" value="0" min="0" step="1" oninput="updateAmt()">
                        </div>
                    </div>
                    <div class="note-small fournisseur-only" style="font-size: 11px; margin-bottom: 8px;">Appliqu√© sur le RAC brut. N'affecte pas le prix cumac.</div>
                </div>

                <div class="status-badge ok" id="statusBadge" style="margin-bottom: 14px; margin-top: 4px;">DOSSIER OK</div>

                <button id="exportBtn" class="btn-dark-export pdf" disabled>
                    üìÑ Exporter en PDF
                </button>
                
                <button id="whatsappBtn" class="btn-dark-export whatsapp" disabled>
                    üí¨ Demander un devis
                </button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p style="margin: 0;">Propuls√© par 770 Lab</p>
    </div>

    <div id="printArea" style="display: none;">
        <div style="padding: 40px; font-family: -apple-system, sans-serif;">
            <h1 style="font-size: 28px; margin-bottom: 10px;" id="printTitle">Dossier ‚Äî</h1>
            <p style="color: #6b7280; margin-bottom: 30px;" id="printDate"></p>
            
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="font-size: 14px; color: #6b7280; text-transform: uppercase; margin-bottom: 15px;">R√©sum√©</h2>
                <p style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;" id="printScenario"></p>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">TOTAL TTC</div>
                    <div style="font-size: 28px; font-weight: 700;" id="printTTC"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">AIDES MPR</div>
                    <div style="font-size: 28px; font-weight: 700;" id="printMPR"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">AIDES CEE</div>
                    <div style="font-size: 28px; font-weight: 700;" id="printCEE"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">TOTAL DES AIDES</div>
                    <div style="font-size: 28px; font-weight: 700; color: #34c759;" id="printTotalAides"></div>
                </div>
            </div>
            
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="font-size: 14px; color: #6b7280; text-transform: uppercase; margin-bottom: 15px;">Prise en charge du RAC</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <div style="font-size: 12px; color: #6b7280;">Pourcentage (%)</div>
                        <div style="font-size: 24px; font-weight: 700;" id="printPct"></div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #6b7280;">RAC offert (‚Ç¨)</div>
                        <div style="font-size: 24px; font-weight: 700;" id="printOffert"></div>
                    </div>
                </div>
                
                <div style="padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: right;">
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">RESTE √Ä CHARGE</div>
                    <div style="font-size: 36px; font-weight: 700;" id="printRAC"></div>
                </div>
                
                <div style="margin-top: 20px; padding: 16px; border-radius: 12px; text-align: center; font-weight: 700; font-size: 18px;" id="printStatus"></div>
            </div>
            
            <div style="text-align: center; margin-top: 40px; color: #6b7280; font-size: 12px;">
                Propuls√© par 770 Lab
            </div>
        </div>
    </div>

<script>
// ============================================
// BAR√àMES DE REVENUS MPR 2026
// ============================================
// ============================================
// TABLE D√âPARTEMENTS ‚Üí ZONE CLIMATIQUE (source officielle)
// ============================================
const DEPT_ZONE = {
    "01":"H1","02":"H1","03":"H1","04":"H2","05":"H1","06":"H3","07":"H2","08":"H1","09":"H2","10":"H1",
    "11":"H3","12":"H2","13":"H3","14":"H1","15":"H1","16":"H2","17":"H2","18":"H2","19":"H1","20":"H3",
    "2A":"H3","2B":"H3",
    "21":"H1","22":"H2","23":"H1","24":"H2","25":"H1","26":"H2","27":"H1","28":"H1","29":"H2","30":"H3",
    "31":"H2","32":"H2","33":"H2","34":"H3","35":"H2","36":"H2","37":"H2","38":"H1","39":"H1","40":"H2",
    "41":"H2","42":"H1","43":"H1","44":"H2","45":"H1","46":"H2","47":"H2","48":"H2","49":"H2","50":"H2",
    "51":"H1","52":"H1","53":"H2","54":"H1","55":"H1","56":"H2","57":"H1","58":"H1","59":"H1","60":"H1",
    "61":"H1","62":"H1","63":"H1","64":"H2","65":"H2","66":"H3","67":"H1","68":"H1","69":"H1","70":"H1",
    "71":"H1","72":"H2","73":"H1","74":"H1","75":"H1","76":"H1","77":"H1","78":"H1","79":"H2","80":"H1",
    "81":"H2","82":"H2","83":"H3","84":"H2","85":"H2","86":"H2","87":"H1","88":"H1","89":"H1","90":"H1",
    "91":"H1","92":"H1","93":"H1","94":"H1","95":"H1"
};

function detectZoneFromDept() {
    const deptInput = document.getElementById('departement').value.trim();
    if (!deptInput) return;
    const zone = DEPT_ZONE[deptInput] || DEPT_ZONE[deptInput.padStart(2,'0')];
    if (zone) {
        document.getElementById('zone').value = zone;
        document.getElementById('deptZoneResult').textContent = `‚Üí Zone ${zone}`;
        document.getElementById('deptZoneResult').style.display = 'inline';
        // Auto Tbase dimensionnement
        const deptKey = deptInput.padStart(2,'0');
        const tbase = DEPT_TBASE[deptKey] || DEPT_TBASE[deptInput];
        if (tbase !== undefined) {
            document.getElementById('dimTbase').value = tbase;
            calcDim();
        }
        calc();
    } else {
        document.getElementById('deptZoneResult').textContent = '‚ùå D√©partement inconnu';
        document.getElementById('deptZoneResult').style.display = 'inline';
    }
}

const REVENUS_2026 = {
    PROVINCE: {
        1: [17363, 22259, 31185],
        2: [25393, 32553, 45842],
        3: [30540, 39148, 55196],
        4: [35676, 45735, 64550],
        5: [40835, 52348, 73907],
        supplement: [5151, 6598, 9357]
    },
    IDF: {
        1: [24031, 29253, 40851],
        2: [35270, 42933, 60051],
        3: [42357, 51564, 71846],
        4: [49455, 60208, 84562],
        5: [56580, 68877, 96817],
        supplement: [7116, 8663, 12257]
    }
};

function getSeuilsForPersonnes(region, nb) {
    const data = REVENUS_2026[region];
    if (nb <= 5) return data[nb];
    const base = data[5];
    const sup = data.supplement;
    const extra = nb - 5;
    return [
        base[0] + sup[0] * extra,
        base[1] + sup[1] * extra,
        base[2] + sup[2] * extra
    ];
}

function detectProfil() {
    const region = document.getElementById('region').value;
    const nb = parseInt(document.getElementById('nbPersonnes').value);
    const rfr = parseFloat(document.getElementById('rfr').value);
    const resultEl = document.getElementById('profilResult');

    if (!rfr || rfr <= 0) {
        resultEl.className = 'profil-result';
        resultEl.textContent = '';
        return;
    }

    const seuils = getSeuilsForPersonnes(region, nb);
    let profil, label, className;

    if (rfr <= seuils[0]) {
        profil = 'BLEU'; label = 'üîµ Profil Bleu ‚Äî Revenus tr√®s modestes'; className = 'profil-bleu';
    } else if (rfr <= seuils[1]) {
        profil = 'JAUNE'; label = 'üü° Profil Jaune ‚Äî Revenus modestes'; className = 'profil-jaune';
    } else if (rfr <= seuils[2]) {
        profil = 'VIOLET'; label = 'üü£ Profil Violet ‚Äî Revenus interm√©diaires'; className = 'profil-violet';
    } else {
        profil = 'ROSE'; label = 'ü©∑ Profil Rose ‚Äî Revenus sup√©rieurs'; className = 'profil-rose';
    }

    const regionLabel = region === 'IDF' ? '√éle-de-France' : 'Province';
    const seuilInfo = profil === 'ROSE' 
        ? `RFR ${rfr.toLocaleString('fr-FR')} ‚Ç¨ > ${seuils[2].toLocaleString('fr-FR')} ‚Ç¨`
        : `RFR ${rfr.toLocaleString('fr-FR')} ‚Ç¨ ‚â§ ${seuils[profil === 'BLEU' ? 0 : (profil === 'JAUNE' ? 1 : 2)].toLocaleString('fr-FR')} ‚Ç¨`;

    resultEl.className = `profil-result show ${className}`;
    resultEl.innerHTML = `${label}<br><span style="font-weight:400;font-size:12px;">${regionLabel} ‚Ä¢ ${nb} pers. ‚Ä¢ ${seuilInfo}</span>`;

    document.getElementById('categorie').value = profil;

    // Sync cat√©gorie m√©nage CEE
    if (profil === 'BLEU' || profil === 'JAUNE') {
        document.getElementById('menageCEE').value = 'tm';
    } else {
        document.getElementById('menageCEE').value = 'autres';
    }

    calc();
}

function toggleRevenus() {
    const body = document.getElementById('revenusBody');
    const arrow = document.getElementById('toggleArrow');
    if (body) body.classList.toggle('open');
    if (arrow) arrow.classList.toggle('open');
}

// ============================================
// CEE D√âTAIL ‚Äî BAR-TH-171 / 143 / 148
// (Source : fiche BAR-TH-171 vA78.4)
// ============================================
const CEE_PRICE = { tm: 12.5, autres: 7.5 }; // ‚Ç¨/MWhc

const BAR143 = { H1: 134800, H2: 121000, H3: 100500 };

// BAR-TH-148 v.A73.3 ‚Äî Forfaits officiels (√† compter du 01/11/2025)
const BAR148 = { maison: 14700, appartement: 11800 };

const BAR171 = {
    maison: {
        base: { lt140: 90900, ge140: 109200 },
        coefSurface: (S) => (S < 70 ? 0.5 : (S < 90 ? 0.7 : 1.0)),
        tranches: "Maison : S<70‚Üí0,5 ¬∑ 70‚â§S<90‚Üí0,7 ¬∑ S‚â•90‚Üí1"
    },
    appartement: {
        base: { lt140: 48700, ge140: 58900 },
        coefSurface: (S) => (S < 35 ? 0.5 : (S < 60 ? 0.7 : 1.0)),
        tranches: "Appart : S<35‚Üí0,5 ¬∑ 35‚â§S<60‚Üí0,7 ¬∑ S‚â•60‚Üí1"
    },
    coefZone: { H1: 1.2, H2: 1.0, H3: 0.7 }
};


// Surface dropdown ‚Üí cat√©gorie pour table CEE (maison: les 5 anciennes cat√©gories)
function surfaceToCategory(surfaceVal) {
    // surfaceVal comes from the dropdown: "S<70", "70<=S<90", "S>=90" (maison) or "S<35", "35<=S<60", "S>=60" (appart)
    // Map to table CEE keys
    const map = {
        'S<70': 'S<70', '70<=S<90': '70<S<90', 'S>=90': '90<S<110',
        'S<35': 'S<70', '35<=S<60': '70<S<90', 'S>=60': '90<S<110'
    };
    return map[surfaceVal] || '90<S<110';
}

function getSurfaceLabel() {
    const sel = document.getElementById('surface');
    return sel.options[sel.selectedIndex].text;
}

// Surface coef from dropdown value (BAR-TH-171 officiel)
function getSurfaceCoef(surfaceVal) {
    const map = { 'S<70': 0.5, '70<=S<90': 0.7, 'S>=90': 1, 'S<35': 0.5, '35<=S<60': 0.7, 'S>=60': 1 };
    return map[surfaceVal] || 1;
}

// Dynamic surface options based on type logement
function updateSurfaceOptions() {
    const tl = document.getElementById('typeLogement').value;
    const sel = document.getElementById('surface');
    const oldCoef = getSurfaceCoef(sel.value); // preserve coef level
    sel.innerHTML = '';
    if (tl === 'maison') {
        sel.add(new Option('S < 70 m¬≤', 'S<70'));
        sel.add(new Option('70 ‚â§ S < 90 m¬≤', '70<=S<90'));
        sel.add(new Option('S ‚â• 90 m¬≤', 'S>=90'));
    } else {
        sel.add(new Option('S < 35 m¬≤', 'S<35'));
        sel.add(new Option('35 ‚â§ S < 60 m¬≤', '35<=S<60'));
        sel.add(new Option('S ‚â• 60 m¬≤', 'S>=60'));
    }
    // Set option with same coef level
    const coefToMaison = { 0.5: 'S<70', 0.7: '70<=S<90', 1: 'S>=90' };
    const coefToAppart = { 0.5: 'S<35', 0.7: '35<=S<60', 1: 'S>=60' };
    const targetMap = tl === 'maison' ? coefToMaison : coefToAppart;
    sel.value = targetMap[oldCoef] || sel.options[sel.options.length - 1].value;
}

function onTypeLogementChange() {
    updateSurfaceOptions();
    calc();
}

function onScenarioChange() {
    calc();
}

let _calcRunning = false;

let lastCEEDetailPrime = 0;
let lastCEEDetailKwhc = 0;

function toggleCEE() {
    const body = document.getElementById('ceeBody');
    const arrow = document.getElementById('ceeToggleArrow');
    if (body) body.classList.toggle('open');
    if (arrow) arrow.classList.toggle('open');
}

// Quelle(s) fiche(s) BAR-TH s'appliquent selon le sc√©nario
// Depuis 01/01/2026 : BAR-TH-148 NON cumulable avec BAR-TH-171 (arr√™t√© 15/12/2025)
function getCEEFiches(scenario) {
    switch(scenario) {
        case 'PAC':                    return ['171'];
        case 'PAC + BALLON √âLECTRIQUE': return ['171'];
        case 'PAC + BALLON THERMO':     return ['171']; // 148 non cumulable depuis 01/2026
        case 'PAC + SSC':              return ['143'];
        default:                        return ['171'];
    }
}

function calcCEEDetail() {
  try {
    const sc = document.getElementById('scenario').value;
    const zn = document.getElementById('zone').value;
    const menage = document.getElementById('menageCEE').value;
    const price = CEE_PRICE[menage] || CEE_PRICE.autres;
    const tl = document.getElementById('typeLogement').value;
    const surfaceVal = document.getElementById('surface').value;
    const coefS = getSurfaceCoef(surfaceVal);

    const fiches = getCEEFiches(sc);

    // Labels
    document.getElementById('ceeScenarioLabel').textContent = SCENARIO_NAMES[sc] || sc;
    document.getElementById('ceeFichesLabel').textContent = fiches.map(f => 'BAR-TH-' + f).join(' + ');
    const noteEl = document.getElementById('ceeNonCumulNote');
    if (noteEl) {
        if (sc === 'PAC + BALLON THERMO') {
            noteEl.style.display = 'inline';
            noteEl.textContent = '‚ö† BAR-TH-148 non cumulable avec 171 depuis 01/2026';
        } else {
            noteEl.style.display = 'none';
        }
    }

    // Show/hide blocs
    document.getElementById('ceeBloc171').classList.toggle('cee-hidden', !fiches.includes('171'));
    document.getElementById('ceeBloc148').classList.toggle('cee-hidden', !fiches.includes('148'));
    document.getElementById('ceeBloc143').classList.toggle('cee-hidden', !fiches.includes('143'));

    let totalKwhc = 0;
    let details = [];
    let statusParts = [];

    // === BAR-TH-171 ===
    if (fiches.includes('171')) {
        const etasKey = document.getElementById('etas').value === '111-140' ? 'lt140' : 'ge140';
        const base = BAR171[tl].base[etasKey];
        const cz = BAR171.coefZone[zn];
        document.getElementById('ceeCoefSurface').value = coefS.toString().replace('.', ',');
        const CDP = 5; // Coup de pouce Chauffage √ó5 (arr√™t√© 74e, oct 2025)
        const kwhc171 = base * coefS * cz * CDP;
        totalKwhc += kwhc171;
        details.push(`171: ${fmtIntCEE(kwhc171)}`);
        statusParts.push(`‚úÖ 171: base ${fmtIntCEE(base)} √ó coef ${coefS} √ó zone ${cz} √ó CdP √ó${CDP}`);
    }

    // === BAR-TH-148 ===
    if (fiches.includes('148')) {
        const kwhc148 = BAR148[tl] || 14700;
        totalKwhc += kwhc148;
        details.push(`148: ${fmtIntCEE(kwhc148)}`);
        const typeLabel = tl === 'maison' ? 'Maison' : 'Appart';
        document.getElementById('cee148Forfait').value = `${fmtIntCEE(kwhc148)} kWhc (${typeLabel})`;
        const prime148 = (kwhc148 / 1000) * price;
        document.getElementById('ceeOut148').textContent = fmtEurCEE(prime148);
        document.getElementById('ceeOut148Detail').textContent = `${fmtIntCEE(kwhc148)} kWhc`;
        document.getElementById('ceeKpi148').style.display = 'block';
        statusParts.push(`‚úÖ 148: ${fmtIntCEE(kwhc148)} kWhc (v.A73.3 ¬∑ ${typeLabel})`);
    } else {
        document.getElementById('ceeKpi148').style.display = 'none';
    }

    // === BAR-TH-143 ===
    if (fiches.includes('143')) {
        const CDP143 = 2; // Coup de pouce Chauffage √ó2 (arr√™t√© 27/12/2025, depuis 01/2026)
        const kwhc143 = BAR143[zn] * CDP143;
        totalKwhc += kwhc143;
        details.push(`143: ${fmtIntCEE(kwhc143)}`);
        document.getElementById('cee143Forfait').value = `${fmtIntCEE(BAR143[zn])} √ó ${CDP143} = ${fmtIntCEE(kwhc143)} kWhc (${zn})`;
        document.getElementById('ceeCoefSurface').value = '‚Äî';
        statusParts.push(`‚úÖ 143: forfait ${zn} ${fmtIntCEE(BAR143[zn])} √ó CdP √ó${CDP143} = ${fmtIntCEE(kwhc143)} kWhc`);
    }

    const primeCEE = (totalKwhc / 1000) * price;
    lastCEEDetailPrime = primeCEE;
    lastCEEDetailKwhc = totalKwhc;

    document.getElementById('ceeOutKwhc').textContent = `${fmtIntCEE(totalKwhc)} kWhc`;
    document.getElementById('ceeOutDetail').textContent = details.join(' + ');
    document.getElementById('ceeOutPrime').textContent = fmtEurCEE(primeCEE);
    document.getElementById('ceeOutPrix').textContent = `${price.toString().replace('.', ',')} ‚Ç¨/MWhc ¬∑ ${menage === 'tm' ? 'Tr√®s modestes' : 'Autres'}`;

    const resultEl = document.getElementById('ceeResult');
    if (statusParts.length > 0) {
        resultEl.className = 'cee-result show';
        resultEl.innerHTML = statusParts.join('<br>');
    } else {
        resultEl.className = 'cee-result';
    }

  } catch(e) {
    console.error('calcCEEDetail() error:', e);
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = '‚ö† CEEDetail: ' + e.message; errDiv.style.display = 'block'; errDiv.style.color = '#dc2626'; errDiv.style.background = '#fef2f2'; }
  }
}

function fmtIntCEE(n) {
    return isFinite(n) ? Math.round(n).toLocaleString('fr-FR') : '‚Äî';
}
function fmtEurCEE(n) {
    return isFinite(n) ? Math.round(n).toLocaleString('fr-FR') + ' ‚Ç¨' : '‚Äî';
}

// ============================================
// DONN√âES PRINCIPALES
// ============================================
const D={TTC:{"PAC":10890,"PAC + BALLON √âLECTRIQUE":13750,"PAC + BALLON THERMO":13750,"PAC + SSC":25850},MPR:{"PAC":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON √âLECTRIQUE":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON THERMO":{BLEU:6200,JAUNE:4800,VIOLET:3400,ROSE:0},"PAC + SSC":{BLEU:15000,JAUNE:12000,VIOLET:7000,ROSE:0}},COUT:{"PAC":6200,"PAC + BALLON √âLECTRIQUE":6400,"PAC + BALLON THERMO":7300,"PAC + SSC":11700},COUT_DETAIL:{"PAC":{pac_materiel:2900,pac_pose:2500,ballon_materiel:0,ballon_pose:0,accessoires:500,admin:300},"PAC + BALLON √âLECTRIQUE":{pac_materiel:2900,pac_pose:2500,ballon_materiel:200,ballon_pose:0,accessoires:500,admin:300},"PAC + BALLON THERMO":{pac_materiel:2900,pac_pose:2500,ballon_materiel:1100,ballon_pose:500,accessoires:500,admin:300},"PAC + SSC":{pac_materiel:2900,pac_pose:2500,ballon_materiel:3200,ballon_pose:2300,accessoires:500,admin:300}},CEE:{"140-170":{H1:{PAC:{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON ELECTRIQUE":{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON THERMO":{"S<70":289500,"70<S<90":399420,"90<S<110":564300,"110<S<130":619260,"S>130":894060},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON ELECTRIQUE":{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON THERMO":{"S<70":243700,"70<S<90":335300,"90<S<110":472700,"110<S<130":518500,"S>130":747500},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON ELECTRIQUE":{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON THERMO":{"S<70":175000,"70<S<90":239120,"90<S<110":335300,"110<S<130":367360,"S>130":527660},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}},"111-140":{H1:{PAC:{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON ELECTRIQUE":{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON THERMO":{"S<70":253200,"70<S<90":348600,"90<S<110":491700,"110<S<130":539400,"S>130":777900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON ELECTRIQUE":{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON THERMO":{"S<70":213450,"70<S<90":292950,"90<S<110":412200,"110<S<130":451950,"S>130":650700},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON ELECTRIQUE":{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON THERMO":{"S<70":153825,"70<S<90":209475,"90<S<110":292950,"110<S<130":320775,"S>130":459900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}}}};
const M={"PAC":"PAC","PAC + BALLON √âLECTRIQUE":"BALLON ELECTRIQUE","PAC + BALLON THERMO":"BALLON THERMO","PAC + SSC":"BALLON SSC"};

const SCENARIO_NAMES = {"PAC":"PAC","PAC + BALLON √âLECTRIQUE":"PAC + Ballon √âlectrique","PAC + BALLON THERMO":"PAC + Ballon Thermo","PAC + SSC":"PAC + SSC"};

function getCEE(et, zn, cs, sf){
    if(!D.CEE[et]) return 0;
    if(!D.CEE[et][zn]) return 0;
    if(!D.CEE[et][zn][cs]) return 0;
    if(!D.CEE[et][zn][cs][sf]) return 0;
    return D.CEE[et][zn][cs][sf];
}

let mode=0;

function checkStoredMode(){
    const stored = localStorage.getItem('fournisseurAuth');
    if(stored){
        const data = JSON.parse(stored);
        const now = new Date().getTime();
        if(now - data.timestamp < 24 * 60 * 60 * 1000){
            mode = 1;
            document.getElementById('mainContent').classList.add('fournisseur-mode');
            document.getElementById('lockIcon').textContent='üîì';
            return true;
        } else {
            localStorage.removeItem('fournisseurAuth');
        }
    }
    return false;
}

function saveMode(){
    localStorage.setItem('fournisseurAuth', JSON.stringify({ timestamp: new Date().getTime() }));
}

function clearMode(){
    localStorage.removeItem('fournisseurAuth');
}

function fmt(n){
    return Math.round(n).toLocaleString('fr-FR')+' ‚Ç¨';
}

function updateFromTTC(){
    document.getElementById('lockTTC').checked=false;
    calc();
}

function updateFromDetail(){
    document.getElementById('lockCoutHT').checked=false;
    
    const fields = [
        ['coutPACMateriel','qtePACMateriel','totalPACMateriel'],
        ['coutPACPose','qtePACPose','totalPACPose'],
        ['coutBallonMateriel','qteBallonMateriel','totalBallonMateriel'],
        ['coutBallonPose','qteBallonPose','totalBallonPose'],
        ['coutAccessoires','qteAccessoires','totalAccessoires'],
        ['coutAdmin','qteAdmin','totalAdmin']
    ];
    
    let totalGlobal = 0;
    fields.forEach(([cId, qId, tId]) => {
        const c = parseFloat(document.getElementById(cId).value) || 0;
        const q = parseFloat(document.getElementById(qId).value) || 0;
        const t = c * q;
        document.getElementById(tId).textContent = fmt(t);
        totalGlobal += t;
    });
    
    document.getElementById('coutTotalHTDisplay').textContent = fmt(totalGlobal);
    calc();
}

function calc(){
  try {
    _calcRunning = true;
    
    // Always recalculate CEE detail first (updates lastCEEDetailPrime)
    calcCEEDetail();
    
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    // Check if CEE override is active
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        if(lockTTC){
            tt = D.TTC[sc] || 0;
            document.getElementById('totalTTCInput').value=tt;
        }else{
            tt=parseFloat(document.getElementById('totalTTCInput').value)||0;
        }
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                document.getElementById('coutPACMateriel').value = detail.pac_materiel;
                document.getElementById('qtePACMateriel').value = 1;
                document.getElementById('totalPACMateriel').textContent = fmt(detail.pac_materiel);
                document.getElementById('coutPACPose').value = detail.pac_pose;
                document.getElementById('qtePACPose').value = 1;
                document.getElementById('totalPACPose').textContent = fmt(detail.pac_pose);
                document.getElementById('coutBallonMateriel').value = detail.ballon_materiel;
                document.getElementById('qteBallonMateriel').value = detail.ballon_materiel > 0 ? 1 : 0;
                document.getElementById('totalBallonMateriel').textContent = fmt(detail.ballon_materiel);
                document.getElementById('coutBallonPose').value = detail.ballon_pose;
                document.getElementById('qteBallonPose').value = detail.ballon_pose > 0 ? 1 : 0;
                document.getElementById('totalBallonPose').textContent = fmt(detail.ballon_pose);
                document.getElementById('coutAccessoires').value = detail.accessoires;
                document.getElementById('qteAccessoires').value = 1;
                document.getElementById('totalAccessoires').textContent = fmt(detail.accessoires);
                document.getElementById('coutAdmin').value = detail.admin;
                document.getElementById('qteAdmin').value = 1;
                document.getElementById('totalAdmin').textContent = fmt(detail.admin);
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin;
            }else{
                ch = D.COUT[sc] || 0;
            }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
        }
        document.getElementById('coutTotalHTDisplay').textContent = fmt(ch);
    }else{
        ch=D.COUT[sc]||0;
    }
    
    let ce;
    let ceForMarge, taForMarge;
    
    // Always use detailed CEE calculation (with Coup de pouce)
    ce = lastCEEDetailPrime;
    ceForMarge = ce;
    taForMarge = ad + ceForMarge;
    
    if(mode){
        // Sync prixCumac with m√©nage CEE category
        const menageVal = document.getElementById('menageCEE').value;
        const pxAuto = (menageVal === 'tm') ? 12.5 : 7.5;
        document.getElementById('prixCumac').value = pxAuto;
        document.getElementById('kwhCumac').value=Math.round(lastCEEDetailKwhc).toLocaleString('fr-FR');
    }
    
    const ceDisplay = ce;
    const ceeSourceText = getCEEFiches(sc).map(f => 'BAR-TH-' + f).join(' + ') + ' d√©taill√©';
    
    const ta=ad+ceDisplay;
    const rb=tt-ta;
    
    document.getElementById('totalTTC').textContent=fmt(tt);
    document.getElementById('aidesMPR').textContent=fmt(ad);
    document.getElementById('aidesCEE').textContent=fmt(ceDisplay);
    document.getElementById('totalAides').textContent=fmt(ta);
    document.getElementById('ceeSourceLabel').textContent=ceeSourceText;
    
    if(mode) document.getElementById('displayCoutHT').textContent=fmt(ch);
    
    const st=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const ct2=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zn2=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const et2=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const sf2=getSurfaceLabel();
    const colorClass=ct==='BLEU'?'color-bleu':(ct==='JAUNE'?'color-jaune':(ct==='VIOLET'?'color-violet':'color-rose'));
    const borderColor=ct==='BLEU'?'#0071e3':(ct==='JAUNE'?'#fbbf24':(ct==='VIOLET'?'#8b5cf6':'#ec4899'));
    
    document.getElementById('scenarioSummary').innerHTML=`<strong class="${colorClass}">${st}</strong><span class="separator">‚Ä¢</span>${ct2}<span class="separator">‚Ä¢</span>Zone ${zn2}<span class="separator">‚Ä¢</span>${sf2}<span class="separator">‚Ä¢</span>${et2}`;
    document.getElementById('scenarioSummary').style.borderLeftColor=borderColor;
    
    calcRAC(rb,ch,ta,taForMarge,tt);
    
    _calcRunning = false;
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = ''; errDiv.style.display = 'none'; }
  } catch(e) {
    _calcRunning = false;
    console.error('calc() error:', e);
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = '‚ö† calc(): ' + e.message; errDiv.style.display = 'block'; errDiv.style.color = '#dc2626'; errDiv.style.background = '#fef2f2'; }
  }
}

function calcRAC(rb,ch,ta,taForMarge,tt){
    const po=parseFloat(document.getElementById('racPourcent').value)||0;
    const mo=parseFloat(document.getElementById('racOffert').value)||0;
    const rc=rb-mo;
    document.getElementById('resteCharge').textContent=fmt(rc);
    
    const rbForMarge = tt - taForMarge;
    const rcForMarge = rbForMarge - mo;
    const vhForMarge = Math.max(0,rcForMarge)/1.055;
    const mgForMarge = vhForMarge - ch + taForMarge;
    
    if(mode){
        document.getElementById('margeFinal').textContent=fmt(mgForMarge);
    }
    
    const currentScenario = document.getElementById('scenario').value;
    const seuilOK = (currentScenario === 'PAC + SSC') ? 6000 : 4000;
    const seuilWarning = (currentScenario === 'PAC + SSC') ? 3000 : 2000;
    
    const bd=document.getElementById('statusBadge');
    if(mgForMarge>=seuilOK){
        bd.className='status-badge ok';
        bd.textContent='DOSSIER OK'
    }else if(mgForMarge>=seuilWarning){
        bd.className='status-badge warning';
        bd.textContent='DOSSIER √Ä AM√âLIORER'
    }else{
        bd.className='status-badge danger';
        bd.textContent='DOSSIER REFUS√â'
    }
}

function updatePct(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        tt = lockTTC ? (D.TTC[sc] || 0) : (parseFloat(document.getElementById('totalTTCInput').value)||0);
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin;
            }else{ ch = D.COUT[sc] || 0; }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
        }
    }else{ ch=D.COUT[sc]||0; }
    
    let ce = lastCEEDetailPrime;
    let ceForMarge = ce;
    let taForMarge = ad + ceForMarge;
    
    const ta=ad+ce;
    const rb=tt-ta;
    
    let po=parseFloat(document.getElementById('racPourcent').value)||0;
    if(po>100)po=100; if(po<0)po=0;
    document.getElementById('racPourcent').value=Math.round(po);
    const mo=Math.round(rb*(po/100));
    document.getElementById('racOffert').value=mo;
    
    calcRAC(rb,ch,ta,taForMarge,tt);
}

function updateAmt(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        tt = lockTTC ? (D.TTC[sc] || 0) : (parseFloat(document.getElementById('totalTTCInput').value)||0);
    }else{ tt=D.TTC[sc]||0; }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin;
            }else{ ch = D.COUT[sc] || 0; }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
        }
    }else{ ch=D.COUT[sc]||0; }
    
    let ce = lastCEEDetailPrime;
    let ceForMarge = ce;
    let taForMarge = ad + ceForMarge;
    
    const ta=ad+ce;
    const rb=tt-ta;
    
    let mo=parseFloat(document.getElementById('racOffert').value)||0;
    if(mo>rb)mo=rb; if(mo<0)mo=0;
    document.getElementById('racOffert').value=Math.round(mo);
    let po=rb>0?Math.round((mo/rb)*100):0;
    if(po>100)po=100; if(po<0)po=0;
    document.getElementById('racPourcent').value=po;
    
    calcRAC(rb,ch,ta,taForMarge,tt);
}

function reset(){
    document.getElementById('scenario').value='PAC';
    document.getElementById('categorie').value='BLEU';
    document.getElementById('zone').value='H1';
    document.getElementById('etas').value='140-170';
    document.getElementById('surface').value='S>=90';
    document.getElementById('typeLogement').value='maison';
    updateSurfaceOptions();
    document.getElementById('racPourcent').value=0;
    document.getElementById('racOffert').value=0;
    if(mode){
        document.getElementById('prixCumac').value=12.5;
    }
    calc();
}

function checkExport(){
    const nom=document.getElementById('nom').value.trim();
    const prenom=document.getElementById('prenom').value.trim();
    const btn=document.getElementById('exportBtn');
    const wBtn=document.getElementById('whatsappBtn');
    if(nom&&prenom){
        btn.disabled=false; btn.style.cursor='pointer'; btn.style.opacity='1';
        wBtn.disabled=false; wBtn.style.cursor='pointer'; wBtn.style.opacity='1';
    }else{
        btn.disabled=true; btn.style.cursor='not-allowed'; btn.style.opacity='0.5';
        wBtn.disabled=true; wBtn.style.cursor='not-allowed'; wBtn.style.opacity='0.5';
    }
}

function sendWhatsApp(){
    const nom=document.getElementById('nom').value.trim();
    const prenom=document.getElementById('prenom').value.trim();
    if(!nom||!prenom){ alert('Veuillez renseigner le nom et le pr√©nom du client'); return; }
    const scenario=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const categorie=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zone=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const etas=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const surface=getSurfaceLabel();
    const ttc=document.getElementById('totalTTC').textContent;
    const aidesMPR=document.getElementById('aidesMPR').textContent;
    const aidesCEE=document.getElementById('aidesCEE').textContent;
    const totalAides=document.getElementById('totalAides').textContent;
    const rac=document.getElementById('resteCharge').textContent;
    const message=`üè† *Demande de devis - Les Artisans Verts*%0A%0Aüë§ *Client :* ${prenom} ${nom}%0A%0Aüìã *Configuration :*%0A‚Ä¢ Sc√©nario : ${scenario}%0A‚Ä¢ ${categorie}%0A‚Ä¢ ${zone}%0A‚Ä¢ ${surface}%0A‚Ä¢ ${etas}%0A%0Aüí∞ *Montants :*%0A‚Ä¢ Total TTC : ${ttc}%0A‚Ä¢ Aides MPR : ${aidesMPR}%0A‚Ä¢ Aides CEE : ${aidesCEE}%0A‚Ä¢ Total aides : ${totalAides}%0A‚Ä¢ Reste √† charge : ${rac}%0A%0AJe souhaite obtenir un devis d√©taill√©.`;
    window.open(`https://api.whatsapp.com/send?text=${message}`, '_blank');
}

function exportPDF(){
    const nom=document.getElementById('nom').value.trim();
    const prenom=document.getElementById('prenom').value.trim();
    if(!nom||!prenom){ alert('Veuillez renseigner le nom et le pr√©nom du client'); return; }
    document.getElementById('printTitle').textContent=`Dossier ‚Äî ${prenom} ${nom}`;
    document.getElementById('printDate').textContent=`Date: ${new Date().toLocaleDateString('fr-FR')}`;
    document.getElementById('printScenario').textContent=document.getElementById('scenarioSummary').textContent;
    document.getElementById('printTTC').textContent=document.getElementById('totalTTC').textContent;
    document.getElementById('printMPR').textContent=document.getElementById('aidesMPR').textContent;
    document.getElementById('printCEE').textContent=document.getElementById('aidesCEE').textContent;
    document.getElementById('printTotalAides').textContent=document.getElementById('totalAides').textContent;
    document.getElementById('printPct').textContent=document.getElementById('racPourcent').value;
    document.getElementById('printOffert').textContent=document.getElementById('racOffert').value+' ‚Ç¨';
    document.getElementById('printRAC').textContent=document.getElementById('resteCharge').textContent;
    const badge=document.getElementById('statusBadge');
    const printStatus=document.getElementById('printStatus');
    printStatus.textContent=badge.textContent;
    if(badge.classList.contains('ok')){ printStatus.style.background='#d1f4e0'; printStatus.style.color='#0d7f3f'; }
    else if(badge.classList.contains('warning')){ printStatus.style.background='#fff3cd'; printStatus.style.color='#856404'; }
    else{ printStatus.style.background='#f8d7da'; printStatus.style.color='#721c24'; }
    window.print();
}

// ============================================
// AUTHENTIFICATION
// ============================================
document.getElementById('lockBtn').onclick=function(){
    if(!mode){
        const stored = localStorage.getItem('fournisseurAuth');
        if(stored){
            const data = JSON.parse(stored);
            const now = new Date().getTime();
            if(now - data.timestamp < 24 * 60 * 60 * 1000){
                mode=1; document.getElementById('mainContent').classList.add('fournisseur-mode');
                document.getElementById('lockIcon').textContent='üîì'; calc(); return;
            }
        }
        document.getElementById('passwordModal').classList.add('active');
    }else{
        mode=0; document.getElementById('mainContent').classList.remove('fournisseur-mode');
        document.getElementById('lockIcon').textContent='üîí'; calc();
    }
};

document.getElementById('exportBtn').onclick=exportPDF;
document.getElementById('whatsappBtn').onclick=sendWhatsApp;

document.getElementById('unlockBtn').onclick=function(){
    const pw=document.getElementById('passwordInput').value;
    if(pw==='gamberge'||pw==='lav'){
        mode=1; saveMode();
        document.getElementById('mainContent').classList.add('fournisseur-mode');
        document.getElementById('passwordModal').classList.remove('active');
        document.getElementById('passwordInput').value='';
        document.getElementById('lockIcon').textContent='üîì'; calc();
    }else{ alert('Mot de passe incorrect'); }
};

document.getElementById('passwordModal').onclick=function(e){
    if(e.target.id==='passwordModal') document.getElementById('passwordModal').classList.remove('active');
};


// ============================================
// SCROLL GRADIENT
// ============================================
(function() {
    const gradients = [
        'linear-gradient(90deg, #34d399, #22d3ee, #818cf8)',
        'linear-gradient(90deg, #22d3ee, #818cf8, #c084fc)',
        'linear-gradient(90deg, #818cf8, #c084fc, #f472b6)',
        'linear-gradient(90deg, #c084fc, #f472b6, #fb923c)',
        'linear-gradient(90deg, #f472b6, #fb923c, #fbbf24)',
        'linear-gradient(90deg, #fb923c, #fbbf24, #34d399)',
    ];
    let ticking = false;
    function updateScrollGradient() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = docHeight > 0 ? scrollTop / docHeight : 0;
        const idx = Math.min(Math.floor(scrollPercent * gradients.length), gradients.length - 1);
        document.documentElement.style.setProperty('--scroll-gradient', gradients[idx]);
        ticking = false;
    }
    window.addEventListener('scroll', function() {
        if (!ticking) { requestAnimationFrame(updateScrollGradient); ticking = true; }
    }, { passive: true });
    updateScrollGradient();
})();

// ============================================
// DIMENSIONNEMENT PAC
// ============================================

// Tbase par d√©partement (¬∞C) - valeurs conventionnelles
const DEPT_TBASE = {
    '01':-10,'02':-9,'03':-8,'04':-8,'05':-10,'06':-5,'07':-6,'08':-10,'09':-8,'10':-10,
    '11':-5,'12':-8,'13':-5,'14':-7,'15':-10,'16':-5,'17':-5,'18':-8,'19':-8,'20':-2,
    '2A':-2,'2B':-2,'21':-10,'22':-4,'23':-8,'24':-5,'25':-12,'26':-6,'27':-7,'28':-7,
    '29':-4,'30':-5,'31':-5,'32':-5,'33':-5,'34':-5,'35':-5,'36':-7,'37':-7,'38':-10,
    '39':-10,'40':-5,'41':-7,'42':-8,'43':-10,'44':-5,'45':-7,'46':-5,'47':-5,'48':-10,
    '49':-5,'50':-5,'51':-10,'52':-10,'53':-5,'54':-12,'55':-10,'56':-4,'57':-12,'58':-10,
    '59':-9,'60':-7,'61':-7,'62':-9,'63':-8,'64':-5,'65':-5,'66':-5,'67':-12,'68':-12,
    '69':-8,'70':-12,'71':-10,'72':-7,'73':-12,'74':-12,'75':-7,'76':-7,'77':-7,'78':-7,
    '79':-5,'80':-9,'81':-5,'82':-5,'83':-3,'84':-6,'85':-5,'86':-5,'87':-8,'88':-12,
    '89':-10,'90':-12,'91':-7,'92':-7,'93':-7,'94':-7,'95':-7
};

let currentG = 0.95;

// ============ DIMENSIONNEMENT ‚Äî Ann√©e ‚Üí G auto ============

// Table G par ann√©e de construction
function getGFromAnnee(annee) {
    if (annee >= 2021) return 0.6;   // RE 2020
    if (annee >= 2013) return 0.7;   // RT 2012
    if (annee >= 2006) return 0.75;  // RT 2005
    if (annee >= 2001) return 0.8;
    if (annee >= 1990) return 0.95;  // RT 2000
    if (annee >= 1983) return 1.1;
    if (annee >= 1975) return 1.3;   // 1√®re r√©glementation
    return 1.6;                       // Avant 1975
}

let currentIsolation = 'origine';

function selectIsolation(state) {
    currentIsolation = state;
    document.querySelectorAll('#gCoefOptions .g-radio').forEach(el => {
        const val = el.querySelector('input').value;
        el.classList.toggle('selected', val === state);
        if (val === state) el.querySelector('input').checked = true;
    });
    calcDim();
}

function getEffectiveG() {
    const annee = parseInt(document.getElementById('dimAnnee').value) || 2000;
    let g = getGFromAnnee(annee);
    if (currentIsolation === 'partielle') g = Math.max(g - 0.2, 0.5);
    if (currentIsolation === 'totale') g = Math.max(Math.min(g, 0.7), 0.5);
    return g;
}

function updateConfort() {
    const val = parseInt(document.getElementById('dimConfort').value);
    document.getElementById('confortPct').textContent = val + '%';
    let name, desc;
    if (val <= 75) { name = '√âCONOMIE'; desc = 'Dimensionnement r√©duit, couverture minimale.'; }
    else if (val <= 115) { name = 'STANDARD'; desc = 'Le choix recommand√© pour un confort √©quilibr√©.'; }
    else { name = 'CONFORT +'; desc = 'Surdimensionnement pour un confort maximal.'; }
    document.getElementById('confortName').textContent = name;
    document.getElementById('confortDesc').textContent = desc;
    // Map confort to T1 (taux PAC seule): 60‚Üí40%, 100‚Üí60%, 140‚Üí80%
    const t1 = 40 + (val - 60) * (40 / 80); // linear 40..80
    document.getElementById('dimT1').value = Math.round(t1);
}

function selectG(g) { /* legacy compat */ currentG = g; calcDim(); }

function calcDim() {
    const S = parseFloat(document.getElementById('dimSurface').value) || 0;
    const H = parseFloat(document.getElementById('dimHauteur').value) || 2.5;
    const V = S * H;

    const Tbase = parseFloat(document.getElementById('dimTbase').value) || -7;
    const Tint = parseFloat(document.getElementById('dimTint').value) || 21;
    const deltaT = Tint - Tbase;

    const G = getEffectiveG();
    currentG = G;
    const gDisplay = document.getElementById('dimGDisplay');
    if (gDisplay) gDisplay.textContent = `G = ${G.toFixed(2).replace('.', ',')}`;

    const P = G * V * deltaT;
    const T1 = parseFloat(document.getElementById('dimT1').value) || 60;
    const T2 = parseFloat(document.getElementById('dimT2').value) || 140;

    const puissancePAC = P * T1 / 100;
    const puissanceTotale = P * T2 / 100;
    const puissanceAppoint = puissanceTotale - puissancePAC;

    document.getElementById('dimDeperditions').textContent = Math.round(P).toLocaleString('fr-FR') + ' W';
    document.getElementById('dimDepFormula').textContent = `${G.toFixed(2).replace('.', ',')} √ó ${Math.round(V)} √ó ${deltaT}`;

    document.getElementById('dimPuissancePAC').textContent = (puissancePAC / 1000).toFixed(1).replace('.', ',') + ' kW';
    document.getElementById('dimPuissancePACDetail').textContent = `${Math.round(P).toLocaleString('fr-FR')} W √ó ${T1}%`;

    document.getElementById('dimPuissanceAppoint').textContent = (puissanceAppoint / 1000).toFixed(1).replace('.', ',') + ' kW';
    document.getElementById('dimPuissanceAppointDetail').textContent = `(P √ó ${T2}% ‚àí PAC)`;

    document.getElementById('dimPuissanceTotale').textContent = (puissanceTotale / 1000).toFixed(1).replace('.', ',') + ' kW';
}

// ============================================
// INIT
// ============================================
checkStoredMode();
updateSurfaceOptions();
calc();
updateConfort();
calcDim();
</script>
</body>
</html>
