<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Aides PAC 2026</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        /* === BANDEAU INFO 2026 === */
        .info-banner-2026 {
            background: linear-gradient(135deg, #14532d 0%, #166534 50%, #15803d 100%);
            color: white;
            padding: 10px 20px;
            font-size: 13px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .info-banner-2026 strong { color: #86efac; }
        .info-banner-2026 .separator-dot { opacity: 0.4; margin: 0 4px; }

        /* === AUTO-DETECTION REVENUS === */
        .revenus-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .revenus-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .revenus-toggle h3 {
            font-size: 14px;
            font-weight: 600;
            color: #16a34a;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .revenus-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #16a34a;
        }
        .revenus-toggle .toggle-arrow.open { transform: rotate(180deg); }
        .revenus-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding-top: 0;
        }
        .revenus-body.open {
            max-height: 500px;
            padding-top: 14px;
        }
        .revenus-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .revenus-grid { grid-template-columns: 1fr; }
        }
        .revenus-grid label {
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 4px;
            display: block;
        }
        .revenus-grid select, .revenus-grid input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }
        .revenus-grid select:focus, .revenus-grid input:focus {
            border-color: #16a34a;
            outline: none;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }
        .profil-result {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: fadeSlide 0.3s ease;
        }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .profil-result.show { display: block; }
        .profil-result.profil-bleu {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .profil-result.profil-jaune {
            background: linear-gradient(135deg, #fef9c3, #fef08a);
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .profil-result.profil-violet {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            color: #5b21b6;
            border: 1px solid #c4b5fd;
        }
        .profil-result.profil-rose {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            color: #9d174d;
            border: 1px solid #f9a8d4;
        }

        /* === CEE DETAIL SECTION === */
        .cee-section {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #93c5fd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .cee-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .cee-toggle h3 {
            font-size: 14px;
            font-weight: 600;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .cee-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #2563eb;
        }
        .cee-toggle .toggle-arrow.open { transform: rotate(180deg); }
        .cee-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease, padding 0.3s ease;
            padding-top: 0;
        }
        .cee-body.open {
            max-height: 800px;
            padding-top: 14px;
        }
        .cee-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .cee-grid { grid-template-columns: 1fr; }
        }
        .cee-grid label {
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 4px;
            display: block;
        }
        .cee-grid select, .cee-grid input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }
        .cee-grid select:focus, .cee-grid input:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .cee-result {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            text-align: center;
            display: none;
            animation: fadeSlide 0.3s ease;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .cee-result.show { display: block; }
        .cee-hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        .cee-bloc-171, .cee-bloc-148 {
            transition: all 0.3s ease;
        }
        .cee-hidden { display: none !important; }

        /* Isolation state radio buttons */
        .g-radio {
            display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px;
            border: 1.5px solid #e2e8f0; border-radius: 10px; cursor: pointer;
            transition: all 0.15s ease; font-size: 13px; background: white;
        }
        .g-radio:hover { border-color: #a3cfbb; background: #f8fdfb; }
        .g-radio.selected { border-color: #16a34a; background: #f0fdf4; }
        .g-radio input[type="radio"] { accent-color: #16a34a; margin: 3px 0 0 0; width: 18px; height: 18px; flex-shrink: 0; }
        .g-label { flex: 1; }
        .g-label-title { font-weight: 600; color: #1d1d1f; font-size: 13px; }
        .g-label-sub { font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .g-value { display: none; }

        /* Dim form */
        .dim-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
        .dim-field label { font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; margin-bottom: 6px; }
        .dim-field .req { color: #dc2626; }
        .dim-field input, .dim-field select {
            width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px;
            font-size: 15px; font-weight: 500; color: #0f172a; background: white; transition: border-color 0.15s;
        }
        .dim-field input:focus, .dim-field select:focus { border-color: #16a34a; outline: none; box-shadow: 0 0 0 3px rgba(22,163,74,0.08); }
        .dim-field .dim-hint { font-size: 11px; color: #94a3b8; margin-top: 4px; }

        /* Confort slider */
        .confort-box { border: 1.5px solid #e2e8f0; border-radius: 10px; padding: 16px; }
        .confort-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .confort-val { font-size: 22px; font-weight: 700; color: #16a34a; }
        .confort-lbl { font-size: 14px; font-weight: 600; color: #334155; text-transform: uppercase; letter-spacing: 0.5px; }
        input.confort-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 4px; outline: none; margin: 8px 0; padding: 0; border: none;
            background: linear-gradient(to right, #fb923c, #16a34a 50%, #3b82f6); }
        input.confort-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 26px; height: 26px; border-radius: 50%; background: white; border: 3px solid #16a34a; cursor: pointer; box-shadow: 0 1px 6px rgba(0,0,0,0.15); }
        input.confort-slider::-moz-range-thumb { width: 26px; height: 26px; border-radius: 50%; background: white; border: 3px solid #16a34a; cursor: pointer; box-shadow: 0 1px 6px rgba(0,0,0,0.15); }
        .confort-labels { display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .confort-desc { font-size: 12px; color: #64748b; margin-top: 10px; font-style: italic; }

        /* Isolation checklist */
        .iso-check {
            display: flex; align-items: center; gap: 10px; padding: 10px 14px;
            border: 1.5px solid #e2e8f0; border-radius: 8px; cursor: pointer;
            transition: all 0.15s ease; background: white;
        }
        .iso-check:hover { border-color: #a3cfbb; background: #f8fdfb; }
        .iso-check:has(input:checked) { border-color: #16a34a; background: #f0fdf4; }
        .iso-check input[type="checkbox"] { accent-color: #16a34a; width: 18px; height: 18px; flex-shrink: 0; cursor: pointer; }
        .iso-info { flex: 1; }
        .iso-title { font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; }
        .iso-sub { font-size: 11px; color: #94a3b8; }
        .iso-quand {
            padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px;
            color: #64748b; background: #f8fafc; display: none; cursor: pointer;
        }
        .iso-check:has(input:checked) .iso-quand { display: block; }
        .cee-kpi-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        .cee-kpi {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 12px;
            text-align: center;
        }
        .cee-kpi .kpi-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .cee-kpi .kpi-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e40af;
        }
        .cee-kpi .kpi-value.green { color: #16a34a; }
        .cee-kpi .kpi-detail {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 2px;
            font-family: ui-monospace, monospace;
        }

        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }



        .btn-apply {
            flex: 1;
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-apply:hover {
            background: #0077ed;
        }

        .btn-close-modal {
            background: #f5f5f7;
            color: #1d1d1f;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-close-modal:hover {
            background: #e8e8ed;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 28px;
            padding: 30px 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #1d1d1f;
        }

        .form-group small {
            display: block;
            font-size: 12px;
            color: #86868b;
            margin-top: 4px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 4px rgba(0,113,227,0.1);
        }

        .fournisseur-only {
            display: none;
        }

        .fournisseur-mode .fournisseur-only {
            display: block;
        }
        
        .fournisseur-mode .ttc-readonly {
            display: none !important;
        }

        .client-only {
            display: block;
        }

        .fournisseur-mode .client-only {
            display: none;
        }

        .results-sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .summary-card {
            background: linear-gradient(165deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.05);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--scroll-gradient, linear-gradient(90deg, #34d399, #22d3ee, #818cf8));
            transition: background 0.4s ease;
        }

        .result-row-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }
        .result-row-card:hover {
            background: rgba(255,255,255,0.07);
            border-color: rgba(255,255,255,0.12);
            transform: translateY(-1px);
        }
        .result-row-card .rrc-label {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255,255,255,0.55);
            letter-spacing: 0.3px;
        }
        .result-row-card .rrc-value {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            font-variant-numeric: tabular-nums;
        }
        .result-row-card .rrc-value.green { color: #34d399; }
        .result-row-card .rrc-value.yellow { color: #fbbf24; }
        .result-row-card .rrc-value.red { color: #f87171; }
        .result-row-card .rrc-value.cyan { color: #22d3ee; }
        .result-row-card .rrc-value.blue { color: #60a5fa; }

        .result-highlight-card {
            background: linear-gradient(135deg, rgba(52,211,153,0.12) 0%, rgba(34,211,238,0.08) 100%);
            border: 1px solid rgba(52,211,153,0.2);
            border-radius: 14px;
            padding: 18px 22px;
            margin-bottom: 12px;
            text-align: center;
            position: relative;
        }
        .result-highlight-card .rhc-label {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .result-highlight-card .rhc-value {
            font-size: 34px;
            font-weight: 800;
            color: #34d399;
            text-shadow: 0 0 30px rgba(52,211,153,0.3);
        }

        .glow-separator {
            height: 2px;
            margin: 16px 0;
            border-radius: 2px;
            background: var(--scroll-gradient, linear-gradient(90deg, #34d399, #22d3ee, #818cf8));
            opacity: 0.4;
            transition: opacity 0.3s, background 0.6s;
        }
        .glow-separator:hover { opacity: 0.7; }

        .dark-section-title {
            font-size: 11px;
            font-weight: 700;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            padding-left: 2px;
        }

        .scenario-label-dark {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 18px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 3px solid #34d399;
            line-height: 1.5;
            transition: border-color 0.4s;
        }
        .scenario-label-dark strong { font-weight: 600; color: #f1f5f9; }
        .scenario-label-dark .separator { color: rgba(255,255,255,0.3); margin: 0 8px; }

        .rac-dark-section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px;
        }
        .rac-dark-section .amount-label {
            color: rgba(255,255,255,0.45);
        }
        .rac-dark-section input[type="number"] {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            color: #f1f5f9;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        .rac-dark-section input[type="number"]:focus {
            border-color: #34d399;
            box-shadow: 0 0 0 3px rgba(52,211,153,0.15);
            outline: none;
        }
        .rac-dark-section .note-small { color: rgba(255,255,255,0.35); }

        .ttc-input-dark {
            font-size: 24px;
            font-weight: 700;
            text-align: right;
            padding: 10px 14px;
            width: 100%;
            border: 2px solid rgba(96,165,250,0.4);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #f1f5f9;
            margin-bottom: 6px;
            transition: border-color 0.2s;
        }
        .ttc-input-dark:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 3px rgba(96,165,250,0.15);
            outline: none;
        }

        .btn-dark-export {
            width: 100%;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
            letter-spacing: 0.3px;
        }
        .btn-dark-export:hover {
            background: rgba(255,255,255,0.12);
            color: white;
            border-color: rgba(255,255,255,0.2);
        }
        .btn-dark-export.pdf { }
        .btn-dark-export.whatsapp { }

        .summary-header {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .scenario-label {
            font-size: 13px;
            color: #1d1d1f;
            margin-bottom: 20px;
            padding: 14px;
            background: #f5f5f7;
            border-radius: 8px;
            border-left: 4px solid #0071e3;
            line-height: 1.5;
        }
        
        .scenario-label strong {
            font-weight: 600;
        }
        
        .scenario-label .separator {
            color: #86868b;
            margin: 0 8px;
        }
        
        .color-bleu { color: #0071e3; }
        .color-jaune { color: #fbbf24; }
        .color-violet { color: #8b5cf6; }
        .color-rose { color: #ec4899; }

        .amount-row {
            margin-bottom: 12px;
        }

        .amount-label {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 4px;
        }

        .amount-value {
            font-size: 26px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .amount-value.highlight {
            color: #34c759;
        }

        .rac-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .rac-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .rac-item input {
            font-size: 22px;
            font-weight: 700;
            color: #1d1d1f;
            text-align: center;
            padding: 8px 10px;
        }

        .final-amount {
            text-align: right;
            padding-top: 20px;
            border-top: 2px solid #f5f5f7;
        }

        .final-amount .amount-label {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 6px;
        }

        .final-amount .amount-value {
            font-size: 34px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .status-badge {
            padding: 18px 24px;
            font-weight: 700;
            font-size: 15px;
            border-radius: 14px;
            text-align: center;
            width: 100%;
            letter-spacing: 0.3px;
            transition: all 0.3s;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .status-badge.ok {
            background: linear-gradient(135deg, #065f46, #059669);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.35);
        }
        .status-badge.ok:hover {
            box-shadow: 0 6px 28px rgba(5, 150, 105, 0.5);
            transform: translateY(-1px);
        }
        .status-badge.ok:active { transform: translateY(0); }
        .status-badge.danger {
            background: linear-gradient(135deg, #7f1d1d, #dc2626);
            color: white;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.25);
        }

        .btn-reset {
            background: #f5f5f7;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-reset:hover {
            background: #e8e8ed;
        }


        .footer {
            text-align: center;
            padding: 8px 20px 8px;
            color: #86868b;
            font-size: 13px;
        }

        @media print {
            .header, .user-bar, .btn-reset, .footer, .parameters-section, .main-content {
                display: none !important;
            }
            
            #printArea {
                display: block !important;
            }

            body {
                background: white;
            }

            @page {
                margin: 15mm;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .results-sidebar {
                position: static;
            }


        }

        .note-small {
            font-size: 11px;
            color: #86868b;
            text-align: center;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        /* LOGIN SCREEN */
        .login-container { display:flex; align-items:center; justify-content:center; min-height:100vh; background:linear-gradient(135deg, #0f172a 0%, #1e3a5f 40%, #134e4a 100%); }
        .login-box { background:white; padding:40px; border-radius:16px; width:360px; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .login-box h2 { text-align:center; margin:0 0 6px; font-size:20px; }
        .login-box h2 span { color:#16a34a; }
        .login-box .login-sub { text-align:center; color:#6b7280; font-size:13px; margin-bottom:24px; }
        .login-box .form-group { margin-bottom:16px; }
        .login-box .form-group label { display:block; font-size:13px; font-weight:600; color:#374151; margin-bottom:6px; }
        .login-box .form-group input { width:100%; padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; box-sizing:border-box; }
        .login-box .form-group input:focus { border-color:#16a34a; outline:none; box-shadow:0 0 0 3px rgba(22,163,74,0.15); }
        .login-box .btn-login { width:100%; padding:12px; background:linear-gradient(135deg,#16a34a,#15803d); color:white; border:none; border-radius:8px; font-size:15px; font-weight:700; cursor:pointer; }
        .login-box .btn-login:hover { opacity:0.9; }
        .login-error { color:#dc2626; text-align:center; margin-top:12px; font-size:13px; display:none; }
        .login-logo { text-align:center; margin-bottom:20px; }
        .login-logo span { background:linear-gradient(135deg,#16a34a,#15803d); color:white; padding:10px 18px; border-radius:10px; font-weight:700; font-size:14px; display:inline-block; }

        /* USER BAR */
        .user-bar { display:flex; align-items:center; gap:8px; }
        .user-bar .user-name { font-size:12px; color:#6b7280; font-weight:600; }
        .user-bar .user-role { font-size:10px; color:white; background:#16a34a; padding:1px 6px; border-radius:4px; font-weight:600; }
        .user-bar .btn-hist { padding:4px 10px; font-size:11px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:6px; cursor:pointer; font-weight:600; color:#374151; }
        .user-bar .btn-hist:hover { background:#e5e7eb; }
        .user-bar .btn-logout { padding:4px 10px; font-size:11px; background:#fef2f2; border:1px solid #fecaca; border-radius:6px; cursor:pointer; font-weight:600; color:#dc2626; }
        .user-bar .btn-logout:hover { background:#fee2e2; }
        .guest-bar { display:flex; align-items:center; gap:8px; }
        .guest-bar .btn-login-small { padding:6px 14px; font-size:12px; background:linear-gradient(135deg,#16a34a,#15803d); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; }

        /* VIEW TOGGLE SWITCH */
        .view-toggle { display:flex; align-items:center; gap:8px; background:#f3f4f6; border-radius:8px; padding:3px; }
        .view-toggle .toggle-opt { padding:5px 12px; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; color:#6b7280; transition:all 0.2s; border:none; background:none; }
        .view-toggle .toggle-opt.active { background:white; color:#1f2937; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .view-toggle .toggle-opt:hover:not(.active) { color:#374151; }

        /* HISTORY MODAL */
        .hist-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; }
        .hist-overlay.active { display:flex; }
        .hist-modal { background:white; border-radius:14px; width:90%; max-width:500px; max-height:80vh; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .hist-modal-header { padding:16px 20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
        .hist-modal-header h3 { margin:0; font-size:16px; }
        .hist-modal-close { background:none; border:none; font-size:22px; cursor:pointer; color:#6b7280; padding:0 4px; }
        .hist-modal-body { padding:16px 20px; overflow-y:auto; max-height:60vh; }
        .hist-entry { padding:10px 0; border-bottom:1px solid #f3f4f6; }
        .hist-entry:last-child { border-bottom:none; }
        .hist-meta { display:flex; gap:8px; align-items:center; margin-bottom:4px; }
        .hist-date { font-size:11px; color:#9ca3af; }
        .hist-user { font-size:11px; font-weight:700; color:#16a34a; }
        .hist-action { font-size:13px; color:#1f2937; }
        .hist-detail { font-size:11px; color:#6b7280; margin-top:2px; }
        .hist-empty { text-align:center; color:#9ca3af; padding:30px 0; }
        .hist-clear { margin-top:12px; text-align:center; }
        .hist-clear button { font-size:12px; color:#dc2626; background:none; border:1px solid #fecaca; padding:4px 12px; border-radius:6px; cursor:pointer; }

    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-container">
    <div class="login-box">
        <div class="login-logo"><span>üè† LES ARTISANS VERTS</span></div>
        <h2>Simulateur <span>PAC 2026</span></h2>
        <p class="login-sub">Connexion commerciale</p>
        <div class="form-group"><label>Nom d'utilisateur</label><input type="text" id="loginUser" placeholder="Utilisateur" autofocus></div>
        <div class="form-group"><label>Mot de passe</label><input type="password" id="loginPass" placeholder="Mot de passe"></div>
        <button class="btn-login" onclick="doLogin()">Se connecter</button>
        <p id="loginError" class="login-error"></p>
        <div style="margin-top:20px;padding-top:18px;border-top:1px solid #e5e7eb;text-align:center;">
            <p style="color:#9ca3af;font-size:12px;margin-bottom:10px;">Pas de compte ?</p>
            <button onclick="doGuestLogin()" style="width:100%;padding:11px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">üë§ Continuer en vue client</button>
        </div>
    </div>
</div>

<!-- HISTORY MODAL -->
<div id="historyModal" class="hist-overlay" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="hist-modal">
        <div class="hist-modal-header">
            <h3>üìã Journal des modifications</h3>
            <button class="hist-modal-close" onclick="document.getElementById('historyModal').classList.remove('active')">&times;</button>
        </div>
        <div class="hist-modal-body" id="historyBody"></div>
    </div>
</div>

<!-- PASSWORD CHANGE MODAL -->
<div id="pwdModal" class="hist-overlay" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="hist-modal" style="max-width:380px;">
        <div class="hist-modal-header">
            <h3>üîë Changer mon mot de passe</h3>
            <button class="hist-modal-close" onclick="document.getElementById('pwdModal').classList.remove('active')">&times;</button>
        </div>
        <div class="hist-modal-body">
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;">Ancien mot de passe</label>
                <input type="password" id="pwdOld" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;">Nouveau mot de passe</label>
                <input type="password" id="pwdNew" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;">Confirmer</label>
                <input type="password" id="pwdConfirm" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
            </div>
            <button onclick="doChangePassword()" style="width:100%;padding:12px;background:linear-gradient(135deg,#16a34a,#15803d);color:white;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;">Modifier</button>
            <p id="pwdError" style="color:#dc2626;text-align:center;margin-top:10px;font-size:13px;display:none;"></p>
            <p id="pwdSuccess" style="color:#16a34a;text-align:center;margin-top:10px;font-size:13px;display:none;"></p>
        </div>
    </div>
</div>

<!-- APP (hidden until login) -->
<div id="appScreen" style="display:none;">
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 12px 20px; border-radius: 10px; font-weight: 700; font-size: 15px; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);">
                        üè† LES ARTISANS VERTS
                    </div>
                    <h1 style="margin: 0; font-size: 22px;">Simulateur Aides PAC <span style="font-size: 14px; background: #16a34a; color: white; padding: 2px 8px; border-radius: 6px; vertical-align: middle; margin-left: 6px;">2026</span></h1>
                </div>
                <button class="btn-reset" onclick="reset()" style="padding: 8px 16px; font-size: 12px; width: auto;">‚Üª Reset</button>
                <!-- GUEST BAR (vue client sans compte) -->
                <div class="guest-bar" id="guestBar" style="display:none;">
                    <button class="btn-login-small" onclick="goToLogin()">üîë Se connecter</button>
                </div>
                <!-- USER BAR (commercial/admin connect√©) -->
                <div class="user-bar" id="userBar" style="display:none;">
                    <span class="user-name" id="userNameDisplay">‚Äî</span>
                    <span class="user-role" id="userRoleDisplay">‚Äî</span>
                    <div class="view-toggle" id="viewToggle">
                        <button class="toggle-opt active" id="togClient" onclick="switchView('client')">üë§ Client</button>
                        <button class="toggle-opt" id="togFournisseur" onclick="switchView('fournisseur')">üìä Fournisseur</button>
                    </div>
                    <button class="btn-hist" onclick="openHistory()">üìã</button>
                    <button class="btn-hist" onclick="openPwdModal()" title="Changer mot de passe">üîë</button>
                    <button class="btn-logout" onclick="doLogout()">‚Ü™</button>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="parameters-section">
            <div class="card">
                <h2 class="card-title">Param√®tres</h2>

                <!-- Info client -->
                <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">üë§ Informations client</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Nom</label>
                        <input type="text" id="nom" placeholder="Nom du client" oninput="checkExport()" onchange="logClientChange()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Pr√©nom</label>
                        <input type="text" id="prenom" placeholder="Pr√©nom du client" oninput="checkExport()" onchange="logClientChange()">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="departement">D√©partement</label>
                        <input type="text" id="departement" placeholder="Ex: 33, 75‚Ä¶" maxlength="3" style="text-align: center; font-weight: 600;" oninput="detectDept()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="rfr">Revenu fiscal de r√©f. (‚Ç¨)</label>
                        <input type="number" id="rfr" placeholder="Ex: 35 000" oninput="detectProfil()" style="font-weight: 600;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="nbPersonnes">Foyer</label>
                        <select id="nbPersonnes" onchange="detectProfil()">
                            <option value="1">1 personne</option>
                            <option value="2">2 personnes</option>
                            <option value="3">3 personnes</option>
                            <option value="4" selected>4 personnes</option>
                            <option value="5">5 personnes</option>
                            <option value="6">6 personnes</option>
                            <option value="7">7 personnes</option>
                            <option value="8">8 personnes</option>
                        </select>
                    </div>
                </div>

                <!-- Hidden: auto-g√©r√©s -->
                <select id="zone" onchange="calc()" style="display:none;">
                    <option value="H1">H1</option><option value="H2">H2</option><option value="H3">H3</option>
                </select>
                <span id="deptZoneResult" style="display:none;"></span>
                <select id="region" onchange="detectProfil()" style="display:none;">
                    <option value="PROVINCE">Province</option><option value="IDF">IDF</option>
                </select>
                <input type="hidden" id="typeLogement" value="maison">
                <select id="surface" style="display:none;">
                    <option value="S<70">S &lt; 70 m¬≤</option>
                    <option value="70<=S<90">70 ‚â§ S &lt; 90 m¬≤</option>
                    <option value="S>=90" selected>S ‚â• 90 m¬≤</option>
                </select>
                <select id="categorie" style="display:none;">
                    <option value="BLEU">BLEU</option><option value="JAUNE">JAUNE</option>
                    <option value="VIOLET">VIOLET</option><option value="ROSE">ROSE</option>
                </select>

                <!-- ===== BLOC R√âSULTAT MPR + CEE ===== -->
                <div id="mprCeeWrapper" style="margin-top: 14px; border-radius: 14px; padding: 20px; background: linear-gradient(160deg, #0f172a 0%, #1e3a5f 40%, #134e4a 100%); color: white;">

                <!-- Bloc r√©sultat MPR -->
                <div id="mprResultBloc" style="display: none; border-radius: 12px; padding: 20px; text-align: center; transition: all 0.2s; margin-bottom: 16px;">
                    <div id="mprProfilIcon" style="font-size: 32px; margin-bottom: 6px;">üîµ</div>
                    <div id="mprProfilLabel" style="font-size: 18px; font-weight: 800; margin-bottom: 4px;">Profil Bleu</div>
                    <div id="mprProfilDesc" style="font-size: 13px; font-weight: 500; opacity: 0.85; margin-bottom: 10px;">Revenus tr√®s modestes</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                        <div style="background: rgba(255,255,255,0.25); border-radius: 8px; padding: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.7; letter-spacing: 0.5px;">R√©gion / Zone</div>
                            <div id="mprInfoRegion" style="font-size: 14px; font-weight: 700;">Province</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.25); border-radius: 8px; padding: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.7; letter-spacing: 0.5px;">Foyer</div>
                            <div id="mprInfoFoyer" style="font-size: 14px; font-weight: 700;">4 pers.</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.25); border-radius: 8px; padding: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.7; letter-spacing: 0.5px;">Seuil</div>
                            <div id="mprInfoSeuil" style="font-size: 14px; font-weight: 700;">‚Äî</div>
                        </div>
                    </div>
                    <div id="mprInfoRFR" style="font-size: 12px; margin-top: 10px; opacity: 0.75;"></div>
                    <div id="mprInfoAide" style="font-size: 15px; font-weight: 700; margin-top: 8px; background: rgba(255,255,255,0.3); border-radius: 8px; padding: 8px;"></div>
                </div>

                <!-- Param√®tres techniques + CEE -->
                <div style="font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">‚ö° Sc√©nario & Aides CEE</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="scenario" style="color: rgba(255,255,255,0.7);">Sc√©nario</label>
                        <select id="scenario" onchange="onScenarioChange()">
                            <option value="PAC">PAC</option>
                            <option value="PAC + BALLON √âLECTRIQUE">PAC + BALLON √âLECTRIQUE</option>
                            <option value="PAC + BALLON THERMO">PAC + BALLON THERMO</option>
                            <option value="PAC + SSC">PAC + SSC</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="etas" style="color: rgba(255,255,255,0.7);">Plage d'ETAS</label>
                        <select id="etas" onchange="syncEtas(); calc()">
                            <option value="111-140">111 &lt; ETAS &lt; 140</option>
                            <option value="140-170" selected>140 &lt; ETAS &lt; 170</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="color: rgba(255,255,255,0.7);">Surface chauff√©e (m¬≤)</label>
                        <input type="number" id="ceeSurface" min="1" step="1" value="95" oninput="syncSurfaces('cee')">
                    </div>
                </div>

                <!-- Fiches info -->
                <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 10px;">
                    Fiches : <strong id="ceeFichesLabel" style="color: rgba(255,255,255,0.8);">BAR-TH-171</strong>
                    <span id="ceeNonCumulNote" style="display:none; font-weight: 600; margin-left: 8px;"></span>
                </div>

                <!-- Hidden fields for JS -->
                <span id="ceeScenarioLabel" style="display:none;">PAC</span>
                <select id="ficheCEE" style="display:none;" onchange="toggleCEEBlocs(); calcCEEDetail();">
                    <option value="171">BAR-TH-171</option>
                    <option value="143">BAR-TH-143</option>
                    <option value="148">BAR-TH-148</option>
                </select>
                <select id="ceeEtas" style="display:none;">
                    <option value="lt140">lt140</option>
                    <option value="ge140" selected>ge140</option>
                </select>
                <div style="display:none;">
                    <select id="menageCEE" onchange="calcCEEDetail()">
                        <option value="tm">Tr√®s modestes (12,5 ‚Ç¨/MWhc)</option>
                        <option value="autres">Autres m√©nages (7,5 ‚Ç¨/MWhc)</option>
                    </select>
                    <input type="text" id="ceeCoefSurface" disabled value="‚Äî">
                    <div id="ceeSurfaceInfo"></div>
                </div>

                <!-- KPI CEE -->
                <div class="cee-kpi-row" style="grid-template-columns: 1fr 1fr; margin-top: 4px;">
                    <div class="cee-kpi" style="background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.6);">Volume CEE</div>
                        <div class="kpi-value" id="ceeOutKwhc" style="color: #fbbf24;">‚Äî</div>
                    </div>
                    <div class="cee-kpi" style="background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.6);">Prime CEE</div>
                        <div class="kpi-value" id="ceeOutPrime" style="color: #34d399;">‚Äî</div>
                    </div>
                </div>
                <!-- D√©tail fournisseur -->
                <div class="fournisseur-only" style="margin-top: 4px; font-size: 11px; color: rgba(255,255,255,0.4); font-family: ui-monospace, monospace;">
                    <span id="ceeOutDetail">‚Äî</span> ¬∑ <span id="ceeOutPrix">‚Äî</span>
                </div>

                </div><!-- /mprCeeWrapper -->

                <!-- Blocs fournisseur d√©tail -->
                <div class="fournisseur-only">
                    <div class="cee-bloc-171" id="ceeBloc171" style="display:none;"></div>
                    <div class="cee-bloc-148 cee-hidden" id="ceeBloc148" style="margin-top: 8px;">
                        <div class="cee-grid">
                            <div>
                                <label>Forfait BAR-TH-148 (kWhc)</label>
                                <input type="number" id="ceeKwhc148" min="0" step="100" value="9000" oninput="calcCEEDetail()">
                            </div>
                            <div>
                                <label>Forfait calcul√©</label>
                                <input type="text" id="cee148Forfait" disabled value="‚Äî" style="background: #f1f5f9; font-weight: 600;">
                            </div>
                            <div>
                                <label>Note interne</label>
                                <input type="text" id="ceeNote148" placeholder="COP, volume ballon, marque..." oninput="calcCEEDetail()">
                            </div>
                        </div>
                    </div>
                    <div id="ceeBloc143" class="cee-hidden" style="margin-top: 8px;">
                        <div style="font-size: 12px; font-weight: 600; color: #2563eb; margin-bottom: 8px;">üìô BAR-TH-143 ‚Äî SSC ¬∑ <span style="color: #059669;">Coup de pouce √ó2</span></div>
                        <div class="cee-grid">
                            <div>
                                <label>Forfait par zone</label>
                                <input type="text" id="cee143Forfait" disabled value="‚Äî" style="background: #f1f5f9; font-weight: 600;">
                                <div class="cee-hint">H1: 134 800 ¬∑ H2: 121 000 ¬∑ H3: 100 500 kWhc</div>
                            </div>
                        </div>
                    </div>
                    <div class="cee-kpi-row" style="grid-template-columns: 1fr; margin-top: 8px;">
                        <div class="cee-kpi" id="ceeKpi148" style="display:none;">
                            <div class="kpi-label">Dont BAR-TH-148</div>
                            <div class="kpi-value" id="ceeOut148" style="color: #059669;">‚Äî</div>
                            <div class="kpi-detail" id="ceeOut148Detail">‚Äî</div>
                        </div>
                    </div>
                    <div class="cee-result" id="ceeResult"></div>
                </div>

                <div id="calcErrorDebug" style="color: red; font-size: 12px; font-weight: 600; margin-top: 8px; padding: 6px; background: #fef2f2; border-radius: 6px;"></div>
            </div>

            <!-- ===================== BAR√àME PAC (client) ===================== -->
            <div class="card" id="baremeCard">
                <h2 class="card-title">üìê Puissance PAC recommand√©e</h2>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 14px;">Estimation selon la surface, l'ann√©e de construction et l'isolation</div>

                <!-- Hidden input for sync -->
                <input type="hidden" id="baremeSurface" value="100">

                <!-- Ann√©e de construction -->
                <div class="form-group" style="margin-bottom: 14px;">
                    <label>Ann√©e de construction</label>
                    <input type="number" id="dimAnnee" value="2000" min="1900" max="2026" oninput="evalIsolation(); calcBareme(); calcDim()">
                </div>

                <!-- Questionnaire isolation -->
                <div style="margin-bottom: 14px;">
                    <label style="font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; margin-bottom: 10px;">Travaux d'isolation r√©alis√©s</label>
                    <div style="display: flex; flex-direction: column; gap: 6px;" id="isoChecklist">
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="combles">
                            <span class="iso-info">
                                <span class="iso-title">Combles / Toiture</span>
                                <span class="iso-sub">Isolation souffl√©e, rampants, sarking‚Ä¶</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="murs">
                            <span class="iso-info">
                                <span class="iso-title">Murs (ITE / ITI)</span>
                                <span class="iso-sub">Isolation thermique ext√©rieure ou int√©rieure</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="fenetres">
                            <span class="iso-info">
                                <span class="iso-title">Fen√™tres double / triple vitrage</span>
                                <span class="iso-sub">Remplacement des menuiseries</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="plancher">
                            <span class="iso-info">
                                <span class="iso-title">Plancher bas</span>
                                <span class="iso-sub">Isolation vide sanitaire, sous-sol, terre-plein</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="vmc">
                            <span class="iso-info">
                                <span class="iso-title">VMC double flux</span>
                                <span class="iso-sub">Ventilation m√©canique contr√¥l√©e performante</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                    </div>
                    <!-- R√©sultat isolation (fournisseur only) -->
                    <div id="isoResult" class="fournisseur-only" style="margin-top: 10px; padding: 10px 14px; border-radius: 8px; font-size: 13px; background: #f8fafc; border: 1.5px solid #e2e8f0;">
                        <span style="font-weight: 600;" id="isoStateName">√âtat d'origine / Non pr√©cis√©</span>
                        <span style="color: #64748b;"> ‚Äî </span>
                        <span style="font-weight: 700; color: #16a34a;" id="dimGDisplay">G = 0,95</span>
                    </div>
                </div>

                <!-- R√©sultat bar√®me visuel -->
                <div id="baremeResult" style="padding: 20px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-radius: 12px; border: 1.5px solid #bbf7d0;">
                    <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; text-align: center;">PAC recommand√©e</div>
                    
                    <!-- Gauge visuelle -->
                    <div id="baremeGauge" style="position: relative; margin: 0 auto; max-width: 340px;">
                        <!-- Labels puissance -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span id="baremeLow" style="font-size: 20px; font-weight: 800; color: #16a34a;">10 kW</span>
                            <span id="baremeHigh" style="font-size: 20px; font-weight: 800; color: #dc2626;">12 kW</span>
                        </div>
                        <!-- Barre -->
                        <div style="position: relative; height: 12px; border-radius: 6px; background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%); margin-bottom: 4px;">
                            <!-- Curseur -->
                            <div id="baremeCursor" style="position: absolute; top: -6px; width: 24px; height: 24px; border-radius: 50%; background: white; border: 3px solid #0f172a; box-shadow: 0 2px 8px rgba(0,0,0,0.25); transition: left 0.4s ease; left: 50%;" ></div>
                        </div>
                        <!-- Labels bas -->
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8;">
                            <span>Bien isol√©</span>
                            <span>Mal isol√©</span>
                        </div>
                    </div>

                    <!-- R√©sultat texte -->
                    <div style="text-align: center; margin-top: 14px;">
                        <div id="baremeReco" style="font-size: 32px; font-weight: 800; color: #16a34a;">10 kW</div>
                        <div id="baremeAlt" style="font-size: 13px; color: #64748b; margin-top: 2px;"></div>
                        <div id="baremeIsoHint" style="font-size: 11px; color: #64748b; margin-top: 4px;"></div>
                    </div>
                </div>

                <!-- Tableau fournisseur only -->
                <div class="fournisseur-only" style="margin-top: 8px; overflow: hidden; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #f1f5f9;">
                                <th style="padding: 6px 10px; text-align: left; font-weight: 600; color: #475569;">Surface</th>
                                <th style="padding: 6px 10px; text-align: center; font-weight: 600; color: #475569;">PAC</th>
                            </tr>
                        </thead>
                        <tbody id="baremeTableBody" style="color: #334155;">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ===================== NOTE DE DIMENSIONNEMENT (fournisseur) ===================== -->
            <div class="card fournisseur-only" id="dimensionnementCard">
                <h2 class="card-title">üìê Dimensionnement PAC</h2>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 18px;">Estimation de la puissance recommand√©e ¬∑ Formule : P = G √ó V √ó ŒîT</div>

                <!-- Surface + Hauteur -->
                <div class="dim-row">
                    <div class="dim-field">
                        <label>Surface au sol (m¬≤) <span class="req">*</span></label>
                        <input type="number" id="dimSurface" value="100" min="1" oninput="syncSurfaces('dim')">
                        <div class="dim-hint">Exemple : 100 m¬≤</div>
                    </div>
                    <div class="dim-field">
                        <label>Hauteur sous plafond (m)</label>
                        <input type="number" id="dimHauteur" value="2.5" min="1.5" max="5" step="0.1" oninput="calcDim()">
                        <div class="dim-hint">D√©faut : 2,5 m</div>
                    </div>
                </div>

                <!-- Param√®tres avanc√©s (masqu√©s, gard√©s pour calcul) -->
                <input type="hidden" id="dimTbase" value="-7">
                <input type="hidden" id="dimTint" value="21">
                <input type="hidden" id="dimT1" value="60">
                <input type="hidden" id="dimT2" value="140">

                <!-- R√âSULTATS -->
                <div style="background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: white; font-size: 14px; margin-bottom: 14px; text-align: center;">R√âSULTATS DU DIMENSIONNEMENT</div>
                    
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">D√©perditions totales (P = G √ó V √ó ŒîT)</div>
                        <div style="font-size: 28px; font-weight: 800; color: #fbbf24;" id="dimDeperditions">‚Äî</div>
                        <div style="font-size: 12px; color: #cbd5e1;" id="dimDepFormula">‚Äî</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance PAC</div>
                            <div style="font-size: 24px; font-weight: 800; color: #34d399;" id="dimPuissancePAC">‚Äî</div>
                            <div style="font-size: 11px; color: #cbd5e1;" id="dimPuissancePACDetail">‚Äî</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance appoint</div>
                            <div style="font-size: 24px; font-weight: 800; color: #f97316;" id="dimPuissanceAppoint">‚Äî</div>
                            <div style="font-size: 11px; color: #cbd5e1;" id="dimPuissanceAppointDetail">‚Äî</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.08); border-radius: 8px; padding: 10px; margin-top: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance totale (PAC + appoint)</div>
                        <div style="font-size: 20px; font-weight: 700; color: white;" id="dimPuissanceTotale">‚Äî</div>
                    </div>
                </div>

                <!-- Temp√©rature d'eau -->
                <div class="dim-row" style="margin-bottom: 0;">
                    <div class="dim-field">
                        <label>T¬∞ d'eau du circuit (¬∞C)</label>
                        <input type="number" id="dimTeau" value="60" step="5" min="30" max="80">
                    </div>
                </div>

                <!-- √âquipement -->
                <div style="margin-top: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px;">
                    <div style="font-weight: 600; color: #1d1d1f; font-size: 13px; margin-bottom: 10px;">Mat√©riel install√©</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: #64748b;">Marque PAC</label>
                            <input type="text" id="dimMarque" placeholder="Ex: Daikin, Atlantic‚Ä¶" style="width: 100%; padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #64748b;">R√©f√©rence PAC</label>
                            <input type="text" id="dimReference" placeholder="R√©f. mod√®le" style="width: 100%; padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card fournisseur-only">
                <h2 class="card-title">Co√ªts (Vue Fournisseur)</h2>
                
                <div style="background: #f5f5f7; padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                    <!-- PAC Mat√©riel -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">PAC Mat√©riel</label>
                        <input type="number" id="coutPACMateriel" value="2900" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qtePACMateriel" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPACMateriel">2 900 ‚Ç¨</div>
                    </div>
                    
                    <!-- PAC Pose -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">PAC Pose</label>
                        <input type="number" id="coutPACPose" value="2500" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qtePACPose" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPACPose">2 500 ‚Ç¨</div>
                    </div>
                    
                    <!-- Ballon Mat√©riel -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Ballon Mat√©riel</label>
                        <input type="number" id="coutBallonMateriel" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteBallonMateriel" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalBallonMateriel">0 ‚Ç¨</div>
                    </div>
                    
                    <!-- Ballon Pose -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Ballon Pose</label>
                        <input type="number" id="coutBallonPose" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteBallonPose" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalBallonPose">0 ‚Ç¨</div>
                    </div>
                    
                    <!-- Accessoires -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Access.</label>
                        <input type="number" id="coutAccessoires" value="500" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAccessoires" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAccessoires">500 ‚Ç¨</div>
                    </div>
                    
                    <!-- Admin -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Admin</label>
                        <input type="number" id="coutAdmin" value="400" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAdmin" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAdmin">400 ‚Ç¨</div>
                    </div>
                    
                    <!-- Mandat MPR -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Mandat MPR</label>
                        <input type="number" id="coutMandat" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteMandat" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalMandat">0 ‚Ç¨</div>
                    </div>
                    
                    <!-- Demande mairie -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Mairie</label>
                        <input type="number" id="coutMairie" value="250" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteMairie" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalMairie">0 ‚Ç¨</div>
                    </div>
                    
                    <!-- Pr√©visite -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="checkPrevisite" onchange="updateFromDetail()" style="width: 16px; height: 16px;"> Pr√©visite
                        </label>
                        <input type="number" id="coutPrevisite" value="200" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <div style="text-align: center; font-weight: 600; color: #64748b;">‚Äî</div>
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPrevisite">0 ‚Ç¨</div>
                    </div>
                </div>
                
                <small style="font-size: 11px; color: #86868b; margin-bottom: 12px; display: block; text-align: center;">
                    <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="lockCoutHT" checked onchange="calc()"> Verrouiller les co√ªts (auto selon sc√©nario)
                    </label>
                </small>
                
                <div style="background: #0071e3; color: white; padding: 14px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; font-size: 14px;">TOTAL CO√õT HT</span>
                        <span style="font-size: 20px; font-weight: 700;" id="coutTotalHTDisplay">6 200 ‚Ç¨</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="prixCumac">Prix cumac (‚Ç¨/MWhc) ‚Äî auto selon m√©nage</label>
                        <input type="number" id="prixCumac" value="12.5" step="0.01" oninput="calc()" style="font-weight: 600;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label>kWh cumac</label>
                        <input type="text" id="kwhCumac" value="" readonly style="background: #f5f5f7; color: #1d1d1f; font-weight: 600;">
                    </div>
                </div>
            </div>

            <div style="padding-bottom: 40px;"></div>
        </div>

        <div class="results-sidebar" id="resultsSidebar">
            <div class="summary-card" style="margin-bottom: 0;">
                <div class="scenario-label-dark" id="scenarioSummary">‚Äî</div>

                <!-- TOTAL TTC (readonly client) -->
                <div class="ttc-readonly">
                    <div class="result-row-card" style="background: rgba(96,165,250,0.08); border-color: rgba(96,165,250,0.15);">
                        <div class="rrc-label">üí∞ Co√ªt installation TTC</div>
                        <div class="rrc-value blue" id="totalTTC">‚Äî</div>
                    </div>
                </div>

                <!-- TOTAL TTC (editable fournisseur) -->
                <div class="fournisseur-only" style="margin-bottom: 12px;">
                    <div class="dark-section-title">Co√ªt installation</div>
                    <input type="number" class="ttc-input-dark" id="totalTTCInput" value="10890" step="1" oninput="updateFromTTC()">
                    <small style="font-size: 11px; color: rgba(255,255,255,0.35); margin-top: 4px; display: block;">
                        <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" id="lockTTC" checked onchange="calc()"> Verrouiller (auto selon sc√©nario)
                        </label>
                    </small>
                </div>

                <!-- CO√õT HT fournisseur -->
                <div class="fournisseur-only" style="margin-bottom: 4px;">
                    <div class="result-row-card">
                        <div>
                            <div class="rrc-label">Co√ªt HT</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px;">Mat√©riel + pose + admin</div>
                        </div>
                        <div class="rrc-value" id="displayCoutHT" style="font-size: 18px;">‚Äî</div>
                    </div>
                </div>

                <div class="glow-separator"></div>

                <!-- ESTIMATION FINANCI√àRE -->
                <div class="dark-section-title">Estimation financi√®re</div>

                <div class="result-row-card">
                    <div class="rrc-label">MaPrimeR√©nov'</div>
                    <div class="rrc-value green" id="aidesMPR" style="font-size: 18px;">‚Äî</div>
                </div>

                <div class="result-row-card">
                    <div>
                        <div class="rrc-label">Certificats CEE</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px;" id="ceeSourceLabel">BAR-TH d√©taill√©</div>
                    </div>
                    <div class="rrc-value green" id="aidesCEE" style="font-size: 18px;">‚Äî</div>
                </div>

                <div class="glow-separator"></div>

                <!-- TOTAL AIDES -->
                <div class="result-highlight-card">
                    <div class="rhc-label">Total des aides</div>
                    <div class="rhc-value" id="totalAides">‚Äî</div>
                </div>

                <!-- RESTE √Ä CHARGE -->
                <div class="result-row-card" style="background: rgba(251,191,36,0.08); border-color: rgba(251,191,36,0.15);">
                    <div class="rrc-label">üè† Reste √† charge estim√©</div>
                    <div class="rrc-value yellow" id="resteCharge">‚Äî</div>
                </div>

                <!-- MARGE fournisseur -->
                <div class="fournisseur-only" style="margin-top: 4px;">
                    <div class="result-row-card" style="background: rgba(248,113,113,0.06); border-color: rgba(248,113,113,0.12);">
                        <div class="rrc-label">üìä Marge finale (HT)</div>
                        <div class="rrc-value" id="margeFinal" style="font-size: 18px;">‚Äî</div>
                    </div>
                </div>

                <div class="glow-separator"></div>

                <!-- RAC Section (fournisseur only) -->
                <div class="rac-dark-section fournisseur-only" style="margin-bottom: 14px;">
                    <div class="dark-section-title" style="margin-bottom: 10px;">Prise en charge du RAC</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div class="amount-label" style="color: rgba(255,255,255,0.45); margin-bottom: 4px;">Pourcentage (%)</div>
                            <input type="number" id="racPourcent" value="0" min="0" max="100" step="1" oninput="updatePct()" onchange="logRACChange()">
                        </div>
                        <div>
                            <div class="amount-label" style="color: rgba(255,255,255,0.45); margin-bottom: 4px;">RAC offert (‚Ç¨)</div>
                            <input type="number" id="racOffert" value="0" min="0" step="1" oninput="updateAmt()" onchange="logRACChange()">
                        </div>
                    </div>
                    <div id="maxPctInfo" style="font-size: 12px; padding: 10px 14px; border-radius: 8px; background: rgba(5,150,105,0.12); border: 1px solid rgba(5,150,105,0.25); color: #34d399; margin-bottom: 6px;">
                        Remise max : <strong id="maxPctValue">‚Äî</strong> pour rester en dossier vert
                    </div>
                    <div class="note-small" style="font-size: 11px; margin-bottom: 8px; color: rgba(255,255,255,0.3);">Appliqu√© sur le RAC brut. N'affecte pas le prix cumac.</div>
                </div>

                <!-- Status + Actions -->
                <div id="statusBadge" class="status-badge ok" style="margin-bottom: 14px;" onclick="shareDevis()">
                    <span id="statusIcon">‚úÖ</span>
                    <span id="statusText">Voulez-vous un devis ?</span>
                </div>

                <button id="exportBtn" class="btn-dark-export pdf" onclick="exportPDF()">
                    üìÑ Exporter en PDF
                </button>
                
                <button id="whatsappBtn" class="btn-dark-export whatsapp" onclick="sendWhatsApp()">
                    üí¨ Envoyer par WhatsApp
                </button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p style="margin: 0;">Propuls√© par 770 Lab</p>
    </div>
</div><!-- /appScreen -->
    <div id="debugPanel" style="position:fixed;bottom:0;left:0;right:0;max-height:40vh;overflow-y:auto;background:#1a1a2e;color:#0f0;font-family:monospace;font-size:11px;padding:10px;z-index:99999;display:none;border-top:3px solid #f00;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
            <strong style="color:#ff0;">üîß DEBUG</strong>
            <span onclick="document.getElementById('debugPanel').style.display='none'" style="cursor:pointer;color:#f00;">‚úï Fermer</span>
        </div>
        <div id="debugLog"></div>
    </div>
    <script>
    // Show debug on triple tap
    let _tapCount=0, _tapTimer;
    document.addEventListener('click', function(){
        _tapCount++;
        clearTimeout(_tapTimer);
        _tapTimer=setTimeout(()=>{_tapCount=0},500);
        if(_tapCount>=3){
            document.getElementById('debugPanel').style.display='block';
            _tapCount=0;
        }
    });
    </script>

    <div id="printArea" style="display: none;">
        <div style="padding: 40px; font-family: -apple-system, sans-serif;">
            <h1 style="font-size: 28px; margin-bottom: 10px;" id="printTitle">Dossier ‚Äî</h1>
            <p style="color: #6b7280; margin-bottom: 30px;" id="printDate"></p>
            
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="font-size: 14px; color: #6b7280; text-transform: uppercase; margin-bottom: 15px;">R√©sum√©</h2>
                <p style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;" id="printScenario"></p>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">TOTAL TTC</div>
                    <div style="font-size: 28px; font-weight: 700;" id="printTTC"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">AIDES MPR</div>
                    <div style="font-size: 28px; font-weight: 700;" id="printMPR"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">AIDES CEE</div>
                    <div style="font-size: 28px; font-weight: 700;" id="printCEE"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">TOTAL DES AIDES</div>
                    <div style="font-size: 28px; font-weight: 700; color: #34c759;" id="printTotalAides"></div>
                </div>
            </div>
            
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="font-size: 14px; color: #6b7280; text-transform: uppercase; margin-bottom: 15px;">Prise en charge du RAC</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <div style="font-size: 12px; color: #6b7280;">Pourcentage (%)</div>
                        <div style="font-size: 24px; font-weight: 700;" id="printPct"></div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #6b7280;">RAC offert (‚Ç¨)</div>
                        <div style="font-size: 24px; font-weight: 700;" id="printOffert"></div>
                    </div>
                </div>
                
                <div style="padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: right;">
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">RESTE √Ä CHARGE</div>
                    <div style="font-size: 36px; font-weight: 700;" id="printRAC"></div>
                </div>
                
                <div style="margin-top: 20px; padding: 16px; border-radius: 12px; text-align: center; font-weight: 700; font-size: 18px;" id="printStatus"></div>
            </div>
            
            <div style="text-align: center; margin-top: 40px; color: #6b7280; font-size: 12px;">
                Propuls√© par 770 Lab
            </div>
        </div>
    </div>

<script>
// Debug helper
const _debugLog=[];
function dbg(msg){
    _debugLog.push(new Date().toLocaleTimeString()+': '+msg);
    try{
        const el=document.getElementById('debugLog');
        if(el) el.innerHTML=_debugLog.slice(-30).map(l=>'<div>'+l+'</div>').join('');
    }catch(e){}
    console.log('[DBG]', msg);
}
window.onerror=function(msg,url,line,col,err){
    dbg('‚ùå JS ERROR: '+msg+' (line '+line+')');
    try{document.getElementById('debugPanel').style.display='block';}catch(e){}
    return false;
};

// ============================================
// BAR√àMES DE REVENUS MPR 2026
// ============================================
// ============================================
// TABLE D√âPARTEMENTS ‚Üí ZONE CLIMATIQUE (source officielle)
// ============================================
const DEPT_ZONE = {
    "01":"H1","02":"H1","03":"H1","04":"H2","05":"H1","06":"H3","07":"H2","08":"H1","09":"H2","10":"H1",
    "11":"H3","12":"H2","13":"H3","14":"H1","15":"H1","16":"H2","17":"H2","18":"H2","19":"H1","20":"H3",
    "2A":"H3","2B":"H3",
    "21":"H1","22":"H2","23":"H1","24":"H2","25":"H1","26":"H2","27":"H1","28":"H1","29":"H2","30":"H3",
    "31":"H2","32":"H2","33":"H2","34":"H3","35":"H2","36":"H2","37":"H2","38":"H1","39":"H1","40":"H2",
    "41":"H2","42":"H1","43":"H1","44":"H2","45":"H1","46":"H2","47":"H2","48":"H2","49":"H2","50":"H2",
    "51":"H1","52":"H1","53":"H2","54":"H1","55":"H1","56":"H2","57":"H1","58":"H1","59":"H1","60":"H1",
    "61":"H1","62":"H1","63":"H1","64":"H2","65":"H2","66":"H3","67":"H1","68":"H1","69":"H1","70":"H1",
    "71":"H1","72":"H2","73":"H1","74":"H1","75":"H1","76":"H1","77":"H1","78":"H1","79":"H2","80":"H1",
    "81":"H2","82":"H2","83":"H3","84":"H2","85":"H2","86":"H2","87":"H1","88":"H1","89":"H1","90":"H1",
    "91":"H1","92":"H1","93":"H1","94":"H1","95":"H1"
};

function detectDept() {
    const deptInput = document.getElementById('departement').value.trim();
    if (!deptInput) return;
    const deptKey = deptInput.padStart(2,'0');

    // Auto IDF
    const IDF_DEPTS = ['75','77','78','91','92','93','94','95'];
    const isIDF = IDF_DEPTS.includes(deptKey);
    document.getElementById('region').value = isIDF ? 'IDF' : 'PROVINCE';
    detectProfil();

    const zone = DEPT_ZONE[deptInput] || DEPT_ZONE[deptKey];
    if (zone) {
        document.getElementById('zone').value = zone;
        document.getElementById('deptZoneResult').textContent = `‚Üí Zone ${zone}${isIDF ? ' ¬∑ IDF' : ''}`;
        
        // Auto Tbase dimensionnement
        const tbase = DEPT_TBASE[deptKey] || DEPT_TBASE[deptInput];
        if (tbase !== undefined) {
            document.getElementById('dimTbase').value = tbase;
            calcDim();
        }
        calc();
        calcCEEDetail();
    } else {
        document.getElementById('deptZoneResult').textContent = '‚ùå D√©partement inconnu';
        
    }
}

const REVENUS_2026 = {
    PROVINCE: {
        1: [17363, 22259, 31185],
        2: [25393, 32553, 45842],
        3: [30540, 39148, 55196],
        4: [35676, 45735, 64550],
        5: [40835, 52348, 73907],
        supplement: [5151, 6598, 9357]
    },
    IDF: {
        1: [24031, 29253, 40851],
        2: [35270, 42933, 60051],
        3: [42357, 51564, 71846],
        4: [49455, 60208, 84562],
        5: [56580, 68877, 96817],
        supplement: [7116, 8663, 12257]
    }
};

function getSeuilsForPersonnes(region, nb) {
    const data = REVENUS_2026[region];
    if (nb <= 5) return data[nb];
    const base = data[5];
    const sup = data.supplement;
    const extra = nb - 5;
    return [
        base[0] + sup[0] * extra,
        base[1] + sup[1] * extra,
        base[2] + sup[2] * extra
    ];
}

function detectProfil() {
    const region = document.getElementById('region').value;
    const nb = parseInt(document.getElementById('nbPersonnes').value);
    const rfr = parseFloat(document.getElementById('rfr').value);
    const bloc = document.getElementById('mprResultBloc');

    if (!rfr || rfr <= 0) {
        bloc.style.display = 'none';
        return;
    }

    const seuils = getSeuilsForPersonnes(region, nb);
    let profil, icon, label, desc, bg, color;

    if (rfr <= seuils[0]) {
        profil = 'BLEU'; icon = 'üîµ'; label = 'Profil Bleu'; desc = 'Revenus tr√®s modestes';
        bg = 'linear-gradient(135deg, #1e40af, #3b82f6)'; color = '#ffffff';
    } else if (rfr <= seuils[1]) {
        profil = 'JAUNE'; icon = 'üü°'; label = 'Profil Jaune'; desc = 'Revenus modestes';
        bg = 'linear-gradient(135deg, #ca8a04, #eab308)'; color = '#ffffff';
    } else if (rfr <= seuils[2]) {
        profil = 'VIOLET'; icon = 'üü£'; label = 'Profil Violet'; desc = 'Revenus interm√©diaires';
        bg = 'linear-gradient(135deg, #6b21a8, #a855f7)'; color = '#ffffff';
    } else {
        profil = 'ROSE'; icon = '<span style="display:inline-block;width:28px;height:28px;border-radius:50%;background:#f472b6;"></span>'; label = 'Profil Rose'; desc = 'Revenus sup√©rieurs';
        bg = 'linear-gradient(135deg, #9d174d, #f472b6)'; color = '#ffffff';
    }

    const regionLabel = region === 'IDF' ? '√éle-de-France' : 'Province';
    const seuilIdx = profil === 'BLEU' ? 0 : (profil === 'JAUNE' ? 1 : 2);
    const seuilVal = seuils[seuilIdx];

    // Update bloc
    bloc.style.display = 'block';
    bloc.style.background = bg;
    bloc.style.color = color;
    document.getElementById('mprProfilIcon').innerHTML = icon;
    document.getElementById('mprProfilLabel').textContent = label;
    document.getElementById('mprProfilDesc').textContent = desc;
    const zn = document.getElementById('zone').value;
    document.getElementById('mprInfoRegion').textContent = regionLabel + ' ¬∑ ' + zn;
    document.getElementById('mprInfoFoyer').textContent = nb + ' pers.';
    document.getElementById('mprInfoSeuil').textContent = profil === 'ROSE'
        ? '> ' + seuilVal.toLocaleString('fr-FR') + ' ‚Ç¨'
        : '‚â§ ' + seuilVal.toLocaleString('fr-FR') + ' ‚Ç¨';
    document.getElementById('mprInfoRFR').textContent = 'RFR d√©clar√© : ' + rfr.toLocaleString('fr-FR') + ' ‚Ç¨';

    // Aide MPR pour le sc√©nario en cours
    const sc = document.getElementById('scenario').value;
    const mpr = D.MPR[sc] ? D.MPR[sc][profil] : 0;
    document.getElementById('mprInfoAide').textContent = mpr > 0
        ? 'Aide MaPrimeR√©nov\' : ' + mpr.toLocaleString('fr-FR') + ' ‚Ç¨'
        : 'Pas d\'aide MaPrimeR√©nov\' pour ce profil';

    document.getElementById('categorie').value = profil;

    // Sync cat√©gorie m√©nage CEE
    document.getElementById('menageCEE').value = (profil === 'BLEU') ? 'tm' : 'autres';

    calc();
    calcCEEDetail();
}

function toggleRevenus() {
    const body = document.getElementById('revenusBody');
    const arrow = document.getElementById('toggleArrow');
    if (body) body.classList.toggle('open');
    if (arrow) arrow.classList.toggle('open');
}

// ============================================
// CEE D√âTAIL ‚Äî BAR-TH-171 / 143 / 148
// (Source : fiche BAR-TH-171 vA78.4)
// ============================================
const CEE_PRICE = { tm: 12.5, autres: 7.5 }; // ‚Ç¨/MWhc

const BAR143 = { H1: 134800, H2: 121000, H3: 100500 };

// BAR-TH-148 v.A73.3 ‚Äî Forfaits officiels (√† compter du 01/11/2025)
const BAR148 = { maison: 14700, appartement: 11800 };

const BAR171 = {
    maison: {
        base: { lt140: 90900, ge140: 109200 },
        coefSurface: (S) => (S < 70 ? 0.5 : (S < 90 ? 0.7 : 1.0)),
        tranches: "Maison : S<70‚Üí0,5 ¬∑ 70‚â§S<90‚Üí0,7 ¬∑ S‚â•90‚Üí1"
    },
    appartement: {
        base: { lt140: 48700, ge140: 58900 },
        coefSurface: (S) => (S < 35 ? 0.5 : (S < 60 ? 0.7 : 1.0)),
        tranches: "Appart : S<35‚Üí0,5 ¬∑ 35‚â§S<60‚Üí0,7 ¬∑ S‚â•60‚Üí1"
    },
    coefZone: { H1: 1.2, H2: 1.0, H3: 0.7 }
};


// Surface dropdown ‚Üí cat√©gorie pour table CEE (maison: les 5 anciennes cat√©gories)
function surfaceToCategory(surfaceVal) {
    // surfaceVal comes from the dropdown: "S<70", "70<=S<90", "S>=90" (maison) or "S<35", "35<=S<60", "S>=60" (appart)
    // Map to table CEE keys
    const map = {
        'S<70': 'S<70', '70<=S<90': '70<S<90', 'S>=90': '90<S<110',
        'S<35': 'S<70', '35<=S<60': '70<S<90', 'S>=60': '90<S<110'
    };
    return map[surfaceVal] || '90<S<110';
}

function getSurfaceLabel() {
    const sel = document.getElementById('surface');
    return sel.options[sel.selectedIndex].text;
}

// Surface coef from dropdown value (BAR-TH-171 officiel)
function getSurfaceCoef(surfaceVal) {
    const map = { 'S<70': 0.5, '70<=S<90': 0.7, 'S>=90': 1, 'S<35': 0.5, '35<=S<60': 0.7, 'S>=60': 1 };
    return map[surfaceVal] || 1;
}

// Dynamic surface options based on type logement
function updateSurfaceOptions() {
    const tl = document.getElementById('typeLogement').value;
    const sel = document.getElementById('surface');
    const oldCoef = getSurfaceCoef(sel.value); // preserve coef level
    sel.innerHTML = '';
    if (tl === 'maison') {
        sel.add(new Option('S < 70 m¬≤', 'S<70'));
        sel.add(new Option('70 ‚â§ S < 90 m¬≤', '70<=S<90'));
        sel.add(new Option('S ‚â• 90 m¬≤', 'S>=90'));
    } else {
        sel.add(new Option('S < 35 m¬≤', 'S<35'));
        sel.add(new Option('35 ‚â§ S < 60 m¬≤', '35<=S<60'));
        sel.add(new Option('S ‚â• 60 m¬≤', 'S>=60'));
    }
    // Set option with same coef level
    const coefToMaison = { 0.5: 'S<70', 0.7: '70<=S<90', 1: 'S>=90' };
    const coefToAppart = { 0.5: 'S<35', 0.7: '35<=S<60', 1: 'S>=60' };
    const targetMap = tl === 'maison' ? coefToMaison : coefToAppart;
    sel.value = targetMap[oldCoef] || sel.options[sel.options.length - 1].value;
}

function onTypeLogementChange() {
    updateSurfaceOptions();
    calc();
}

function syncEtas() {
    const val = document.getElementById('etas').value;
    document.getElementById('ceeEtas').value = (val === '111-140') ? 'lt140' : 'ge140';
    calcCEEDetail();
}

function onScenarioChange() {
    detectProfil();
    calc();
    if(typeof logScenarioChange==='function') logScenarioChange();
}

let _calcRunning = false;

let lastCEEDetailPrime = 0;
let lastCEEDetailKwhc = 0;

function toggleCEE() {
    const body = document.getElementById('ceeBody');
    const arrow = document.getElementById('ceeToggleArrow');
    if (body) body.classList.toggle('open');
    if (arrow) arrow.classList.toggle('open');
}

// Quelle(s) fiche(s) BAR-TH s'appliquent selon le sc√©nario
// Depuis 01/01/2026 : BAR-TH-148 NON cumulable avec BAR-TH-171 (arr√™t√© 15/12/2025)
function getCEEFiches(scenario) {
    switch(scenario) {
        case 'PAC':                    return ['171'];
        case 'PAC + BALLON √âLECTRIQUE': return ['171'];
        case 'PAC + BALLON THERMO':     return ['171']; // 148 non cumulable depuis 01/2026
        case 'PAC + SSC':              return ['171', '143']; // cumul 171+143, CdP sur 171 uniquement
        default:                        return ['171'];
    }
}

function calcCEEDetail() {
  try {
    const sc = document.getElementById('scenario').value;
    const zn = document.getElementById('zone').value;
    const menage = document.getElementById('menageCEE').value;
    const price = CEE_PRICE[menage] || CEE_PRICE.autres;
    const tl = document.getElementById('typeLogement').value;
    const surfaceVal = document.getElementById('surface').value;
    const coefS = getSurfaceCoef(surfaceVal);

    // Update surface info label
    const ceeSurfInfo = document.getElementById('ceeSurfaceInfo');
    if (ceeSurfInfo) {
        const s = parseInt(document.getElementById('ceeSurface').value) || 0;
        if (tl === 'maison') {
            ceeSurfInfo.textContent = s < 70 ? '‚Üí S < 70 m¬≤ (coef 0,5)' : (s < 90 ? '‚Üí 70 ‚â§ S < 90 m¬≤ (coef 0,7)' : '‚Üí S ‚â• 90 m¬≤ (coef 1)');
        } else {
            ceeSurfInfo.textContent = s < 35 ? '‚Üí S < 35 m¬≤ (coef 0,5)' : (s < 60 ? '‚Üí 35 ‚â§ S < 60 m¬≤ (coef 0,7)' : '‚Üí S ‚â• 60 m¬≤ (coef 1)');
        }
    }

    const fiches = getCEEFiches(sc);

    // Labels
    document.getElementById('ceeScenarioLabel').textContent = SCENARIO_NAMES[sc] || sc;
    document.getElementById('ceeFichesLabel').textContent = fiches.map(f => 'BAR-TH-' + f).join(' + ');
    const noteEl = document.getElementById('ceeNonCumulNote');
    if (noteEl) {
        if (sc === 'PAC + BALLON THERMO') {
            noteEl.style.display = 'inline';
            noteEl.textContent = '‚ö† BAR-TH-148 non cumulable avec 171 depuis 01/2026';
        } else if (sc === 'PAC + SSC') {
            noteEl.style.display = 'inline';
            noteEl.innerHTML = 'üí° CdP √ó5 sur 171 (prioritaire vs √ó2 sur 143)';
            noteEl.style.color = '#059669';
        } else {
            noteEl.style.display = 'none';
        }
    }

    // Show/hide blocs
    document.getElementById('ceeBloc171').classList.toggle('cee-hidden', !fiches.includes('171'));
    document.getElementById('ceeBloc148').classList.toggle('cee-hidden', !fiches.includes('148'));
    document.getElementById('ceeBloc143').classList.toggle('cee-hidden', !fiches.includes('143'));

    let totalKwhc = 0;
    let details = [];
    let statusParts = [];

    // === BAR-TH-171 ===
    if (fiches.includes('171')) {
        const etasKey = document.getElementById('etas').value === '111-140' ? 'lt140' : 'ge140';
        const base = BAR171[tl].base[etasKey];
        const cz = BAR171.coefZone[zn];
        document.getElementById('ceeCoefSurface').value = coefS.toString().replace('.', ',');
        const CDP = 5; // Coup de pouce Chauffage √ó5 (arr√™t√© 74e, oct 2025)
        const kwhc171 = base * coefS * cz * CDP;
        totalKwhc += kwhc171;
        details.push(`171: ${fmtIntCEE(kwhc171)}`);
        statusParts.push(`‚úÖ 171: base ${fmtIntCEE(base)} √ó coef ${coefS} √ó zone ${cz} √ó CdP √ó${CDP}`);
    }

    // === BAR-TH-148 ===
    if (fiches.includes('148')) {
        const kwhc148 = BAR148[tl] || 14700;
        totalKwhc += kwhc148;
        details.push(`148: ${fmtIntCEE(kwhc148)}`);
        const typeLabel = tl === 'maison' ? 'Maison' : 'Appart';
        document.getElementById('cee148Forfait').value = `${fmtIntCEE(kwhc148)} kWhc (${typeLabel})`;
        const prime148 = (kwhc148 / 1000) * price;
        document.getElementById('ceeOut148').textContent = fmtEurCEE(prime148);
        document.getElementById('ceeOut148Detail').textContent = `${fmtIntCEE(kwhc148)} kWhc`;
        document.getElementById('ceeKpi148').style.display = 'block';
        statusParts.push(`‚úÖ 148: ${fmtIntCEE(kwhc148)} kWhc (v.A73.3 ¬∑ ${typeLabel})`);
    } else {
        document.getElementById('ceeKpi148').style.display = 'none';
    }

    // === BAR-TH-143 ===
    if (fiches.includes('143')) {
        const base143 = BAR143[zn];
        const CDP143 = 2;
        const kwhc143avecCdP = base143 * CDP143;
        // Si cumul avec 171 : CdP va sur 171 (√ó5 > √ó2), 143 = forfait base
        // Si 143 seul : CdP √ó2 applicable
        const has171 = fiches.includes('171');
        const kwhc143 = has171 ? base143 : kwhc143avecCdP;
        totalKwhc += kwhc143;
        details.push(`143: ${fmtIntCEE(kwhc143)}`);
        if (has171) {
            document.getElementById('cee143Forfait').value = `${fmtIntCEE(base143)} kWhc (${zn}) ‚Äî CdP sur 171`;
            statusParts.push(`‚úÖ 143: forfait ${zn} = ${fmtIntCEE(base143)} kWhc (CdP √ó${CDP143} = ${fmtIntCEE(kwhc143avecCdP)} si seul)`);
        } else {
            document.getElementById('cee143Forfait').value = `${fmtIntCEE(base143)} √ó ${CDP143} = ${fmtIntCEE(kwhc143avecCdP)} kWhc (${zn})`;
            statusParts.push(`‚úÖ 143: forfait ${zn} ${fmtIntCEE(base143)} √ó CdP √ó${CDP143} = ${fmtIntCEE(kwhc143avecCdP)} kWhc`);
        }
    }

    const primeCEE = (totalKwhc / 1000) * price;
    lastCEEDetailPrime = primeCEE;
    lastCEEDetailKwhc = totalKwhc;

    document.getElementById('ceeOutKwhc').textContent = `${fmtIntCEE(totalKwhc)} kWhc`;
    document.getElementById('ceeOutDetail').textContent = details.join(' + ');
    document.getElementById('ceeOutPrime').textContent = fmtEurCEE(primeCEE);
    document.getElementById('ceeOutPrix').textContent = `${price.toString().replace('.', ',')} ‚Ç¨/MWhc ¬∑ ${menage === 'tm' ? 'Tr√®s modestes' : 'Autres'}`;

    const resultEl = document.getElementById('ceeResult');
    if (statusParts.length > 0) {
        resultEl.className = 'cee-result show';
        resultEl.innerHTML = statusParts.join('<br>');
    } else {
        resultEl.className = 'cee-result';
    }

  } catch(e) {
    console.error('calcCEEDetail() error:', e);
    if(typeof dbg==='function') dbg('‚ùå calcCEEDetail: '+e.message+' at line '+(e.stack||'').split('\n')[1]);
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = '‚ö† CEEDetail: ' + e.message; errDiv.style.display = 'block'; errDiv.style.color = '#dc2626'; errDiv.style.background = '#fef2f2'; }
  }
}

function fmtIntCEE(n) {
    return isFinite(n) ? Math.round(n).toLocaleString('fr-FR') : '‚Äî';
}
function fmtEurCEE(n) {
    return isFinite(n) ? Math.round(n).toLocaleString('fr-FR') + ' ‚Ç¨' : '‚Äî';
}

// ============================================
// DONN√âES PRINCIPALES
// ============================================
const D={TTC:{"PAC":10890,"PAC + BALLON √âLECTRIQUE":13750,"PAC + BALLON THERMO":13750,"PAC + SSC":25850},MPR:{"PAC":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON √âLECTRIQUE":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON THERMO":{BLEU:6200,JAUNE:4800,VIOLET:3400,ROSE:0},"PAC + SSC":{BLEU:15000,JAUNE:12000,VIOLET:7000,ROSE:0}},COUT:{"PAC":6600,"PAC + BALLON √âLECTRIQUE":6800,"PAC + BALLON THERMO":7200,"PAC + SSC":11650},COUT_DETAIL:{"PAC":{pac_materiel:2900,pac_pose:2500,ballon_materiel:0,ballon_pose:0,accessoires:800,admin:400,mairie:0},"PAC + BALLON √âLECTRIQUE":{pac_materiel:2900,pac_pose:2500,ballon_materiel:200,ballon_pose:0,accessoires:800,admin:400,mairie:0},"PAC + BALLON THERMO":{pac_materiel:2900,pac_pose:2500,ballon_materiel:1100,ballon_pose:500,accessoires:800,admin:400,mairie:0},"PAC + SSC":{pac_materiel:5700,pac_pose:4500,ballon_materiel:0,ballon_pose:0,accessoires:800,admin:400,mairie:250}},CEE:{"140-170":{H1:{PAC:{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON ELECTRIQUE":{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON THERMO":{"S<70":289500,"70<S<90":399420,"90<S<110":564300,"110<S<130":619260,"S>130":894060},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON ELECTRIQUE":{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON THERMO":{"S<70":243700,"70<S<90":335300,"90<S<110":472700,"110<S<130":518500,"S>130":747500},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON ELECTRIQUE":{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON THERMO":{"S<70":175000,"70<S<90":239120,"90<S<110":335300,"110<S<130":367360,"S>130":527660},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}},"111-140":{H1:{PAC:{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON ELECTRIQUE":{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON THERMO":{"S<70":253200,"70<S<90":348600,"90<S<110":491700,"110<S<130":539400,"S>130":777900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON ELECTRIQUE":{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON THERMO":{"S<70":213450,"70<S<90":292950,"90<S<110":412200,"110<S<130":451950,"S>130":650700},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON ELECTRIQUE":{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON THERMO":{"S<70":153825,"70<S<90":209475,"90<S<110":292950,"110<S<130":320775,"S>130":459900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}}}};
const M={"PAC":"PAC","PAC + BALLON √âLECTRIQUE":"BALLON ELECTRIQUE","PAC + BALLON THERMO":"BALLON THERMO","PAC + SSC":"BALLON SSC"};

const SCENARIO_NAMES = {"PAC":"PAC","PAC + BALLON √âLECTRIQUE":"PAC + Ballon √âlectrique","PAC + BALLON THERMO":"PAC + Ballon Thermo","PAC + SSC":"PAC + SSC"};

function getCEE(et, zn, cs, sf){
    if(!D.CEE[et]) return 0;
    if(!D.CEE[et][zn]) return 0;
    if(!D.CEE[et][zn][cs]) return 0;
    if(!D.CEE[et][zn][cs][sf]) return 0;
    return D.CEE[et][zn][cs][sf];
}

let mode=0;

function fmt(n){
    return Math.round(n).toLocaleString('fr-FR')+' ‚Ç¨';
}

function updateFromTTC(){
    document.getElementById('lockTTC').checked=false;
    calc();
}

function updateFromDetail(){
    document.getElementById('lockCoutHT').checked=false;
    
    const fields = [
        ['coutPACMateriel','qtePACMateriel','totalPACMateriel'],
        ['coutPACPose','qtePACPose','totalPACPose'],
        ['coutBallonMateriel','qteBallonMateriel','totalBallonMateriel'],
        ['coutBallonPose','qteBallonPose','totalBallonPose'],
        ['coutAccessoires','qteAccessoires','totalAccessoires'],
        ['coutAdmin','qteAdmin','totalAdmin'],
        ['coutMandat','qteMandat','totalMandat'],
        ['coutMairie','qteMairie','totalMairie']
    ];
    
    let totalGlobal = 0;
    fields.forEach(([cId, qId, tId]) => {
        const c = parseFloat(document.getElementById(cId).value) || 0;
        const q = parseFloat(document.getElementById(qId).value) || 0;
        const t = c * q;
        document.getElementById(tId).textContent = fmt(t);
        totalGlobal += t;
    });
    
    // Pr√©visite (checkbox)
    const prevChecked = document.getElementById('checkPrevisite').checked;
    const prevCost = prevChecked ? (parseFloat(document.getElementById('coutPrevisite').value) || 0) : 0;
    document.getElementById('totalPrevisite').textContent = prevChecked ? fmt(prevCost) : '0 ‚Ç¨';
    totalGlobal += prevCost;
    
    document.getElementById('coutTotalHTDisplay').textContent = fmt(totalGlobal);
    calc();
}

function getCoutFromFields() {
    const f = ['coutPACMateriel','coutPACPose','coutBallonMateriel','coutBallonPose','coutAccessoires','coutAdmin','coutMandat','coutMairie'];
    const q = ['qtePACMateriel','qtePACPose','qteBallonMateriel','qteBallonPose','qteAccessoires','qteAdmin','qteMandat','qteMairie'];
    let t = 0;
    for (let i = 0; i < f.length; i++) {
        t += (parseFloat(document.getElementById(f[i]).value)||0) * (parseFloat(document.getElementById(q[i]).value)||0);
    }
    if (document.getElementById('checkPrevisite').checked) t += parseFloat(document.getElementById('coutPrevisite').value)||0;
    return t;
}

function getCoutFromDetail(sc, ad) {
    if (!D.COUT_DETAIL[sc]) return D.COUT[sc] || 0;
    const d = D.COUT_DETAIL[sc];
    let t = d.pac_materiel + d.pac_pose + d.ballon_materiel + d.ballon_pose + d.accessoires + d.admin + (d.mairie || 0);
    if (ad > 0) t += Math.round(ad * 0.12);
    if (document.getElementById('checkPrevisite').checked) t += parseFloat(document.getElementById('coutPrevisite').value)||200;
    return t;
}

// Frais pass-through (factur√©s au client, ajout√©s au TTC)
// These are revenue items that shouldn't reduce margin
function getPassThrough() {
    if(mode) {
        const m = (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
        const r = (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
        const p = document.getElementById('checkPrevisite').checked ? (parseFloat(document.getElementById('coutPrevisite').value)||0) : 0;
        return m + r + p;
    } else {
        // Client mode: calculate from data
        const sc = document.getElementById('scenario').value;
        const ct = document.getElementById('categorie').value;
        const ad = (D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
        const d = D.COUT_DETAIL[sc];
        let pt = (d ? (d.mairie||0) : 0);
        if(ad > 0) pt += Math.round(ad * 0.12);
        if(document.getElementById('checkPrevisite').checked) pt += parseFloat(document.getElementById('coutPrevisite').value)||200;
        return pt;
    }
}

function calc(){
  try {
    _calcRunning = true;
    
    // Always recalculate CEE detail first (updates lastCEEDetailPrime)
    calcCEEDetail();
    
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    // Check if CEE override is active
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        if(lockTTC){
            tt = D.TTC[sc] || 0;
            document.getElementById('totalTTCInput').value=tt;
        }else{
            tt=parseFloat(document.getElementById('totalTTCInput').value)||0;
        }
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                document.getElementById('coutPACMateriel').value = detail.pac_materiel;
                document.getElementById('qtePACMateriel').value = 1;
                document.getElementById('totalPACMateriel').textContent = fmt(detail.pac_materiel);
                document.getElementById('coutPACPose').value = detail.pac_pose;
                document.getElementById('qtePACPose').value = 1;
                document.getElementById('totalPACPose').textContent = fmt(detail.pac_pose);
                document.getElementById('coutBallonMateriel').value = detail.ballon_materiel;
                document.getElementById('qteBallonMateriel').value = detail.ballon_materiel > 0 ? 1 : 0;
                document.getElementById('totalBallonMateriel').textContent = fmt(detail.ballon_materiel);
                document.getElementById('coutBallonPose').value = detail.ballon_pose;
                document.getElementById('qteBallonPose').value = detail.ballon_pose > 0 ? 1 : 0;
                document.getElementById('totalBallonPose').textContent = fmt(detail.ballon_pose);
                document.getElementById('coutAccessoires').value = detail.accessoires;
                document.getElementById('qteAccessoires').value = 1;
                document.getElementById('totalAccessoires').textContent = fmt(detail.accessoires);
                document.getElementById('coutAdmin').value = detail.admin;
                document.getElementById('qteAdmin').value = 1;
                document.getElementById('totalAdmin').textContent = fmt(detail.admin);
                // Mandat MPR = 12% de l'aide MPR
                const mandatVal = Math.round(ad * 0.12);
                document.getElementById('coutMandat').value = mandatVal;
                document.getElementById('qteMandat').value = ad > 0 ? 1 : 0;
                document.getElementById('totalMandat').textContent = fmt(ad > 0 ? mandatVal : 0);
                // Demande mairie (SSC uniquement)
                const mairieVal = detail.mairie || 0;
                document.getElementById('coutMairie').value = mairieVal > 0 ? mairieVal : 250;
                document.getElementById('qteMairie').value = mairieVal > 0 ? 1 : 0;
                document.getElementById('totalMairie').textContent = fmt(mairieVal);
                // Pr√©visite
                const prevOn = document.getElementById('checkPrevisite').checked;
                const prevCost = prevOn ? (parseFloat(document.getElementById('coutPrevisite').value) || 200) : 0;
                document.getElementById('totalPrevisite').textContent = prevOn ? fmt(prevCost) : '0 ‚Ç¨';
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin + (ad > 0 ? mandatVal : 0) + mairieVal + prevCost;
            }else{
                ch = D.COUT[sc] || 0;
            }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
            ch += (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
            ch += (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
            if(document.getElementById('checkPrevisite').checked) ch += parseFloat(document.getElementById('coutPrevisite').value)||0;
        }
        document.getElementById('coutTotalHTDisplay').textContent = fmt(ch);
    }else{
        ch=getCoutFromDetail(sc, ad);
    }
    
    // Pass-through costs (mandat, mairie, pr√©visite) are revenue items
    // They're displayed in costs but excluded from margin calculation
    const chForMarge = ch - getPassThrough();
    
    let ce;
    let ceForMarge, taForMarge;
    
    // Always use detailed CEE calculation (with Coup de pouce)
    ce = lastCEEDetailPrime;
    ceForMarge = ce;
    taForMarge = ad + ceForMarge;
    
    if(mode){
        // Sync prixCumac with m√©nage CEE category
        const menageVal = document.getElementById('menageCEE').value;
        const pxAuto = (menageVal === 'tm') ? 12.5 : 7.5;
        document.getElementById('prixCumac').value = pxAuto;
        document.getElementById('kwhCumac').value=Math.round(lastCEEDetailKwhc).toLocaleString('fr-FR');
    }
    
    const ceDisplay = ce;
    const ceeSourceText = getCEEFiches(sc).map(f => 'BAR-TH-' + f).join(' + ') + ' d√©taill√©';
    
    const ta=ad+ceDisplay;
    const rb=tt-ta;
    
    document.getElementById('totalTTC').textContent=fmt(tt);
    document.getElementById('aidesMPR').textContent=fmt(ad);
    document.getElementById('aidesCEE').textContent=fmt(ceDisplay);
    document.getElementById('totalAides').textContent=fmt(ta);
    document.getElementById('ceeSourceLabel').textContent=ceeSourceText;
    
    if(mode) document.getElementById('displayCoutHT').textContent=fmt(ch);
    
    const st=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const ct2=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zn2=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const et2=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const sf2=getSurfaceLabel();
    const colorClass=ct==='BLEU'?'color-bleu':(ct==='JAUNE'?'color-jaune':(ct==='VIOLET'?'color-violet':'color-rose'));
    const borderColor=ct==='BLEU'?'#0071e3':(ct==='JAUNE'?'#fbbf24':(ct==='VIOLET'?'#8b5cf6':'#ec4899'));
    
    document.getElementById('scenarioSummary').innerHTML=`<strong class="${colorClass}">${st}</strong><span class="separator">‚Ä¢</span>${ct2}<span class="separator">‚Ä¢</span>Zone ${zn2}<span class="separator">‚Ä¢</span>${sf2}<span class="separator">‚Ä¢</span>${et2}`;
    document.getElementById('scenarioSummary').style.borderLeftColor=borderColor;
    
    calcRAC(rb,chForMarge,ta,taForMarge,tt);
    if(typeof dbg==='function') dbg('calc: sc='+sc+' ct='+ct+' ad='+ad+' ce='+ce+' ch='+ch+' chFM='+chForMarge+' tt='+tt+' rb='+rb+' taFM='+taForMarge);
    
    _calcRunning = false;
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = ''; errDiv.style.display = 'none'; }
  } catch(e) {
    _calcRunning = false;
    console.error('calc() error:', e);
    if(typeof dbg==='function') dbg('‚ùå calc: '+e.message+' at '+(e.stack||'').split('\n')[1]);
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = '‚ö† calc(): ' + e.message; errDiv.style.display = 'block'; errDiv.style.color = '#dc2626'; errDiv.style.background = '#fef2f2'; }
  }
}

function calcRAC(rb,ch,ta,taForMarge,tt){
    const po=parseFloat(document.getElementById('racPourcent').value)||0;
    const mo=parseFloat(document.getElementById('racOffert').value)||0;
    const rc=rb-mo;
    // RAC n√©gatif ‚Üí afficher 1‚Ç¨ en vue client, vrai montant en vue fournisseur
    document.getElementById('resteCharge').textContent = (rc < 0 && !mode) ? '1 ‚Ç¨' : fmt(rc);
    
    const rbForMarge = tt - taForMarge;
    const rcForMarge = rbForMarge - mo;
    const vhForMarge = Math.max(0,rcForMarge)/1.055;
    const mgForMarge = vhForMarge - ch + taForMarge;
    
    if(mode){
        document.getElementById('margeFinal').textContent=fmt(mgForMarge);
    }
    
    const currentScenario = document.getElementById('scenario').value;
    const seuilOK = (currentScenario === 'PAC + SSC') ? 6000 : 4000;
    
    // Calculate max % offerable (fournisseur)
    if(mode){
        const maxPctEl = document.getElementById('maxPctValue');
        const maxPctBox = document.getElementById('maxPctInfo');
        if(maxPctEl){
            if(rb <= 0){
                // Aides cover entire TTC - no RAC to discount
                if(mgForMarge >= seuilOK){
                    maxPctEl.textContent = 'Aides > TTC \u2014 pas de RAC \u00e0 r\u00e9duire';
                    maxPctBox.style.background = 'rgba(5,150,105,0.12)';
                    maxPctBox.style.borderColor = 'rgba(5,150,105,0.25)';
                    maxPctBox.style.color = '#34d399';
                } else {
                    maxPctEl.textContent = '0% \u2014 marge insuffisante';
                    maxPctBox.style.background = 'rgba(220,38,38,0.12)';
                    maxPctBox.style.borderColor = 'rgba(220,38,38,0.25)';
                    maxPctBox.style.color = '#f87171';
                }
            } else {
                // Normal case: solve for max offert
                const maxOffert = rbForMarge - (seuilOK + ch - taForMarge) * 1.055;
                const maxPct = Math.max(0, Math.floor((maxOffert / rb) * 100));
                if(typeof dbg==='function') dbg('maxOff: maxOff='+Math.round(maxOffert)+' pct='+maxPct);
                if(maxOffert > 0){
                    maxPctEl.textContent = maxPct + '% (' + fmt(Math.floor(maxOffert)) + ')';
                    maxPctBox.style.background = 'rgba(5,150,105,0.12)';
                    maxPctBox.style.borderColor = 'rgba(5,150,105,0.25)';
                    maxPctBox.style.color = '#34d399';
                } else {
                    maxPctEl.textContent = '0% \u2014 marge insuffisante';
                    maxPctBox.style.background = 'rgba(220,38,38,0.12)';
                    maxPctBox.style.borderColor = 'rgba(220,38,38,0.25)';
                    maxPctBox.style.color = '#f87171';
                }
            }
        }
    }
    
    const bd=document.getElementById('statusBadge');
    const icon=document.getElementById('statusIcon');
    const txt=document.getElementById('statusText');
    if(typeof dbg==='function') dbg('RAC: mg='+Math.round(mgForMarge)+' seuil='+seuilOK+' rbFM='+Math.round(rbForMarge)+' ch='+Math.round(ch));
    if(mgForMarge>=seuilOK){
        bd.className='status-badge ok';
        bd.onclick=shareDevis;
        icon.textContent='‚úÖ';
        txt.textContent='Voulez-vous un devis ?';
    }else{
        bd.className='status-badge danger';
        bd.onclick=null;
        icon.textContent='‚ùå';
        txt.textContent='Dossier refus√©';
    }
}

function shareDevis(){
    const nom=document.getElementById('nom').value.trim()||'Client';
    const prenom=document.getElementById('prenom').value.trim()||'';
    const scenario=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const ttc=document.getElementById('totalTTC').textContent;
    const totalAides=document.getElementById('totalAides').textContent;
    const rac=document.getElementById('resteCharge').textContent;
    
    const text = `üè† Estimation PAC ‚Äî ${prenom} ${nom}\n\nüìã ${scenario}\nüí∞ Installation TTC : ${ttc}\nüéÅ Total aides : ${totalAides}\nüè† Reste √† charge : ${rac}\n\nSimulation r√©alis√©e par Les Artisans Verts`;
    
    if(navigator.share){
        navigator.share({
            title: 'Devis PAC ‚Äî ' + (prenom + ' ' + nom).trim(),
            text: text
        }).catch(()=>{});
    }else{
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(text).then(()=>{
            const bd=document.getElementById('statusBadge');
            const oldTxt=document.getElementById('statusText').textContent;
            document.getElementById('statusText').textContent='‚úì Copi√© !';
            setTimeout(()=>{ document.getElementById('statusText').textContent=oldTxt; }, 2000);
        }).catch(()=>{
            window.open('https://api.whatsapp.com/send?text='+encodeURIComponent(text),'_blank');
        });
    }
}

function updatePct(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        tt = lockTTC ? (D.TTC[sc] || 0) : (parseFloat(document.getElementById('totalTTCInput').value)||0);
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin + (ad > 0 ? Math.round(ad * 0.12) : 0) + (detail.mairie || 0) + (document.getElementById("checkPrevisite").checked ? (parseFloat(document.getElementById("coutPrevisite").value) || 200) : 0);
            }else{ ch = D.COUT[sc] || 0; }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
            ch += (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
            ch += (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
            if(document.getElementById('checkPrevisite').checked) ch += parseFloat(document.getElementById('coutPrevisite').value)||0;
        }
    }else{ ch=getCoutFromDetail(sc, ad); }
    
    let ce = lastCEEDetailPrime;
    let ceForMarge = ce;
    let taForMarge = ad + ceForMarge;
    
    const chForMarge = ch - getPassThrough();
    const ta=ad+ce;
    const rb=tt-ta;
    
    let po=parseFloat(document.getElementById('racPourcent').value)||0;
    if(po>100)po=100; if(po<0)po=0;
    document.getElementById('racPourcent').value=Math.round(po);
    const mo=Math.round(rb*(po/100));
    document.getElementById('racOffert').value=mo;
    
    calcRAC(rb,chForMarge,ta,taForMarge,tt);
}

function updateAmt(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        tt = lockTTC ? (D.TTC[sc] || 0) : (parseFloat(document.getElementById('totalTTCInput').value)||0);
    }else{ tt=D.TTC[sc]||0; }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin;
            }else{ ch = D.COUT[sc] || 0; }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
            ch += (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
            ch += (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
            if(document.getElementById('checkPrevisite').checked) ch += parseFloat(document.getElementById('coutPrevisite').value)||0;
        }
    }else{ ch=getCoutFromDetail(sc, ad); }
    
    let ce = lastCEEDetailPrime;
    let ceForMarge = ce;
    let taForMarge = ad + ceForMarge;
    
    const chForMarge = ch - getPassThrough();
    const ta=ad+ce;
    const rb=tt-ta;
    
    let mo=parseFloat(document.getElementById('racOffert').value)||0;
    if(mo>rb)mo=rb; if(mo<0)mo=0;
    document.getElementById('racOffert').value=Math.round(mo);
    let po=rb>0?Math.round((mo/rb)*100):0;
    if(po>100)po=100; if(po<0)po=0;
    document.getElementById('racPourcent').value=po;
    
    calcRAC(rb,chForMarge,ta,taForMarge,tt);
}

function reset(){
    document.getElementById('scenario').value='PAC';
    document.getElementById('categorie').value='BLEU';
    document.getElementById('zone').value='H1';
    document.getElementById('etas').value='140-170';
    document.getElementById('surface').value='S>=90';
    document.getElementById('typeLogement').value='maison';
    document.getElementById('rfr').value='';
    document.getElementById('nbPersonnes').value='4';
    document.getElementById('mprResultBloc').style.display='none';
    updateSurfaceOptions();
    document.getElementById('racPourcent').value=0;
    document.getElementById('racOffert').value=0;
    if(mode){
        document.getElementById('prixCumac').value=12.5;
    }
    calc();
}

function checkExport(){
    const nom=document.getElementById('nom').value.trim();
    const prenom=document.getElementById('prenom').value.trim();
    const btn=document.getElementById('exportBtn');
    const wBtn=document.getElementById('whatsappBtn');
    const hint=document.getElementById('exportHint');
    if(nom&&prenom){
        btn.disabled=false; btn.style.cursor='pointer'; btn.style.opacity='1';
        wBtn.disabled=false; wBtn.style.cursor='pointer'; wBtn.style.opacity='1';
        if(hint) hint.style.display='none';
    }else{
        btn.disabled=true; btn.style.cursor='not-allowed'; btn.style.opacity='0.5';
        wBtn.disabled=true; wBtn.style.cursor='not-allowed'; wBtn.style.opacity='0.5';
        if(hint) hint.style.display='block';
    }
}

function sendWhatsApp(){
    if(typeof logExport==='function') logExport('WhatsApp');
    const nom=document.getElementById('nom').value.trim() || 'Client';
    const prenom=document.getElementById('prenom').value.trim() || '';
    const scenario=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const categorie=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zone=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const etas=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const surface=getSurfaceLabel();
    const ttc=document.getElementById('totalTTC').textContent;
    const aidesMPR=document.getElementById('aidesMPR').textContent;
    const aidesCEE=document.getElementById('aidesCEE').textContent;
    const totalAides=document.getElementById('totalAides').textContent;
    const rac=document.getElementById('resteCharge').textContent;
    const message=`üè† *Demande de devis - Les Artisans Verts*%0A%0Aüë§ *Client :* ${prenom} ${nom}%0A%0Aüìã *Configuration :*%0A‚Ä¢ Sc√©nario : ${scenario}%0A‚Ä¢ ${categorie}%0A‚Ä¢ ${zone}%0A‚Ä¢ ${surface}%0A‚Ä¢ ${etas}%0A%0Aüí∞ *Montants :*%0A‚Ä¢ Total TTC : ${ttc}%0A‚Ä¢ Aides MPR : ${aidesMPR}%0A‚Ä¢ Aides CEE : ${aidesCEE}%0A‚Ä¢ Total aides : ${totalAides}%0A‚Ä¢ Reste √† charge : ${rac}%0A%0AJe souhaite obtenir un devis d√©taill√©.`;
    window.open(`https://api.whatsapp.com/send?text=${message}`, '_blank');
}

function exportPDF(){
    if(typeof logExport==='function') logExport('PDF');
    const nom=document.getElementById('nom').value.trim() || 'Client';
    const prenom=document.getElementById('prenom').value.trim() || '';
    document.getElementById('printTitle').textContent=`Dossier ‚Äî ${prenom} ${nom}`.trim();
    document.getElementById('printDate').textContent=`Date: ${new Date().toLocaleDateString('fr-FR')}`;
    document.getElementById('printScenario').textContent=document.getElementById('scenarioSummary').textContent;
    document.getElementById('printTTC').textContent=document.getElementById('totalTTC').textContent;
    document.getElementById('printMPR').textContent=document.getElementById('aidesMPR').textContent;
    document.getElementById('printCEE').textContent=document.getElementById('aidesCEE').textContent;
    document.getElementById('printTotalAides').textContent=document.getElementById('totalAides').textContent;
    document.getElementById('printPct').textContent=document.getElementById('racPourcent').value;
    document.getElementById('printOffert').textContent=document.getElementById('racOffert').value+' ‚Ç¨';
    document.getElementById('printRAC').textContent=document.getElementById('resteCharge').textContent;
    const badge=document.getElementById('statusBadge');
    const printStatus=document.getElementById('printStatus');
    printStatus.textContent=document.getElementById('statusText').textContent;
    if(badge.classList.contains('ok')){ printStatus.style.background='#d1f4e0'; printStatus.style.color='#0d7f3f'; }
    else{ printStatus.style.background='#f8d7da'; printStatus.style.color='#721c24'; }
    window.print();
}

// ============================================
// AUTHENTIFICATION PAR COMMERCIAL (API)
// ============================================
const API_URL = 'https://script.google.com/macros/s/AKfycbwP1Nu60KfLu6iKNk7SMfkJoaq5_UbzcEtwnlBm5r1XbDYz8T16zayfPWynm0Zd_4Th/exec';
const FALLBACK_USERS = {
    'ishay':   { pass:'lav',       name:'Ishay',       role:'admin' },
    'admin':   { pass:'gamberge',  name:'Admin',       role:'admin' },
    'mendy':   { pass:'mendy5786', name:'Mendy',       role:'commercial' },
    'david':   { pass:'david26',   name:'David',       role:'commercial' },
    'sarah':   { pass:'sarah26',   name:'Sarah',       role:'commercial' },
    'marc':    { pass:'marc26',    name:'Marc',        role:'commercial' },
    'julie':   { pass:'julie26',   name:'Julie',       role:'commercial' },
    'thomas':  { pass:'thomas26',  name:'Thomas',      role:'commercial' },
};
let currentUser = null;
let useAPI = false;

function apiCall(params, callback, errorCallback) {
    if (!API_URL) { if(errorCallback) errorCallback('Pas de serveur'); return; }
    const qs = Object.entries(params).map(([k,v])=>k+'='+encodeURIComponent(v)).join('&');
    fetch(API_URL + '?' + qs, {redirect:'follow'})
        .then(r => r.text())
        .then(txt => {
            let d;
            try { d = JSON.parse(txt); } catch(e) {
                const m = txt.match(/\{[\s\S]*\}/);
                if(m) try { d = JSON.parse(m[0]); } catch(e2){}
            }
            if(d) callback(d);
            else if(errorCallback) errorCallback('R√©ponse invalide');
        })
        .catch(e => { if(errorCallback) errorCallback(e.message); });
}

function doLogin(){
    const u = document.getElementById('loginUser').value.trim().toLowerCase();
    const p = document.getElementById('loginPass').value;
    const errEl = document.getElementById('loginError');
    errEl.style.display = 'none';
    if(!u){ errEl.textContent='Veuillez saisir un identifiant'; errEl.style.display='block'; return; }

    if(API_URL) {
        // API mode
        errEl.textContent = 'Connexion...'; errEl.style.display='block'; errEl.style.color='#6b7280';
        apiCall({action:'login', user:u, pass:p}, function(d){
            errEl.style.color = '#dc2626';
            if(d.success){
                useAPI = true;
                const usr = d.user || {};
                currentUser = {
                    id: usr.username || u,
                    name: usr.name || u,
                    role: usr.role || 'commercial'
                };
                try{ localStorage.setItem('pac_user', JSON.stringify(currentUser)); localStorage.setItem('pac_api','1'); }catch(e){}
                showApp();
            } else {
                errEl.textContent = d.error || 'Identifiants incorrects';
                errEl.style.display = 'block';
            }
        }, function(err){
            // Fallback local
            errEl.style.color = '#dc2626';
            doLoginLocal(u, p, errEl);
        });
    } else {
        doLoginLocal(u, p, errEl);
    }
}
function doLoginLocal(u, p, errEl){
    const account = FALLBACK_USERS[u];
    if(!account || account.pass !== p){
        errEl.textContent = 'Identifiant ou mot de passe incorrect';
        errEl.style.display = 'block';
        errEl.style.color = '#dc2626';
        return;
    }
    useAPI = false;
    currentUser = { id:u, name:account.name, role:account.role };
    try{ localStorage.setItem('pac_user', JSON.stringify(currentUser)); localStorage.removeItem('pac_api'); }catch(e){}
    showApp();
    logAction('Connexion (local)', account.name);
}
document.getElementById('loginPass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
document.getElementById('loginUser').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

function doLogout(){
    logAction('D√©connexion', currentUser ? currentUser.name : '');
    currentUser = null;
    try{ localStorage.removeItem('pac_user'); localStorage.removeItem('pac_api'); }catch(e){}
    location.reload();
}

function goToLogin(){
    currentUser = null;
    try{ localStorage.removeItem('pac_user'); }catch(e){}
    document.getElementById('appScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
}

function doGuestLogin(){
    currentUser = { id:'guest', name:'Client', role:'guest' };
    try{ localStorage.setItem('pac_user', JSON.stringify(currentUser)); }catch(e){}
    showApp();
}

function switchView(v){
    if(v === 'fournisseur'){
        mode = 1;
        document.getElementById('mainContent').classList.add('fournisseur-mode');
        document.getElementById('togFournisseur').classList.add('active');
        document.getElementById('togClient').classList.remove('active');
        logAction('Vue fournisseur', '');
    } else {
        mode = 0;
        document.getElementById('mainContent').classList.remove('fournisseur-mode');
        document.getElementById('togClient').classList.add('active');
        document.getElementById('togFournisseur').classList.remove('active');
    }
    try{ calc(); }catch(e){}
}

function showApp(){
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';

    const isGuest = !currentUser || currentUser.role === 'guest';

    if(isGuest){
        // Vue client uniquement
        mode = 0;
        document.getElementById('mainContent').classList.remove('fournisseur-mode');
        document.getElementById('guestBar').style.display = 'flex';
        document.getElementById('userBar').style.display = 'none';
    } else {
        // Commercial/admin : vue fournisseur par d√©faut
        mode = 1;
        document.getElementById('mainContent').classList.add('fournisseur-mode');
        document.getElementById('guestBar').style.display = 'none';
        document.getElementById('userBar').style.display = 'flex';
        document.getElementById('userNameDisplay').textContent = currentUser.name;
        document.getElementById('userRoleDisplay').textContent = currentUser.role === 'admin' ? 'üëë Admin' : 'üìä Commercial';
        // Toggle default to fournisseur
        document.getElementById('togFournisseur').classList.add('active');
        document.getElementById('togClient').classList.remove('active');
    }

    try { updateSurfaceOptions(); } catch(e){}
    try { calc(); } catch(e){}
    try { buildBaremeTable(); } catch(e){}
    try { calcBareme(); } catch(e){}
    try { syncEtas(); } catch(e){}
    try { calcDim(); } catch(e){}
}

function checkAutoLogin(){
    try{
        const stored = localStorage.getItem('pac_user');
        if(stored){
            const data = JSON.parse(stored);
            if(data && data.id){
                if(localStorage.getItem('pac_api')) useAPI = true;
                currentUser = data;
                showApp();
                return true;
            }
        }
    }catch(e){}
    return false;
}

// ============================================
// CHANGEMENT DE MOT DE PASSE
// ============================================
function openPwdModal(){
    document.getElementById('pwdOld').value = '';
    document.getElementById('pwdNew').value = '';
    document.getElementById('pwdConfirm').value = '';
    document.getElementById('pwdError').style.display = 'none';
    document.getElementById('pwdSuccess').style.display = 'none';
    document.getElementById('pwdModal').classList.add('active');
}
function doChangePassword(){
    const oldP = document.getElementById('pwdOld').value;
    const newP = document.getElementById('pwdNew').value;
    const conf = document.getElementById('pwdConfirm').value;
    const errEl = document.getElementById('pwdError');
    const okEl = document.getElementById('pwdSuccess');
    errEl.style.display = 'none';
    okEl.style.display = 'none';

    if(!oldP || !newP){ errEl.textContent='Tous les champs sont requis'; errEl.style.display='block'; return; }
    if(newP.length < 4){ errEl.textContent='Minimum 4 caract√®res'; errEl.style.display='block'; return; }
    if(newP !== conf){ errEl.textContent='Les mots de passe ne correspondent pas'; errEl.style.display='block'; return; }

    if(useAPI && API_URL){
        errEl.textContent = 'Modification...'; errEl.style.display='block'; errEl.style.color='#6b7280';
        apiCall({action:'changePassword', user:currentUser.id, oldPass:oldP, newPass:newP}, function(d){
            errEl.style.color = '#dc2626';
            if(d.success){
                errEl.style.display = 'none';
                okEl.textContent = '‚úÖ Mot de passe modifi√© !';
                okEl.style.display = 'block';
                setTimeout(()=>{ document.getElementById('pwdModal').classList.remove('active'); }, 1500);
            } else {
                errEl.textContent = d.error || 'Erreur';
                errEl.style.display = 'block';
            }
        }, function(err){
            errEl.textContent = 'Erreur serveur: ' + err;
            errEl.style.display = 'block';
            errEl.style.color = '#dc2626';
        });
    } else {
        // Mode local: update FALLBACK_USERS
        const account = FALLBACK_USERS[currentUser.id];
        if(!account){ errEl.textContent='Compte introuvable'; errEl.style.display='block'; return; }
        if(account.pass !== oldP){ errEl.textContent='Ancien mot de passe incorrect'; errEl.style.display='block'; return; }
        account.pass = newP;
        okEl.textContent = '‚úÖ Modifi√© (session uniquement en mode local)';
        okEl.style.display = 'block';
        logAction('Changement mot de passe', currentUser.name);
        setTimeout(()=>{ document.getElementById('pwdModal').classList.remove('active'); }, 1500);
    }
}

// ============================================
// JOURNAL DES MODIFICATIONS
// ============================================
function getJournal(){
    try{ return JSON.parse(localStorage.getItem('pac_journal') || '[]'); }catch(e){ return []; }
}
function saveJournal(j){
    try{
        if(j.length > 200) j = j.slice(j.length - 200);
        localStorage.setItem('pac_journal', JSON.stringify(j));
    }catch(e){}
}
function logAction(action, detail){
    const entry = {
        date: new Date().toISOString(),
        user: currentUser ? currentUser.name : '?',
        role: currentUser ? currentUser.role : '?',
        action: action,
        detail: detail || ''
    };
    // Local journal
    const j = getJournal();
    j.push(entry);
    saveJournal(j);
    // API journal (fire and forget)
    if(useAPI && API_URL){
        apiCall({action:'log', user:entry.user, logAction:action, detail:detail||''}, function(){}, function(){});
    }
}
function openHistory(){
    if(useAPI && API_URL){
        // Fetch from server
        const body = document.getElementById('historyBody');
        body.innerHTML = '<div class="hist-empty">Chargement...</div>';
        document.getElementById('historyModal').classList.add('active');
        apiCall({action:'getJournal', limit:'100'}, function(d){
            renderJournal(d.journal || []);
        }, function(err){
            // Fallback to local
            renderJournal(getJournal().reverse().slice(0, 100));
        });
    } else {
        renderJournal(getJournal().reverse().slice(0, 100));
        document.getElementById('historyModal').classList.add('active');
    }
}
function renderJournal(entries){
    const body = document.getElementById('historyBody');
    if(!entries || entries.length === 0){
        body.innerHTML = '<div class="hist-empty">Aucune entr√©e dans le journal</div>';
        return;
    }
    let html = '';
    entries.forEach(e => {
        const d = new Date(e.date);
        const dateStr = d.toLocaleDateString('fr-FR') + ' ' + d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
        html += '<div class="hist-entry">';
        html += '<div class="hist-meta"><span class="hist-user">' + (e.user||'?') + '</span><span class="hist-date">' + dateStr + '</span></div>';
        html += '<div class="hist-action">' + (e.action||'') + '</div>';
        if(e.detail) html += '<div class="hist-detail">' + e.detail + '</div>';
        html += '</div>';
    });
    if(currentUser && currentUser.role === 'admin'){
        html += '<div class="hist-clear"><button onclick="clearJournal()">üóëÔ∏è Vider le journal</button></div>';
    }
    body.innerHTML = html;
}
function clearJournal(){
    if(confirm('Vider tout le journal ?')){
        try{ localStorage.setItem('pac_journal','[]'); }catch(e){}
        openHistory();
    }
}

// Log key actions
function logScenarioChange(){
    const sc = document.getElementById('scenario').value;
    logAction('Changement sc√©nario', sc);
}
function logClientChange(){
    const nom = document.getElementById('nom').value.trim();
    const prenom = document.getElementById('prenom').value.trim();
    if(nom || prenom) logAction('Client modifi√©', (prenom + ' ' + nom).trim());
}
function logExport(type){
    const nom = document.getElementById('nom').value.trim() || 'Client';
    logAction('Export ' + type, nom);
}
function logRACChange(){
    const pct = document.getElementById('racPourcent').value;
    const offert = document.getElementById('racOffert').value;
    logAction('RAC modifi√©', pct + '% / ' + offert + ' ‚Ç¨');
}


// ============================================
// SCROLL GRADIENT
// ============================================
(function() {
    const gradients = [
        'linear-gradient(90deg, #34d399, #22d3ee, #818cf8)',
        'linear-gradient(90deg, #22d3ee, #818cf8, #c084fc)',
        'linear-gradient(90deg, #818cf8, #c084fc, #f472b6)',
        'linear-gradient(90deg, #c084fc, #f472b6, #fb923c)',
        'linear-gradient(90deg, #f472b6, #fb923c, #fbbf24)',
        'linear-gradient(90deg, #fb923c, #fbbf24, #34d399)',
    ];
    let ticking = false;
    function updateScrollGradient() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = docHeight > 0 ? scrollTop / docHeight : 0;
        const idx = Math.min(Math.floor(scrollPercent * gradients.length), gradients.length - 1);
        document.documentElement.style.setProperty('--scroll-gradient', gradients[idx]);
        ticking = false;
    }
    window.addEventListener('scroll', function() {
        if (!ticking) { requestAnimationFrame(updateScrollGradient); ticking = true; }
    }, { passive: true });
    updateScrollGradient();
})();

// ============================================
// DIMENSIONNEMENT PAC
// ============================================

// Tbase par d√©partement (¬∞C) - valeurs conventionnelles
const DEPT_TBASE = {
    '01':-10,'02':-9,'03':-8,'04':-8,'05':-10,'06':-5,'07':-6,'08':-10,'09':-8,'10':-10,
    '11':-5,'12':-8,'13':-5,'14':-7,'15':-10,'16':-5,'17':-5,'18':-8,'19':-8,'20':-2,
    '2A':-2,'2B':-2,'21':-10,'22':-4,'23':-8,'24':-5,'25':-12,'26':-6,'27':-7,'28':-7,
    '29':-4,'30':-5,'31':-5,'32':-5,'33':-5,'34':-5,'35':-5,'36':-7,'37':-7,'38':-10,
    '39':-10,'40':-5,'41':-7,'42':-8,'43':-10,'44':-5,'45':-7,'46':-5,'47':-5,'48':-10,
    '49':-5,'50':-5,'51':-10,'52':-10,'53':-5,'54':-12,'55':-10,'56':-4,'57':-12,'58':-10,
    '59':-9,'60':-7,'61':-7,'62':-9,'63':-8,'64':-5,'65':-5,'66':-5,'67':-12,'68':-12,
    '69':-8,'70':-12,'71':-10,'72':-7,'73':-12,'74':-12,'75':-7,'76':-7,'77':-7,'78':-7,
    '79':-5,'80':-9,'81':-5,'82':-5,'83':-3,'84':-6,'85':-5,'86':-5,'87':-8,'88':-12,
    '89':-10,'90':-12,'91':-7,'92':-7,'93':-7,'94':-7,'95':-7
};

let currentG = 0.95;

// ============ DIMENSIONNEMENT ‚Äî Ann√©e ‚Üí G auto ============

// Table G par ann√©e de construction
function getGFromAnnee(annee) {
    if (annee >= 2021) return 0.6;   // RE 2020
    if (annee >= 2013) return 0.7;   // RT 2012
    if (annee >= 2006) return 0.75;  // RT 2005
    if (annee >= 2001) return 0.8;
    if (annee >= 1990) return 0.95;  // RT 2000
    if (annee >= 1983) return 1.1;
    if (annee >= 1975) return 1.3;   // 1√®re r√©glementation
    return 1.6;                       // Avant 1975
}

let currentIsolation = 'origine';

function evalIsolation() {
    const checks = document.querySelectorAll('#isoChecklist input[type="checkbox"]:checked');
    const count = checks.length;
    let recentCount = 0;
    checks.forEach(cb => {
        const quand = cb.closest('.iso-check').querySelector('.iso-quand');
        if (quand && quand.value === 'recent') recentCount++;
    });

    // D√©termination auto de l'√©tat
    if (count === 0) {
        currentIsolation = 'origine';
    } else if (count >= 3 && recentCount >= 2) {
        currentIsolation = 'totale';
    } else {
        currentIsolation = 'partielle';
    }

    // Affichage
    const names = { origine: '√âtat d\'origine / Non pr√©cis√©', partielle: 'R√©novation partielle', totale: 'R√©novation totale' };
    const colors = { origine: '#64748b', partielle: '#d97706', totale: '#16a34a' };
    const el = document.getElementById('isoStateName');
    if (el) { el.textContent = names[currentIsolation]; el.style.color = colors[currentIsolation]; }
    calcDim();
}

function selectIsolation(state) { currentIsolation = state; calcDim(); }

function getEffectiveG() {
    const annee = parseInt(document.getElementById('dimAnnee').value) || 2000;
    let g = getGFromAnnee(annee);
    if (currentIsolation === 'partielle') g = Math.max(g - 0.2, 0.5);
    if (currentIsolation === 'totale') g = Math.max(Math.min(g, 0.7), 0.5);
    return g;
}

// ============ BAR√àME PAC ============
const BAREME_PAC = [
    { max: 40, reco: [4] },
    { max: 50, reco: [6] },
    { max: 60, reco: [6, 8] },
    { max: 70, reco: [6, 8] },
    { max: 80, reco: [8] },
    { max: 90, reco: [8, 10] },
    { max: 100, reco: [10] },
    { max: 110, reco: [10, 12] },
    { max: 120, reco: [12] },
    { max: 130, reco: [12, 14] },
    { max: 140, reco: [14] },
    { max: 150, reco: [14, 16] },
    { max: 160, reco: [16] },
    { max: 170, reco: [16, 18] },
    { max: 180, reco: [18] },
    { max: 190, reco: [18, 20] },
    { max: Infinity, reco: [20] }
];

function getBaremePAC(surface) {
    for (const row of BAREME_PAC) {
        if (surface <= row.max) return row.reco;
    }
    return [20];
}

function calcBareme() {
    const s = parseInt(document.getElementById('baremeSurface').value) || 100;
    const reco = getBaremePAC(s);
    const el = document.getElementById('baremeReco');
    const alt = document.getElementById('baremeAlt');
    const hint = document.getElementById('baremeIsoHint');
    const cursor = document.getElementById('baremeCursor');
    const lowEl = document.getElementById('baremeLow');
    const highEl = document.getElementById('baremeHigh');

    // Determine low and high power
    let lowKW, highKW;
    if (reco.length === 2) {
        lowKW = reco[0];
        highKW = reco[1];
    } else {
        // Single recommendation ‚Äî create a range
        lowKW = reco[0];
        highKW = reco[0] < 20 ? reco[0] + 2 : reco[0];
    }

    lowEl.textContent = lowKW + ' kW';
    highEl.textContent = highKW + ' kW';

    // Score: 0 = well insulated (left), 100 = poorly insulated (right)
    const annee = parseInt(document.getElementById('dimAnnee').value) || 2000;
    let score = 50; // default middle

    // Ann√©e factor: older = worse isolation
    if (annee < 1975) score += 20;
    else if (annee < 1990) score += 10;
    else if (annee < 2005) score += 0;
    else if (annee < 2012) score -= 10;
    else score -= 15;

    // Isolation factor
    if (currentIsolation === 'totale') score -= 30;
    else if (currentIsolation === 'partielle') score -= 10;
    else score += 10; // origine

    // Clamp 5-95%
    score = Math.max(5, Math.min(95, score));

    // Position cursor (left = bien isol√© = lowKW)
    cursor.style.left = `calc(${score}% - 12px)`;

    // Determine recommendation
    if (score <= 30) {
        el.textContent = lowKW + ' kW';
        el.style.color = '#16a34a';
        alt.textContent = 'Isolation performante ‚Üí puissance optimis√©e';
        if (hint) hint.textContent = '';
    } else if (score >= 70) {
        el.textContent = highKW + ' kW';
        el.style.color = '#dc2626';
        alt.textContent = 'Isolation faible ‚Üí puissance sup√©rieure conseill√©e';
        if (hint) hint.textContent = '';
    } else {
        el.textContent = lowKW + ' ou ' + highKW + ' kW';
        el.style.color = '#d97706';
        alt.textContent = lowKW + ' kW = √©conomique ¬∑ ' + highKW + ' kW = confort';
        if (hint) hint.textContent = '';
    }

    // Highlight matching row in table
    const maxVals = [40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,9999];
    const rows = document.querySelectorAll('#baremeTableBody tr');
    let matched = false;
    rows.forEach((tr, i) => {
        const isMatch = !matched && s <= maxVals[i];
        tr.style.background = isMatch ? '#f0fdf4' : '';
        tr.style.fontWeight = isMatch ? '600' : '';
        if (isMatch) matched = true;
    });
}

function syncMenageCEE() {
    const cat = document.getElementById('categorie').value;
    document.getElementById('menageCEE').value = (cat === 'BLEU') ? 'tm' : 'autres';
    calcCEEDetail();
}

function syncSurfaces(from) {
    const val = (from === 'bareme')
        ? document.getElementById('baremeSurface').value
        : (from === 'cee')
        ? document.getElementById('ceeSurface').value
        : document.getElementById('dimSurface').value;
    const s = parseInt(val) || 100;
    document.getElementById('baremeSurface').value = s;
    document.getElementById('dimSurface').value = s;
    const ceeSurf = document.getElementById('ceeSurface');
    if (ceeSurf) ceeSurf.value = s;

    // Auto-set surface dropdown (maison)
    const tl = document.getElementById('typeLogement').value;
    const sel = document.getElementById('surface');
    if (tl === 'maison') {
        if (s < 70) sel.value = 'S<70';
        else if (s < 90) sel.value = '70<=S<90';
        else sel.value = 'S>=90';
    } else {
        if (s < 35) sel.value = 'S<35';
        else if (s < 60) sel.value = '35<=S<60';
        else sel.value = 'S>=60';
    }

    calcBareme();
    calcDim();
    calcCEEDetail();
    calc();
}

function buildBaremeTable() {
    const tbody = document.getElementById('baremeTableBody');
    const rows = [
        ['‚â§ 40 m¬≤', '4 kW'], ['50 m¬≤', '6 kW'], ['60 m¬≤', '6 ou 8 kW'],
        ['70 m¬≤', '6 ou 8 kW'], ['80 m¬≤', '8 kW'], ['90 m¬≤', '8 ou 10 kW'],
        ['100 m¬≤', '10 kW'], ['110 m¬≤', '10 ou 12 kW'], ['120 m¬≤', '12 kW'],
        ['130 m¬≤', '12 ou 14 kW'], ['140 m¬≤', '14 kW'], ['150 m¬≤', '14 ou 16 kW'],
        ['160 m¬≤', '16 kW'], ['170 m¬≤', '16 ou 18 kW'], ['180 m¬≤', '18 kW'],
        ['190 m¬≤', '18 ou 20 kW'], ['‚â• 200 m¬≤', '20 kW']
    ];
    const maxVals = [40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,9999];
    tbody.innerHTML = rows.map((r, i) =>
        `<tr data-max="${maxVals[i]}" style="border-top: 1px solid #f1f5f9;">
            <td style="padding: 5px 10px;">${r[0]}</td>
            <td style="padding: 5px 10px; text-align: center; font-weight: 500;">${r[1]}</td>
        </tr>`
    ).join('');
}

function selectG(g) { /* legacy compat */ currentG = g; calcDim(); }

function calcDim() {
    const S = parseFloat(document.getElementById('dimSurface').value) || 0;
    const H = parseFloat(document.getElementById('dimHauteur').value) || 2.5;
    const V = S * H;

    const Tbase = parseFloat(document.getElementById('dimTbase').value) || -7;
    const Tint = parseFloat(document.getElementById('dimTint').value) || 21;
    const deltaT = Tint - Tbase;

    const G = getEffectiveG();
    currentG = G;
    const gDisplay = document.getElementById('dimGDisplay');
    if (gDisplay) gDisplay.textContent = `G = ${G.toFixed(2).replace('.', ',')}`;

    const P = G * V * deltaT;
    const T1 = parseFloat(document.getElementById('dimT1').value) || 60;
    const T2 = parseFloat(document.getElementById('dimT2').value) || 140;

    const puissancePAC = P * T1 / 100;
    const puissanceTotale = P * T2 / 100;
    const puissanceAppoint = puissanceTotale - puissancePAC;

    document.getElementById('dimDeperditions').textContent = Math.round(P).toLocaleString('fr-FR') + ' W';
    document.getElementById('dimDepFormula').textContent = `${G.toFixed(2).replace('.', ',')} √ó ${Math.round(V)} √ó ${deltaT}`;

    document.getElementById('dimPuissancePAC').textContent = (puissancePAC / 1000).toFixed(1).replace('.', ',') + ' kW';
    document.getElementById('dimPuissancePACDetail').textContent = `${Math.round(P).toLocaleString('fr-FR')} W √ó ${T1}%`;

    document.getElementById('dimPuissanceAppoint').textContent = (puissanceAppoint / 1000).toFixed(1).replace('.', ',') + ' kW';
    document.getElementById('dimPuissanceAppointDetail').textContent = `(P √ó ${T2}% ‚àí PAC)`;

    document.getElementById('dimPuissanceTotale').textContent = (puissanceTotale / 1000).toFixed(1).replace('.', ',') + ' kW';
}

// ============================================
// INIT
// ============================================
dbg('üöÄ Init start');
checkAutoLogin();
dbg('üèÅ Init complete');
// Triple-tap to show debug panel
</script>
</body>
</html>
