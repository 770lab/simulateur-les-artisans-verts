<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Aides PAC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .lock-btn {
            background: #f5f5f7;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lock-btn:hover {
            background: #e8e8ed;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
        }

        .modal-content h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .modal-content input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 16px;
        }

        .modal-content button {
            width: 100%;
            padding: 12px;
            background: #0071e3;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-content button:hover {
            background: #0077ed;
        }

        /* Modal Recommandations */
        .reco-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .reco-header {
            padding: 30px 40px 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .reco-header h2 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .reco-header p {
            color: #86868b;
            font-size: 14px;
        }

        .reco-filters {
            padding: 20px 40px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .reco-filters h3 {
            font-size: 14px;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .filter-item label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .filter-item select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 14px;
        }

        .reco-tabs {
            display: flex;
            padding: 0 40px;
            background: white;
            border-bottom: 2px solid #e5e7eb;
        }

        .reco-tab {
            padding: 16px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #86868b;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reco-tab:hover {
            color: #1d1d1f;
        }

        .reco-tab.active {
            color: #0071e3;
            border-bottom-color: #0071e3;
        }

        .reco-body {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
        }

        .reco-content {
            display: none;
        }

        .reco-content.active {
            display: block;
        }

        .reco-grid {
            display: grid;
            gap: 16px;
        }

        .reco-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .reco-card:hover {
            border-color: #0071e3;
            box-shadow: 0 4px 20px rgba(0,113,227,0.1);
        }

        .reco-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .reco-rank {
            background: linear-gradient(135deg, #0071e3 0%, #0077ed 100%);
            color: white;
            font-size: 18px;
            font-weight: 700;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reco-scenario {
            flex: 1;
            margin-left: 16px;
        }

        .reco-scenario h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .reco-scenario p {
            font-size: 13px;
            color: #86868b;
        }

        .reco-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .reco-metric {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
        }

        .reco-metric-label {
            font-size: 11px;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .reco-metric-value {
            font-size: 18px;
            font-weight: 700;
        }

        .reco-metric-value.positive {
            color: #34c759;
        }

        .reco-metric-value.negative {
            color: #ff3b30;
        }

        .reco-score {
            text-align: center;
            padding: 12px;
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            color: white;
            border-radius: 8px;
            font-weight: 700;
        }

        .reco-score.good {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%);
        }

        .reco-score.medium {
            background: linear-gradient(135deg, #ff9500 0%, #ffb340 100%);
        }

        .reco-score.low {
            background: linear-gradient(135deg, #ff3b30 0%, #ff6961 100%);
        }

        .reco-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .btn-apply {
            flex: 1;
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-apply:hover {
            background: #0077ed;
        }

        .btn-close-modal {
            background: #f5f5f7;
            color: #1d1d1f;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-close-modal:hover {
            background: #e8e8ed;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 28px;
            padding: 30px 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #1d1d1f;
        }

        .form-group small {
            display: block;
            font-size: 12px;
            color: #86868b;
            margin-top: 4px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 4px rgba(0,113,227,0.1);
        }

        .fournisseur-only {
            display: none;
        }

        .fournisseur-mode .fournisseur-only {
            display: block;
        }
        
        .fournisseur-mode .ttc-readonly {
            display: none !important;
        }

        .client-only {
            display: block;
        }

        .fournisseur-mode .client-only {
            display: none;
        }

        .results-sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
            margin-bottom: 16px;
        }

        .summary-header {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .scenario-label {
            font-size: 13px;
            color: #1d1d1f;
            margin-bottom: 20px;
            padding: 14px;
            background: #f5f5f7;
            border-radius: 8px;
            border-left: 4px solid #0071e3;
            line-height: 1.5;
        }
        
        .scenario-label strong {
            font-weight: 600;
        }
        
        .scenario-label .separator {
            color: #86868b;
            margin: 0 8px;
        }
        
        .color-bleu { color: #0071e3; }
        .color-jaune { color: #fbbf24; }
        .color-violet { color: #8b5cf6; }
        .color-rose { color: #ec4899; }

        .amount-row {
            margin-bottom: 12px;
        }

        .amount-label {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 4px;
        }

        .amount-value {
            font-size: 26px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .amount-value.highlight {
            color: #34c759;
        }

        .rac-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .rac-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .rac-item input {
            font-size: 22px;
            font-weight: 700;
            color: #1d1d1f;
            text-align: center;
            padding: 8px 10px;
        }

        .final-amount {
            text-align: right;
            padding-top: 20px;
            border-top: 2px solid #f5f5f7;
        }

        .final-amount .amount-label {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 6px;
        }

        .final-amount .amount-value {
            font-size: 34px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .status-badge {
            display: inline-block;
            padding: 14px 32px;
            font-weight: 700;
            font-size: 18px;
            border-radius: 12px;
            text-align: center;
            width: 100%;
            letter-spacing: 0.5px;
            transition: all 0.3s;
        }

        .status-badge.ok {
            background: #d1f4e0;
            color: #0d7f3f;
        }

        .status-badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.danger {
            background: #f8d7da;
            color: #721c24;
        }

        .btn-reset {
            background: #f5f5f7;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-reset:hover {
            background: #e8e8ed;
        }

        .btn-reco {
            background: linear-gradient(135deg, #ff9500 0%, #ffb340 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3);
        }

        .btn-reco:hover {
            background: linear-gradient(135deg, #ffb340 0%, #ff9500 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 149, 0, 0.4);
        }

        .footer {
            text-align: center;
            padding: 8px 20px 8px;
            color: #86868b;
            font-size: 13px;
        }

        @media print {
            .header, .lock-btn, .btn-reset, .footer, .parameters-section, .main-content {
                display: none !important;
            }
            
            #printArea {
                display: block !important;
            }

            body {
                background: white;
            }

            @page {
                margin: 15mm;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .results-sidebar {
                position: static;
            }

            .reco-modal-content {
                width: 100%;
                max-height: 100vh;
                border-radius: 0;
            }

            .reco-tabs {
                overflow-x: auto;
            }
        }

        .note-small {
            font-size: 11px;
            color: #86868b;
            text-align: center;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 12px 20px; border-radius: 10px; font-weight: 700; font-size: 15px; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);">
                        üè† LES ARTISANS VERTS
                    </div>
                    <h1 style="margin: 0; font-size: 22px;">Simulateur Aides PAC</h1>
                </div>
                <button class="lock-btn" id="lockBtn">
                    <span id="lockIcon">üîí</span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <h2>Acc√®s Vue fournisseur</h2>
            <input type="password" id="passwordInput" placeholder="Mot de passe">
            <button id="unlockBtn">D√©verrouiller</button>
        </div>
    </div>

    <!-- Modal Recommandations -->
    <div class="modal" id="recoModal">
        <div class="reco-modal-content">
            <div class="reco-header">
                <h2>üéØ Recommandations Automatiques</h2>
                <p>Analyse intelligente de 320 sc√©narios possibles</p>
            </div>

            <div class="reco-filters">
                <h3>Filtres (optionnels)</h3>
                <div class="filter-grid">
                    <div class="filter-item">
                        <label>Zone climatique</label>
                        <select id="filterZone">
                            <option value="">Toutes</option>
                            <option value="H1">H1</option>
                            <option value="H2">H2</option>
                            <option value="H3">H3</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Surface</label>
                        <select id="filterSurface">
                            <option value="">Toutes</option>
                            <option value="S<70">S < 70 m¬≤</option>
                            <option value="70<S<90">70‚Äì90 m¬≤</option>
                            <option value="90<S<110">90‚Äì110 m¬≤</option>
                            <option value="110<S<130">110‚Äì130 m¬≤</option>
                            <option value="S>130">> 130 m¬≤</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>Cat√©gorie MPR</label>
                        <select id="filterCategorie">
                            <option value="">Toutes</option>
                            <option value="BLEU">MPR Bleu</option>
                            <option value="JAUNE">MPR Jaune</option>
                            <option value="VIOLET">MPR Violet</option>
                            <option value="ROSE">MPR Rose</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="reco-tabs">
                <button class="reco-tab active" data-tab="marge">üí∞ Top Marge</button>
                <button class="reco-tab" data-tab="rac">üí≥ RAC Minimal</button>
                <button class="reco-tab" data-tab="equilibre">‚öñÔ∏è √âquilibre</button>
                <button class="reco-tab" data-tab="vendable">üéØ Plus Vendable</button>
            </div>

            <div class="reco-body">
                <div class="reco-content active" id="recoMarge">
                    <div class="loading">Calcul en cours</div>
                </div>
                <div class="reco-content" id="recoRAC">
                    <div class="loading">Calcul en cours</div>
                </div>
                <div class="reco-content" id="recoEquilibre">
                    <div class="loading">Calcul en cours</div>
                </div>
                <div class="reco-content" id="recoVendable">
                    <div class="loading">Calcul en cours</div>
                </div>
            </div>

            <div style="padding: 20px 40px; border-top: 1px solid #e5e7eb; background: #f9fafb;">
                <button class="btn-close-modal" onclick="closeRecoModal()">Fermer</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="parameters-section">
            <div class="card">
                <h2 class="card-title">Informations Client</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div>
                        <label>Nom</label>
                        <input type="text" id="nom" placeholder="Nom du client" oninput="checkExport()">
                    </div>
                    <div>
                        <label>Pr√©nom</label>
                        <input type="text" id="prenom" placeholder="Pr√©nom du client" oninput="checkExport()">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">Param√®tres</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="scenario">Sc√©nario</label>
                        <select id="scenario" onchange="calc()">
                            <option value="PAC">PAC</option>
                            <option value="PAC + BALLON √âLECTRIQUE">PAC + BALLON √âLECTRIQUE</option>
                            <option value="PAC + BALLON THERMO">PAC + BALLON THERMO</option>
                            <option value="PAC + SSC">PAC + SSC</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="categorie">Cat√©gorie MPR</label>
                        <select id="categorie" onchange="calc()">
                            <option value="BLEU">MPR Bleu</option>
                            <option value="JAUNE">MPR Jaune</option>
                            <option value="VIOLET">MPR Violet</option>
                            <option value="ROSE">MPR Rose</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="zone">Zone climatique</label>
                        <select id="zone" onchange="calc()">
                            <option value="H1">H1</option>
                            <option value="H2">H2</option>
                            <option value="H3">H3</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="etas">Plage d'ETAS</label>
                        <select id="etas" onchange="calc()">
                            <option value="111-140">111 < ETAS < 140</option>
                            <option value="140-170" selected>140 < ETAS < 170</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: 0; grid-column: 1 / -1;">
                        <label for="surface">Surface S (m¬≤)</label>
                        <select id="surface" onchange="calc()">
                            <option value="S<70">S < 70 m¬≤</option>
                            <option value="70<S<90">70‚Äì90 m¬≤</option>
                            <option value="90<S<110" selected>90‚Äì110 m¬≤</option>
                            <option value="110<S<130">110‚Äì130 m¬≤</option>
                            <option value="S>130">> 130 m¬≤</option>
                        </select>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn-reset" onclick="reset()">R√©initialiser</button>
                    <button class="btn-reco fournisseur-only" onclick="openRecoModal()">üéØ Recommandations</button>
                </div>
            </div>

            <div class="card fournisseur-only">
                <h2 class="card-title">Co√ªts (Vue Fournisseur)</h2>
                
                <div style="background: #f5f5f7; padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                    <!-- PAC -->
                    <div style="display: grid; grid-template-columns: 80px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">PAC</label>
                        <input type="number" id="coutPAC" value="2900" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qtePAC" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPAC">2 900 ‚Ç¨</div>
                    </div>
                    
                    <!-- Ballon -->
                    <div style="display: grid; grid-template-columns: 80px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Ballon</label>
                        <input type="number" id="coutBallon" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteBallon" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalBallon">0 ‚Ç¨</div>
                    </div>
                    
                    <!-- Accessoires -->
                    <div style="display: grid; grid-template-columns: 80px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Access.</label>
                        <input type="number" id="coutAccessoires" value="500" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAccessoires" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAccessoires">500 ‚Ç¨</div>
                    </div>
                    
                    <!-- Admin -->
                    <div style="display: grid; grid-template-columns: 80px 1fr 80px 100px; gap: 8px; align-items: center;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Admin</label>
                        <input type="number" id="coutAdmin" value="300" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAdmin" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAdmin">300 ‚Ç¨</div>
                    </div>
                </div>
                
                <small style="font-size: 11px; color: #86868b; margin-bottom: 12px; display: block; text-align: center;">
                    <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="lockCoutHT" checked onchange="calc()"> Verrouiller les co√ªts (auto selon sc√©nario)
                    </label>
                </small>
                
                <div style="background: #0071e3; color: white; padding: 14px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; font-size: 14px;">TOTAL CO√õT HT</span>
                        <span style="font-size: 20px; font-weight: 700;" id="coutTotalHTDisplay">6 200 ‚Ç¨</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="prixCumac">Prix cumac (‚Ç¨/MWhcumac)</label>
                        <input type="number" id="prixCumac" value="11.78" step="0.01" oninput="calc()">
                        <small>
                            <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="lockPrice" checked onchange="calc()"> Verrouiller (auto selon d√©l√©gataire)
                            </label>
                        </small>
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label>D√©l√©gataire</label>
                        <input type="text" id="delegataire" value="" readonly style="background: #f5f5f7; color: #1d1d1f;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0; grid-column: 1 / -1;">
                        <label>kWh cumac</label>
                        <input type="text" id="kwhCumac" value="" readonly style="background: #f5f5f7; color: #1d1d1f; font-weight: 600;">
                    </div>
                </div>
            </div>

            <div style="padding-bottom: 40px;"></div>
        </div>

        <div class="results-sidebar">
            <div class="summary-card" style="margin-bottom: 0;">
                <div class="scenario-label" id="scenarioSummary" style="font-size: 14px; margin-bottom: 20px; padding: 12px; background: #f5f5f7; border-radius: 8px;">‚Äî</div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div class="ttc-readonly" style="margin-bottom: 12px;">
                            <div class="amount-label">TOTAL TTC</div>
                            <div class="amount-value" id="totalTTC" style="text-align: right;">‚Äî</div>
                        </div>
                        
                        <div class="fournisseur-only" style="margin-bottom: 12px;">
                            <div class="amount-label">TOTAL TTC</div>
                            <input type="number" id="totalTTCInput" value="10890" step="1" oninput="updateFromTTC()" style="font-size: 24px; font-weight: 700; text-align: right; padding: 10px 14px; width: 100%; border: 2px solid #0071e3; border-radius: 8px; background: white; margin-bottom: 6px;">
                            <small style="font-size: 11px; color: #86868b; margin-top: 4px;">
                                <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                                    <input type="checkbox" id="lockTTC" checked onchange="calc()"> Verrouiller (auto selon sc√©nario)
                                </label>
                            </small>
                        </div>

                        <div class="fournisseur-only" style="margin-bottom: 12px;">
                            <div class="amount-label">CO√õT HT</div>
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <small style="font-size: 11px; color: #86868b;">Co√ªt mat√©riel + pose + admin</small>
                                <div class="amount-value" id="displayCoutHT" style="text-align: right;">‚Äî</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <div class="amount-label">AIDES MPR</div>
                                <div class="amount-value" id="aidesMPR" style="text-align: right;">‚Äî</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <div class="amount-label">AIDES CEE</div>
                                <div class="amount-value" id="aidesCEE" style="text-align: right;">‚Äî</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <div class="amount-label">TOTAL DES AIDES</div>
                                <div class="amount-value highlight" id="totalAides" style="text-align: right;">‚Äî</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <div class="amount-label">RESTE √Ä CHARGE</div>
                                <div class="amount-value" id="resteCharge" style="text-align: right;">‚Äî</div>
                            </div>
                        </div>

                        <div class="fournisseur-only" style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <div class="amount-label">MARGE FINALE (HT)</div>
                                <div class="amount-value" id="margeFinal" style="text-align: right;">‚Äî</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h2 class="summary-header" style="margin-bottom: 8px;">Prise en charge du RAC</h2>
                        
                        <div style="margin-bottom: 10px;">
                            <div class="amount-label">Pourcentage (%)</div>
                            <input type="number" id="racPourcent" value="0" min="0" max="100" step="1" oninput="updatePct()" style="font-size: 24px; font-weight: 700; text-align: center; padding: 10px;">
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <div class="amount-label">RAC offert (‚Ç¨)</div>
                            <input type="number" id="racOffert" value="0" min="0" step="1" oninput="updateAmt()" style="font-size: 24px; font-weight: 700; text-align: center; padding: 10px;">
                        </div>
                        
                        <div class="note-small fournisseur-only" style="margin-bottom: 10px;">Appliqu√© sur le RAC brut. N'affecte pas le prix cumac.</div>

                        <div class="status-badge ok" id="statusBadge" style="margin-bottom: 16px; margin-top: 4px;">DOSSIER OK</div>
                        
                        <button id="exportBtn" disabled style="width: 100%; background: #0071e3; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: not-allowed; opacity: 0.5; transition: all 0.2s; margin-bottom: 12px;">
                            üìÑ Exporter en PDF
                        </button>
                        
                        <button id="whatsappBtn" disabled style="width: 100%; background: #25D366; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: not-allowed; opacity: 0.5; transition: all 0.2s;">
                            üí¨ Demander un devis
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p style="margin: 0;">Propuls√© par 770 Lab</p>
    </div>

    <div id="printArea" style="display: none;">
        <div style="padding: 40px; font-family: -apple-system, sans-serif;">
            <h1 style="font-size: 28px; margin-bottom: 10px;" id="printTitle">Dossier ‚Äî</h1>
            <p style="color: #6b7280; margin-bottom: 30px;" id="printDate"></p>
            
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="font-size: 14px; color: #6b7280; text-transform: uppercase; margin-bottom: 15px;">R√©sum√©</h2>
                <p style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;" id="printScenario"></p>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">TOTAL TTC</div>
                    <div style="font-size: 28px; font-weight: 700;" id="printTTC"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">AIDES MPR</div>
                    <div style="font-size: 28px; font-weight: 700;" id="printMPR"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">AIDES CEE</div>
                    <div style="font-size: 28px; font-weight: 700;" id="printCEE"></div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 12px; color: #6b7280;">TOTAL DES AIDES</div>
                    <div style="font-size: 28px; font-weight: 700; color: #34c759;" id="printTotalAides"></div>
                </div>
            </div>
            
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="font-size: 14px; color: #6b7280; text-transform: uppercase; margin-bottom: 15px;">Prise en charge du RAC</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <div style="font-size: 12px; color: #6b7280;">Pourcentage (%)</div>
                        <div style="font-size: 24px; font-weight: 700;" id="printPct"></div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #6b7280;">RAC offert (‚Ç¨)</div>
                        <div style="font-size: 24px; font-weight: 700;" id="printOffert"></div>
                    </div>
                </div>
                
                <div style="padding-top: 20px; border-top: 2px solid #e5e7eb; text-align: right;">
                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">RESTE √Ä CHARGE</div>
                    <div style="font-size: 36px; font-weight: 700;" id="printRAC"></div>
                </div>
                
                <div style="margin-top: 20px; padding: 16px; border-radius: 12px; text-align: center; font-weight: 700; font-size: 18px;" id="printStatus"></div>
            </div>
            
            <div style="text-align: center; margin-top: 40px; color: #6b7280; font-size: 12px;">
                Propuls√© par 770 Lab
            </div>
        </div>
    </div>

<script>
const D={TTC:{"PAC":10890,"PAC + BALLON √âLECTRIQUE":13750,"PAC + BALLON THERMO":13750,"PAC + SSC":25850},MPR:{"PAC":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON √âLECTRIQUE":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON THERMO":{BLEU:6200,JAUNE:4800,VIOLET:3400,ROSE:0},"PAC + SSC":{BLEU:15000,JAUNE:12000,VIOLET:7000,ROSE:0}},COUT:{"PAC":6200,"PAC + BALLON √âLECTRIQUE":6400,"PAC + BALLON THERMO":7300,"PAC + SSC":11700},COUT_DETAIL:{"PAC":{pac:5400,ballon:0,accessoires:500,admin:300},"PAC + BALLON √âLECTRIQUE":{pac:5400,ballon:200,accessoires:500,admin:300},"PAC + BALLON THERMO":{pac:5400,ballon:1100,accessoires:500,admin:300},"PAC + SSC":{pac:5400,ballon:5500,accessoires:500,admin:300}},CEE:{"140-170":{H1:{PAC:{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON ELECTRIQUE":{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON THERMO":{"S<70":289500,"70<S<90":399420,"90<S<110":564300,"110<S<130":619260,"S>130":894060},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON ELECTRIQUE":{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON THERMO":{"S<70":243700,"70<S<90":335300,"90<S<110":472700,"110<S<130":518500,"S>130":747500},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON ELECTRIQUE":{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON THERMO":{"S<70":175000,"70<S<90":239120,"90<S<110":335300,"110<S<130":367360,"S>130":527660},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}},"111-140":{H1:{PAC:{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON ELECTRIQUE":{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON THERMO":{"S<70":253200,"70<S<90":348600,"90<S<110":491700,"110<S<130":539400,"S>130":777900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON ELECTRIQUE":{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON THERMO":{"S<70":213450,"70<S<90":292950,"90<S<110":412200,"110<S<130":451950,"S>130":650700},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON ELECTRIQUE":{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON THERMO":{"S<70":153825,"70<S<90":209475,"90<S<110":292950,"110<S<130":320775,"S>130":459900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}}}};
const M={"PAC":"PAC","PAC + BALLON √âLECTRIQUE":"BALLON ELECTRIQUE","PAC + BALLON THERMO":"BALLON THERMO","PAC + SSC":"BALLON SSC"};

const SCENARIO_NAMES = {
    "PAC": "PAC",
    "PAC + BALLON √âLECTRIQUE": "PAC + Ballon √âlectrique",
    "PAC + BALLON THERMO": "PAC + Ballon Thermo",
    "PAC + SSC": "PAC + SSC"
};

const CATEGORIE_NAMES = {
    "BLEU": "MPR Bleu",
    "JAUNE": "MPR Jaune",
    "VIOLET": "MPR Violet",
    "ROSE": "MPR Rose"
};

const SURFACE_NAMES = {
    "S<70": "< 70 m¬≤",
    "70<S<90": "70-90 m¬≤",
    "90<S<110": "90-110 m¬≤",
    "110<S<130": "110-130 m¬≤",
    "S>130": "> 130 m¬≤"
};

function getCEE(et, zn, cs, sf){
    if(!D.CEE[et]) return 0;
    if(!D.CEE[et][zn]) return 0;
    if(!D.CEE[et][zn][cs]) return 0;
    if(!D.CEE[et][zn][cs][sf]) return 0;
    return D.CEE[et][zn][cs][sf];
}

let mode=0;

function checkStoredMode(){
    const stored = localStorage.getItem('fournisseurAuth');
    if(stored){
        const data = JSON.parse(stored);
        const now = new Date().getTime();
        if(now - data.timestamp < 24 * 60 * 60 * 1000){
            mode = 1;
            document.getElementById('mainContent').classList.add('fournisseur-mode');
            document.getElementById('lockIcon').textContent='üîì';
            return true;
        } else {
            localStorage.removeItem('fournisseurAuth');
        }
    }
    return false;
}

function saveMode(){
    const data = {
        timestamp: new Date().getTime()
    };
    localStorage.setItem('fournisseurAuth', JSON.stringify(data));
}

function clearMode(){
    localStorage.removeItem('fournisseurAuth');
}

function deleg(s,c,cee,ch){
    if(c==='BALLON SSC') return 'VALOREN';
    return cee>(ch*1.25)?'ECO NEGOCE':'VALOREN';
}

function prix(d,c){
    const b=c==='BLEU';
    return d==='ECO NEGOCE'?(b?12.5:7.4):(b?11.78:7.0);
}

function prixC(d){
    return d==='ECO NEGOCE'?6.5:7.0;
}

function fmt(n){
    return Math.round(n).toLocaleString('fr-FR')+' ‚Ç¨';
}

function updateFromTTC(){
    document.getElementById('lockTTC').checked=false;
    calc();
}

function updateFromDetail(){
    // D√©cocher le verrou automatiquement quand on modifie un champ individuel
    document.getElementById('lockCoutHT').checked=false;
    
    // Calculer les totaux de chaque ligne
    const coutPAC = parseFloat(document.getElementById('coutPAC').value) || 0;
    const qtePAC = parseFloat(document.getElementById('qtePAC').value) || 0;
    const totalPAC = coutPAC * qtePAC;
    document.getElementById('totalPAC').textContent = fmt(totalPAC);
    
    const coutBallon = parseFloat(document.getElementById('coutBallon').value) || 0;
    const qteBallon = parseFloat(document.getElementById('qteBallon').value) || 0;
    const totalBallon = coutBallon * qteBallon;
    document.getElementById('totalBallon').textContent = fmt(totalBallon);
    
    const coutAccessoires = parseFloat(document.getElementById('coutAccessoires').value) || 0;
    const qteAccessoires = parseFloat(document.getElementById('qteAccessoires').value) || 0;
    const totalAccessoires = coutAccessoires * qteAccessoires;
    document.getElementById('totalAccessoires').textContent = fmt(totalAccessoires);
    
    const coutAdmin = parseFloat(document.getElementById('coutAdmin').value) || 0;
    const qteAdmin = parseFloat(document.getElementById('qteAdmin').value) || 0;
    const totalAdmin = coutAdmin * qteAdmin;
    document.getElementById('totalAdmin').textContent = fmt(totalAdmin);
    
    // Calculer et afficher le total global
    const totalGlobal = totalPAC + totalBallon + totalAccessoires + totalAdmin;
    document.getElementById('coutTotalHTDisplay').textContent = fmt(totalGlobal);
    
    calc();
}

function calc(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=document.getElementById('surface').value;
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        if(lockTTC){
            tt = D.TTC[sc] || 0;
            document.getElementById('totalTTCInput').value=tt;
        }else{
            tt=parseFloat(document.getElementById('totalTTCInput').value)||0;
        }
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        
        if(lockCoutHT){
            // Mode auto : utiliser les co√ªts du sc√©nario
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                
                // Mettre √† jour les champs individuels
                document.getElementById('coutPAC').value = detail.pac;
                document.getElementById('qtePAC').value = 1;
                document.getElementById('totalPAC').textContent = fmt(detail.pac);
                
                document.getElementById('coutBallon').value = detail.ballon;
                document.getElementById('qteBallon').value = detail.ballon > 0 ? 1 : 0;
                document.getElementById('totalBallon').textContent = fmt(detail.ballon);
                
                document.getElementById('coutAccessoires').value = detail.accessoires;
                document.getElementById('qteAccessoires').value = 1;
                document.getElementById('totalAccessoires').textContent = fmt(detail.accessoires);
                
                document.getElementById('coutAdmin').value = detail.admin;
                document.getElementById('qteAdmin').value = 1;
                document.getElementById('totalAdmin').textContent = fmt(detail.admin);
                
                ch = detail.pac + detail.ballon + detail.accessoires + detail.admin;
            }else{
                ch = D.COUT[sc] || 0;
            }
        }else{
            // Mode manuel : additionner les totaux calcul√©s
            const totalPAC = (parseFloat(document.getElementById('coutPAC').value) || 0) * (parseFloat(document.getElementById('qtePAC').value) || 0);
            const totalBallon = (parseFloat(document.getElementById('coutBallon').value) || 0) * (parseFloat(document.getElementById('qteBallon').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            
            ch = totalPAC + totalBallon + totalAccessoires + totalAdmin;
        }
        
        // Afficher le total
        document.getElementById('coutTotalHTDisplay').textContent = fmt(ch);
    }else{
        ch=D.COUT[sc]||0;
    }
    
    const kw=getCEE(et,zn,cs,sf);
    
    let px,ce,dg;
    let ceForMarge, taForMarge;
    
    if(mode){
        const lk=document.getElementById('lockPrice').checked;
        if(lk){
            dg=deleg(sf,cs,kw*11.78/1000,ch);
            px=prix(dg,ct);
            document.getElementById('prixCumac').value=px.toFixed(2);
        }else{
            px=parseFloat(document.getElementById('prixCumac').value)||0;
            ce=kw*px/1000;
            dg=deleg(sf,cs,ce,ch);
        }
        ce=kw*px/1000;
        ceForMarge=ce;
        taForMarge=ad+ceForMarge;
        
        document.getElementById('delegataire').value=dg;
        document.getElementById('kwhCumac').value=Math.round(kw).toLocaleString('fr-FR');
    }else{
        ce=kw*7.0/1000;
        dg=deleg(sf,cs,ce,ch);
        px=prixC(dg);
        ce=kw*px/1000;
        
        const dgForMarge=deleg(sf,cs,kw*11.78/1000,ch);
        const pxForMarge=prix(dgForMarge,ct);
        ceForMarge=kw*pxForMarge/1000;
        taForMarge=ad+ceForMarge;
    }
    
    const ta=ad+ce;
    const rb=tt-ta;
    
    document.getElementById('totalTTC').textContent=fmt(tt);
    document.getElementById('aidesMPR').textContent=fmt(ad);
    document.getElementById('aidesCEE').textContent=fmt(ce);
    document.getElementById('totalAides').textContent=fmt(ta);
    
    if(mode) document.getElementById('displayCoutHT').textContent=fmt(ch);
    
    const st=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const ct2=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zn2=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const et2=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const sf2=document.getElementById('surface').options[document.getElementById('surface').selectedIndex].text;
    const colorClass=ct==='BLEU'?'color-bleu':(ct==='JAUNE'?'color-jaune':(ct==='VIOLET'?'color-violet':'color-rose'));
    const borderColor=ct==='BLEU'?'#0071e3':(ct==='JAUNE'?'#fbbf24':(ct==='VIOLET'?'#8b5cf6':'#ec4899'));
    
    document.getElementById('scenarioSummary').innerHTML=`<strong class="${colorClass}">${st}</strong><span class="separator">‚Ä¢</span>${ct2}<span class="separator">‚Ä¢</span>Zone ${zn2}<span class="separator">‚Ä¢</span>${sf2}<span class="separator">‚Ä¢</span>${et2}`;
    document.getElementById('scenarioSummary').style.borderLeftColor=borderColor;
    
    calcRAC(rb,ch,ta,taForMarge,tt);
}

function calcRAC(rb,ch,ta,taForMarge,tt){
    const po=parseFloat(document.getElementById('racPourcent').value)||0;
    const mo=parseFloat(document.getElementById('racOffert').value)||0;
    const rc=rb-mo;
    document.getElementById('resteCharge').textContent=fmt(rc);
    
    const rbForMarge = tt - taForMarge;
    const rcForMarge = rbForMarge - mo;
    const vhForMarge = Math.max(0,rcForMarge)/1.055;
    const mgForMarge = vhForMarge - ch + taForMarge;
    
    if(mode){
        document.getElementById('margeFinal').textContent=fmt(mgForMarge);
    }
    
    // R√©cup√©rer le sc√©nario actuel pour adapter les seuils
    const currentScenario = document.getElementById('scenario').value;
    
    // Seuils diff√©rents pour PAC + SSC
    const seuilOK = (currentScenario === 'PAC + SSC') ? 6000 : 4000;
    const seuilWarning = (currentScenario === 'PAC + SSC') ? 3000 : 2000;
    
    const bd=document.getElementById('statusBadge');
    if(mgForMarge>=seuilOK){
        bd.className='status-badge ok';
        bd.textContent='DOSSIER OK'
    }else if(mgForMarge>=seuilWarning){
        bd.className='status-badge warning';
        bd.textContent='DOSSIER √Ä AM√âLIORER'
    }else{
        bd.className='status-badge danger';
        bd.textContent='DOSSIER REFUS√â'
    }
}

function updatePct(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=document.getElementById('surface').value;
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        if(lockTTC){
            tt = D.TTC[sc] || 0;
        }else{
            tt=parseFloat(document.getElementById('totalTTCInput').value)||0;
        }
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac + detail.ballon + detail.accessoires + detail.admin;
            }else{
                ch = D.COUT[sc] || 0;
            }
        }else{
            // Mode manuel : additionner les totaux calcul√©s
            const totalPAC = (parseFloat(document.getElementById('coutPAC').value) || 0) * (parseFloat(document.getElementById('qtePAC').value) || 0);
            const totalBallon = (parseFloat(document.getElementById('coutBallon').value) || 0) * (parseFloat(document.getElementById('qteBallon').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            
            ch = totalPAC + totalBallon + totalAccessoires + totalAdmin;
        }
    }else{
        ch=D.COUT[sc]||0;
    }
    
    const kw=getCEE(et,zn,cs,sf);
    
    let px,ce,dg;
    let ceForMarge, taForMarge;
    
    if(mode){
        const lk=document.getElementById('lockPrice').checked;
        if(lk){
            ce=kw*11.78/1000;
            dg=deleg(sf,cs,ce,ch);
            px=prix(dg,ct);
        }else{
            px=parseFloat(document.getElementById('prixCumac').value)||0;
        }
        ce=kw*px/1000;
        ceForMarge=ce;
        taForMarge=ad+ceForMarge;
    }else{
        ce=kw*7.0/1000;
        dg=deleg(sf,cs,ce,ch);
        px=prixC(dg);
        ce=kw*px/1000;
        
        const dgForMarge=deleg(sf,cs,kw*11.78/1000,ch);
        const pxForMarge=prix(dgForMarge,ct);
        ceForMarge=kw*pxForMarge/1000;
        taForMarge=ad+ceForMarge;
    }
    
    const ta=ad+ce;
    const rb=tt-ta;
    
    let po=parseFloat(document.getElementById('racPourcent').value)||0;
    if(po>100)po=100;
    if(po<0)po=0;
    document.getElementById('racPourcent').value=Math.round(po);
    const mo=Math.round(rb*(po/100));
    document.getElementById('racOffert').value=mo;
    
    calcRAC(rb,ch,ta,taForMarge,tt);
}

function updateAmt(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=document.getElementById('surface').value;
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        if(lockTTC){
            tt = D.TTC[sc] || 0;
        }else{
            tt=parseFloat(document.getElementById('totalTTCInput').value)||0;
        }
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac + detail.ballon + detail.accessoires + detail.admin;
            }else{
                ch = D.COUT[sc] || 0;
            }
        }else{
            // Mode manuel : additionner les totaux calcul√©s
            const totalPAC = (parseFloat(document.getElementById('coutPAC').value) || 0) * (parseFloat(document.getElementById('qtePAC').value) || 0);
            const totalBallon = (parseFloat(document.getElementById('coutBallon').value) || 0) * (parseFloat(document.getElementById('qteBallon').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            
            ch = totalPAC + totalBallon + totalAccessoires + totalAdmin;
        }
    }else{
        ch=D.COUT[sc]||0;
    }
    
    const kw=getCEE(et,zn,cs,sf);
    
    let px,ce,dg;
    let ceForMarge, taForMarge;
    
    if(mode){
        const lk=document.getElementById('lockPrice').checked;
        if(lk){
            ce=kw*11.78/1000;
            dg=deleg(sf,cs,ce,ch);
            px=prix(dg,ct);
        }else{
            px=parseFloat(document.getElementById('prixCumac').value)||0;
        }
        ce=kw*px/1000;
        ceForMarge=ce;
        taForMarge=ad+ceForMarge;
    }else{
        ce=kw*7.0/1000;
        dg=deleg(sf,cs,ce,ch);
        px=prixC(dg);
        ce=kw*px/1000;
        
        const dgForMarge=deleg(sf,cs,kw*11.78/1000,ch);
        const pxForMarge=prix(dgForMarge,ct);
        ceForMarge=kw*pxForMarge/1000;
        taForMarge=ad+ceForMarge;
    }
    
    const ta=ad+ce;
    const rb=tt-ta;
    
    let mo=parseFloat(document.getElementById('racOffert').value)||0;
    if(mo>rb)mo=rb;
    if(mo<0)mo=0;
    document.getElementById('racOffert').value=Math.round(mo);
    
    let po=rb>0?Math.round((mo/rb)*100):0;
    if(po>100)po=100;
    if(po<0)po=0;
    document.getElementById('racPourcent').value=po;
    
    calcRAC(rb,ch,ta,taForMarge,tt);
}

function reset(){
    document.getElementById('scenario').value='PAC';
    document.getElementById('categorie').value='BLEU';
    document.getElementById('zone').value='H1';
    document.getElementById('etas').value='140-170';
    document.getElementById('surface').value='90<S<110';
    document.getElementById('racPourcent').value=0;
    document.getElementById('racOffert').value=0;
    if(mode){
        document.getElementById('prixCumac').value=11.78;
        document.getElementById('lockPrice').checked=true;
    }
    calc();
}

function checkExport(){
    const nom=document.getElementById('nom').value.trim();
    const prenom=document.getElementById('prenom').value.trim();
    const btn=document.getElementById('exportBtn');
    const wBtn=document.getElementById('whatsappBtn');
    if(nom&&prenom){
        btn.disabled=false;
        btn.style.cursor='pointer';
        btn.style.opacity='1';
        wBtn.disabled=false;
        wBtn.style.cursor='pointer';
        wBtn.style.opacity='1';
    }else{
        btn.disabled=true;
        btn.style.cursor='not-allowed';
        btn.style.opacity='0.5';
        wBtn.disabled=true;
        wBtn.style.cursor='not-allowed';
        wBtn.style.opacity='0.5';
    }
}

function sendWhatsApp(){
    const nom=document.getElementById('nom').value.trim();
    const prenom=document.getElementById('prenom').value.trim();
    if(!nom||!prenom){
        alert('Veuillez renseigner le nom et le pr√©nom du client');
        return;
    }
    const scenario=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const categorie=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zone=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const etas=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const surface=document.getElementById('surface').options[document.getElementById('surface').selectedIndex].text;
    const ttc=document.getElementById('totalTTC').textContent;
    const aidesMPR=document.getElementById('aidesMPR').textContent;
    const aidesCEE=document.getElementById('aidesCEE').textContent;
    const totalAides=document.getElementById('totalAides').textContent;
    const rac=document.getElementById('resteCharge').textContent;
    const message=`üè† *Demande de devis - Les Artisans Verts*%0A%0Aüë§ *Client :* ${prenom} ${nom}%0A%0Aüìã *Configuration :*%0A‚Ä¢ Sc√©nario : ${scenario}%0A‚Ä¢ ${categorie}%0A‚Ä¢ ${zone}%0A‚Ä¢ ${surface}%0A‚Ä¢ ${etas}%0A%0Aüí∞ *Montants :*%0A‚Ä¢ Total TTC : ${ttc}%0A‚Ä¢ Aides MPR : ${aidesMPR}%0A‚Ä¢ Aides CEE : ${aidesCEE}%0A‚Ä¢ Total aides : ${totalAides}%0A‚Ä¢ Reste √† charge : ${rac}%0A%0AJe souhaite obtenir un devis d√©taill√©.`;
    window.open(`https://api.whatsapp.com/send?text=${message}`, '_blank');
}

function exportPDF(){
    const nom=document.getElementById('nom').value.trim();
    const prenom=document.getElementById('prenom').value.trim();
    
    if(!nom||!prenom){
        alert('Veuillez renseigner le nom et le pr√©nom du client');
        return;
    }
    
    document.getElementById('printTitle').textContent=`Dossier ‚Äî ${prenom} ${nom}`;
    document.getElementById('printDate').textContent=`Date: ${new Date().toLocaleDateString('fr-FR')}`;
    document.getElementById('printScenario').textContent=document.getElementById('scenarioSummary').textContent;
    document.getElementById('printTTC').textContent=document.getElementById('totalTTC').textContent;
    document.getElementById('printMPR').textContent=document.getElementById('aidesMPR').textContent;
    document.getElementById('printCEE').textContent=document.getElementById('aidesCEE').textContent;
    document.getElementById('printTotalAides').textContent=document.getElementById('totalAides').textContent;
    document.getElementById('printPct').textContent=document.getElementById('racPourcent').value;
    document.getElementById('printOffert').textContent=document.getElementById('racOffert').value+' ‚Ç¨';
    document.getElementById('printRAC').textContent=document.getElementById('resteCharge').textContent;
    
    const badge=document.getElementById('statusBadge');
    const printStatus=document.getElementById('printStatus');
    printStatus.textContent=badge.textContent;
    if(badge.classList.contains('ok')){
        printStatus.style.background='#d1f4e0';
        printStatus.style.color='#0d7f3f';
    }else if(badge.classList.contains('warning')){
        printStatus.style.background='#fff3cd';
        printStatus.style.color='#856404';
    }else{
        printStatus.style.background='#f8d7da';
        printStatus.style.color='#721c24';
    }
    
    window.print();
}

// ============================================
// SYST√àME DE RECOMMANDATIONS AUTOMATIQUES
// ============================================

function calculateScenario(scenario, categorie, zone, etas, surface){
    const cs = M[scenario];
    const tt = D.TTC[scenario] || 0;
    const ad = (D.MPR[scenario] && D.MPR[scenario][categorie]) ? D.MPR[scenario][categorie] : 0;
    const ch = D.COUT[scenario] || 0;
    const kw = getCEE(etas, zone, cs, surface);
    
    const dg = deleg(surface, cs, kw * 11.78 / 1000, ch);
    const px = prix(dg, categorie);
    const ce = kw * px / 1000;
    const ta = ad + ce;
    const rb = tt - ta;
    
    const vh = Math.max(0, rb) / 1.055;
    const marge = vh - ch + ta;
    
    // Score de vendabilit√© (0-100)
    // Seuils adapt√©s selon le sc√©nario
    const seuilOK = (scenario === 'PAC + SSC') ? 6000 : 4000;
    const seuilWarning = (scenario === 'PAC + SSC') ? 3000 : 2000;
    
    let scoreVendabilite = 0;
    if(marge >= seuilOK) scoreVendabilite += 50;
    else if(marge >= seuilWarning) scoreVendabilite += 25;
    
    if(rb <= 3000) scoreVendabilite += 50;
    else if(rb <= 5000) scoreVendabilite += 35;
    else if(rb <= 7000) scoreVendabilite += 20;
    
    // Score √©quilibre (balance entre marge et RAC)
    // Adapter la cible de marge selon le sc√©nario
    const margeCible = (scenario === 'PAC + SSC') ? 8000 : 6000;
    const ratioMarge = Math.min(100, (marge / margeCible) * 100);
    const ratioRAC = Math.max(0, 100 - ((rb / 10000) * 100));
    const scoreEquilibre = (ratioMarge * 0.6) + (ratioRAC * 0.4);
    
    return {
        scenario,
        categorie,
        zone,
        etas,
        surface,
        tt,
        ad,
        ce,
        ta,
        rb,
        ch,
        marge,
        scoreVendabilite,
        scoreEquilibre,
        delegataire: dg,
        kwhCumac: kw
    };
}

function analyzeAllScenarios(filters = {}){
    const scenarios = ["PAC", "PAC + BALLON √âLECTRIQUE", "PAC + BALLON THERMO", "PAC + SSC"];
    const categories = ["BLEU", "JAUNE", "VIOLET", "ROSE"];
    const zones = ["H1", "H2", "H3"];
    const etasOptions = ["140-170", "111-140"];
    const surfaces = ["S<70", "70<S<90", "90<S<110", "110<S<130", "S>130"];
    
    const results = [];
    
    for(let sc of scenarios){
        for(let cat of categories){
            for(let zn of zones){
                for(let et of etasOptions){
                    for(let sf of surfaces){
                        // Appliquer les filtres
                        if(filters.zone && zn !== filters.zone) continue;
                        if(filters.surface && sf !== filters.surface) continue;
                        if(filters.categorie && cat !== filters.categorie) continue;
                        
                        const result = calculateScenario(sc, cat, zn, et, sf);
                        
                        // Filtrer les marges n√©gatives
                        if(result.marge >= 0){
                            results.push(result);
                        }
                    }
                }
            }
        }
    }
    
    return results;
}

function openRecoModal(){
    document.getElementById('recoModal').classList.add('active');
    
    // Lancer l'analyse apr√®s un court d√©lai pour que la modal s'affiche
    setTimeout(() => {
        runRecommendations();
    }, 100);
}

function closeRecoModal(){
    document.getElementById('recoModal').classList.remove('active');
}

function runRecommendations(){
    const filters = {
        zone: document.getElementById('filterZone').value,
        surface: document.getElementById('filterSurface').value,
        categorie: document.getElementById('filterCategorie').value
    };
    
    const results = analyzeAllScenarios(filters);
    
    // Trier par marge d√©croissante
    const topMarge = [...results].sort((a, b) => b.marge - a.marge).slice(0, 10);
    
    // Trier par RAC croissant
    const topRAC = [...results].sort((a, b) => a.rb - b.rb).slice(0, 10);
    
    // Trier par score √©quilibre
    const topEquilibre = [...results].sort((a, b) => b.scoreEquilibre - a.scoreEquilibre).slice(0, 10);
    
    // Trier par score vendabilit√©
    const topVendable = [...results].sort((a, b) => b.scoreVendabilite - a.scoreVendabilite).slice(0, 10);
    
    // Afficher les r√©sultats
    displayRecommendations('recoMarge', topMarge, 'marge');
    displayRecommendations('recoRAC', topRAC, 'rac');
    displayRecommendations('recoEquilibre', topEquilibre, 'equilibre');
    displayRecommendations('recoVendable', topVendable, 'vendable');
}

function displayRecommendations(containerId, results, type){
    const container = document.getElementById(containerId);
    
    if(results.length === 0){
        container.innerHTML = '<div class="loading">Aucun r√©sultat trouv√© avec ces filtres</div>';
        return;
    }
    
    let html = '<div class="reco-grid">';
    
    results.forEach((result, index) => {
        const rank = index + 1;
        
        let scoreClass = 'good';
        let scoreValue = 0;
        let scoreLabel = '';
        
        if(type === 'marge'){
            scoreValue = Math.round(result.marge);
            scoreLabel = `Marge: ${fmt(result.marge)}`;
            // Seuils adapt√©s selon le sc√©nario
            const seuilOK = (result.scenario === 'PAC + SSC') ? 6000 : 4000;
            const seuilWarning = (result.scenario === 'PAC + SSC') ? 3000 : 2000;
            if(result.marge < seuilWarning) scoreClass = 'low';
            else if(result.marge < seuilOK) scoreClass = 'medium';
        } else if(type === 'rac'){
            scoreValue = Math.round(result.rb);
            scoreLabel = `RAC: ${fmt(result.rb)}`;
            if(result.rb > 7000) scoreClass = 'low';
            else if(result.rb > 5000) scoreClass = 'medium';
        } else if(type === 'equilibre'){
            scoreValue = Math.round(result.scoreEquilibre);
            scoreLabel = `Score: ${scoreValue}/100`;
            if(scoreValue < 50) scoreClass = 'low';
            else if(scoreValue < 70) scoreClass = 'medium';
        } else if(type === 'vendable'){
            scoreValue = Math.round(result.scoreVendabilite);
            scoreLabel = `Vendabilit√©: ${scoreValue}/100`;
            if(scoreValue < 50) scoreClass = 'low';
            else if(scoreValue < 70) scoreClass = 'medium';
        }
        
        html += `
            <div class="reco-card" onclick="applyRecommendation('${result.scenario}', '${result.categorie}', '${result.zone}', '${result.etas}', '${result.surface}')">
                <div class="reco-card-header">
                    <div class="reco-rank">${rank}</div>
                    <div class="reco-scenario">
                        <h4>${SCENARIO_NAMES[result.scenario]}</h4>
                        <p>${CATEGORIE_NAMES[result.categorie]} ‚Ä¢ Zone ${result.zone} ‚Ä¢ ${SURFACE_NAMES[result.surface]}</p>
                    </div>
                </div>
                
                <div class="reco-metrics">
                    <div class="reco-metric">
                        <div class="reco-metric-label">Total TTC</div>
                        <div class="reco-metric-value">${fmt(result.tt)}</div>
                    </div>
                    <div class="reco-metric">
                        <div class="reco-metric-label">Total Aides</div>
                        <div class="reco-metric-value positive">${fmt(result.ta)}</div>
                    </div>
                    <div class="reco-metric">
                        <div class="reco-metric-label">RAC</div>
                        <div class="reco-metric-value">${fmt(result.rb)}</div>
                    </div>
                    <div class="reco-metric">
                        <div class="reco-metric-label">Marge HT</div>
                        <div class="reco-metric-value ${
                            result.scenario === 'PAC + SSC' 
                                ? (result.marge >= 6000 ? 'positive' : (result.marge >= 3000 ? '' : 'negative'))
                                : (result.marge >= 4000 ? 'positive' : (result.marge >= 2000 ? '' : 'negative'))
                        }">${fmt(result.marge)}</div>
                    </div>
                </div>
                
                <div class="reco-score ${scoreClass}">
                    ${scoreLabel}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function applyRecommendation(scenario, categorie, zone, etas, surface){
    document.getElementById('scenario').value = scenario;
    document.getElementById('categorie').value = categorie;
    document.getElementById('zone').value = zone;
    document.getElementById('etas').value = etas;
    document.getElementById('surface').value = surface;
    
    calc();
    
    closeRecoModal();
    
    // Scroll vers le haut
    window.scrollTo({top: 0, behavior: 'smooth'});
}

// Event listeners pour les onglets
document.querySelectorAll('.reco-tab').forEach(tab => {
    tab.addEventListener('click', function(){
        document.querySelectorAll('.reco-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        document.querySelectorAll('.reco-content').forEach(c => c.classList.remove('active'));
        const targetId = this.getAttribute('data-tab');
        
        if(targetId === 'marge') document.getElementById('recoMarge').classList.add('active');
        else if(targetId === 'rac') document.getElementById('recoRAC').classList.add('active');
        else if(targetId === 'equilibre') document.getElementById('recoEquilibre').classList.add('active');
        else if(targetId === 'vendable') document.getElementById('recoVendable').classList.add('active');
    });
});

// Event listeners pour les filtres
document.getElementById('filterZone').addEventListener('change', runRecommendations);
document.getElementById('filterSurface').addEventListener('change', runRecommendations);
document.getElementById('filterCategorie').addEventListener('change', runRecommendations);

// ============================================
// GESTION DE L'AUTHENTIFICATION
// ============================================

document.getElementById('lockBtn').onclick=function(){
    if(!mode){
        const stored = localStorage.getItem('fournisseurAuth');
        if(stored){
            const data = JSON.parse(stored);
            const now = new Date().getTime();
            if(now - data.timestamp < 24 * 60 * 60 * 1000){
                mode=1;
                document.getElementById('mainContent').classList.add('fournisseur-mode');
                document.getElementById('lockIcon').textContent='üîì';
                calc();
                return;
            }
        }
        document.getElementById('passwordModal').classList.add('active');
    }else{
        mode=0;
        document.getElementById('mainContent').classList.remove('fournisseur-mode');
        document.getElementById('lockIcon').textContent='üîí';
        calc();
    }
};

document.getElementById('exportBtn').onclick=exportPDF;
document.getElementById('whatsappBtn').onclick=sendWhatsApp;

document.getElementById('unlockBtn').onclick=function(){
    const pw=document.getElementById('passwordInput').value;
    if(pw==='gamberge'||pw==='lav'){
        mode=1;
        saveMode();
        document.getElementById('mainContent').classList.add('fournisseur-mode');
        document.getElementById('passwordModal').classList.remove('active');
        document.getElementById('passwordInput').value='';
        document.getElementById('lockIcon').textContent='üîì';
        calc();
    }else{
        alert('Mot de passe incorrect');
    }
};

document.getElementById('passwordModal').onclick=function(e){
    if(e.target.id==='passwordModal'){
        document.getElementById('passwordModal').classList.remove('active');
    }
};

document.getElementById('recoModal').onclick=function(e){
    if(e.target.id==='recoModal'){
        closeRecoModal();
    }
};

// ============================================
// INITIALISATION
// ============================================

checkStoredMode();
calc();
</script>
</body>
</html>
