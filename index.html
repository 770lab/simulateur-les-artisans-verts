<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur Aides PAC 2026</title>
    <link rel="icon" type="image/png" href="data:image/png;base64,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">
    <link rel="apple-touch-icon" href="data:image/png;base64,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">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        /* === BANDEAU INFO 2026 === */
        .info-banner-2026 {
            background: linear-gradient(135deg, #14532d 0%, #166534 50%, #15803d 100%);
            color: white;
            padding: 10px 20px;
            font-size: 13px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .info-banner-2026 strong { color: #86efac; }
        .info-banner-2026 .separator-dot { opacity: 0.4; margin: 0 4px; }

        /* === AUTO-DETECTION REVENUS === */
        .revenus-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #bbf7d0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .revenus-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .revenus-toggle h3 {
            font-size: 14px;
            font-weight: 600;
            color: #16a34a;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .revenus-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #16a34a;
        }
        .revenus-toggle .toggle-arrow.open { transform: rotate(180deg); }
        .revenus-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease, padding 0.3s ease;
            padding-top: 0;
        }
        .revenus-body.open {
            max-height: 500px;
            padding-top: 14px;
        }
        .revenus-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .revenus-grid { grid-template-columns: 1fr; }
        }
        .revenus-grid label {
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 4px;
            display: block;
        }
        .revenus-grid select, .revenus-grid input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }
        .revenus-grid select:focus, .revenus-grid input:focus {
            border-color: #16a34a;
            outline: none;
            box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
        }
        .profil-result {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            display: none;
            animation: fadeSlide 0.3s ease;
        }
        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .profil-result.show { display: block; }
        .profil-result.profil-bleu {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .profil-result.profil-jaune {
            background: linear-gradient(135deg, #fef9c3, #fef08a);
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        .profil-result.profil-violet {
            background: linear-gradient(135deg, #ede9fe, #ddd6fe);
            color: #5b21b6;
            border: 1px solid #c4b5fd;
        }
        .profil-result.profil-rose {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            color: #9d174d;
            border: 1px solid #f9a8d4;
        }

        /* === CEE DETAIL SECTION === */
        .cee-section {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #93c5fd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        .cee-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }
        .cee-toggle h3 {
            font-size: 14px;
            font-weight: 600;
            color: #2563eb;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .cee-toggle .toggle-arrow {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: #2563eb;
        }
        .cee-toggle .toggle-arrow.open { transform: rotate(180deg); }
        .cee-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease, padding 0.3s ease;
            padding-top: 0;
        }
        .cee-body.open {
            max-height: 800px;
            padding-top: 14px;
        }
        .cee-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        @media (max-width: 600px) {
            .cee-grid { grid-template-columns: 1fr; }
        }
        .cee-grid label {
            font-size: 12px;
            font-weight: 500;
            color: #475569;
            margin-bottom: 4px;
            display: block;
        }
        .cee-grid select, .cee-grid input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            transition: border-color 0.2s;
        }
        .cee-grid select:focus, .cee-grid input:focus {
            border-color: #2563eb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .cee-result {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            text-align: center;
            display: none;
            animation: fadeSlide 0.3s ease;
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .cee-result.show { display: block; }
        .cee-hint {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        .cee-bloc-171, .cee-bloc-148 {
            transition: all 0.3s ease;
        }
        .cee-hidden { display: none !important; }

        /* Isolation state radio buttons */
        .g-radio {
            display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px;
            border: 1.5px solid #e2e8f0; border-radius: 10px; cursor: pointer;
            transition: all 0.15s ease; font-size: 13px; background: white;
        }
        .g-radio:hover { border-color: #a3cfbb; background: #f8fdfb; }
        .g-radio.selected { border-color: #16a34a; background: #f0fdf4; }
        .g-radio input[type="radio"] { accent-color: #16a34a; margin: 3px 0 0 0; width: 18px; height: 18px; flex-shrink: 0; }
        .g-label { flex: 1; }
        .g-label-title { font-weight: 600; color: #1d1d1f; font-size: 13px; }
        .g-label-sub { font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .g-value { display: none; }

        /* Dim form */
        .dim-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 16px; }
        .dim-field label { font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; margin-bottom: 6px; }
        .dim-field .req { color: #dc2626; }
        .dim-field input, .dim-field select {
            width: 100%; padding: 10px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px;
            font-size: 15px; font-weight: 500; color: #0f172a; background: white; transition: border-color 0.15s;
        }
        .dim-field input:focus, .dim-field select:focus { border-color: #16a34a; outline: none; box-shadow: 0 0 0 3px rgba(22,163,74,0.08); }
        .dim-field .dim-hint { font-size: 11px; color: #94a3b8; margin-top: 4px; }

        /* Confort slider */
        .confort-box { border: 1.5px solid #e2e8f0; border-radius: 10px; padding: 16px; }
        .confort-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .confort-val { font-size: 22px; font-weight: 700; color: #16a34a; }
        .confort-lbl { font-size: 14px; font-weight: 600; color: #334155; text-transform: uppercase; letter-spacing: 0.5px; }
        input.confort-slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 4px; outline: none; margin: 8px 0; padding: 0; border: none;
            background: linear-gradient(to right, #fb923c, #16a34a 50%, #3b82f6); }
        input.confort-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 26px; height: 26px; border-radius: 50%; background: white; border: 3px solid #16a34a; cursor: pointer; box-shadow: 0 1px 6px rgba(0,0,0,0.15); }
        input.confort-slider::-moz-range-thumb { width: 26px; height: 26px; border-radius: 50%; background: white; border: 3px solid #16a34a; cursor: pointer; box-shadow: 0 1px 6px rgba(0,0,0,0.15); }
        .confort-labels { display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .confort-desc { font-size: 12px; color: #64748b; margin-top: 10px; font-style: italic; }

        /* Isolation checklist */
        .iso-check {
            display: flex; align-items: center; gap: 10px; padding: 10px 14px;
            border: 1.5px solid #e2e8f0; border-radius: 8px; cursor: pointer;
            transition: all 0.15s ease; background: white;
        }
        .iso-check:hover { border-color: #a3cfbb; background: #f8fdfb; }
        .iso-check:has(input:checked) { border-color: #16a34a; background: #f0fdf4; }
        .iso-check input[type="checkbox"] { accent-color: #16a34a; width: 18px; height: 18px; flex-shrink: 0; cursor: pointer; }
        .iso-info { flex: 1; }
        .iso-title { font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; }
        .iso-sub { font-size: 11px; color: #94a3b8; }
        .iso-quand {
            padding: 4px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 11px;
            color: #64748b; background: #f8fafc; display: none; cursor: pointer;
        }
        .iso-check:has(input:checked) .iso-quand { display: block; }
        .cee-kpi-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }
        .cee-kpi {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 12px;
            text-align: center;
        }
        .cee-kpi .kpi-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        .cee-kpi .kpi-value {
            font-size: 16px;
            font-weight: 700;
            color: #1e40af;
        }
        .cee-kpi .kpi-value.green { color: #16a34a; }
        .cee-kpi .kpi-detail {
            font-size: 10px;
            color: #94a3b8;
            margin-top: 2px;
            font-family: ui-monospace, monospace;
        }

        .header {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }



        .btn-apply {
            flex: 1;
            background: #0071e3;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-apply:hover {
            background: #0077ed;
        }

        .btn-close-modal {
            background: #f5f5f7;
            color: #1d1d1f;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-close-modal:hover {
            background: #e8e8ed;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1.4fr 1fr;
            gap: 28px;
            padding: 30px 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 5px;
            color: #1d1d1f;
        }

        .form-group small {
            display: block;
            font-size: 12px;
            color: #86868b;
            margin-top: 4px;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 15px;
            background: white;
            transition: all 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #0071e3;
            box-shadow: 0 0 0 4px rgba(0,113,227,0.1);
        }

        .fournisseur-only {
            display: none;
        }

        .fournisseur-mode .fournisseur-only {
            display: block;
        }
        
        .fournisseur-mode .ttc-readonly {
            display: none !important;
        }

        .client-only {
            display: block;
        }

        .fournisseur-mode .client-only {
            display: none;
        }

        .results-sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .summary-card {
            background: linear-gradient(165deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25), 0 0 0 1px rgba(255,255,255,0.05);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--scroll-gradient, linear-gradient(90deg, #34d399, #22d3ee, #818cf8));
            transition: background 0.4s ease;
        }

        .result-row-card {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.25s ease;
            position: relative;
            overflow: hidden;
        }
        .result-row-card:hover {
            background: rgba(255,255,255,0.07);
            border-color: rgba(255,255,255,0.12);
            transform: translateY(-1px);
        }
        .result-row-card .rrc-label {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255,255,255,0.55);
            letter-spacing: 0.3px;
        }
        .result-row-card .rrc-value {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            font-variant-numeric: tabular-nums;
        }
        .result-row-card .rrc-value.green { color: #34d399; }
        .result-row-card .rrc-value.yellow { color: #fbbf24; }
        .result-row-card .rrc-value.red { color: #f87171; }
        .result-row-card .rrc-value.cyan { color: #22d3ee; }
        .result-row-card .rrc-value.blue { color: #60a5fa; }

        .result-highlight-card {
            background: linear-gradient(135deg, rgba(52,211,153,0.12) 0%, rgba(34,211,238,0.08) 100%);
            border: 1px solid rgba(52,211,153,0.2);
            border-radius: 14px;
            padding: 18px 22px;
            margin-bottom: 12px;
            text-align: center;
            position: relative;
        }
        .result-highlight-card .rhc-label {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .result-highlight-card .rhc-value {
            font-size: 34px;
            font-weight: 800;
            color: #34d399;
            text-shadow: 0 0 30px rgba(52,211,153,0.3);
        }

        .glow-separator {
            height: 2px;
            margin: 16px 0;
            border-radius: 2px;
            background: var(--scroll-gradient, linear-gradient(90deg, #34d399, #22d3ee, #818cf8));
            opacity: 0.4;
            transition: opacity 0.3s, background 0.6s;
        }
        .glow-separator:hover { opacity: 0.7; }

        .dark-section-title {
            font-size: 11px;
            font-weight: 700;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            padding-left: 2px;
        }

        .scenario-label-dark {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 18px;
            padding: 12px 16px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 3px solid #34d399;
            line-height: 1.5;
            transition: border-color 0.4s;
        }
        .scenario-label-dark strong { font-weight: 600; color: #f1f5f9; }
        .scenario-label-dark .separator { color: rgba(255,255,255,0.3); margin: 0 8px; }

        .rac-dark-section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px;
        }
        .rac-dark-section .amount-label {
            color: rgba(255,255,255,0.45);
        }
        .rac-dark-section input[type="number"] {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.12);
            color: #f1f5f9;
            font-size: 22px;
            font-weight: 700;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            transition: border-color 0.2s;
        }
        .rac-dark-section input[type="number"]:focus {
            border-color: #34d399;
            box-shadow: 0 0 0 3px rgba(52,211,153,0.15);
            outline: none;
        }
        .rac-dark-section .note-small { color: rgba(255,255,255,0.35); }

        .ttc-input-dark {
            font-size: 20px;
            font-weight: 700;
            text-align: right;
            padding: 4px 8px;
            width: 140px;
            border: none;
            border-radius: 8px;
            background: none;
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
            color: #60a5fa;
            font-variant-numeric: tabular-nums;
            font-family: inherit;
        }
        .ttc-input-dark::-webkit-outer-spin-button,
        .ttc-input-dark::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .ttc-input-dark:focus {
            outline: none;
            border-bottom: 1px solid rgba(96,165,250,0.4);
        }

        .btn-dark-export {
            width: 100%;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.6);
            letter-spacing: 0.3px;
        }
        .btn-dark-export:hover {
            background: rgba(255,255,255,0.12);
            color: white;
            border-color: rgba(255,255,255,0.2);
        }
        .btn-dark-export.pdf { }
        .btn-dark-export.whatsapp { }

        .summary-header {
            font-size: 12px;
            font-weight: 600;
            color: #86868b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .scenario-label {
            font-size: 13px;
            color: #1d1d1f;
            margin-bottom: 20px;
            padding: 14px;
            background: #f5f5f7;
            border-radius: 8px;
            border-left: 4px solid #0071e3;
            line-height: 1.5;
        }
        
        .scenario-label strong {
            font-weight: 600;
        }
        
        .scenario-label .separator {
            color: #86868b;
            margin: 0 8px;
        }
        
        .color-bleu { color: #0071e3; }
        .color-jaune { color: #fbbf24; }
        .color-violet { color: #8b5cf6; }
        .color-rose { color: #ec4899; }

        .amount-row {
            margin-bottom: 12px;
        }

        .amount-label {
            font-size: 12px;
            color: #86868b;
            margin-bottom: 4px;
        }

        .amount-value {
            font-size: 26px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .amount-value.highlight {
            color: #34c759;
        }

        .rac-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.08);
        }

        .rac-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .rac-item input {
            font-size: 22px;
            font-weight: 700;
            color: #1d1d1f;
            text-align: center;
            padding: 8px 10px;
        }

        .final-amount {
            text-align: right;
            padding-top: 20px;
            border-top: 2px solid #f5f5f7;
        }

        .final-amount .amount-label {
            font-size: 13px;
            color: #86868b;
            margin-bottom: 6px;
        }

        .final-amount .amount-value {
            font-size: 34px;
            font-weight: 700;
            color: #1d1d1f;
        }

        .status-badge {
            padding: 18px 24px;
            font-weight: 700;
            font-size: 15px;
            border-radius: 14px;
            text-align: center;
            width: 100%;
            letter-spacing: 0.3px;
            transition: all 0.3s;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .status-badge.ok {
            background: linear-gradient(135deg, #065f46, #059669);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(5, 150, 105, 0.35);
        }
        .status-badge.ok:hover {
            box-shadow: 0 6px 28px rgba(5, 150, 105, 0.5);
            transform: translateY(-1px);
        }
        .status-badge.ok:active { transform: translateY(0); }
        .status-badge.danger {
            background: linear-gradient(135deg, #7f1d1d, #dc2626);
            color: white;
            box-shadow: 0 4px 16px rgba(220, 38, 38, 0.25);
        }

        .btn-reset {
            background: #f5f5f7;
            border: 1px solid #e5e7eb;
            padding: 8px;
            border-radius: 8px;
            font-size: 0;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .btn-reset:hover {
            background: #e8e8ed;
        }


        .footer {
            text-align: center;
            padding: 8px 20px 8px;
            color: #86868b;
            font-size: 13px;
        }

        @media print {
            #loginScreen, .header, .user-bar, .guest-bar, .btn-reset, .footer, .parameters-section, .main-content, .hist-overlay, #pwdModal {
                display: none !important;
            }
            
            #printArea {
                display: block !important;
            }

            #appScreen {
                display: block !important;
            }

            body {
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            @page {
                margin: 10mm;
                size: A4;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .results-sidebar {
                position: static;
            }


        }

        .note-small {
            font-size: 11px;
            color: #86868b;
            text-align: center;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #86868b;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        /* ============ MOBILE ============ */
        @media (max-width: 600px) {
            html, body { overflow-x: hidden; }
            .header { padding: 8px 0; }
            .container { padding: 0 8px; }
            .header .container > div:first-child { margin-bottom: 4px; }
            .user-bar { flex-wrap: wrap; gap: 5px; justify-content: center; }
            .user-bar .user-name { font-size: 11px; }
            .user-bar .user-role { font-size: 9px; padding: 1px 5px; }
            .user-bar .btn-hist, .user-bar .btn-logout { padding: 3px 7px; font-size: 10px; }
            .view-toggle { padding: 2px; }
            .view-toggle .toggle-opt { padding: 4px 8px; font-size: 10px; }
            .guest-bar { justify-content: center; }
            .guest-bar .btn-login-small { padding: 5px 10px; font-size: 11px; }
            .card { padding: 10px; margin-bottom: 10px; }
            .card-title { font-size: 13px; margin-bottom: 10px; }
            .parameters-section { padding: 6px; }
            .results-sidebar { padding: 6px; }
            .grid-3col { grid-template-columns: 1fr 1fr 1fr !important; gap: 6px !important; }
            .form-group label { font-size: 11px; }
            .form-group input, .form-group select { padding: 7px 8px; font-size: 12px; }
        }
        @media (max-width: 380px) {
            .grid-3col { grid-template-columns: 1fr 1fr !important; }
            .view-toggle .toggle-opt { padding: 3px 6px; font-size: 9px; }
        }

        /* LOGIN SCREEN */
        .login-container { display:flex; align-items:center; justify-content:center; min-height:100vh; background:linear-gradient(135deg, #0f172a 0%, #1e3a5f 40%, #134e4a 100%); }
        .login-box { background:white; padding:40px; border-radius:16px; width:360px; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .login-box h2 { text-align:center; margin:0 0 6px; font-size:20px; }
        .login-box h2 span { color:#16a34a; }
        .login-box .login-sub { text-align:center; color:#6b7280; font-size:13px; margin-bottom:24px; }
        .login-box .form-group { margin-bottom:16px; }
        .login-box .form-group label { display:block; font-size:13px; font-weight:600; color:#374151; margin-bottom:6px; }
        .login-box .form-group input { width:100%; padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; box-sizing:border-box; }
        .login-box .form-group input:focus { border-color:#16a34a; outline:none; box-shadow:0 0 0 3px rgba(22,163,74,0.15); }
        .login-box .btn-login { width:100%; padding:12px; background:linear-gradient(135deg,#16a34a,#15803d); color:white; border:none; border-radius:8px; font-size:15px; font-weight:700; cursor:pointer; }
        .login-box .btn-login:hover { opacity:0.9; }
        .login-error { color:#dc2626; text-align:center; margin-top:12px; font-size:13px; display:none; }
        .login-logo { text-align:center; margin-bottom:20px; }
        .login-logo span { background:linear-gradient(135deg,#16a34a,#15803d); color:white; padding:10px 18px; border-radius:10px; font-weight:700; font-size:14px; display:inline-block; }

        /* USER BAR */
        .user-bar { display:flex; align-items:center; gap:8px; }
        .user-bar .user-name { font-size:12px; color:#6b7280; font-weight:600; }
        .user-bar .user-role { font-size:10px; color:white; background:#16a34a; padding:1px 6px; border-radius:4px; font-weight:600; }
        .user-bar .btn-hist { padding:4px 10px; font-size:11px; background:#f3f4f6; border:1px solid #d1d5db; border-radius:6px; cursor:pointer; font-weight:600; color:#374151; }
        .user-bar .btn-hist:hover { background:#e5e7eb; }
        .user-bar .btn-logout { padding:4px 10px; font-size:11px; background:#fef2f2; border:1px solid #fecaca; border-radius:6px; cursor:pointer; font-weight:600; color:#dc2626; }
        .user-bar .btn-logout:hover { background:#fee2e2; }
        .guest-bar { display:flex; align-items:center; gap:8px; }
        .guest-bar .btn-login-small { padding:6px 14px; font-size:12px; background:linear-gradient(135deg,#16a34a,#15803d); color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; }

        /* VIEW TOGGLE SWITCH */
        .view-toggle { display:flex; align-items:center; gap:8px; background:#f3f4f6; border-radius:8px; padding:3px; }
        .view-toggle .toggle-opt { padding:5px 12px; border-radius:6px; font-size:11px; font-weight:600; cursor:pointer; color:#6b7280; transition:all 0.2s; border:none; background:none; }
        .view-toggle .toggle-opt.active { background:white; color:#1f2937; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
        .view-toggle .toggle-opt:hover:not(.active) { color:#374151; }

        /* HISTORY MODAL */
        .hist-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; }
        .hist-overlay.active { display:flex; }
        .hist-modal { background:white; border-radius:14px; width:90%; max-width:500px; max-height:80vh; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .hist-modal-header { padding:16px 20px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; }
        .hist-modal-header h3 { margin:0; font-size:16px; }
        .hist-modal-close { background:none; border:none; font-size:22px; cursor:pointer; color:#6b7280; padding:0 4px; }
        .hist-modal-body { padding:16px 20px; overflow-y:auto; max-height:60vh; }
        .hist-entry { padding:10px 0; border-bottom:1px solid #f3f4f6; }
        .hist-entry:last-child { border-bottom:none; }
        .hist-meta { display:flex; gap:8px; align-items:center; margin-bottom:4px; }
        .hist-date { font-size:11px; color:#9ca3af; }
        .hist-user { font-size:11px; font-weight:700; color:#16a34a; }
        .hist-action { font-size:13px; color:#1f2937; }
        .hist-detail { font-size:11px; color:#6b7280; margin-top:2px; }
        .hist-empty { text-align:center; color:#9ca3af; padding:30px 0; }
        .hist-clear { margin-top:12px; text-align:center; }
        .hist-clear button { font-size:12px; color:#dc2626; background:none; border:1px solid #fecaca; padding:4px 12px; border-radius:6px; cursor:pointer; }

    </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen" class="login-container">
    <div class="login-box">
        <div class="login-logo"><span>&#127968; LES ARTISANS VERTS</span></div>
        <h2>Simulateur <span>PAC 2026</span></h2>
        <p class="login-sub">Connexion commerciale</p>
        <div class="form-group"><label>Nom d'utilisateur</label><input type="text" id="loginUser" placeholder="Utilisateur" autofocus></div>
        <div class="form-group"><label>Mot de passe</label><input type="password" id="loginPass" placeholder="Mot de passe"></div>
        <button class="btn-login" onclick="doLogin()">Se connecter</button>
        <p id="loginError" class="login-error"></p>
        <div style="margin-top:20px;padding-top:18px;border-top:1px solid #e5e7eb;text-align:center;">
            <p style="color:#9ca3af;font-size:12px;margin-bottom:10px;">Pas de compte ?</p>
            <button onclick="doGuestLogin()" style="width:100%;padding:11px;background:#f3f4f6;color:#374151;border:1px solid #d1d5db;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">&#128100; Continuer en vue client</button>
        </div>
    </div>
</div>

<!-- HISTORY MODAL -->
<div id="historyModal" class="hist-overlay" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="hist-modal">
        <div class="hist-modal-header">
            <h3>&#128203; Journal des modifications</h3>
            <button class="hist-modal-close" onclick="document.getElementById('historyModal').classList.remove('active')">&times;</button>
        </div>
        <div class="hist-modal-body" id="historyBody"></div>
    </div>
</div>

<!-- PASSWORD CHANGE MODAL -->
<div id="pwdModal" class="hist-overlay" onclick="if(event.target===this)this.classList.remove('active')">
    <div class="hist-modal" style="max-width:380px;">
        <div class="hist-modal-header">
            <h3>&#128273; Changer mon mot de passe</h3>
            <button class="hist-modal-close" onclick="document.getElementById('pwdModal').classList.remove('active')">&times;</button>
        </div>
        <div class="hist-modal-body">
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;">Ancien mot de passe</label>
                <input type="password" id="pwdOld" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;">Nouveau mot de passe</label>
                <input type="password" id="pwdNew" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
            </div>
            <div style="margin-bottom:14px;">
                <label style="display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:4px;">Confirmer</label>
                <input type="password" id="pwdConfirm" style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;box-sizing:border-box;">
            </div>
            <button onclick="doChangePassword()" style="width:100%;padding:12px;background:linear-gradient(135deg,#16a34a,#15803d);color:white;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;">Modifier</button>
            <p id="pwdError" style="color:#dc2626;text-align:center;margin-top:10px;font-size:13px;display:none;"></p>
            <p id="pwdSuccess" style="color:#16a34a;text-align:center;margin-top:10px;font-size:13px;display:none;"></p>
        </div>
    </div>
</div>

<!-- APP (hidden until login) -->
<div id="appScreen" style="display:none;">
    <div class="header">
        <div class="container">
            <!-- Row 1: Logo + Title + Refresh -->
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="background:linear-gradient(135deg,#16a34a,#15803d); color:white; padding:8px 12px; border-radius:8px; font-weight:700; font-size:13px; letter-spacing:0.3px; box-shadow:0 2px 8px rgba(22,163,74,0.3);">&#127968; LAV</div>
                    <div style="font-size:16px; font-weight:700; color:#1d1d1f; line-height:1.2;">Simulateur PAC <span style="font-size:11px; background:#16a34a; color:white; padding:1px 6px; border-radius:4px; vertical-align:middle;">2026</span></div>
                </div>
                <button class="btn-reset" onclick="reset()" title="Rafrachir"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></button>
            </div>
            <!-- Row 2: User controls -->
            <!-- GUEST BAR -->
            <div class="guest-bar" id="guestBar" style="display:none;">
                <button class="btn-login-small" onclick="goToLogin()">&#128273; Se connecter</button>
            </div>
            <!-- USER BAR -->
            <div class="user-bar" id="userBar" style="display:none;">
                <span class="user-name" id="userNameDisplay">&mdash;</span>
                <span class="user-role" id="userRoleDisplay">&mdash;</span>
                <div class="view-toggle" id="viewToggle">
                    <button class="toggle-opt active" id="togClient" onclick="switchView('client')">&#128100; Client</button>
                    <button class="toggle-opt" id="togFournisseur" onclick="switchView('fournisseur')">&#128202; Pro</button>
                </div>
                <button class="btn-hist" id="btnHistory" onclick="openHistory()" style="display:none;">&#128203;</button>
                <button class="btn-hist" id="btnPwd" onclick="openPwdModal()" style="display:none;">&#128273;</button>
                <button class="btn-logout" onclick="doLogout()">&#8618;</button>
            </div>
        </div>
    </div>

    <div class="main-content" id="mainContent">
        <div class="parameters-section">
            <div class="card">
                <h2 class="card-title">Paramtres</h2>

                <!-- Info client -->
                <div style="font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">&#128100; Informations client</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Nom</label>
                        <input type="text" id="nom" placeholder="Nom du client" oninput="checkExport()" onchange="logClientChange()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Prnom</label>
                        <input type="text" id="prenom" placeholder="Prnom du client" oninput="checkExport()" onchange="logClientChange()">
                    </div>
                </div>
                <div class="grid-3col" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="departement">Dpartement</label>
                        <input type="text" id="departement" placeholder="Ex: 33, 75&#8230;" maxlength="3" style="text-align: center; font-weight: 600;" oninput="detectDept()">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="rfr">Revenu fiscal de rf. (&euro;)</label>
                        <input type="number" id="rfr" placeholder="Ex: 35 000" oninput="detectProfil()" style="font-weight: 600;">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="nbPersonnes">Foyer</label>
                        <select id="nbPersonnes" onchange="detectProfil()">
                            <option value="1">1 personne</option>
                            <option value="2">2 personnes</option>
                            <option value="3">3 personnes</option>
                            <option value="4" selected>4 personnes</option>
                            <option value="5">5 personnes</option>
                            <option value="6">6 personnes</option>
                            <option value="7">7 personnes</option>
                            <option value="8">8 personnes</option>
                        </select>
                    </div>
                </div>

                <!-- Hidden: auto-grs -->
                <select id="zone" onchange="calc()" style="display:none;">
                    <option value="H1">H1</option><option value="H2">H2</option><option value="H3">H3</option>
                </select>
                <span id="deptZoneResult" style="display:none;"></span>
                <select id="region" onchange="detectProfil()" style="display:none;">
                    <option value="PROVINCE">Province</option><option value="IDF">IDF</option>
                </select>
                <input type="hidden" id="typeLogement" value="maison">
                <select id="surface" style="display:none;">
                    <option value="S<70">S &lt; 70 m</option>
                    <option value="70<=S<90">70 &le; S &lt; 90 m</option>
                    <option value="S>=90" selected>S &ge; 90 m</option>
                </select>
                <select id="categorie" style="display:none;">
                    <option value="BLEU">BLEU</option><option value="JAUNE">JAUNE</option>
                    <option value="VIOLET">VIOLET</option><option value="ROSE">ROSE</option>
                </select>

                <!-- ===== BLOC RSULTAT MPR + CEE ===== -->
                <div id="mprCeeWrapper" style="margin-top: 14px; border-radius: 14px; padding: 20px; background: linear-gradient(160deg, #0f172a 0%, #1e3a5f 40%, #134e4a 100%); color: white;">

                <!-- Bloc rsultat MPR -->
                <div id="mprResultBloc" style="display: none; border-radius: 12px; padding: 20px; text-align: center; transition: all 0.2s; margin-bottom: 16px;">
                    <div id="mprProfilIcon" style="font-size: 32px; margin-bottom: 6px;">&#128309;</div>
                    <div id="mprProfilLabel" style="font-size: 18px; font-weight: 800; margin-bottom: 4px;">Profil Bleu</div>
                    <div id="mprProfilDesc" style="font-size: 13px; font-weight: 500; opacity: 0.85; margin-bottom: 10px;">Revenus trs modestes</div>
                    <div class="grid-3col" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                        <div style="background: rgba(255,255,255,0.25); border-radius: 8px; padding: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.7; letter-spacing: 0.5px;">Rgion / Zone</div>
                            <div id="mprInfoRegion" style="font-size: 14px; font-weight: 700;">Province</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.25); border-radius: 8px; padding: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.7; letter-spacing: 0.5px;">Foyer</div>
                            <div id="mprInfoFoyer" style="font-size: 14px; font-weight: 700;">4 pers.</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.25); border-radius: 8px; padding: 8px;">
                            <div style="font-size: 10px; text-transform: uppercase; opacity: 0.7; letter-spacing: 0.5px;">Seuil</div>
                            <div id="mprInfoSeuil" style="font-size: 14px; font-weight: 700;">&mdash;</div>
                        </div>
                    </div>
                    <div id="mprInfoRFR" style="font-size: 12px; margin-top: 10px; opacity: 0.75;"></div>
                    <div id="mprInfoAide" style="font-size: 15px; font-weight: 700; margin-top: 8px; background: rgba(255,255,255,0.3); border-radius: 8px; padding: 8px;"></div>
                </div>

                <!-- Paramtres techniques + CEE -->
                <div style="font-size: 12px; font-weight: 600; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">&#9889; Scnario & Aides CEE</div>
                <div class="grid-3col" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="scenario" style="color: rgba(255,255,255,0.7);">Scnario</label>
                        <select id="scenario" onchange="onScenarioChange()">
                            <option value="PAC">PAC</option>
                            <option value="PAC + BALLON LECTRIQUE">PAC + BALLON LECTRIQUE</option>
                            <option value="PAC + BALLON THERMO">PAC + BALLON THERMO</option>
                            <option value="PAC + SSC">PAC + SSC</option>
                            <option value="SSC">SSC</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;" id="etasGroup">
                        <label for="etas" style="color: rgba(255,255,255,0.7);">Plage d'ETAS</label>
                        <select id="etas" onchange="syncEtas(); calc()">
                            <option value="111-140">111 &lt; ETAS &lt; 140</option>
                            <option value="140-170" selected>140 &lt; ETAS &lt; 170</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;" id="ceeSurfaceGroup">
                        <label style="color: rgba(255,255,255,0.7);">Surface chauffe (m)</label>
                        <input type="number" id="ceeSurface" min="1" step="1" value="95" oninput="syncSurfaces('cee')">
                    </div>
                </div>

                <!-- Fiches info (hidden) -->
                <div style="display:none;">
                    Fiches : <strong id="ceeFichesLabel">BAR-TH-171</strong>
                    <span id="ceeNonCumulNote"></span>
                </div>

                <!-- Hidden fields for JS -->
                <span id="ceeScenarioLabel" style="display:none;">PAC</span>
                <select id="ficheCEE" style="display:none;" onchange="toggleCEEBlocs(); calcCEEDetail();">
                    <option value="171">BAR-TH-171</option>
                    <option value="143">BAR-TH-143</option>
                    <option value="148">BAR-TH-148</option>
                </select>
                <select id="ceeEtas" style="display:none;">
                    <option value="lt140">lt140</option>
                    <option value="ge140" selected>ge140</option>
                </select>
                <div style="display:none;">
                    <select id="menageCEE" onchange="calcCEEDetail()">
                        <option value="tm">Trs modestes (12,5 &euro;/MWhc)</option>
                        <option value="autres">Autres mnages (7,5 &euro;/MWhc)</option>
                    </select>
                    <input type="text" id="ceeCoefSurface" disabled value="&mdash;">
                    <div id="ceeSurfaceInfo"></div>
                </div>

                <!-- KPI CEE -->
                <div class="cee-kpi-row" style="grid-template-columns: 1fr 1fr; margin-top: 4px;">
                    <div class="cee-kpi" style="background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.6);">Volume CEE</div>
                        <div class="kpi-value" id="ceeOutKwhc" style="color: #fbbf24;">&mdash;</div>
                    </div>
                    <div class="cee-kpi" style="background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1);">
                        <div class="kpi-label" style="color: rgba(255,255,255,0.6);">Prime CEE</div>
                        <div class="kpi-value" id="ceeOutPrime" style="color: #34d399;">&mdash;</div>
                    </div>
                </div>
                <!-- Dtail fournisseur -->
                <div class="fournisseur-only" style="margin-top: 4px; font-size: 11px; color: rgba(255,255,255,0.4); font-family: ui-monospace, monospace;">
                    <span id="ceeOutDetail">&mdash;</span>  <span id="ceeOutPrix">&mdash;</span>
                </div>

                </div><!-- /mprCeeWrapper -->

                <!-- Blocs fournisseur dtail -->
                <div class="fournisseur-only">
                    <div class="cee-bloc-171" id="ceeBloc171" style="display:none;"></div>
                    <div class="cee-bloc-148 cee-hidden" id="ceeBloc148" style="margin-top: 8px;">
                        <div class="cee-grid">
                            <div>
                                <label>Forfait BAR-TH-148 (kWhc)</label>
                                <input type="number" id="ceeKwhc148" min="0" step="100" value="9000" oninput="calcCEEDetail()">
                            </div>
                            <div>
                                <label>Forfait calcul</label>
                                <input type="text" id="cee148Forfait" disabled value="&mdash;" style="background: #f1f5f9; font-weight: 600;">
                            </div>
                            <div>
                                <label>Note interne</label>
                                <input type="text" id="ceeNote148" placeholder="COP, volume ballon, marque..." oninput="calcCEEDetail()">
                            </div>
                        </div>
                    </div>
                    <div id="ceeBloc143" class="cee-hidden" style="margin-top: 8px;">
                        <div style="font-size: 12px; font-weight: 600; color: #2563eb; margin-bottom: 8px;">&#128217; BAR-TH-143 &mdash; SSC  <span style="color: #059669;">Coup de pouce &times;2</span></div>
                        <div class="cee-grid">
                            <div>
                                <label>Forfait par zone</label>
                                <input type="text" id="cee143Forfait" disabled value="&mdash;" style="background: #f1f5f9; font-weight: 600;">
                                <div class="cee-hint">H1: 134 800  H2: 121 000  H3: 100 500 kWhc</div>
                            </div>
                        </div>
                    </div>
                    <div class="cee-kpi-row" style="grid-template-columns: 1fr; margin-top: 8px;">
                        <div class="cee-kpi" id="ceeKpi148" style="display:none;">
                            <div class="kpi-label">Dont BAR-TH-148</div>
                            <div class="kpi-value" id="ceeOut148" style="color: #059669;">&mdash;</div>
                            <div class="kpi-detail" id="ceeOut148Detail">&mdash;</div>
                        </div>
                    </div>
                    <div class="cee-result" id="ceeResult"></div>
                </div>

                <div id="calcErrorDebug" style="color: red; font-size: 12px; font-weight: 600; margin-top: 8px; padding: 6px; background: #fef2f2; border-radius: 6px;"></div>
            </div>

            <!-- ===================== BARME PAC (client) ===================== -->
            <div class="card" id="baremeCard">
                <h2 class="card-title">&#128208; Puissance PAC recommande</h2>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 14px;">Estimation selon la surface, l'anne de construction et l'isolation</div>

                <!-- Hidden input for sync -->
                <input type="hidden" id="baremeSurface" value="100">

                <!-- Anne de construction -->
                <div class="form-group" style="margin-bottom: 14px;">
                    <label>Anne de construction</label>
                    <input type="number" id="dimAnnee" value="2000" min="1900" max="2026" oninput="evalIsolation(); calcBareme(); calcDim()">
                </div>

                <!-- Questionnaire isolation -->
                <div style="margin-bottom: 14px;">
                    <label style="font-weight: 600; color: #1d1d1f; font-size: 13px; display: block; margin-bottom: 10px;">Travaux d'isolation raliss</label>
                    <div style="display: flex; flex-direction: column; gap: 6px;" id="isoChecklist">
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="combles">
                            <span class="iso-info">
                                <span class="iso-title">Combles / Toiture</span>
                                <span class="iso-sub">Isolation souffle, rampants, sarking&#8230;</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="murs">
                            <span class="iso-info">
                                <span class="iso-title">Murs (ITE / ITI)</span>
                                <span class="iso-sub">Isolation thermique extrieure ou intrieure</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="fenetres">
                            <span class="iso-info">
                                <span class="iso-title">Fentres double / triple vitrage</span>
                                <span class="iso-sub">Remplacement des menuiseries</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="plancher">
                            <span class="iso-info">
                                <span class="iso-title">Plancher bas</span>
                                <span class="iso-sub">Isolation vide sanitaire, sous-sol, terre-plein</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                        <label class="iso-check" onclick="setTimeout(function(){evalIsolation();calcBareme()},10)">
                            <input type="checkbox" name="isoWork" value="vmc">
                            <span class="iso-info">
                                <span class="iso-title">VMC double flux</span>
                                <span class="iso-sub">Ventilation mcanique contrle performante</span>
                            </span>
                            <select class="iso-quand" onchange="evalIsolation();calcBareme()">
                                <option value="recent">&lt; 5 ans</option>
                                <option value="ancien">&gt; 5 ans</option>
                            </select>
                        </label>
                    </div>
                    <!-- Rsultat isolation (fournisseur only) -->
                    <div id="isoResult" class="fournisseur-only" style="margin-top: 10px; padding: 10px 14px; border-radius: 8px; font-size: 13px; background: #f8fafc; border: 1.5px solid #e2e8f0;">
                        <span style="font-weight: 600;" id="isoStateName">tat d'origine / Non prcis</span>
                        <span style="color: #64748b;"> &mdash; </span>
                        <span style="font-weight: 700; color: #16a34a;" id="dimGDisplay">G = 0,95</span>
                    </div>
                </div>

                <!-- Rsultat barme visuel -->
                <div id="baremeResult" style="padding: 20px; background: linear-gradient(135deg, #f0fdf4, #ecfdf5); border-radius: 12px; border: 1.5px solid #bbf7d0;">
                    <div style="font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; text-align: center;">PAC recommande</div>
                    
                    <!-- Gauge visuelle -->
                    <div id="baremeGauge" style="position: relative; margin: 0 auto; max-width: 340px;">
                        <!-- Labels puissance -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                            <span id="baremeLow" style="font-size: 20px; font-weight: 800; color: #16a34a;">10 kW</span>
                            <span id="baremeHigh" style="font-size: 20px; font-weight: 800; color: #dc2626;">12 kW</span>
                        </div>
                        <!-- Barre -->
                        <div style="position: relative; height: 12px; border-radius: 6px; background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%); margin-bottom: 4px;">
                            <!-- Curseur -->
                            <div id="baremeCursor" style="position: absolute; top: -6px; width: 24px; height: 24px; border-radius: 50%; background: white; border: 3px solid #0f172a; box-shadow: 0 2px 8px rgba(0,0,0,0.25); transition: left 0.4s ease; left: 50%;" ></div>
                        </div>
                        <!-- Labels bas -->
                        <div style="display: flex; justify-content: space-between; font-size: 10px; color: #94a3b8;">
                            <span>Bien isol</span>
                            <span>Mal isol</span>
                        </div>
                    </div>

                    <!-- Rsultat texte -->
                    <div style="text-align: center; margin-top: 14px;">
                        <div id="baremeReco" style="font-size: 32px; font-weight: 800; color: #16a34a;">10 kW</div>
                        <div id="baremeAlt" style="font-size: 13px; color: #64748b; margin-top: 2px;"></div>
                        <div id="baremeIsoHint" style="font-size: 11px; color: #64748b; margin-top: 4px;"></div>
                    </div>
                </div>

                <!-- Tableau supprim - logique intgre dans calcBareme -->
            </div>

            <!-- ===================== NOTE DE DIMENSIONNEMENT (fournisseur) ===================== -->
            <div class="card fournisseur-only" id="dimensionnementCard">
                <h2 class="card-title">&#128208; Dimensionnement PAC</h2>
                <div style="font-size: 12px; color: #64748b; margin-bottom: 18px;">Estimation de la puissance recommande  Formule : P = G &times; V &times; &#916;T</div>

                <!-- Surface + Hauteur -->
                <div class="dim-row">
                    <div class="dim-field">
                        <label>Surface au sol (m) <span class="req">*</span></label>
                        <input type="number" id="dimSurface" value="100" min="1" oninput="syncSurfaces('dim')">
                        <div class="dim-hint">Exemple : 100 m</div>
                    </div>
                    <div class="dim-field">
                        <label>Hauteur sous plafond (m)</label>
                        <input type="number" id="dimHauteur" value="2.5" min="1.5" max="5" step="0.1" oninput="calcDim()">
                        <div class="dim-hint">Dfaut : 2,5 m</div>
                    </div>
                </div>

                <!-- Paramtres avancs (masqus, gards pour calcul) -->
                <input type="hidden" id="dimTbase" value="-7">
                <input type="hidden" id="dimTint" value="21">
                <input type="hidden" id="dimT1" value="60">
                <input type="hidden" id="dimT2" value="140">

                <!-- RSULTATS -->
                <div style="background: linear-gradient(135deg, #0f172a 0%, #1e3a5f 100%); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                    <div style="font-weight: 700; color: white; font-size: 14px; margin-bottom: 14px; text-align: center;">RSULTATS DU DIMENSIONNEMENT</div>
                    
                    <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px;">Dperditions totales (P = G &times; V &times; &#916;T)</div>
                        <div style="font-size: 28px; font-weight: 800; color: #fbbf24;" id="dimDeperditions">&mdash;</div>
                        <div style="font-size: 12px; color: #cbd5e1;" id="dimDepFormula">&mdash;</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance PAC</div>
                            <div style="font-size: 24px; font-weight: 800; color: #34d399;" id="dimPuissancePAC">&mdash;</div>
                            <div style="font-size: 11px; color: #cbd5e1;" id="dimPuissancePACDetail">&mdash;</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance appoint</div>
                            <div style="font-size: 24px; font-weight: 800; color: #f97316;" id="dimPuissanceAppoint">&mdash;</div>
                            <div style="font-size: 11px; color: #cbd5e1;" id="dimPuissanceAppointDetail">&mdash;</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.08); border-radius: 8px; padding: 10px; margin-top: 10px; text-align: center;">
                        <div style="font-size: 11px; color: #94a3b8; text-transform: uppercase;">Puissance totale (PAC + appoint)</div>
                        <div style="font-size: 20px; font-weight: 700; color: white;" id="dimPuissanceTotale">&mdash;</div>
                    </div>
                </div>

                <!-- Temprature d'eau -->
                <div class="dim-row" style="margin-bottom: 0;">
                    <div class="dim-field">
                        <label>T d'eau du circuit (C)</label>
                        <input type="number" id="dimTeau" value="60" step="5" min="30" max="80">
                    </div>
                </div>

                <!-- quipement -->
                <div style="margin-top: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 14px;">
                    <div style="font-weight: 600; color: #1d1d1f; font-size: 13px; margin-bottom: 10px;">Matriel install</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 12px; color: #64748b;">Marque PAC</label>
                            <input type="text" id="dimMarque" placeholder="Ex: Daikin, Atlantic&#8230;" style="width: 100%; padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 12px; color: #64748b;">Rfrence PAC</label>
                            <input type="text" id="dimReference" placeholder="Rf. modle" style="width: 100%; padding: 8px 10px; border: 1px solid #d2d2d7; border-radius: 6px;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card fournisseur-only">
                <h2 class="card-title">Cots (Vue Fournisseur)</h2>
                
                <div style="background: #f5f5f7; padding: 16px; border-radius: 8px; margin-bottom: 8px;">
                    <!-- PAC Matriel -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">PAC Matriel</label>
                        <input type="number" id="coutPACMateriel" value="2900" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qtePACMateriel" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPACMateriel">2 900 &euro;</div>
                    </div>
                    
                    <!-- PAC Pose -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">PAC Pose</label>
                        <input type="number" id="coutPACPose" value="2500" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qtePACPose" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPACPose">2 500 &euro;</div>
                    </div>
                    
                    <!-- Ballon Matriel -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Ballon Matriel</label>
                        <input type="number" id="coutBallonMateriel" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteBallonMateriel" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalBallonMateriel">0 &euro;</div>
                    </div>
                    
                    <!-- Ballon Pose -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Ballon Pose</label>
                        <input type="number" id="coutBallonPose" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteBallonPose" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalBallonPose">0 &euro;</div>
                    </div>
                    
                    <!-- Accessoires -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Access.</label>
                        <input type="number" id="coutAccessoires" value="500" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAccessoires" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAccessoires">500 &euro;</div>
                    </div>
                    
                    <!-- Admin -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Admin</label>
                        <input type="number" id="coutAdmin" value="400" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteAdmin" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalAdmin">400 &euro;</div>
                    </div>
                    
                    <!-- Mandat MPR -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Mandat MPR</label>
                        <input type="number" id="coutMandat" value="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteMandat" value="1" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalMandat">0 &euro;</div>
                    </div>
                    
                    <!-- Demande mairie -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center; margin-bottom: 10px;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px;">Mairie</label>
                        <input type="number" id="coutMairie" value="250" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <input type="number" id="qteMairie" value="0" min="0" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: center;">
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalMairie">0 &euro;</div>
                    </div>
                    
                    <!-- Prvisite -->
                    <div style="display: grid; grid-template-columns: 120px 1fr 80px 100px; gap: 8px; align-items: center;">
                        <label style="color: #1d1d1f; font-weight: 600; font-size: 13px; display: flex; align-items: center; gap: 6px;">
                            <input type="checkbox" id="checkPrevisite" onchange="updateFromDetail()" style="width: 16px; height: 16px;"> Prvisite
                        </label>
                        <input type="number" id="coutPrevisite" value="200" step="1" oninput="updateFromDetail()" style="padding: 8px 12px; border: 1px solid #d2d2d7; border-radius: 6px; font-weight: 600; text-align: right;">
                        <div style="text-align: center; font-weight: 600; color: #64748b;">&mdash;</div>
                        <div style="font-weight: 700; text-align: right; color: #1d1d1f;" id="totalPrevisite">0 &euro;</div>
                    </div>
                </div>
                
                <small style="font-size: 11px; color: #86868b; margin-bottom: 12px; display: block; text-align: center;">
                    <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="lockCoutHT" checked onchange="calc()"> Verrouiller les cots (auto selon scnario)
                    </label>
                </small>
                
                <div style="background: #0071e3; color: white; padding: 14px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; font-size: 14px;">TOTAL COT HT</span>
                        <span style="font-size: 20px; font-weight: 700;" id="coutTotalHTDisplay">6 200 &euro;</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="prixCumac">Prix cumac (&euro;/MWhc) &mdash; auto selon mnage</label>
                        <input type="number" id="prixCumac" value="12.5" step="0.01" oninput="calc()" style="font-weight: 600;">
                    </div>

                    <div class="form-group" style="margin-bottom: 0;">
                        <label>kWh cumac</label>
                        <input type="text" id="kwhCumac" value="" readonly style="background: #f5f5f7; color: #1d1d1f; font-weight: 600;">
                    </div>
                </div>
            </div>

            <div style="padding-bottom: 40px;"></div>
        </div>

        <div class="results-sidebar" id="resultsSidebar">
            <div class="summary-card" style="margin-bottom: 0;">
                <div class="scenario-label-dark" id="scenarioSummary">&mdash;</div>

                <!-- TOTAL TTC (readonly client) -->
                <div class="ttc-readonly">
                    <div class="result-row-card" style="background: rgba(96,165,250,0.08); border-color: rgba(96,165,250,0.15);">
                        <div class="rrc-label">&#128176; Cot installation TTC</div>
                        <div class="rrc-value blue" id="totalTTC">&mdash;</div>
                    </div>
                </div>

                <!-- TOTAL TTC (editable fournisseur) -->
                <div class="fournisseur-only" style="margin-bottom: 12px;">
                    <div class="result-row-card" style="background: rgba(96,165,250,0.08); border-color: rgba(96,165,250,0.15); flex-wrap: wrap;">
                        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                            <div class="rrc-label">&#128176; Cot installation TTC</div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <input type="number" class="ttc-input-dark" id="totalTTCInput" value="10890" step="1" oninput="updateFromTTC()">
                                <span style="font-size: 20px; font-weight: 700; color: #60a5fa;"></span>
                            </div>
                        </div>
                        <small style="font-size: 11px; color: rgba(255,255,255,0.35); margin-top: 4px; width: 100%;">
                            <label style="display: inline-flex; align-items: center; gap: 6px; cursor: pointer;">
                                <input type="checkbox" id="lockTTC" checked onchange="calc()"> Verrouiller (auto selon scnario)
                            </label>
                        </small>
                    </div>
                </div>

                <!-- COT HT fournisseur -->
                <div class="fournisseur-only" style="margin-bottom: 4px;">
                    <div class="result-row-card">
                        <div>
                            <div class="rrc-label">Cot HT</div>
                            <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px;">Matriel + pose + admin</div>
                        </div>
                        <div class="rrc-value" id="displayCoutHT" style="font-size: 18px;">&mdash;</div>
                    </div>
                </div>

                <div class="glow-separator"></div>

                <!-- ESTIMATION FINANCIRE -->
                <div class="dark-section-title">Estimation financire</div>

                <div class="result-row-card">
                    <div class="rrc-label">MaPrimeRnov'</div>
                    <div class="rrc-value green" id="aidesMPR" style="font-size: 18px;">&mdash;</div>
                </div>

                <div class="result-row-card">
                    <div>
                        <div class="rrc-label">Certificats CEE</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 2px;" id="ceeSourceLabel">BAR-TH dtaill</div>
                    </div>
                    <div class="rrc-value green" id="aidesCEE" style="font-size: 18px;">&mdash;</div>
                </div>

                <div class="glow-separator"></div>

                <!-- TOTAL AIDES -->
                <div class="result-highlight-card">
                    <div class="rhc-label">Total des aides</div>
                    <div class="rhc-value" id="totalAides">&mdash;</div>
                </div>

                <!-- RESTE  CHARGE -->
                <div class="result-row-card" style="background: rgba(251,191,36,0.08); border-color: rgba(251,191,36,0.15);">
                    <div class="rrc-label">&#127968; Reste  charge estim</div>
                    <div class="rrc-value yellow" id="resteCharge">&mdash;</div>
                </div>

                <!-- MARGE fournisseur -->
                <div class="fournisseur-only" style="margin-top: 4px;">
                    <div class="result-row-card" style="background: rgba(248,113,113,0.06); border-color: rgba(248,113,113,0.12);">
                        <div class="rrc-label">&#128202; Marge finale (HT)</div>
                        <div class="rrc-value" id="margeFinal" style="font-size: 18px;">&mdash;</div>
                    </div>
                </div>

                <div class="glow-separator"></div>

                <!-- RAC Section (fournisseur only) -->
                <div class="rac-dark-section fournisseur-only" style="margin-bottom: 14px;">
                    <div class="dark-section-title" style="margin-bottom: 10px;">Prise en charge du RAC</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <div class="amount-label" style="color: rgba(255,255,255,0.45); margin-bottom: 4px;">Pourcentage (%)</div>
                            <input type="number" id="racPourcent" value="0" min="0" max="100" step="1" oninput="updatePct()" onchange="logRACChange()">
                        </div>
                        <div>
                            <div class="amount-label" style="color: rgba(255,255,255,0.45); margin-bottom: 4px;">RAC offert (&euro;)</div>
                            <input type="number" id="racOffert" value="0" min="0" step="1" oninput="updateAmt()" onchange="logRACChange()">
                        </div>
                    </div>
                    <div id="maxPctInfo" style="font-size: 12px; padding: 10px 14px; border-radius: 8px; background: rgba(5,150,105,0.12); border: 1px solid rgba(5,150,105,0.25); color: #34d399; margin-bottom: 6px;">
                        Remise max : <strong id="maxPctValue">&mdash;</strong> pour rester en dossier vert
                    </div>
                    <div class="note-small" style="font-size: 11px; margin-bottom: 8px; color: rgba(255,255,255,0.3);">Appliqu sur le RAC brut. N'affecte pas le prix cumac.</div>
                </div>

                <!-- Status + Actions -->
                <div id="statusBadge" class="status-badge ok" style="margin-bottom: 14px;" onclick="shareDevis()">
                    <span id="statusIcon">&#9989;</span>
                    <span id="statusText">Voulez-vous un devis ?</span>
                </div>

                <button id="exportBtn" class="btn-dark-export pdf" onclick="exportPDF()">
                    &#128196; Exporter en PDF
                </button>
                
                <button id="whatsappBtn" class="btn-dark-export whatsapp" onclick="sendWhatsApp()">
                    &#128172; Envoyer par WhatsApp
                </button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p style="margin: 0;">Propuls par 770 Lab</p>
    </div>
</div><!-- /appScreen -->

    <div id="printArea" style="display: none;">
        <div style="padding: 20px 30px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; color: #1f2937; max-width: 800px; margin: 0 auto;">
            
            <!-- EN-TTE -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 3px solid #16a34a;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="background: linear-gradient(135deg, #16a34a, #15803d); color: white; padding: 8px 14px; border-radius: 8px; font-weight: 700; font-size: 14px;">&#127968; LES ARTISANS VERTS</div>
                    <div style="font-size: 12px; color: #6b7280;">Simulateur Aides PAC 2026</div>
                </div>
                <div style="text-align: right;">
                    <div id="printDate" style="font-size: 12px; color: #6b7280;"></div>
                    <div id="printCommercial" style="font-size: 11px; color: #16a34a; font-weight: 600; margin-top: 2px;"></div>
                </div>
            </div>

            <!-- TITRE -->
            <h1 id="printTitle" style="font-size: 22px; font-weight: 800; margin: 0 0 14px; color: #0f172a;"></h1>

            <!-- CLIENT + PROFIL -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 14px; page-break-inside: avoid;">
                <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;">
                    <div style="font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">&#128100; Client</div>
                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <tr><td style="padding: 2px 0; color: #6b7280; width: 45%;">Nom</td><td style="padding: 2px 0; font-weight: 600;" id="printNom"></td></tr>
                        <tr><td style="padding: 2px 0; color: #6b7280;">Dpartement</td><td style="padding: 2px 0; font-weight: 600;" id="printDept"></td></tr>
                        <tr><td style="padding: 2px 0; color: #6b7280;">Zone</td><td style="padding: 2px 0; font-weight: 600;" id="printZone"></td></tr>
                        <tr><td style="padding: 2px 0; color: #6b7280;">Foyer</td><td style="padding: 2px 0; font-weight: 600;" id="printFoyer"></td></tr>
                        <tr><td style="padding: 2px 0; color: #6b7280;">RFR</td><td style="padding: 2px 0; font-weight: 600;" id="printRFR"></td></tr>
                    </table>
                </div>
                <div id="printProfilCard" style="border-radius: 8px; padding: 12px; color: white;">
                    <div style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; opacity: 0.8;">&#127963;&#65039; Profil MaPrimeRnov'</div>
                    <div id="printProfilIcon" style="font-size: 28px; margin-bottom: 2px;">&#128309;</div>
                    <div id="printProfilLabel" style="font-size: 18px; font-weight: 800;"></div>
                    <div id="printProfilDesc" style="font-size: 12px; opacity: 0.85; margin-top: 2px;"></div>
                    <div id="printProfilSeuil" style="font-size: 11px; opacity: 0.7; margin-top: 4px;"></div>
                </div>
            </div>

            <!-- CONFIGURATION TECHNIQUE -->
            <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin-bottom: 14px; page-break-inside: avoid;">
                <div style="font-size: 10px; font-weight: 700; color: #0369a1; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">&#9881;&#65039; Configuration technique</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                    <div><div style="font-size: 10px; color: #64748b;">Scnario</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printScenario"></div></div>
                    <div><div style="font-size: 10px; color: #64748b;">Surface</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printSurface"></div></div>
                    <div><div style="font-size: 10px; color: #64748b;">ETAS</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printETAS"></div></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 6px;">
                    <div><div style="font-size: 10px; color: #64748b;">PAC recommande</div><div style="font-size: 13px; font-weight: 700; color: #16a34a;" id="printPACReco"></div></div>
                    <div><div style="font-size: 10px; color: #64748b;">Isolation</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printIsolation"></div></div>
                    <div><div style="font-size: 10px; color: #64748b;">Construction</div><div style="font-size: 13px; font-weight: 700; color: #0f172a;" id="printAnnee"></div></div>
                </div>
            </div>

            <!-- ESTIMATION FINANCIRE -->
            <div style="margin-bottom: 14px; page-break-inside: avoid;">
                <div style="font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">&#128176; Estimation financire</div>
                <div style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <tr style="background: #f8fafc;">
                            <td style="padding: 10px 14px; font-weight: 600;">Total TTC installation</td>
                            <td style="padding: 10px 14px; text-align: right; font-weight: 800; font-size: 16px;" id="printTTC"></td>
                        </tr>
                        <tr style="border-top: 1px solid #f1f5f9;">
                            <td style="padding: 8px 14px; color: #6b7280;">&#8627; MaPrimeRnov'</td>
                            <td style="padding: 8px 14px; text-align: right; font-weight: 700; color: #2563eb; font-size: 14px;" id="printMPR"></td>
                        </tr>
                        <tr style="border-top: 1px solid #f1f5f9;">
                            <td style="padding: 8px 14px; color: #6b7280;">&#8627; Prime CEE</td>
                            <td style="padding: 8px 14px; text-align: right; font-weight: 700; color: #2563eb; font-size: 14px;" id="printCEE"></td>
                        </tr>
                        <tr style="border-top: 2px solid #16a34a; background: #f0fdf4;">
                            <td style="padding: 10px 14px; font-weight: 700; color: #16a34a; font-size: 14px;">Total des aides</td>
                            <td style="padding: 10px 14px; text-align: right; font-weight: 800; color: #16a34a; font-size: 18px;" id="printTotalAides"></td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- DTAIL CEE -->
            <div style="background: #fefce8; border: 1px solid #fde68a; border-radius: 8px; padding: 8px 12px; margin-bottom: 14px; font-size: 11px; color: #92400e; page-break-inside: avoid;">
                <strong>Dtail CEE :</strong> <span id="printCEEDetail"></span>
            </div>

            <!-- RESTE  CHARGE -->
            <div style="border: 2px solid #0f172a; border-radius: 10px; padding: 16px; margin-bottom: 14px; text-align: center; page-break-inside: avoid;">
                <div style="font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Reste  charge client</div>
                <div id="printRAC" style="font-size: 36px; font-weight: 800; color: #0f172a;"></div>
                <div id="printRACDetail" style="font-size: 12px; color: #6b7280; margin-top: 2px;"></div>
            </div>

            <!-- STATUT -->
            <div id="printStatus" style="padding: 12px; border-radius: 8px; text-align: center; font-weight: 700; font-size: 16px; margin-bottom: 16px; page-break-inside: avoid;"></div>

            <!-- PIED DE PAGE -->
            <div style="text-align: center; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                <div style="font-size: 10px; color: #9ca3af;">Document gnr automatiquement &mdash; Les Artisans Verts  Propuls par 770 Lab</div>
                <div style="font-size: 9px; color: #d1d5db; margin-top: 2px;">Ce document est une estimation et ne constitue pas un devis contractuel</div>
            </div>
        </div>
    </div>

<script>
// Debug helper
const _debugLog=[];
function dbg(msg){
    _debugLog.push(new Date().toLocaleTimeString()+': '+msg);
    try{
        const el=document.getElementById('debugLog');
        if(el) el.innerHTML=_debugLog.slice(-30).map(l=>'<div>'+l+'</div>').join('');
    }catch(e){}
    console.log('[DBG]', msg);
}
window.onerror=function(msg,url,line,col,err){
    console.warn('JS ERROR:', msg, 'line', line);
    return false;
};

// ============================================
// BARMES DE REVENUS MPR 2026
// ============================================
// ============================================
// TABLE DPARTEMENTS \u2192 ZONE CLIMATIQUE (source officielle)
// ============================================
const DEPT_ZONE = {
    "01":"H1","02":"H1","03":"H1","04":"H2","05":"H1","06":"H3","07":"H2","08":"H1","09":"H2","10":"H1",
    "11":"H3","12":"H2","13":"H3","14":"H1","15":"H1","16":"H2","17":"H2","18":"H2","19":"H1","20":"H3",
    "2A":"H3","2B":"H3",
    "21":"H1","22":"H2","23":"H1","24":"H2","25":"H1","26":"H2","27":"H1","28":"H1","29":"H2","30":"H3",
    "31":"H2","32":"H2","33":"H2","34":"H3","35":"H2","36":"H2","37":"H2","38":"H1","39":"H1","40":"H2",
    "41":"H2","42":"H1","43":"H1","44":"H2","45":"H1","46":"H2","47":"H2","48":"H2","49":"H2","50":"H2",
    "51":"H1","52":"H1","53":"H2","54":"H1","55":"H1","56":"H2","57":"H1","58":"H1","59":"H1","60":"H1",
    "61":"H1","62":"H1","63":"H1","64":"H2","65":"H2","66":"H3","67":"H1","68":"H1","69":"H1","70":"H1",
    "71":"H1","72":"H2","73":"H1","74":"H1","75":"H1","76":"H1","77":"H1","78":"H1","79":"H2","80":"H1",
    "81":"H2","82":"H2","83":"H3","84":"H2","85":"H2","86":"H2","87":"H1","88":"H1","89":"H1","90":"H1",
    "91":"H1","92":"H1","93":"H1","94":"H1","95":"H1"
};

function detectDept() {
    const deptInput = document.getElementById('departement').value.trim();
    if (!deptInput) return;
    const deptKey = deptInput.padStart(2,'0');

    // Auto IDF
    const IDF_DEPTS = ['75','77','78','91','92','93','94','95'];
    const isIDF = IDF_DEPTS.includes(deptKey);
    document.getElementById('region').value = isIDF ? 'IDF' : 'PROVINCE';
    detectProfil();

    const zone = DEPT_ZONE[deptInput] || DEPT_ZONE[deptKey];
    if (zone) {
        document.getElementById('zone').value = zone;
        document.getElementById('deptZoneResult').textContent = `\u2192 Zone ${zone}${isIDF ? '  IDF' : ''}`;
        
        // Auto Tbase dimensionnement
        const tbase = DEPT_TBASE[deptKey] || DEPT_TBASE[deptInput];
        if (tbase !== undefined) {
            document.getElementById('dimTbase').value = tbase;
            calcDim();
        }
        calc();
        calcCEEDetail();
    } else {
        document.getElementById('deptZoneResult').textContent = '\u274C Dpartement inconnu';
        
    }
}

const REVENUS_2026 = {
    PROVINCE: {
        1: [17363, 22259, 31185],
        2: [25393, 32553, 45842],
        3: [30540, 39148, 55196],
        4: [35676, 45735, 64550],
        5: [40835, 52348, 73907],
        supplement: [5151, 6598, 9357]
    },
    IDF: {
        1: [24031, 29253, 40851],
        2: [35270, 42933, 60051],
        3: [42357, 51564, 71846],
        4: [49455, 60208, 84562],
        5: [56580, 68877, 96817],
        supplement: [7116, 8663, 12257]
    }
};

function getSeuilsForPersonnes(region, nb) {
    const data = REVENUS_2026[region];
    if (nb <= 5) return data[nb];
    const base = data[5];
    const sup = data.supplement;
    const extra = nb - 5;
    return [
        base[0] + sup[0] * extra,
        base[1] + sup[1] * extra,
        base[2] + sup[2] * extra
    ];
}

function detectProfil() {
    const region = document.getElementById('region').value;
    const nb = parseInt(document.getElementById('nbPersonnes').value);
    const rfr = parseFloat(document.getElementById('rfr').value);
    const bloc = document.getElementById('mprResultBloc');

    if (!rfr || rfr <= 0) {
        bloc.style.display = 'none';
        return;
    }

    const seuils = getSeuilsForPersonnes(region, nb);
    let profil, icon, label, desc, bg, color;

    if (rfr <= seuils[0]) {
        profil = 'BLEU'; icon = '\uD83D\uDD35'; label = 'Profil Bleu'; desc = 'Revenus trs modestes';
        bg = 'linear-gradient(135deg, #1e40af, #3b82f6)'; color = '#ffffff';
    } else if (rfr <= seuils[1]) {
        profil = 'JAUNE'; icon = '\uD83D\uDFE1'; label = 'Profil Jaune'; desc = 'Revenus modestes';
        bg = 'linear-gradient(135deg, #ca8a04, #eab308)'; color = '#ffffff';
    } else if (rfr <= seuils[2]) {
        profil = 'VIOLET'; icon = '\uD83D\uDFE3'; label = 'Profil Violet'; desc = 'Revenus intermdiaires';
        bg = 'linear-gradient(135deg, #6b21a8, #a855f7)'; color = '#ffffff';
    } else {
        profil = 'ROSE'; icon = '<span style="display:inline-block;width:28px;height:28px;border-radius:50%;background:#f472b6;"></span>'; label = 'Profil Rose'; desc = 'Revenus suprieurs';
        bg = 'linear-gradient(135deg, #9d174d, #f472b6)'; color = '#ffffff';
    }

    const regionLabel = region === 'IDF' ? 'le-de-France' : 'Province';
    const seuilIdx = profil === 'BLEU' ? 0 : (profil === 'JAUNE' ? 1 : 2);
    const seuilVal = seuils[seuilIdx];

    // Update bloc
    bloc.style.display = 'block';
    bloc.style.background = bg;
    bloc.style.color = color;
    document.getElementById('mprProfilIcon').innerHTML = icon;
    document.getElementById('mprProfilLabel').textContent = label;
    document.getElementById('mprProfilDesc').textContent = desc;
    const zn = document.getElementById('zone').value;
    document.getElementById('mprInfoRegion').textContent = regionLabel + '  ' + zn;
    document.getElementById('mprInfoFoyer').textContent = nb + ' pers.';
    document.getElementById('mprInfoSeuil').textContent = profil === 'ROSE'
        ? '> ' + seuilVal.toLocaleString('fr-FR') + ' \u20AC'
        : '\u2264 ' + seuilVal.toLocaleString('fr-FR') + ' \u20AC';
    document.getElementById('mprInfoRFR').textContent = 'RFR dclar : ' + rfr.toLocaleString('fr-FR') + ' \u20AC';

    // Aide MPR pour le scnario en cours
    const sc = document.getElementById('scenario').value;
    const mpr = D.MPR[sc] ? D.MPR[sc][profil] : 0;
    document.getElementById('mprInfoAide').textContent = mpr > 0
        ? 'Aide MaPrimeRnov\' : ' + mpr.toLocaleString('fr-FR') + ' \u20AC'
        : 'Pas d\'aide MaPrimeRnov\' pour ce profil';

    document.getElementById('categorie').value = profil;

    // Sync catgorie mnage CEE
    document.getElementById('menageCEE').value = (profil === 'BLEU') ? 'tm' : 'autres';

    calc();
    calcCEEDetail();
}

function toggleRevenus() {
    const body = document.getElementById('revenusBody');
    const arrow = document.getElementById('toggleArrow');
    if (body) body.classList.toggle('open');
    if (arrow) arrow.classList.toggle('open');
}

// ============================================
// CEE DTAIL \u2014 BAR-TH-171 / 143 / 148
// (Source : fiche BAR-TH-171 vA78.4)
// ============================================
const CEE_PRICE = { tm: 12.5, autres: 7.5 }; // \u20AC/MWhc

const BAR143 = { H1: 134800, H2: 121000, H3: 100500 };

// BAR-TH-148 v.A73.3 \u2014 Forfaits officiels ( compter du 01/11/2025)
const BAR148 = { maison: 14700, appartement: 11800 };

const BAR171 = {
    maison: {
        base: { lt140: 90900, ge140: 109200 },
        coefSurface: (S) => (S < 70 ? 0.5 : (S < 90 ? 0.7 : 1.0)),
        tranches: "Maison : S<70\u21920,5  70\u2264S<90\u21920,7  S\u226590\u21921"
    },
    appartement: {
        base: { lt140: 48700, ge140: 58900 },
        coefSurface: (S) => (S < 35 ? 0.5 : (S < 60 ? 0.7 : 1.0)),
        tranches: "Appart : S<35\u21920,5  35\u2264S<60\u21920,7  S\u226560\u21921"
    },
    coefZone: { H1: 1.2, H2: 1.0, H3: 0.7 }
};


// Surface dropdown \u2192 catgorie pour table CEE (maison: les 5 anciennes catgories)
function surfaceToCategory(surfaceVal) {
    // surfaceVal comes from the dropdown: "S<70", "70<=S<90", "S>=90" (maison) or "S<35", "35<=S<60", "S>=60" (appart)
    // Map to table CEE keys
    const map = {
        'S<70': 'S<70', '70<=S<90': '70<S<90', 'S>=90': '90<S<110',
        'S<35': 'S<70', '35<=S<60': '70<S<90', 'S>=60': '90<S<110'
    };
    return map[surfaceVal] || '90<S<110';
}

function getSurfaceLabel() {
    const sel = document.getElementById('surface');
    return sel.options[sel.selectedIndex].text;
}

// Surface coef from dropdown value (BAR-TH-171 officiel)
function getSurfaceCoef(surfaceVal) {
    const map = { 'S<70': 0.5, '70<=S<90': 0.7, 'S>=90': 1, 'S<35': 0.5, '35<=S<60': 0.7, 'S>=60': 1 };
    return map[surfaceVal] || 1;
}

// Dynamic surface options based on type logement
function updateSurfaceOptions() {
    const tl = document.getElementById('typeLogement').value;
    const sel = document.getElementById('surface');
    const oldCoef = getSurfaceCoef(sel.value); // preserve coef level
    sel.innerHTML = '';
    if (tl === 'maison') {
        sel.add(new Option('S < 70 m', 'S<70'));
        sel.add(new Option('70 \u2264 S < 90 m', '70<=S<90'));
        sel.add(new Option('S \u2265 90 m', 'S>=90'));
    } else {
        sel.add(new Option('S < 35 m', 'S<35'));
        sel.add(new Option('35 \u2264 S < 60 m', '35<=S<60'));
        sel.add(new Option('S \u2265 60 m', 'S>=60'));
    }
    // Set option with same coef level
    const coefToMaison = { 0.5: 'S<70', 0.7: '70<=S<90', 1: 'S>=90' };
    const coefToAppart = { 0.5: 'S<35', 0.7: '35<=S<60', 1: 'S>=60' };
    const targetMap = tl === 'maison' ? coefToMaison : coefToAppart;
    sel.value = targetMap[oldCoef] || sel.options[sel.options.length - 1].value;
}

function onTypeLogementChange() {
    updateSurfaceOptions();
    calc();
}

function syncEtas() {
    const val = document.getElementById('etas').value;
    document.getElementById('ceeEtas').value = (val === '111-140') ? 'lt140' : 'ge140';
    calcCEEDetail();
}

function onScenarioChange() {
    const sc = document.getElementById('scenario').value;
    const isSSC = (sc === 'SSC');
    // SSC seul: hide ETAS, surface, barme PAC (143 = forfait zone only)
    document.getElementById('etasGroup').style.display = isSSC ? 'none' : '';
    document.getElementById('ceeSurfaceGroup').style.display = isSSC ? 'none' : '';
    document.getElementById('baremeCard').style.display = isSSC ? 'none' : '';
    const dimCard = document.getElementById('dimensionnementCard');
    if (dimCard) dimCard.style.display = isSSC ? 'none' : '';
    // Demande mairie for SSC scenarios
    const mairieRow = document.getElementById('mairieRow');
    if (mairieRow) mairieRow.style.display = (sc === 'PAC + SSC' || sc === 'SSC') ? '' : 'none';
    detectProfil();
    calc();
    if(typeof logScenarioChange==='function') logScenarioChange();
}

let _calcRunning = false;

let lastCEEDetailPrime = 0;
let lastCEEDetailKwhc = 0;

function toggleCEE() {
    const body = document.getElementById('ceeBody');
    const arrow = document.getElementById('ceeToggleArrow');
    if (body) body.classList.toggle('open');
    if (arrow) arrow.classList.toggle('open');
}

// Quelle(s) fiche(s) BAR-TH s'appliquent selon le scnario
// Depuis 01/01/2026 : BAR-TH-148 NON cumulable avec BAR-TH-171 (arrt 15/12/2025)
function getCEEFiches(scenario) {
    switch(scenario) {
        case 'PAC':                    return ['171'];
        case 'PAC + BALLON LECTRIQUE': return ['171'];
        case 'PAC + BALLON THERMO':     return ['171']; // 148 non cumulable depuis 01/2026
        case 'PAC + SSC':              return ['171', '143']; // cumul 171+143, CdP sur 171 uniquement
        case 'SSC':                    return ['143']; // SSC seul = BAR-TH-143 uniquement
        default:                        return ['171'];
    }
}

function calcCEEDetail() {
  try {
    const sc = document.getElementById('scenario').value;
    const zn = document.getElementById('zone').value;
    const menage = document.getElementById('menageCEE').value;
    const price = CEE_PRICE[menage] || CEE_PRICE.autres;
    const tl = document.getElementById('typeLogement').value;
    const surfaceVal = document.getElementById('surface').value;
    const coefS = getSurfaceCoef(surfaceVal);

    // Update surface info label
    const ceeSurfInfo = document.getElementById('ceeSurfaceInfo');
    if (ceeSurfInfo) {
        const s = parseInt(document.getElementById('ceeSurface').value) || 0;
        if (tl === 'maison') {
            ceeSurfInfo.textContent = s < 70 ? '\u2192 S < 70 m (coef 0,5)' : (s < 90 ? '\u2192 70 \u2264 S < 90 m (coef 0,7)' : '\u2192 S \u2265 90 m (coef 1)');
        } else {
            ceeSurfInfo.textContent = s < 35 ? '\u2192 S < 35 m (coef 0,5)' : (s < 60 ? '\u2192 35 \u2264 S < 60 m (coef 0,7)' : '\u2192 S \u2265 60 m (coef 1)');
        }
    }

    const fiches = getCEEFiches(sc);

    // Labels
    document.getElementById('ceeScenarioLabel').textContent = SCENARIO_NAMES[sc] || sc;
    document.getElementById('ceeFichesLabel').textContent = fiches.map(f => 'BAR-TH-' + f).join(' + ');
    const noteEl = document.getElementById('ceeNonCumulNote');
    if (noteEl) { noteEl.style.display = 'none'; }

    // Show/hide blocs
    document.getElementById('ceeBloc171').classList.toggle('cee-hidden', !fiches.includes('171'));
    document.getElementById('ceeBloc148').classList.toggle('cee-hidden', !fiches.includes('148'));
    document.getElementById('ceeBloc143').classList.toggle('cee-hidden', !fiches.includes('143'));

    let totalKwhc = 0;
    let details = [];
    let statusParts = [];

    // === BAR-TH-171 ===
    if (fiches.includes('171')) {
        const etasKey = document.getElementById('etas').value === '111-140' ? 'lt140' : 'ge140';
        const base = BAR171[tl].base[etasKey];
        const cz = BAR171.coefZone[zn];
        document.getElementById('ceeCoefSurface').value = coefS.toString().replace('.', ',');
        const CDP = 5; // Coup de pouce Chauffage \u00D75 (arrt 74e, oct 2025)
        const kwhc171 = base * coefS * cz * CDP;
        totalKwhc += kwhc171;
        details.push(`171: ${fmtIntCEE(kwhc171)}`);
        statusParts.push(`\u2705 171: base ${fmtIntCEE(base)} \u00D7 coef ${coefS} \u00D7 zone ${cz} \u00D7 CdP \u00D7${CDP}`);
    }

    // === BAR-TH-148 ===
    if (fiches.includes('148')) {
        const kwhc148 = BAR148[tl] || 14700;
        totalKwhc += kwhc148;
        details.push(`148: ${fmtIntCEE(kwhc148)}`);
        const typeLabel = tl === 'maison' ? 'Maison' : 'Appart';
        document.getElementById('cee148Forfait').value = `${fmtIntCEE(kwhc148)} kWhc (${typeLabel})`;
        const prime148 = (kwhc148 / 1000) * price;
        document.getElementById('ceeOut148').textContent = fmtEurCEE(prime148);
        document.getElementById('ceeOut148Detail').textContent = `${fmtIntCEE(kwhc148)} kWhc`;
        document.getElementById('ceeKpi148').style.display = 'block';
        statusParts.push(`\u2705 148: ${fmtIntCEE(kwhc148)} kWhc (v.A73.3  ${typeLabel})`);
    } else {
        document.getElementById('ceeKpi148').style.display = 'none';
    }

    // === BAR-TH-143 ===
    if (fiches.includes('143')) {
        const base143 = BAR143[zn];
        const CDP143 = 2;
        const kwhc143avecCdP = base143 * CDP143;
        // Si cumul avec 171 : CdP va sur 171 (\u00D75 > \u00D72), 143 = forfait base
        // Si 143 seul : CdP \u00D72 applicable
        const has171 = fiches.includes('171');
        const kwhc143 = has171 ? base143 : kwhc143avecCdP;
        totalKwhc += kwhc143;
        details.push(`143: ${fmtIntCEE(kwhc143)}`);
        if (has171) {
            document.getElementById('cee143Forfait').value = `${fmtIntCEE(base143)} kWhc (${zn}) \u2014 CdP sur 171`;
            statusParts.push(`\u2705 143: forfait ${zn} = ${fmtIntCEE(base143)} kWhc (CdP \u00D7${CDP143} = ${fmtIntCEE(kwhc143avecCdP)} si seul)`);
        } else {
            document.getElementById('cee143Forfait').value = `${fmtIntCEE(base143)} \u00D7 ${CDP143} = ${fmtIntCEE(kwhc143avecCdP)} kWhc (${zn})`;
            statusParts.push(`\u2705 143: forfait ${zn} ${fmtIntCEE(base143)} \u00D7 CdP \u00D7${CDP143} = ${fmtIntCEE(kwhc143avecCdP)} kWhc`);
        }
    }

    const primeCEE = (totalKwhc / 1000) * price;
    lastCEEDetailPrime = primeCEE;
    lastCEEDetailKwhc = totalKwhc;

    document.getElementById('ceeOutKwhc').textContent = `${fmtIntCEE(totalKwhc)} kWhc`;
    document.getElementById('ceeOutDetail').textContent = details.join(' + ');
    document.getElementById('ceeOutPrime').textContent = fmtEurCEE(primeCEE);
    document.getElementById('ceeOutPrix').textContent = `${price.toString().replace('.', ',')} \u20AC/MWhc  ${menage === 'tm' ? 'Trs modestes' : 'Autres'}`;

    const resultEl = document.getElementById('ceeResult');
    if (statusParts.length > 0) {
        resultEl.className = 'cee-result show';
        resultEl.innerHTML = statusParts.join('<br>');
    } else {
        resultEl.className = 'cee-result';
    }

  } catch(e) {
    console.error('calcCEEDetail() error:', e);
    if(typeof dbg==='function') dbg('\u274C calcCEEDetail: '+e.message+' at line '+(e.stack||'').split('\n')[1]);
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = '\u0161\u00A0 CEEDetail: ' + e.message; errDiv.style.display = 'block'; errDiv.style.color = '#dc2626'; errDiv.style.background = '#fef2f2'; }
  }
}

function fmtIntCEE(n) {
    return isFinite(n) ? Math.round(n).toLocaleString('fr-FR') : '\u2014';
}
function fmtEurCEE(n) {
    return isFinite(n) ? Math.round(n).toLocaleString('fr-FR') + ' \u20AC' : '\u2014';
}

// ============================================
// DONNES PRINCIPALES
// ============================================
const D={TTC:{"PAC":10890,"PAC + BALLON LECTRIQUE":13750,"PAC + BALLON THERMO":13750,"PAC + SSC":25850,"SSC":15000},MPR:{"PAC":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON LECTRIQUE":{BLEU:5000,JAUNE:4000,VIOLET:3000,ROSE:0},"PAC + BALLON THERMO":{BLEU:6200,JAUNE:4800,VIOLET:3400,ROSE:0},"PAC + SSC":{BLEU:15000,JAUNE:12000,VIOLET:7000,ROSE:0},"SSC":{BLEU:10000,JAUNE:8000,VIOLET:4000,ROSE:0}},COUT:{"PAC":6600,"PAC + BALLON LECTRIQUE":6800,"PAC + BALLON THERMO":7200,"PAC + SSC":11650,"SSC":8500},COUT_DETAIL:{"PAC":{pac_materiel:2900,pac_pose:2500,ballon_materiel:0,ballon_pose:0,accessoires:800,admin:400,mairie:0},"PAC + BALLON LECTRIQUE":{pac_materiel:2900,pac_pose:2500,ballon_materiel:200,ballon_pose:0,accessoires:800,admin:400,mairie:0},"PAC + BALLON THERMO":{pac_materiel:2900,pac_pose:2500,ballon_materiel:1100,ballon_pose:500,accessoires:800,admin:400,mairie:0},"PAC + SSC":{pac_materiel:5700,pac_pose:4500,ballon_materiel:0,ballon_pose:0,accessoires:800,admin:400,mairie:250},"SSC":{pac_materiel:4200,pac_pose:3500,ballon_materiel:0,ballon_pose:0,accessoires:500,admin:300,mairie:250}},CEE:{"140-170":{H1:{PAC:{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON ELECTRIQUE":{"S<70":274800,"70<S<90":384720,"90<S<110":549600,"110<S<130":604560,"S>130":879360},"BALLON THERMO":{"S<70":289500,"70<S<90":399420,"90<S<110":564300,"110<S<130":619260,"S>130":894060},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON ELECTRIQUE":{"S<70":229000,"70<S<90":320600,"90<S<110":458000,"110<S<130":503800,"S>130":732800},"BALLON THERMO":{"S<70":243700,"70<S<90":335300,"90<S<110":472700,"110<S<130":518500,"S>130":747500},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON ELECTRIQUE":{"S<70":160300,"70<S<90":224420,"90<S<110":320600,"110<S<130":352660,"S>130":512960},"BALLON THERMO":{"S<70":175000,"70<S<90":239120,"90<S<110":335300,"110<S<130":367360,"S>130":527660},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}},"111-140":{H1:{PAC:{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON ELECTRIQUE":{"S<70":238500,"70<S<90":333900,"90<S<110":477000,"110<S<130":524700,"S>130":763200},"BALLON THERMO":{"S<70":253200,"70<S<90":348600,"90<S<110":491700,"110<S<130":539400,"S>130":777900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H2:{PAC:{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON ELECTRIQUE":{"S<70":198750,"70<S<90":278250,"90<S<110":397500,"110<S<130":437250,"S>130":636000},"BALLON THERMO":{"S<70":213450,"70<S<90":292950,"90<S<110":412200,"110<S<130":451950,"S>130":650700},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}},H3:{PAC:{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON ELECTRIQUE":{"S<70":139125,"70<S<90":194775,"90<S<110":278250,"110<S<130":306075,"S>130":445200},"BALLON THERMO":{"S<70":153825,"70<S<90":209475,"90<S<110":292950,"110<S<130":320775,"S>130":459900},"BALLON SSC":{"S<70":769200,"70<S<90":769200,"90<S<110":769200,"110<S<130":769200,"S>130":769200}}}}};
const M={"PAC":"PAC","PAC + BALLON LECTRIQUE":"BALLON ELECTRIQUE","PAC + BALLON THERMO":"BALLON THERMO","PAC + SSC":"BALLON SSC","SSC":"BALLON SSC"};

const SCENARIO_NAMES = {"PAC":"PAC","PAC + BALLON LECTRIQUE":"PAC + Ballon lectrique","PAC + BALLON THERMO":"PAC + Ballon Thermo","PAC + SSC":"PAC + SSC","SSC":"SSC"};

function getCEE(et, zn, cs, sf){
    if(!D.CEE[et]) return 0;
    if(!D.CEE[et][zn]) return 0;
    if(!D.CEE[et][zn][cs]) return 0;
    if(!D.CEE[et][zn][cs][sf]) return 0;
    return D.CEE[et][zn][cs][sf];
}

let mode=0;
let autoGesteApplied = false;
let savedRacPourcent = 0;
let savedRacOffert = 0;

function fmt(n){
    return Math.round(n).toLocaleString('fr-FR')+' \u20AC';
}

function updateFromTTC(){
    document.getElementById('lockTTC').checked=false;
    calc();
}

function updateFromDetail(){
    document.getElementById('lockCoutHT').checked=false;
    
    const fields = [
        ['coutPACMateriel','qtePACMateriel','totalPACMateriel'],
        ['coutPACPose','qtePACPose','totalPACPose'],
        ['coutBallonMateriel','qteBallonMateriel','totalBallonMateriel'],
        ['coutBallonPose','qteBallonPose','totalBallonPose'],
        ['coutAccessoires','qteAccessoires','totalAccessoires'],
        ['coutAdmin','qteAdmin','totalAdmin'],
        ['coutMandat','qteMandat','totalMandat'],
        ['coutMairie','qteMairie','totalMairie']
    ];
    
    let totalGlobal = 0;
    fields.forEach(([cId, qId, tId]) => {
        const c = parseFloat(document.getElementById(cId).value) || 0;
        const q = parseFloat(document.getElementById(qId).value) || 0;
        const t = c * q;
        document.getElementById(tId).textContent = fmt(t);
        totalGlobal += t;
    });
    
    // Prvisite (checkbox)
    const prevChecked = document.getElementById('checkPrevisite').checked;
    const prevCost = prevChecked ? (parseFloat(document.getElementById('coutPrevisite').value) || 0) : 0;
    document.getElementById('totalPrevisite').textContent = prevChecked ? fmt(prevCost) : '0 \u20AC';
    totalGlobal += prevCost;
    
    document.getElementById('coutTotalHTDisplay').textContent = fmt(totalGlobal);
    calc();
}

function getCoutFromFields() {
    const f = ['coutPACMateriel','coutPACPose','coutBallonMateriel','coutBallonPose','coutAccessoires','coutAdmin','coutMandat','coutMairie'];
    const q = ['qtePACMateriel','qtePACPose','qteBallonMateriel','qteBallonPose','qteAccessoires','qteAdmin','qteMandat','qteMairie'];
    let t = 0;
    for (let i = 0; i < f.length; i++) {
        t += (parseFloat(document.getElementById(f[i]).value)||0) * (parseFloat(document.getElementById(q[i]).value)||0);
    }
    if (document.getElementById('checkPrevisite').checked) t += parseFloat(document.getElementById('coutPrevisite').value)||0;
    return t;
}

function getCoutFromDetail(sc, ad) {
    if (!D.COUT_DETAIL[sc]) return D.COUT[sc] || 0;
    const d = D.COUT_DETAIL[sc];
    let t = d.pac_materiel + d.pac_pose + d.ballon_materiel + d.ballon_pose + d.accessoires + d.admin + (d.mairie || 0);
    if (ad > 0) t += Math.round(ad * 0.12);
    if (document.getElementById('checkPrevisite').checked) t += parseFloat(document.getElementById('coutPrevisite').value)||200;
    return t;
}

// Frais pass-through (facturs au client, ajouts au TTC)
// These are revenue items that shouldn't reduce margin
function getPassThrough() {
    if(mode) {
        const m = (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
        const r = (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
        const p = document.getElementById('checkPrevisite').checked ? (parseFloat(document.getElementById('coutPrevisite').value)||0) : 0;
        return m + r + p;
    } else {
        // Client mode: calculate from data
        const sc = document.getElementById('scenario').value;
        const ct = document.getElementById('categorie').value;
        const ad = (D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
        const d = D.COUT_DETAIL[sc];
        let pt = (d ? (d.mairie||0) : 0);
        if(ad > 0) pt += Math.round(ad * 0.12);
        if(document.getElementById('checkPrevisite').checked) pt += parseFloat(document.getElementById('coutPrevisite').value)||200;
        return pt;
    }
}

function calc(){
  try {
    _calcRunning = true;
    
    // Always recalculate CEE detail first (updates lastCEEDetailPrime)
    calcCEEDetail();
    
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    // Check if CEE override is active
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        if(lockTTC){
            tt = D.TTC[sc] || 0;
            document.getElementById('totalTTCInput').value=tt;
        }else{
            tt=parseFloat(document.getElementById('totalTTCInput').value)||0;
        }
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                document.getElementById('coutPACMateriel').value = detail.pac_materiel;
                document.getElementById('qtePACMateriel').value = 1;
                document.getElementById('totalPACMateriel').textContent = fmt(detail.pac_materiel);
                document.getElementById('coutPACPose').value = detail.pac_pose;
                document.getElementById('qtePACPose').value = 1;
                document.getElementById('totalPACPose').textContent = fmt(detail.pac_pose);
                document.getElementById('coutBallonMateriel').value = detail.ballon_materiel;
                document.getElementById('qteBallonMateriel').value = detail.ballon_materiel > 0 ? 1 : 0;
                document.getElementById('totalBallonMateriel').textContent = fmt(detail.ballon_materiel);
                document.getElementById('coutBallonPose').value = detail.ballon_pose;
                document.getElementById('qteBallonPose').value = detail.ballon_pose > 0 ? 1 : 0;
                document.getElementById('totalBallonPose').textContent = fmt(detail.ballon_pose);
                document.getElementById('coutAccessoires').value = detail.accessoires;
                document.getElementById('qteAccessoires').value = 1;
                document.getElementById('totalAccessoires').textContent = fmt(detail.accessoires);
                document.getElementById('coutAdmin').value = detail.admin;
                document.getElementById('qteAdmin').value = 1;
                document.getElementById('totalAdmin').textContent = fmt(detail.admin);
                // Mandat MPR = 12% de l'aide MPR
                const mandatVal = Math.round(ad * 0.12);
                document.getElementById('coutMandat').value = mandatVal;
                document.getElementById('qteMandat').value = ad > 0 ? 1 : 0;
                document.getElementById('totalMandat').textContent = fmt(ad > 0 ? mandatVal : 0);
                // Demande mairie (SSC uniquement)
                const mairieVal = detail.mairie || 0;
                document.getElementById('coutMairie').value = mairieVal > 0 ? mairieVal : 250;
                document.getElementById('qteMairie').value = mairieVal > 0 ? 1 : 0;
                document.getElementById('totalMairie').textContent = fmt(mairieVal);
                // Prvisite
                const prevOn = document.getElementById('checkPrevisite').checked;
                const prevCost = prevOn ? (parseFloat(document.getElementById('coutPrevisite').value) || 200) : 0;
                document.getElementById('totalPrevisite').textContent = prevOn ? fmt(prevCost) : '0 \u20AC';
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin + (ad > 0 ? mandatVal : 0) + mairieVal + prevCost;
            }else{
                ch = D.COUT[sc] || 0;
            }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
            ch += (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
            ch += (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
            if(document.getElementById('checkPrevisite').checked) ch += parseFloat(document.getElementById('coutPrevisite').value)||0;
        }
        document.getElementById('coutTotalHTDisplay').textContent = fmt(ch);
    }else{
        ch=getCoutFromDetail(sc, ad);
    }
    
    // Pass-through costs (mandat, mairie, prvisite) are revenue items
    // They're displayed in costs but excluded from margin calculation
    const chForMarge = ch - getPassThrough();
    
    let ce;
    let ceForMarge, taForMarge;
    
    // Always use detailed CEE calculation (with Coup de pouce)
    ce = lastCEEDetailPrime;
    ceForMarge = ce;
    taForMarge = ad + ceForMarge;
    
    if(mode){
        // Sync prixCumac with mnage CEE category
        const menageVal = document.getElementById('menageCEE').value;
        const pxAuto = (menageVal === 'tm') ? 12.5 : 7.5;
        document.getElementById('prixCumac').value = pxAuto;
        document.getElementById('kwhCumac').value=Math.round(lastCEEDetailKwhc).toLocaleString('fr-FR');
    }
    
    const ceDisplay = ce;
    const ceeSourceText = getCEEFiches(sc).map(f => 'BAR-TH-' + f).join(' + ') + ' dtaill';
    
    const ta=ad+ceDisplay;
    const rb=tt-ta;
    
    // Compute pro-level RAC (prix cumac trs modestes) for auto-geste detection
    const proCEE = (lastCEEDetailKwhc / 1000) * 12.5;
    const proRB = tt - (ad + proCEE);
    
    // En vue client, si aides > TTC, ajuster l'affichage pour cohrence (TTC = aides + 1)
    const displayTTC = (!mode && rb < 0) ? (ta + 1) : tt;
    
    document.getElementById('totalTTC').textContent=fmt(displayTTC);
    document.getElementById('aidesMPR').textContent=fmt(ad);
    document.getElementById('aidesCEE').textContent=fmt(ceDisplay);
    document.getElementById('totalAides').textContent=fmt(ta);
    document.getElementById('ceeSourceLabel').textContent=ceeSourceText;
    
    if(mode) document.getElementById('displayCoutHT').textContent=fmt(ch);
    
    const st=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const ct2=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zn2=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const et2=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const sf2=getSurfaceLabel();
    const colorClass=ct==='BLEU'?'color-bleu':(ct==='JAUNE'?'color-jaune':(ct==='VIOLET'?'color-violet':'color-rose'));
    const borderColor=ct==='BLEU'?'#0071e3':(ct==='JAUNE'?'#fbbf24':(ct==='VIOLET'?'#8b5cf6':'#ec4899'));
    
    let summaryHTML;
    if (sc === 'SSC') {
        summaryHTML = `<strong class="${colorClass}">${st}</strong><span class="separator">\u2022</span>${ct2}<span class="separator">\u2022</span>Zone ${zn2}`;
    } else {
        summaryHTML = `<strong class="${colorClass}">${st}</strong><span class="separator">\u2022</span>${ct2}<span class="separator">\u2022</span>Zone ${zn2}<span class="separator">\u2022</span>${sf2}<span class="separator">\u2022</span>${et2}`;
    }
    document.getElementById('scenarioSummary').innerHTML = summaryHTML;
    document.getElementById('scenarioSummary').style.borderLeftColor=borderColor;
    
    calcRAC(rb,chForMarge,ta,taForMarge,tt,proRB);
    if(typeof dbg==='function') dbg('calc: sc='+sc+' ct='+ct+' ad='+ad+' ce='+ce+' ch='+ch+' chFM='+chForMarge+' tt='+tt+' rb='+rb+' taFM='+taForMarge+' proRB='+Math.round(proRB));
    
    _calcRunning = false;
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = ''; errDiv.style.display = 'none'; }
  } catch(e) {
    _calcRunning = false;
    console.error('calc() error:', e);
    if(typeof dbg==='function') dbg('\u274C calc: '+e.message+' at '+(e.stack||'').split('\n')[1]);
    const errDiv = document.getElementById('calcErrorDebug');
    if (errDiv) { errDiv.textContent = '\u0161\u00A0 calc(): ' + e.message; errDiv.style.display = 'block'; errDiv.style.color = '#dc2626'; errDiv.style.background = '#fef2f2'; }
  }
}

function calcRAC(rb,ch,ta,taForMarge,tt,proRB){
    let po=parseFloat(document.getElementById('racPourcent').value)||0;
    let mo=parseFloat(document.getElementById('racOffert').value)||0;
    
    // Vue client : auto geste co quand le RAC pro est ngatif
    if(!mode && proRB !== undefined && proRB < 0 && rb > 1){
        if(!autoGesteApplied){
            savedRacPourcent = document.getElementById('racPourcent').value;
            savedRacOffert = document.getElementById('racOffert').value;
        }
        mo = rb - 1;
        po = rb > 0 ? Math.round((mo/rb)*100) : 0;
        document.getElementById('racOffert').value = Math.round(mo);
        document.getElementById('racPourcent').value = po;
        autoGesteApplied = true;
    } else if(mode && autoGesteApplied){
        document.getElementById('racPourcent').value = savedRacPourcent;
        document.getElementById('racOffert').value = savedRacOffert;
        po = parseFloat(savedRacPourcent) || 0;
        mo = parseFloat(savedRacOffert) || 0;
        autoGesteApplied = false;
    } else if(!mode && proRB !== undefined && proRB >= 0 && autoGesteApplied){
        document.getElementById('racPourcent').value = savedRacPourcent;
        document.getElementById('racOffert').value = savedRacOffert;
        po = parseFloat(savedRacPourcent) || 0;
        mo = parseFloat(savedRacOffert) || 0;
        autoGesteApplied = false;
    }
    
    const rc=rb-mo;
    // RAC ngatif \u2192 afficher 1\u20AC en vue client, vrai montant en vue fournisseur
    document.getElementById('resteCharge').textContent = (rc < 0 && !mode) ? '1 \u20AC' : fmt(rc);
    
    const rbForMarge = tt - taForMarge;
    const moForMarge = autoGesteApplied ? (parseFloat(savedRacOffert)||0) : mo;
    const rcForMarge = rbForMarge - moForMarge;
    const vhForMarge = Math.max(0,rcForMarge)/1.055;
    const mgForMarge = vhForMarge - ch + taForMarge;
    
    if(mode){
        document.getElementById('margeFinal').textContent=fmt(mgForMarge);
    }
    
    const currentScenario = document.getElementById('scenario').value;
    const seuilOK = (currentScenario === 'PAC + SSC' || currentScenario === 'SSC') ? 6000 : 4000;
    
    // Calculate max % offerable (fournisseur)
    if(mode){
        const maxPctEl = document.getElementById('maxPctValue');
        const maxPctBox = document.getElementById('maxPctInfo');
        if(maxPctEl){
            if(rb <= 0){
                // Aides cover entire TTC - no RAC to discount
                if(mgForMarge >= seuilOK){
                    maxPctEl.textContent = 'Aides > TTC \u2014 pas de RAC \u00e0 r\u00e9duire';
                    maxPctBox.style.background = 'rgba(5,150,105,0.12)';
                    maxPctBox.style.borderColor = 'rgba(5,150,105,0.25)';
                    maxPctBox.style.color = '#34d399';
                } else {
                    maxPctEl.textContent = '0% \u2014 marge insuffisante';
                    maxPctBox.style.background = 'rgba(220,38,38,0.12)';
                    maxPctBox.style.borderColor = 'rgba(220,38,38,0.25)';
                    maxPctBox.style.color = '#f87171';
                }
            } else {
                // Normal case: solve for max offert
                const maxOffert = rbForMarge - (seuilOK + ch - taForMarge) * 1.055;
                const maxPct = Math.max(0, Math.floor((maxOffert / rb) * 100));
                if(typeof dbg==='function') dbg('maxOff: maxOff='+Math.round(maxOffert)+' pct='+maxPct);
                if(maxOffert > 0){
                    maxPctEl.textContent = maxPct + '% (' + fmt(Math.floor(maxOffert)) + ')';
                    maxPctBox.style.background = 'rgba(5,150,105,0.12)';
                    maxPctBox.style.borderColor = 'rgba(5,150,105,0.25)';
                    maxPctBox.style.color = '#34d399';
                } else {
                    maxPctEl.textContent = '0% \u2014 marge insuffisante';
                    maxPctBox.style.background = 'rgba(220,38,38,0.12)';
                    maxPctBox.style.borderColor = 'rgba(220,38,38,0.25)';
                    maxPctBox.style.color = '#f87171';
                }
            }
        }
    }
    
    const bd=document.getElementById('statusBadge');
    const icon=document.getElementById('statusIcon');
    const txt=document.getElementById('statusText');
    if(typeof dbg==='function') dbg('RAC: mg='+Math.round(mgForMarge)+' seuil='+seuilOK+' rbFM='+Math.round(rbForMarge)+' ch='+Math.round(ch));
    if(mgForMarge>=seuilOK){
        bd.className='status-badge ok';
        bd.onclick=shareDevis;
        icon.textContent='\u2705';
        txt.textContent='Voulez-vous un devis ?';
    }else{
        bd.className='status-badge danger';
        bd.onclick=null;
        icon.textContent='\u274C';
        txt.textContent='Dossier refus';
    }
}

function shareDevis(){
    const nom=document.getElementById('nom').value.trim()||'Client';
    const prenom=document.getElementById('prenom').value.trim()||'';
    const scenario=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const ttc=document.getElementById('totalTTC').textContent;
    const totalAides=document.getElementById('totalAides').textContent;
    const rac=document.getElementById('resteCharge').textContent;
    
    const text = `\uD83C\uDFE0 Estimation PAC \u2014 ${prenom} ${nom}\n\n\uD83D\uDCCB ${scenario}\n\uD83D\uDCB0 Installation TTC : ${ttc}\n\uD83C\uDF81 Total aides : ${totalAides}\n\uD83C\uDFE0 Reste  charge : ${rac}\n\nSimulation ralise par Les Artisans Verts`;
    
    if(navigator.share){
        navigator.share({
            title: 'Devis PAC \u2014 ' + (prenom + ' ' + nom).trim(),
            text: text
        }).catch(()=>{});
    }else{
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(text).then(()=>{
            const bd=document.getElementById('statusBadge');
            const oldTxt=document.getElementById('statusText').textContent;
            document.getElementById('statusText').textContent='\u2713 Copi !';
            setTimeout(()=>{ document.getElementById('statusText').textContent=oldTxt; }, 2000);
        }).catch(()=>{
            window.open('https://api.whatsapp.com/send?text='+encodeURIComponent(text),'_blank');
        });
    }
}

function updatePct(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        tt = lockTTC ? (D.TTC[sc] || 0) : (parseFloat(document.getElementById('totalTTCInput').value)||0);
    }else{
        tt=D.TTC[sc]||0;
    }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin + (ad > 0 ? Math.round(ad * 0.12) : 0) + (detail.mairie || 0) + (document.getElementById("checkPrevisite").checked ? (parseFloat(document.getElementById("coutPrevisite").value) || 200) : 0);
            }else{ ch = D.COUT[sc] || 0; }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
            ch += (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
            ch += (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
            if(document.getElementById('checkPrevisite').checked) ch += parseFloat(document.getElementById('coutPrevisite').value)||0;
        }
    }else{ ch=getCoutFromDetail(sc, ad); }
    
    let ce = lastCEEDetailPrime;
    let ceForMarge = ce;
    let taForMarge = ad + ceForMarge;
    
    const chForMarge = ch - getPassThrough();
    const ta=ad+ce;
    const rb=tt-ta;
    
    let po=parseFloat(document.getElementById('racPourcent').value)||0;
    if(po>100)po=100; if(po<0)po=0;
    document.getElementById('racPourcent').value=Math.round(po);
    const mo=Math.round(rb*(po/100));
    document.getElementById('racOffert').value=mo;
    
    calcRAC(rb,chForMarge,ta,taForMarge,tt);
}

function updateAmt(){
    const sc=document.getElementById('scenario').value;
    const ct=document.getElementById('categorie').value;
    const zn=document.getElementById('zone').value;
    const et=document.getElementById('etas').value;
    const sf=surfaceToCategory(document.getElementById('surface').value);
    const cs=M[sc];
    
    let tt;
    if(mode){
        const lockTTC=document.getElementById('lockTTC').checked;
        tt = lockTTC ? (D.TTC[sc] || 0) : (parseFloat(document.getElementById('totalTTCInput').value)||0);
    }else{ tt=D.TTC[sc]||0; }
    
    const ad=(D.MPR[sc]&&D.MPR[sc][ct])?D.MPR[sc][ct]:0;
    
    let ch;
    if(mode){
        const lockCoutHT=document.getElementById('lockCoutHT').checked;
        if(lockCoutHT){
            if(D.COUT_DETAIL[sc]){
                const detail=D.COUT_DETAIL[sc];
                ch = detail.pac_materiel + detail.pac_pose + detail.ballon_materiel + detail.ballon_pose + detail.accessoires + detail.admin;
            }else{ ch = D.COUT[sc] || 0; }
        }else{
            const totalPACMateriel = (parseFloat(document.getElementById('coutPACMateriel').value) || 0) * (parseFloat(document.getElementById('qtePACMateriel').value) || 0);
            const totalPACPose = (parseFloat(document.getElementById('coutPACPose').value) || 0) * (parseFloat(document.getElementById('qtePACPose').value) || 0);
            const totalBallonMateriel = (parseFloat(document.getElementById('coutBallonMateriel').value) || 0) * (parseFloat(document.getElementById('qteBallonMateriel').value) || 0);
            const totalBallonPose = (parseFloat(document.getElementById('coutBallonPose').value) || 0) * (parseFloat(document.getElementById('qteBallonPose').value) || 0);
            const totalAccessoires = (parseFloat(document.getElementById('coutAccessoires').value) || 0) * (parseFloat(document.getElementById('qteAccessoires').value) || 0);
            const totalAdmin = (parseFloat(document.getElementById('coutAdmin').value) || 0) * (parseFloat(document.getElementById('qteAdmin').value) || 0);
            ch = totalPACMateriel + totalPACPose + totalBallonMateriel + totalBallonPose + totalAccessoires + totalAdmin;
            ch += (parseFloat(document.getElementById('coutMandat').value)||0) * (parseFloat(document.getElementById('qteMandat').value)||0);
            ch += (parseFloat(document.getElementById('coutMairie').value)||0) * (parseFloat(document.getElementById('qteMairie').value)||0);
            if(document.getElementById('checkPrevisite').checked) ch += parseFloat(document.getElementById('coutPrevisite').value)||0;
        }
    }else{ ch=getCoutFromDetail(sc, ad); }
    
    let ce = lastCEEDetailPrime;
    let ceForMarge = ce;
    let taForMarge = ad + ceForMarge;
    
    const chForMarge = ch - getPassThrough();
    const ta=ad+ce;
    const rb=tt-ta;
    
    let mo=parseFloat(document.getElementById('racOffert').value)||0;
    if(mo>rb)mo=rb; if(mo<0)mo=0;
    document.getElementById('racOffert').value=Math.round(mo);
    let po=rb>0?Math.round((mo/rb)*100):0;
    if(po>100)po=100; if(po<0)po=0;
    document.getElementById('racPourcent').value=po;
    
    calcRAC(rb,chForMarge,ta,taForMarge,tt);
}

function reset(){
    document.getElementById('scenario').value='PAC';
    document.getElementById('categorie').value='BLEU';
    document.getElementById('zone').value='H1';
    document.getElementById('etas').value='140-170';
    document.getElementById('surface').value='S>=90';
    document.getElementById('typeLogement').value='maison';
    document.getElementById('rfr').value='';
    document.getElementById('nbPersonnes').value='4';
    document.getElementById('mprResultBloc').style.display='none';
    updateSurfaceOptions();
    document.getElementById('racPourcent').value=0;
    document.getElementById('racOffert').value=0;
    if(mode){
        document.getElementById('prixCumac').value=12.5;
    }
    calc();
}

function checkExport(){
    const nom=document.getElementById('nom').value.trim();
    const prenom=document.getElementById('prenom').value.trim();
    const btn=document.getElementById('exportBtn');
    const wBtn=document.getElementById('whatsappBtn');
    const hint=document.getElementById('exportHint');
    if(nom&&prenom){
        btn.disabled=false; btn.style.cursor='pointer'; btn.style.opacity='1';
        wBtn.disabled=false; wBtn.style.cursor='pointer'; wBtn.style.opacity='1';
        if(hint) hint.style.display='none';
    }else{
        btn.disabled=true; btn.style.cursor='not-allowed'; btn.style.opacity='0.5';
        wBtn.disabled=true; wBtn.style.cursor='not-allowed'; wBtn.style.opacity='0.5';
        if(hint) hint.style.display='block';
    }
}

function sendWhatsApp(){
    if(typeof logExport==='function') logExport('WhatsApp');
    const nom=document.getElementById('nom').value.trim() || 'Client';
    const prenom=document.getElementById('prenom').value.trim() || '';
    const scenario=document.getElementById('scenario').options[document.getElementById('scenario').selectedIndex].text;
    const categorie=document.getElementById('categorie').options[document.getElementById('categorie').selectedIndex].text;
    const zone=document.getElementById('zone').options[document.getElementById('zone').selectedIndex].text;
    const etas=document.getElementById('etas').options[document.getElementById('etas').selectedIndex].text;
    const surface=getSurfaceLabel();
    const ttc=document.getElementById('totalTTC').textContent;
    const aidesMPR=document.getElementById('aidesMPR').textContent;
    const aidesCEE=document.getElementById('aidesCEE').textContent;
    const totalAides=document.getElementById('totalAides').textContent;
    const rac=document.getElementById('resteCharge').textContent;
    const message=`\uD83C\uDFE0 *Demande de devis - Les Artisans Verts*%0A%0A\uD83D\uDC64 *Client :* ${prenom} ${nom}%0A%0A\uD83D\uDCCB *Configuration :*%0A\u2022 Scnario : ${scenario}%0A\u2022 ${categorie}%0A\u2022 ${zone}%0A\u2022 ${surface}%0A\u2022 ${etas}%0A%0A\uD83D\uDCB0 *Montants :*%0A\u2022 Total TTC : ${ttc}%0A\u2022 Aides MPR : ${aidesMPR}%0A\u2022 Aides CEE : ${aidesCEE}%0A\u2022 Total aides : ${totalAides}%0A\u2022 Reste  charge : ${rac}%0A%0AJe souhaite obtenir un devis dtaill.`;
    window.open(`https://api.whatsapp.com/send?text=${message}`, '_blank');
}

function exportPDF(){
    if(typeof logExport==='function') logExport('PDF');
    const nom=document.getElementById('nom').value.trim() || 'Client';
    const prenom=document.getElementById('prenom').value.trim() || '';
    const fullName = (prenom + ' ' + nom).trim();

    // En-tte
    document.getElementById('printTitle').textContent = 'Dossier \u2014 ' + fullName;
    document.getElementById('printDate').textContent = new Date().toLocaleDateString('fr-FR', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
    document.getElementById('printCommercial').textContent = currentUser ? ('Commercial : ' + currentUser.name) : '';

    // Client info
    document.getElementById('printNom').textContent = fullName;
    document.getElementById('printDept').textContent = document.getElementById('departement').value || '\u2014';
    const zoneEl = document.getElementById('zone');
    document.getElementById('printZone').textContent = zoneEl ? zoneEl.value : '\u2014';
    const foyerEl = document.getElementById('foyer');
    document.getElementById('printFoyer').textContent = foyerEl ? foyerEl.options[foyerEl.selectedIndex].text : '\u2014';
    const rfr = document.getElementById('rfr').value;
    document.getElementById('printRFR').textContent = rfr ? parseInt(rfr).toLocaleString('fr-FR') + ' \u20AC' : '\u2014';

    // Profil MPR
    const profilLabel = document.getElementById('mprProfilLabel');
    const profilDesc = document.getElementById('mprProfilDesc');
    const profilCard = document.getElementById('printProfilCard');
    const cat = document.getElementById('categorie').value;
    const profilColors = { BLEU:'#2563eb', JAUNE:'#d97706', VIOLET:'#7c3aed', ROSE:'#db2777' };
    const profilIcons = { BLEU:'\uD83D\uDD35', JAUNE:'\uD83D\uDFE1', VIOLET:'\uD83D\uDFE3', ROSE:'\uD83D\uDD34' };
    profilCard.style.background = profilColors[cat] || '#64748b';
    document.getElementById('printProfilIcon').textContent = profilIcons[cat] || '\u26AA';
    document.getElementById('printProfilLabel').textContent = profilLabel ? profilLabel.textContent : cat;
    document.getElementById('printProfilDesc').textContent = profilDesc ? profilDesc.textContent : '';
    const seuilEl = document.getElementById('mprInfoSeuil');
    document.getElementById('printProfilSeuil').textContent = seuilEl ? ('Seuil : ' + seuilEl.textContent) : '';

    // Configuration technique
    const sc = document.getElementById('scenario');
    document.getElementById('printScenario').textContent = sc.options[sc.selectedIndex].text;
    const ceeSurf = document.getElementById('ceeSurface');
    document.getElementById('printSurface').textContent = (ceeSurf ? ceeSurf.value : '95') + ' m';
    const etas = document.getElementById('etas');
    document.getElementById('printETAS').textContent = etas ? etas.options[etas.selectedIndex].text : '\u2014';
    const baremeReco = document.getElementById('baremeReco');
    document.getElementById('printPACReco').textContent = baremeReco ? baremeReco.textContent : '\u2014';
    const isoState = document.getElementById('isoStateName');
    document.getElementById('printIsolation').textContent = isoState ? isoState.textContent : '\u2014';
    document.getElementById('printAnnee').textContent = document.getElementById('dimAnnee').value || '\u2014';

    // Montants
    document.getElementById('printTTC').textContent = document.getElementById('totalTTC').textContent;
    document.getElementById('printMPR').textContent = document.getElementById('aidesMPR').textContent;
    document.getElementById('printCEE').textContent = document.getElementById('aidesCEE').textContent;
    document.getElementById('printTotalAides').textContent = document.getElementById('totalAides').textContent;

    // Dtail CEE
    const ceeFiches = document.getElementById('ceeFichesLabel');
    const ceeDetailEl = document.getElementById('ceeOutDetail');
    const ceePrixEl = document.getElementById('ceeOutPrix');
    let ceeDetail = '';
    if(ceeFiches) ceeDetail += 'Fiches : ' + ceeFiches.textContent;
    if(ceeDetailEl && ceeDetailEl.textContent !== '\u2014') ceeDetail += '  ' + ceeDetailEl.textContent;
    if(ceePrixEl && ceePrixEl.textContent !== '\u2014') ceeDetail += '  ' + ceePrixEl.textContent;
    document.getElementById('printCEEDetail').textContent = ceeDetail || '\u2014';

    // RAC
    document.getElementById('printRAC').textContent = document.getElementById('resteCharge').textContent;
    const pct = document.getElementById('racPourcent').value;
    const offert = document.getElementById('racOffert').value;
    if(parseInt(pct) > 0 || parseInt(offert) > 0){
        document.getElementById('printRACDetail').textContent = 'Prise en charge fournisseur : ' + pct + '% soit ' + offert + ' \u20AC';
    } else {
        document.getElementById('printRACDetail').textContent = '';
    }

    // Statut
    const badge = document.getElementById('statusBadge');
    const printStatus = document.getElementById('printStatus');
    printStatus.textContent = document.getElementById('statusText').textContent;
    if(badge.classList.contains('ok')){
        printStatus.style.background = '#dcfce7';
        printStatus.style.color = '#166534';
        printStatus.style.border = '2px solid #86efac';
    } else {
        printStatus.style.background = '#fef2f2';
        printStatus.style.color = '#991b1b';
        printStatus.style.border = '2px solid #fca5a5';
    }

    window.print();
}

// ============================================
// AUTHENTIFICATION PAR COMMERCIAL (API)
// ============================================
const API_URL = 'https://script.google.com/macros/s/AKfycbwP1Nu60KfLu6iKNk7SMfkJoaq5_UbzcEtwnlBm5r1XbDYz8T16zayfPWynm0Zd_4Th/exec';
const FALLBACK_USERS = {
    'ishay':   { pass:'lav',       name:'Ishay',       role:'admin' },
    'admin':   { pass:'gamberge',  name:'Admin',       role:'admin' },
    'mendy':   { pass:'mendy5786', name:'Mendy',       role:'commercial' },
    'david':   { pass:'david26',   name:'David',       role:'commercial' },
    'sarah':   { pass:'sarah26',   name:'Sarah',       role:'commercial' },
    'marc':    { pass:'marc26',    name:'Marc',        role:'commercial' },
    'julie':   { pass:'julie26',   name:'Julie',       role:'commercial' },
    'thomas':  { pass:'thomas26',  name:'Thomas',      role:'commercial' },
};
let currentUser = null;
let useAPI = false;

function apiCall(params, callback, errorCallback) {
    if (!API_URL) { if(errorCallback) errorCallback('Pas de serveur'); return; }
    const qs = Object.entries(params).map(([k,v])=>k+'='+encodeURIComponent(v)).join('&');
    fetch(API_URL + '?' + qs, {redirect:'follow'})
        .then(r => r.text())
        .then(txt => {
            let d;
            try { d = JSON.parse(txt); } catch(e) {
                const m = txt.match(/\{[\s\S]*\}/);
                if(m) try { d = JSON.parse(m[0]); } catch(e2){}
            }
            if(d) callback(d);
            else if(errorCallback) errorCallback('Rponse invalide');
        })
        .catch(e => { if(errorCallback) errorCallback(e.message); });
}

function doLogin(){
    const u = document.getElementById('loginUser').value.trim().toLowerCase();
    const p = document.getElementById('loginPass').value;
    const errEl = document.getElementById('loginError');
    errEl.style.display = 'none';
    if(!u){ errEl.textContent='Veuillez saisir un identifiant'; errEl.style.display='block'; return; }

    if(API_URL) {
        // API mode
        errEl.textContent = 'Connexion...'; errEl.style.display='block'; errEl.style.color='#6b7280';
        apiCall({action:'login', user:u, pass:p}, function(d){
            errEl.style.color = '#dc2626';
            if(d.success){
                useAPI = true;
                const usr = d.user || {};
                currentUser = {
                    id: usr.username || u,
                    name: usr.name || u,
                    role: usr.role || 'commercial'
                };
                try{ localStorage.setItem('pac_user', JSON.stringify(currentUser)); localStorage.setItem('pac_api','1'); }catch(e){}
                showApp();
            } else {
                errEl.textContent = d.error || 'Identifiants incorrects';
                errEl.style.display = 'block';
            }
        }, function(err){
            // Fallback local
            errEl.style.color = '#dc2626';
            doLoginLocal(u, p, errEl);
        });
    } else {
        doLoginLocal(u, p, errEl);
    }
}
function doLoginLocal(u, p, errEl){
    const account = FALLBACK_USERS[u];
    if(!account || account.pass !== p){
        errEl.textContent = 'Identifiant ou mot de passe incorrect';
        errEl.style.display = 'block';
        errEl.style.color = '#dc2626';
        return;
    }
    useAPI = false;
    currentUser = { id:u, name:account.name, role:account.role };
    try{ localStorage.setItem('pac_user', JSON.stringify(currentUser)); localStorage.removeItem('pac_api'); }catch(e){}
    showApp();
    logAction('Connexion (local)', account.name);
}
document.getElementById('loginPass').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
document.getElementById('loginUser').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

function doLogout(){
    logAction('Dconnexion', currentUser ? currentUser.name : '');
    currentUser = null;
    try{ localStorage.removeItem('pac_user'); localStorage.removeItem('pac_api'); }catch(e){}
    location.reload();
}

function goToLogin(){
    currentUser = null;
    try{ localStorage.removeItem('pac_user'); }catch(e){}
    document.getElementById('appScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
}

function doGuestLogin(){
    currentUser = { id:'guest', name:'Client', role:'guest' };
    try{ localStorage.setItem('pac_user', JSON.stringify(currentUser)); }catch(e){}
    showApp();
}

function switchView(v){
    if(v === 'fournisseur'){
        mode = 1;
        document.getElementById('mainContent').classList.add('fournisseur-mode');
        document.getElementById('togFournisseur').classList.add('active');
        document.getElementById('togClient').classList.remove('active');
        logAction('Vue fournisseur', '');
    } else {
        mode = 0;
        document.getElementById('mainContent').classList.remove('fournisseur-mode');
        document.getElementById('togClient').classList.add('active');
        document.getElementById('togFournisseur').classList.remove('active');
    }
    try{ calc(); }catch(e){}
}

function showApp(){
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appScreen').style.display = 'block';

    const isGuest = !currentUser || currentUser.role === 'guest';

    if(isGuest){
        // Vue client uniquement
        mode = 0;
        document.getElementById('mainContent').classList.remove('fournisseur-mode');
        document.getElementById('guestBar').style.display = 'flex';
        document.getElementById('userBar').style.display = 'none';
    } else {
        // Commercial/admin : vue fournisseur par dfaut
        mode = 1;
        document.getElementById('mainContent').classList.add('fournisseur-mode');
        document.getElementById('guestBar').style.display = 'none';
        document.getElementById('userBar').style.display = 'flex';
        document.getElementById('userNameDisplay').textContent = currentUser.name;
        document.getElementById('userRoleDisplay').textContent = currentUser.role === 'admin' ? '\uD83D\uDC51 Admin' : '\uD83D\uDCCA Commercial';
        // Admin-only buttons
        const isAdmin = currentUser.role === 'admin';
        document.getElementById('btnHistory').style.display = isAdmin ? '' : 'none';
        document.getElementById('btnPwd').style.display = isAdmin ? '' : 'none';
        // Toggle default to fournisseur
        document.getElementById('togFournisseur').classList.add('active');
        document.getElementById('togClient').classList.remove('active');
    }

    try { updateSurfaceOptions(); } catch(e){}
    try { calc(); } catch(e){}
    try { buildBaremeTable(); } catch(e){}
    try { calcBareme(); } catch(e){}
    try { syncEtas(); } catch(e){}
    try { calcDim(); } catch(e){}
}

function checkAutoLogin(){
    try{
        const stored = localStorage.getItem('pac_user');
        if(stored){
            const data = JSON.parse(stored);
            if(data && data.id){
                if(localStorage.getItem('pac_api')) useAPI = true;
                currentUser = data;
                showApp();
                return true;
            }
        }
    }catch(e){}
    return false;
}

// ============================================
// CHANGEMENT DE MOT DE PASSE
// ============================================
function openPwdModal(){
    document.getElementById('pwdOld').value = '';
    document.getElementById('pwdNew').value = '';
    document.getElementById('pwdConfirm').value = '';
    document.getElementById('pwdError').style.display = 'none';
    document.getElementById('pwdSuccess').style.display = 'none';
    document.getElementById('pwdModal').classList.add('active');
}
function doChangePassword(){
    const oldP = document.getElementById('pwdOld').value;
    const newP = document.getElementById('pwdNew').value;
    const conf = document.getElementById('pwdConfirm').value;
    const errEl = document.getElementById('pwdError');
    const okEl = document.getElementById('pwdSuccess');
    errEl.style.display = 'none';
    okEl.style.display = 'none';

    if(!oldP || !newP){ errEl.textContent='Tous les champs sont requis'; errEl.style.display='block'; return; }
    if(newP.length < 4){ errEl.textContent='Minimum 4 caractres'; errEl.style.display='block'; return; }
    if(newP !== conf){ errEl.textContent='Les mots de passe ne correspondent pas'; errEl.style.display='block'; return; }

    if(useAPI && API_URL){
        errEl.textContent = 'Modification...'; errEl.style.display='block'; errEl.style.color='#6b7280';
        apiCall({action:'changePassword', user:currentUser.id, oldPass:oldP, newPass:newP}, function(d){
            errEl.style.color = '#dc2626';
            if(d.success){
                errEl.style.display = 'none';
                okEl.textContent = '\u2705 Mot de passe modifi !';
                okEl.style.display = 'block';
                setTimeout(()=>{ document.getElementById('pwdModal').classList.remove('active'); }, 1500);
            } else {
                errEl.textContent = d.error || 'Erreur';
                errEl.style.display = 'block';
            }
        }, function(err){
            errEl.textContent = 'Erreur serveur: ' + err;
            errEl.style.display = 'block';
            errEl.style.color = '#dc2626';
        });
    } else {
        // Mode local: update FALLBACK_USERS
        const account = FALLBACK_USERS[currentUser.id];
        if(!account){ errEl.textContent='Compte introuvable'; errEl.style.display='block'; return; }
        if(account.pass !== oldP){ errEl.textContent='Ancien mot de passe incorrect'; errEl.style.display='block'; return; }
        account.pass = newP;
        okEl.textContent = '\u2705 Modifi (session uniquement en mode local)';
        okEl.style.display = 'block';
        logAction('Changement mot de passe', currentUser.name);
        setTimeout(()=>{ document.getElementById('pwdModal').classList.remove('active'); }, 1500);
    }
}

// ============================================
// JOURNAL DES MODIFICATIONS
// ============================================
function getJournal(){
    try{ return JSON.parse(localStorage.getItem('pac_journal') || '[]'); }catch(e){ return []; }
}
function saveJournal(j){
    try{
        if(j.length > 200) j = j.slice(j.length - 200);
        localStorage.setItem('pac_journal', JSON.stringify(j));
    }catch(e){}
}
function logAction(action, detail){
    const entry = {
        date: new Date().toISOString(),
        user: currentUser ? currentUser.name : '?',
        role: currentUser ? currentUser.role : '?',
        action: action,
        detail: detail || ''
    };
    // Local journal
    const j = getJournal();
    j.push(entry);
    saveJournal(j);
    // API journal (fire and forget)
    if(useAPI && API_URL){
        apiCall({action:'log', user:entry.user, logAction:action, detail:detail||''}, function(){}, function(){});
    }
}
function openHistory(){
    if(useAPI && API_URL){
        // Fetch from server
        const body = document.getElementById('historyBody');
        body.innerHTML = '<div class="hist-empty">Chargement...</div>';
        document.getElementById('historyModal').classList.add('active');
        apiCall({action:'getJournal', limit:'100'}, function(d){
            renderJournal(d.journal || []);
        }, function(err){
            // Fallback to local
            renderJournal(getJournal().reverse().slice(0, 100));
        });
    } else {
        renderJournal(getJournal().reverse().slice(0, 100));
        document.getElementById('historyModal').classList.add('active');
    }
}
function renderJournal(entries){
    const body = document.getElementById('historyBody');
    if(!entries || entries.length === 0){
        body.innerHTML = '<div class="hist-empty">Aucune entre dans le journal</div>';
        return;
    }
    let html = '';
    entries.forEach(e => {
        const d = new Date(e.date);
        const dateStr = d.toLocaleDateString('fr-FR') + ' ' + d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
        html += '<div class="hist-entry">';
        html += '<div class="hist-meta"><span class="hist-user">' + (e.user||'?') + '</span><span class="hist-date">' + dateStr + '</span></div>';
        html += '<div class="hist-action">' + (e.action||'') + '</div>';
        if(e.detail) html += '<div class="hist-detail">' + e.detail + '</div>';
        html += '</div>';
    });
    if(currentUser && currentUser.role === 'admin'){
        html += '<div class="hist-clear"><button onclick="clearJournal()">\uD83D\uDDD1\uFE0F Vider le journal</button></div>';
    }
    body.innerHTML = html;
}
function clearJournal(){
    if(confirm('Vider tout le journal ?')){
        try{ localStorage.setItem('pac_journal','[]'); }catch(e){}
        openHistory();
    }
}

// Log key actions
function logScenarioChange(){
    const sc = document.getElementById('scenario').value;
    logAction('Changement scnario', sc);
}
function logClientChange(){
    const nom = document.getElementById('nom').value.trim();
    const prenom = document.getElementById('prenom').value.trim();
    if(nom || prenom) logAction('Client modifi', (prenom + ' ' + nom).trim());
}
function logExport(type){
    const nom = document.getElementById('nom').value.trim() || 'Client';
    logAction('Export ' + type, nom);
}
function logRACChange(){
    const pct = document.getElementById('racPourcent').value;
    const offert = document.getElementById('racOffert').value;
    logAction('RAC modifi', pct + '% / ' + offert + ' \u20AC');
}


// ============================================
// SCROLL GRADIENT
// ============================================
(function() {
    const gradients = [
        'linear-gradient(90deg, #34d399, #22d3ee, #818cf8)',
        'linear-gradient(90deg, #22d3ee, #818cf8, #c084fc)',
        'linear-gradient(90deg, #818cf8, #c084fc, #f472b6)',
        'linear-gradient(90deg, #c084fc, #f472b6, #fb923c)',
        'linear-gradient(90deg, #f472b6, #fb923c, #fbbf24)',
        'linear-gradient(90deg, #fb923c, #fbbf24, #34d399)',
    ];
    let ticking = false;
    function updateScrollGradient() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const docHeight = document.documentElement.scrollHeight - window.innerHeight;
        const scrollPercent = docHeight > 0 ? scrollTop / docHeight : 0;
        const idx = Math.min(Math.floor(scrollPercent * gradients.length), gradients.length - 1);
        document.documentElement.style.setProperty('--scroll-gradient', gradients[idx]);
        ticking = false;
    }
    window.addEventListener('scroll', function() {
        if (!ticking) { requestAnimationFrame(updateScrollGradient); ticking = true; }
    }, { passive: true });
    updateScrollGradient();
})();

// ============================================
// DIMENSIONNEMENT PAC
// ============================================

// Tbase par dpartement (C) - valeurs conventionnelles
const DEPT_TBASE = {
    '01':-10,'02':-9,'03':-8,'04':-8,'05':-10,'06':-5,'07':-6,'08':-10,'09':-8,'10':-10,
    '11':-5,'12':-8,'13':-5,'14':-7,'15':-10,'16':-5,'17':-5,'18':-8,'19':-8,'20':-2,
    '2A':-2,'2B':-2,'21':-10,'22':-4,'23':-8,'24':-5,'25':-12,'26':-6,'27':-7,'28':-7,
    '29':-4,'30':-5,'31':-5,'32':-5,'33':-5,'34':-5,'35':-5,'36':-7,'37':-7,'38':-10,
    '39':-10,'40':-5,'41':-7,'42':-8,'43':-10,'44':-5,'45':-7,'46':-5,'47':-5,'48':-10,
    '49':-5,'50':-5,'51':-10,'52':-10,'53':-5,'54':-12,'55':-10,'56':-4,'57':-12,'58':-10,
    '59':-9,'60':-7,'61':-7,'62':-9,'63':-8,'64':-5,'65':-5,'66':-5,'67':-12,'68':-12,
    '69':-8,'70':-12,'71':-10,'72':-7,'73':-12,'74':-12,'75':-7,'76':-7,'77':-7,'78':-7,
    '79':-5,'80':-9,'81':-5,'82':-5,'83':-3,'84':-6,'85':-5,'86':-5,'87':-8,'88':-12,
    '89':-10,'90':-12,'91':-7,'92':-7,'93':-7,'94':-7,'95':-7
};

let currentG = 0.95;

// ============ DIMENSIONNEMENT \u2014 Anne \u2192 G auto ============

// Table G par anne de construction
function getGFromAnnee(annee) {
    if (annee >= 2021) return 0.6;   // RE 2020
    if (annee >= 2013) return 0.7;   // RT 2012
    if (annee >= 2006) return 0.75;  // RT 2005
    if (annee >= 2001) return 0.8;
    if (annee >= 1990) return 0.95;  // RT 2000
    if (annee >= 1983) return 1.1;
    if (annee >= 1975) return 1.3;   // 1re rglementation
    return 1.6;                       // Avant 1975
}

let currentIsolation = 'origine';

function evalIsolation() {
    const checks = document.querySelectorAll('#isoChecklist input[type="checkbox"]:checked');
    const count = checks.length;
    let recentCount = 0;
    checks.forEach(cb => {
        const quand = cb.closest('.iso-check').querySelector('.iso-quand');
        if (quand && quand.value === 'recent') recentCount++;
    });

    // Dtermination auto de l'tat
    if (count === 0) {
        currentIsolation = 'origine';
    } else if (count >= 3 && recentCount >= 2) {
        currentIsolation = 'totale';
    } else {
        currentIsolation = 'partielle';
    }

    // Affichage
    const names = { origine: 'tat d\'origine / Non prcis', partielle: 'Rnovation partielle', totale: 'Rnovation totale' };
    const colors = { origine: '#64748b', partielle: '#d97706', totale: '#16a34a' };
    const el = document.getElementById('isoStateName');
    if (el) { el.textContent = names[currentIsolation]; el.style.color = colors[currentIsolation]; }
    calcDim();
}

function selectIsolation(state) { currentIsolation = state; calcDim(); }

function getEffectiveG() {
    const annee = parseInt(document.getElementById('dimAnnee').value) || 2000;
    let g = getGFromAnnee(annee);
    if (currentIsolation === 'partielle') g = Math.max(g - 0.2, 0.5);
    if (currentIsolation === 'totale') g = Math.max(Math.min(g, 0.7), 0.5);
    return g;
}

// ============ BARME PAC ============
// Pattern: every 10m, alternating single/double recommendations
// +2kW per 20m step
function getBaremePAC(surface) {
    if (surface <= 40) return [4];
    if (surface <= 50) return [6];
    // From 60m: pattern repeats every 20m
    // 60-70 = [6,8], 80 = [8], 90 = [8,10], 100 = [10], etc.
    const base = Math.floor((surface - 1) / 20); // 0-indexed group
    const inGroup = ((surface - 1) % 20) < 10 ? 0 : 1; // first or second half
    const kw = (base) * 2 + 4; // 4, 6, 8, 10, ...
    
    // Simpler approach: use explicit formula
    const step = Math.floor((surface - 1) / 10); // 0=\u226410, ... 3=31-40, 4=41-50, 5=51-60...
    const kwBase = Math.max(4, Math.floor(surface / 10) * 2);
    
    // Even simpler: keep the proven table + extend
    const table = [
        [40, [4]], [50, [6]], [60, [6,8]], [70, [6,8]], [80, [8]], [90, [8,10]],
        [100, [10]], [110, [10,12]], [120, [12]], [130, [12,14]], [140, [14]],
        [150, [14,16]], [160, [16]], [170, [16,18]], [180, [18]], [190, [18,20]],
        [200, [20]], [210, [20,22]], [220, [22]], [230, [22,24]], [240, [24]],
        [250, [24,26]], [260, [26]], [270, [26,28]], [280, [28]], [290, [28,30]],
        [300, [30]], [350, [30,35]], [Infinity, [35]]
    ];
    for (const [max, reco] of table) {
        if (surface <= max) return reco;
    }
    return [35];
}

function calcBareme() {
    const s = parseInt(document.getElementById('baremeSurface').value) || 100;
    const reco = getBaremePAC(s);
    const el = document.getElementById('baremeReco');
    const alt = document.getElementById('baremeAlt');
    const hint = document.getElementById('baremeIsoHint');
    const cursor = document.getElementById('baremeCursor');
    const lowEl = document.getElementById('baremeLow');
    const highEl = document.getElementById('baremeHigh');

    // Determine low and high power
    let lowKW, highKW;
    if (reco.length === 2) {
        lowKW = reco[0];
        highKW = reco[1];
    } else {
        lowKW = reco[0];
        highKW = reco[0] < 35 ? reco[0] + 2 : reco[0];
    }

    lowEl.textContent = lowKW + ' kW';
    highEl.textContent = highKW + ' kW';

    // Score: 0 = well insulated (left/green), 100 = poorly insulated (right/red)
    const annee = parseInt(document.getElementById('dimAnnee').value) || 2000;
    
    // Count checked isolation items
    const checks = document.querySelectorAll('#isoChecklist input[type="checkbox"]:checked');
    const totalChecks = checks.length; // 0 to 5
    let recentCount = 0;
    checks.forEach(cb => {
        const quand = cb.closest('.iso-check').querySelector('.iso-quand');
        if (quand && quand.value === 'recent') recentCount++;
    });

    // Base score from anne
    let score;
    if (annee < 1975) score = 90;
    else if (annee < 1990) score = 75;
    else if (annee < 2005) score = 55;
    else if (annee < 2012) score = 35;
    else score = 20;

    // Each checked item reduces score significantly
    // 5 items checked = max reduction
    const reductionPerItem = 12; // each item: -12
    const recentBonus = 3; // recent items: extra -3
    score -= totalChecks * reductionPerItem;
    score -= recentCount * recentBonus;

    // All 5 checked + all recent \u2192 score should be ~0-5
    // 5*12 + 5*3 = 75, from base 90 \u2192 15, from base 55 \u2192 -20 \u2192 clamped to 5

    // Clamp 3-97%
    score = Math.max(3, Math.min(97, score));

    // Position cursor
    cursor.style.left = `calc(${score}% - 12px)`;

    // Determine recommendation
    if (score <= 25) {
        el.textContent = lowKW + ' kW';
        el.style.color = '#16a34a';
        alt.textContent = 'Isolation performante \u2192 puissance optimise';
        if (hint) hint.textContent = '';
    } else if (score >= 75) {
        el.textContent = highKW + ' kW';
        el.style.color = '#dc2626';
        alt.textContent = 'Isolation faible \u2192 puissance suprieure conseille';
        if (hint) hint.textContent = '';
    } else {
        el.textContent = lowKW + ' ou ' + highKW + ' kW';
        el.style.color = '#d97706';
        alt.textContent = lowKW + ' kW = conomique  ' + highKW + ' kW = confort';
        if (hint) hint.textContent = '';
    }
}

function syncMenageCEE() {
    const cat = document.getElementById('categorie').value;
    document.getElementById('menageCEE').value = (cat === 'BLEU') ? 'tm' : 'autres';
    calcCEEDetail();
}

function syncSurfaces(from) {
    const val = (from === 'bareme')
        ? document.getElementById('baremeSurface').value
        : (from === 'cee')
        ? document.getElementById('ceeSurface').value
        : document.getElementById('dimSurface').value;
    const s = parseInt(val) || 100;
    document.getElementById('baremeSurface').value = s;
    document.getElementById('dimSurface').value = s;
    const ceeSurf = document.getElementById('ceeSurface');
    if (ceeSurf) ceeSurf.value = s;

    // Auto-set surface dropdown (maison)
    const tl = document.getElementById('typeLogement').value;
    const sel = document.getElementById('surface');
    if (tl === 'maison') {
        if (s < 70) sel.value = 'S<70';
        else if (s < 90) sel.value = '70<=S<90';
        else sel.value = 'S>=90';
    } else {
        if (s < 35) sel.value = 'S<35';
        else if (s < 60) sel.value = '35<=S<60';
        else sel.value = 'S>=60';
    }

    calcBareme();
    calcDim();
    calcCEEDetail();
    calc();
}

function buildBaremeTable() { /* table removed */ }

function selectG(g) { /* legacy compat */ currentG = g; calcDim(); }

function calcDim() {
    const S = parseFloat(document.getElementById('dimSurface').value) || 0;
    const H = parseFloat(document.getElementById('dimHauteur').value) || 2.5;
    const V = S * H;

    const Tbase = parseFloat(document.getElementById('dimTbase').value) || -7;
    const Tint = parseFloat(document.getElementById('dimTint').value) || 21;
    const deltaT = Tint - Tbase;

    const G = getEffectiveG();
    currentG = G;
    const gDisplay = document.getElementById('dimGDisplay');
    if (gDisplay) gDisplay.textContent = `G = ${G.toFixed(2).replace('.', ',')}`;

    const P = G * V * deltaT;
    const T1 = parseFloat(document.getElementById('dimT1').value) || 60;
    const T2 = parseFloat(document.getElementById('dimT2').value) || 140;

    const puissancePAC = P * T1 / 100;
    const puissanceTotale = P * T2 / 100;
    const puissanceAppoint = puissanceTotale - puissancePAC;

    document.getElementById('dimDeperditions').textContent = Math.round(P).toLocaleString('fr-FR') + ' W';
    document.getElementById('dimDepFormula').textContent = `${G.toFixed(2).replace('.', ',')} \u00D7 ${Math.round(V)} \u00D7 ${deltaT}`;

    document.getElementById('dimPuissancePAC').textContent = (puissancePAC / 1000).toFixed(1).replace('.', ',') + ' kW';
    document.getElementById('dimPuissancePACDetail').textContent = `${Math.round(P).toLocaleString('fr-FR')} W \u00D7 ${T1}%`;

    document.getElementById('dimPuissanceAppoint').textContent = (puissanceAppoint / 1000).toFixed(1).replace('.', ',') + ' kW';
    document.getElementById('dimPuissanceAppointDetail').textContent = `(P \u00D7 ${T2}% \u2212 PAC)`;

    document.getElementById('dimPuissanceTotale').textContent = (puissanceTotale / 1000).toFixed(1).replace('.', ',') + ' kW';
}

// ============================================
// INIT
// ============================================
dbg('\uD83D\uDE80 Init start');
checkAutoLogin();
dbg('\uD83C\uDFC1 Init complete');
// Triple-tap to show debug panel
</script>
</body>
</html>
